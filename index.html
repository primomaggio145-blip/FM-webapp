<!DOCTYPE html>

<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Accademia Musicale</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽµ</text></svg>" />

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>

  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; width: 100%; }
    body { background: #0f0e0c; }
    #loading {
      position: fixed; inset: 0; background: #0f0e0c;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 16px; z-index: 9999;
      font-family: sans-serif; transition: opacity 0.4s ease;
    }
    #loading .logo { font-size: 26px; font-weight: 600; color: #c9a84c; letter-spacing: 0.08em; }
    #loading .spinner {
      width: 32px; height: 32px; border: 2px solid #2a2520;
      border-top-color: #c9a84c; border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    #loading .sub { font-size: 12px; color: #4a4438; letter-spacing: 0.1em; text-transform: uppercase; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

</head>
<body>
  <div id="loading">
    <div class="logo">â™ª Accademia Musicale</div>
    <div class="spinner"></div>
    <div class="sub">Caricamento in corsoâ€¦</div>
  </div>
  <div id="root"></div>

  <script type="text/babel">
// React hooks are available globally via window.React when loaded via CDN
const { useState, useEffect, useMemo } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMA CONDIVISO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const C = {
  bg:"#0f0e0c", surface:"#1a1815", surfaceHover:"#1f1d1a", surface2:"#141210",
  border:"#2a2520", borderHover:"#3d372e",
  gold:"#c9a84c", goldDim:"#7a6430", goldBg:"#2e2308", goldLight:"#e8c76a",
  text:"#f0ead8", textMuted:"#8a8070", textDim:"#4a4438",
  green:"#4ade80", greenBg:"#0a2016", greenBorder:"#14532d",
  red:"#f87171",  redBg:"#2a0d0d",   redBorder:"#7f1d1d",
  blue:"#60a5fa", blueBg:"#0d1a2e",  blueBorder:"#1e3a5f",
  orange:"#fb923c",orangeBg:"#2a1508",orangeBorder:"#9a3412",
  purple:"#c084fc",purpleBg:"#1a0d2e",purpleBorder:"#6b21a8",
  teal:"#2dd4bf", tealBg:"#0a2420",  tealBorder:"#0f766e",
};

const G = `
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Sans:wght@300;400;500&display=swap');
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  html,body,#root{height:100%;background:${C.bg};}
  body{color:${C.text};font-family:'DM Sans',sans-serif;overflow-x:hidden;}
  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:${C.bg};}
  ::-webkit-scrollbar-thumb{background:${C.goldDim};border-radius:2px;}
  input::placeholder,textarea::placeholder{color:${C.textDim};}
  input:focus,textarea:focus,select:focus{outline:none;}

  @keyframes fadeUp   {from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fadeIn   {from{opacity:0}to{opacity:1}}
  @keyframes overlayIn{from{opacity:0}to{opacity:1}}
  @keyframes slideIn  {from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
  @keyframes slideDrawer{from{transform:translateX(100%)}to{transform:translateX(0)}}
  @keyframes pulse    {0%,100%{opacity:1}50%{opacity:.4}}
  @keyframes tick     {from{transform:scaleY(0);transform-origin:bottom}to{transform:scaleY(1);transform-origin:bottom}}
  @keyframes slideR   {from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
  @keyframes spin     {to{transform:rotate(360deg)}}
  @keyframes countUp  {from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes floatA   {0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-12px) rotate(1deg)}}
  @keyframes floatB   {0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-8px) rotate(-1.5deg)}}
  @keyframes floatC   {0%,100%{transform:translateY(0)}50%{transform:translateY(-16px)}}

  .kpi-card{animation:fadeUp 0.5s ease both;}
  .kpi-card:nth-child(1){animation-delay:0.05s}
  .kpi-card:nth-child(2){animation-delay:0.10s}
  .kpi-card:nth-child(3){animation-delay:0.15s}
  .kpi-card:nth-child(4){animation-delay:0.20s}
  .kpi-card:nth-child(5){animation-delay:0.25s}
  .section{animation:fadeUp 0.6s ease both;}
  .section:nth-child(1){animation-delay:0.25s}
  .section:nth-child(2){animation-delay:0.35s}
  .section:nth-child(3){animation-delay:0.45s}
  .alert-row{animation:slideR 0.35s ease both;}
  .hover-row{cursor:pointer;transition:background 0.12s;}
  .hover-row:hover{background:${C.surfaceHover}!important;}
  .lesson-row{transition:background 0.12s;}
  .lesson-row:hover{background:${C.surfaceHover}!important;}
  .bar-fill{animation:tick 0.6s cubic-bezier(.4,0,.2,1) both;}
  .nav-btn{transition:all 0.15s;}
  .nav-btn:hover{background:${C.surfaceHover}!important;}
  .quick-action{transition:all 0.18s;}
  .quick-action:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.4);}
  .btn-gold{transition:all .18s;}
  .btn-gold:hover{filter:brightness(1.12);transform:translateY(-1px);}
  .st1{animation:fadeUp .5s ease both}
  .st2{animation:fadeUp .5s .1s ease both}
  .st3{animation:fadeUp .5s .2s ease both}
  .st4{animation:fadeUp .5s .3s ease both}
  .st5{animation:fadeUp .5s .4s ease both}
  .inp:focus-within label{color:${C.gold}!important;}
  .inp:focus-within div{border-color:${C.goldDim}!important;}
  /* â”€â”€ RESPONSIVE â”€â”€ */

  /* layout grids (desktop defaults) */
  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .stat-strip{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
  .stat-strip-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
  .form-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .form-3col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
  .cards-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
  .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .week-grid{overflow-x:auto;-webkit-overflow-scrolling:touch;}

  @media (max-width:767px){
    /* navigation */
    .sidebar-desktop{display:none!important;}
    .bottom-nav{display:flex!important;}
    .login-left-panel{display:none!important;}
    .hide-mobile{display:none!important;}

    /* modal */
    .modal-wide{max-width:calc(100vw - 16px)!important;width:calc(100vw - 16px)!important;margin:8px!important;border-radius:14px!important;}

    /* toolbar */
    .cal-toolbar{flex-wrap:wrap!important;gap:8px!important;}
    .cal-toolbar-right{flex-wrap:wrap!important;gap:6px!important;}
    .toolbar-wrap{flex-wrap:wrap!important;gap:8px!important;}

    /* grids */
    .info-grid{grid-template-columns:1fr!important;}
    .stat-strip{grid-template-columns:1fr 1fr!important;}
    .stat-strip-3{grid-template-columns:1fr 1fr!important;}
    .form-2col{grid-template-columns:1fr!important;}
    .form-3col{grid-template-columns:1fr 1fr!important;}
    .cards-grid{grid-template-columns:1fr 1fr!important;}
    .grid-resp-1{grid-template-columns:1fr!important;}
    .grid-resp-2{grid-template-columns:1fr 1fr!important;}

    /* spacing */
    .view-pad{padding:12px 12px!important;}
    .inner-pad{padding:12px 12px!important;}
    .main-scroll{padding-bottom:72px!important;}

    /* table */
    .table-scroll{overflow-x:auto!important;-webkit-overflow-scrolling:touch!important;}
    .table-scroll > *{min-width:480px;}
    .week-grid > *{min-width:580px;}

    /* flex */
    .flex-wrap-mob{flex-wrap:wrap!important;gap:8px!important;}
    .btn-group-mob{flex-wrap:wrap!important;gap:6px!important;}

    /* login */
    .login-form-wrap{padding:24px 20px!important;}
  }

  @media (max-width:480px){
    .stat-strip{grid-template-columns:1fr 1fr!important;}
    .cards-grid{grid-template-columns:1fr!important;}
    .info-grid{grid-template-columns:1fr!important;}
    .modal-wide{max-width:100vw!important;width:100vw!important;margin:0!important;border-radius:0 0 16px 16px!important;max-height:96vh!important;}
    .view-pad{padding:10px 10px!important;}
    .hide-xxs{display:none!important;}
  }

  @media (min-width:768px){
    .bottom-nav{display:none!important;}
    .modal-resp{align-self:center;border-radius:16px!important;margin:24px auto!important;max-height:92vh!important;}
    .modal-resp-outer{align-items:center!important;padding:24px!important;}
  }
  @media (max-width:767px){
    .modal-resp{border-radius:16px 16px 0 0!important;max-height:92vh!important;}
  }

  /* â”€â”€ TABLET (max 1024px) â”€â”€ */
  @media (max-width:1024px){
    .cards-grid{grid-template-columns:1fr 1fr!important;}
    .stat-strip{grid-template-columns:1fr 1fr!important;}
    .form-3col{grid-template-columns:1fr 1fr!important;}
  }

  /* â”€â”€ RESPONSIVE TABLE COLUMNS â”€â”€ */
  .hide-mobile{display:table-cell;}
  @media (max-width:700px){
    .hide-mobile{display:none!important;}
    .cal-toolbar-right{flex-wrap:wrap!important;}
    .tb-label{display:none!important;}
  }
  @media (max-width:480px){
    .hide-mobile{display:none!important;}
    .resp-hide{display:none!important;}
  }
  
  /* Ensure overflow containers work */
  .table-outer{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .table-outer table{min-width:520px;}
  
  /* Fix allievi table minimum width */
  @media (max-width:700px){
    th.hide-mobile, td.hide-mobile{display:none!important;}
  }

  /* â”€â”€ UNIVERSAL FIXES â”€â”€ */
  .view-content{padding:20px 24px;}
  .view-header{padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
  .view-inner{padding:16px 24px;overflow:auto;flex:1;}
  .toolbar-btns{display:flex;gap:8px;flex-wrap:wrap;}
  .cal-filter-bar{flex-wrap:wrap;gap:6px;}
  .resp-select{min-width:100px!important;max-width:160px!important;}
  .resp-table{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .resp-table-inner{min-width:480px;}
  .resp-grid-detail{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .resp-stat-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
  .resp-stat-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
  .resp-cards-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
  .resp-form-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

  @media (max-width:767px){
    .view-content{padding:12px!important;}
    .view-header{padding:0 12px!important;height:52px!important;}
    .view-inner{padding:12px!important;}
    .toolbar-btns{gap:6px!important;}
    .toolbar-btns .tb-label{display:none!important;}
    .resp-select{min-width:80px!important;}
    .resp-stat-4{grid-template-columns:1fr 1fr!important;}
    .resp-stat-3{grid-template-columns:1fr 1fr!important;}
    .resp-cards-3{grid-template-columns:1fr!important;}
    .resp-form-2{grid-template-columns:1fr!important;}
    .resp-grid-detail{grid-template-columns:1fr!important;}
    .resp-hide{display:none!important;}
    .modal-box{max-width:calc(100vw - 16px)!important;max-height:94vh!important;border-radius:14px!important;}
    .modal-box-full{max-width:100vw!important;width:100vw!important;border-radius:12px 12px 0 0!important;position:fixed!important;bottom:0!important;max-height:90vh!important;}
    .modal-scroll{max-height:70vh!important;overflow-y:auto!important;}
    .week-view-wrap{overflow-x:auto!important;-webkit-overflow-scrolling:touch!important;}
    .week-view-wrap > div{min-width:560px!important;}
    .resp-table{overflow-x:auto!important;}
    .resp-table-inner{min-width:420px!important;}
    .btn-icon-only .btn-txt{display:none!important;}
    .filter-bar-mob{flex-direction:column!important;align-items:stretch!important;}
    .cal-toolbar{gap:6px!important;padding:10px 12px!important;}
    .cal-nav-label{font-size:14px!important;}
    .entrate-cols .col-cat{display:none!important;}
    .att-row{flex-wrap:wrap!important;gap:4px!important;}
    .att-row button{flex:1 1 calc(50% - 4px)!important;}
  }

  @media (max-width:480px){
    .view-content{padding:8px!important;}
    .view-header{padding:0 8px!important;}
    .view-inner{padding:8px!important;}
    .resp-stat-4{grid-template-columns:1fr 1fr!important;}
    .resp-cards-3{grid-template-columns:1fr!important;}
    .modal-box{max-width:100vw!important;width:100vw!important;border-radius:12px 12px 0 0!important;max-height:96vh!important;}
  }
  `;

// â”€â”€ RESPONSIVE HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const useIsMobile = () => {
  const [isMobile, setIsMobile] = useState(
    typeof window !== "undefined" ? window.innerWidth < 768 : false
  );
  useEffect(() => {
    const handler = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener("resize", handler);
    return () => window.removeEventListener("resize", handler);
  }, []);
  return isMobile;
};



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ICONE â€” superset di tutti i moduli
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Ic = ({ n, size=16, stroke="currentColor", fill="none" }) => {
  const p = {
    users:    <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></>,
    music:    <><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></>,
    note:     <><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></>,
    calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
    cal:      <><rect x="3" y="4" width="18" height="17" rx="2"/><path d="M16 2v4M8 2v4M3 10h18M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></>,
    euro:     <><path d="M4 10h12M4 14h12M19 6a7 7 0 1 0 0 12"/></>,
    euro2:    <><circle cx="12" cy="12" r="10"/><path d="M15 9.354a4 4 0 1 0 0 5.292M8.5 10H13M8.5 14H13"/></>,
    chart:    <><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></>,
    alert:    <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>,
    warn:     <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>,
    check:    <path d="M20 6 9 17l-5-5"/>,
    clock:    <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
    user:     <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
    solo:     <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
    group:    <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></>,
    up:       <><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></>,
    down:     <><path d="m19 12-7 7-7-7"/><path d="M12 5v14"/></>,
    star:     <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>,
    flag:     <><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></>,
    pin:      <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
    bell:     <><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></>,
    plus:     <><path d="M12 5v14M5 12h14"/></>,
    grid:     <><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>,
    settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
    receipt:  <><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M16 8H8M16 12H8M12 16H8"/></>,
    x:        <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
    chevD:    <path d="m6 9 6 6 6-6"/>,
    info:     <><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></>,
    edit:     <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
    trash:    <><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></>,
    search:   <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></>,
    back:     <path d="m15 18-6-6 6-6"/>,
    arrow:    <path d="m9 18 6-6-6-6"/>,
    right:    <path d="m9 18 6-6-6-6"/>,
    left:     <path d="m15 18-6-6 6-6"/>,
    mail:     <><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></>,
    lock:     <><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
    eye:      <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>,
    eyeOff:   <><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>,
    send:     <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
    shield:   <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></>,
    filter:   <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>,
    phone:    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.36 13a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.19 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 21 16.92z"/>,
    tag:      <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>,
    repeat:   <><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></>,
    today:    <><rect x="3" y="4" width="18" height="17" rx="2"/><path d="M16 2v4M8 2v4M3 10h18M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></>,
    courses:  <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>,
    list:     <><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></>,
    ban:      <><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></>,
    unlock:   <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>,
    copy:     <><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>,
    mic:      <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>,
    ticket:   <><path d="M15 5v2M15 11v2M15 17v2M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 0 0-4V7a2 2 0 0 1 2-2z"/></>,
    star2:    <><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></>,
    map:      <><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/></>,
    qr:       <><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="5" y="5" width="3" height="3" fill="currentColor"/><rect x="16" y="5" width="3" height="3" fill="currentColor"/><rect x="16" y="16" width="3" height="3" fill="currentColor"/><rect x="5" y="16" width="3" height="3" fill="currentColor"/></>,
    report:   <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>,
  };
  return (
    <svg width={size} height={size} viewBox="0 0 24 24" fill={fill}
      stroke={stroke} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
      {p[n] || null}
    </svg>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRIMITIVI CONDIVISI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const uid = () => "id_" + Date.now() + "_" + Math.floor(Math.random()*10000);

const initials = (nome) => nome ? nome.split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase() : "??";
const age = (dataN) => { if(!dataN) return "â€”"; const d=new Date(dataN); const now=new Date(); let a=now.getFullYear()-d.getFullYear(); if(now.getMonth()<d.getMonth()||(now.getMonth()===d.getMonth()&&now.getDate()<d.getDate()))a--; return a; };
const fmtDate = (s) => { if(!s) return "â€”"; const d=new Date(s+"T00:00:00"); return d.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric"}); };
const yyyymmdd = (d) => d.toISOString().split("T")[0];

const Badge = ({ label, color="gold", stato, variant }) => {
  const lbl = label || stato;
  const col = color !== "gold" ? color : variant ? variant :
    stato === "attivo"    ? "green" : stato === "inattivo"  ? "red" :
    stato === "sospeso"   ? "orange": stato === "invitato"  ? "blue" :
    stato === "pagato"    ? "green" : stato === "scaduto"   ? "red"  :
    stato === "attesa"    ? "orange": color;
  const map = {
    green:  {bg:C.greenBg,  c:C.green,  b:C.greenBorder},
    red:    {bg:C.redBg,    c:C.red,    b:C.redBorder},
    gold:   {bg:C.goldBg,   c:C.gold,   b:C.goldDim},
    orange: {bg:C.orangeBg, c:C.orange, b:C.orangeBorder},
    blue:   {bg:C.blueBg,   c:C.blue,   b:C.blueBorder},
    teal:   {bg:C.tealBg,   c:C.teal,   b:C.tealBorder},
    purple: {bg:C.purpleBg, c:C.purple, b:C.purpleBorder},
    gray:   {bg:C.surface,  c:C.textMuted, b:C.border},
  };
  const s = map[col] || map.gold;
  return (
    <span style={{background:s.bg,color:s.c,border:`1px solid ${s.b}`,borderRadius:4,
      padding:"2px 8px",fontSize:11,fontWeight:500,letterSpacing:"0.04em",
      textTransform:"uppercase",whiteSpace:"nowrap",display:"inline-block"}}>
      {lbl}
    </span>
  );
};

const Btn = ({ children, onClick, variant:_variantRaw, small:_smallRaw, danger:_dangerRaw, disabled:_disabledRaw, style:_extraStyleRaw }) => {
  const variant = _variantRaw||"primary"; const small=_smallRaw||false; const danger=_dangerRaw||false; const disabled=_disabledRaw||false; const extraStyle=_extraStyleRaw||{};
  const base = {display:"flex",alignItems:"center",gap:6,border:"none",borderRadius:8,
    cursor:disabled?"not-allowed":"pointer",fontFamily:"'DM Sans',sans-serif",fontWeight:500,
    transition:"all 0.15s",opacity:disabled?0.5:1,fontSize:small?12:13,
    padding:small?"6px 12px":"10px 18px"};
  const v = {
    primary:   {background:C.gold,color:C.bg},
    secondary: {background:"transparent",color:C.textMuted,border:`1px solid ${C.border}`},
    ghost:     {background:"transparent",color:C.textMuted},
    danger:    {background:C.redBg,color:C.red,border:`1px solid ${C.redBorder}`},
  };
  return <button onClick={disabled?undefined:onClick} style={{...base,...v[danger?"danger":variant],...extraStyle}}>{children}</button>;
};

const Input = ({ label, error, ...props }) => (
  <div style={{display:"flex",flexDirection:"column",gap:6}}>
    {label && <label style={{fontSize:12,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase"}}>{label}</label>}
    <input style={{background:C.surface,border:`1px solid ${error?C.red:C.border}`,borderRadius:8,
      color:C.text,fontSize:14,padding:"10px 14px",width:"100%",fontFamily:"'DM Sans',sans-serif"}} {...props}/>
    {error && <span style={{fontSize:11,color:C.red}}>{error}</span>}
  </div>
);

const Sel = ({ label, options:_optionsRaw, error, value, onChange, ...props }) => {
  const options = _optionsRaw || [];
  return (
  <div style={{display:"flex",flexDirection:"column",gap:6}}>
    {label && <label style={{fontSize:12,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase"}}>{label}</label>}
    <select value={value} onChange={onChange}
      style={{background:C.surface,border:`1px solid ${error?C.red:C.border}`,borderRadius:8,
        color:C.text,fontSize:14,padding:"10px 14px",width:"100%",
        fontFamily:"'DM Sans',sans-serif",appearance:"none"}} {...props}>
      <option value="">â€” seleziona â€”</option>
      {options.map(o=><option key={o.value||o} value={o.value||o}>{o.label||o}</option>)}
    </select>
    {error && <span style={{fontSize:11,color:C.red}}>{error}</span>}
  </div>
);
}

const Textarea = ({ label, ...props }) => (
  <div style={{display:"flex",flexDirection:"column",gap:6}}>
    {label && <label style={{fontSize:12,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase"}}>{label}</label>}
    <textarea rows={3} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
      color:C.text,fontSize:14,padding:"10px 14px",width:"100%",
      fontFamily:"'DM Sans',sans-serif",resize:"vertical"}} {...props}/>
  </div>
);

const Modal = ({ title, onClose, children, wide=false }) => (
  <div className="modal-resp-outer" style={{position:"fixed",inset:0,zIndex:200,display:"flex",alignItems:"flex-end",
    justifyContent:"center",padding:"0"}} onClick={onClose}>
    <div style={{position:"absolute",inset:0,background:"rgba(0,0,0,0.78)",
      backdropFilter:"blur(4px)",animation:"overlayIn 0.2s ease"}}/>
    <div onClick={e=>e.stopPropagation()} className={"modal-resp" + (wide?" modal-wide":"")}
      style={{position:"relative",background:C.surface,
      border:`1px solid ${C.border}`,borderRadius:"16px 16px 0 0",width:"100%",
      maxWidth:wide?900:520,maxHeight:"94vh",overflow:"hidden",
      margin:"0 auto",
      boxSizing:"border-box",
      display:"flex",flexDirection:"column",animation:"fadeUp 0.25s ease"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
        padding:"14px 20px",borderBottom:`1px solid ${C.border}`,flexShrink:0}}>
        <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600,margin:0}}>{title}</h2>
        <button onClick={onClose} style={{background:"none",border:"none",cursor:"pointer",
          color:C.textMuted,display:"flex",padding:4,flexShrink:0}}>
          <Ic n="x" size={18} stroke={C.textMuted}/>
        </button>
      </div>
      <div style={{overflow:"auto",flex:1,WebkitOverflowScrolling:"touch",maxHeight:"80vh"}}>{children}</div>
    </div>
  </div>
);

const Toggle = ({ value, checked, onChange, label }) => (
  <div style={{display:"flex",alignItems:"center",gap:10,cursor:"pointer"}}
    onClick={()=>onChange(!(checked!==undefined?checked:!!value))}>
    <div style={{width:38,height:21,borderRadius:11,
      background:(checked!==undefined?checked:!!value)?C.gold:C.border,
      position:"relative",transition:"background 0.2s",flexShrink:0}}>
      <div style={{width:15,height:15,borderRadius:"50%",background:C.bg,
        boxShadow:"0 1px 3px rgba(0,0,0,0.4)",position:"absolute",top:3,
        left:(checked!==undefined?checked:!!value)?20:3,transition:"left 0.2s"}}/>
    </div>
    {label&&<span style={{fontSize:13,color:C.text}}>{label}</span>}
  </div>
);

const Avatar = ({ initials:ini, hex=C.gold, size=36 }) => (
  <div style={{width:size,height:size,borderRadius:"50%",background:`${hex}20`,
    border:`1.5px solid ${hex}40`,display:"flex",alignItems:"center",justifyContent:"center",
    fontSize:size*0.35,fontWeight:700,color:hex,flexShrink:0,letterSpacing:"0.02em"}}>
    {ini}
  </div>
);

const Field = ({ label, children }) => (
  <div style={{display:"flex",flexDirection:"column",gap:5}}>
    <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>{label}</label>
    {children}
  </div>
);

const SectionDivider = ({ label }) => (
  <div style={{display:"flex",alignItems:"center",gap:10,margin:"8px 0 4px"}}>
    <div style={{flex:1,height:1,background:C.border}}/>
    <span style={{fontSize:10,color:C.textDim,letterSpacing:"0.1em",textTransform:"uppercase",flexShrink:0}}>{label}</span>
    <div style={{flex:1,height:1,background:C.border}}/>
  </div>
);

const ConfirmDel = ({ title="Conferma eliminazione", testo, label, description, onConfirm, onClose }) => (
  <Modal title={title} onClose={onClose}>
    <div style={{padding:24,display:"flex",flexDirection:"column",gap:16,alignItems:"center",textAlign:"center"}}>
      <div style={{width:56,height:56,borderRadius:"50%",background:C.redBg,
        border:`1px solid ${C.redBorder}`,display:"flex",alignItems:"center",justifyContent:"center"}}>
        <Ic n="warn" size={24} stroke={C.red}/>
      </div>
      <div>
        {label && <p style={{fontSize:16,fontWeight:500,marginBottom:8}}>
          Eliminare <strong style={{color:C.gold}}>{label}</strong>?
        </p>}
        <p style={{fontSize:13,color:C.textMuted}}>{testo||description||"Questa azione Ã¨ irreversibile."}</p>
      </div>
    </div>
    <div style={{padding:"16px 24px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"center",gap:10}}>
      <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
      <Btn danger onClick={onConfirm}><Ic n="trash" size={14} stroke={C.red}/>Conferma</Btn>
    </div>
  </Modal>
);

// â”€â”€â”€ RICEVUTA MODAL + PRINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRINT_CSS = `
@media print {
  body > * { display: none !important; }
  #ricevuta-print-root { display: block !important; }
  @page { margin: 18mm 20mm; size: A4; }
}
#ricevuta-print-root {
  display: none;
  font-family: 'DM Sans', Arial, sans-serif;
  color: #1a1a2e;
  background: #fff;
}
.ric-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 28px; border-bottom: 2px solid #c9a84c; padding-bottom: 16px; }
.ric-logo   { font-size: 22px; font-weight: 700; letter-spacing: 0.03em; }
.ric-scuola-sub { font-size: 11px; color: #666; margin-top: 2px; letter-spacing: 0.06em; text-transform: uppercase; }
.ric-num    { text-align: right; }
.ric-num .num { font-size: 28px; font-weight: 700; color: #c9a84c; line-height: 1; }
.ric-num .lbl { font-size: 10px; color: #888; letter-spacing: 0.1em; text-transform: uppercase; }
.ric-body   { margin-bottom: 24px; }
.ric-row    { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
.ric-row:last-child { border-bottom: none; }
.ric-row .k { color: #666; }
.ric-row .v { font-weight: 600; }
.ric-importo { text-align: center; margin: 28px 0; padding: 20px; border: 2px solid #c9a84c; border-radius: 8px; }
.ric-importo .val { font-size: 42px; font-weight: 700; color: #c9a84c; font-family: 'Cormorant Garamond', Georgia, serif; }
.ric-importo .lbl { font-size: 11px; color: #888; letter-spacing: 0.12em; text-transform: uppercase; margin-top: 2px; }
.ric-footer { font-size: 10px; color: #888; text-align: center; margin-top: 32px; padding-top: 12px; border-top: 1px solid #ddd; line-height: 1.6; }
.ric-firma  { margin-top: 40px; display: flex; justify-content: space-between; }
.ric-firma-box { text-align: center; width: 180px; }
.ric-firma-line { border-top: 1px solid #333; margin-bottom: 6px; }
.ric-firma-lbl  { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.08em; }
`;

const RicevutaModal = ({ entrata, student, config, onClose }) => {
  const cfg = config || CONFIG_DEFAULT;
  // Numero ricevuta: usa quello salvato sull'entrata, oppure genera al volo (legacy/anteprima)
  const numRic = entrata.numRicevuta || (String(cfg.progressivoRicevute||1).padStart(3,"0") + "/" + (entrata.anno||new Date().getFullYear()));
  // Intestatario: nomeRicevuta dell'allievo (genitore/tutore per minorenni), fallback al nome allievo
  const intestatario = student?.nomeRicevuta?.trim() || student?.name || entrata.studentName || "â€”";
  const MESI_N = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
  const dataStampa = new Date().toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric"});
  const dataPag    = entrata.data ? new Date(entrata.data+"T00:00:00").toLocaleDateString("it-IT") : dataStampa;
  const meseLabel  = entrata.mese ? MESI_N[entrata.mese-1]+" "+(entrata.anno||new Date().getFullYear()) : "";
  const importoStr = `â‚¬ ${(entrata.importo||0).toLocaleString("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2})}`;

  const handlePrint = () => {
    // inject print css once
    if(!document.getElementById("ric-print-style")) {
      const s = document.createElement("style");
      s.id = "ric-print-style";
      s.innerHTML = PRINT_CSS;
      document.head.appendChild(s);
    }
    // create / update print root
    let root = document.getElementById("ricevuta-print-root");
    if(!root) { root = document.createElement("div"); root.id = "ricevuta-print-root"; document.body.appendChild(root); }
    const indirizzoHtml = cfg.indirizzo ? '<div style="font-size:11px;color:#666;margin-top:4px">'+cfg.indirizzo+'</div>' : '';
    const cfHtml = cfg.codiceFiscale ? '<div style="font-size:11px;color:#666">CF: '+cfg.codiceFiscale+'</div>' : '';
    const nascitaHtml = student?.birthdate ? '<div class="ric-row"><span class="k">Data di nascita</span><span class="v">'+new Date(student.birthdate+'T00:00:00').toLocaleDateString('it-IT')+'</span></div>' : '';
    const mesesHtml = meseLabel ? '<div class="ric-row"><span class="k">Competenza</span><span class="v">'+meseLabel+'</span></div>' : '';
    root.innerHTML = `
      <div class="ric-header">
        <div>
          <div class="ric-logo">${cfg.nomeScuola||'Accademia Musicale'}</div>
          <div class="ric-scuola-sub">${cfg.tipoEnte||''}</div>
          ${indirizzoHtml}
          ${cfHtml}
        </div>
        <div class="ric-num">
          <div class="lbl">Ricevuta nÂ°</div>
          <div class="num">${numRic}</div>
          <div style="font-size:11px;color:#888;margin-top:4px">del ${dataStampa}</div>
        </div>
      </div>
      <div class="ric-body">
        <div class="ric-row"><span class="k">Ricevuta da</span><span class="v">${intestatario}</span></div>
        ${nascitaHtml}
        <div class="ric-row"><span class="k">Data pagamento</span><span class="v">${dataPag}</span></div>
        <div class="ric-row"><span class="k">Descrizione</span><span class="v">${entrata.desc||'Quota mensile'}</span></div>
        ${mesesHtml}
        <div class="ric-row"><span class="k">Metodo di pagamento</span><span class="v">${entrata.metodo||'â€”'}</span></div>
      </div>
      <div class="ric-importo">
        <div class="val">${importoStr}</div>
        <div class="lbl">Importo ricevuto</div>
      </div>
      <div class="ric-firma">
        <div class="ric-firma-box">
          <div class="ric-firma-line"></div>
          <div class="ric-firma-lbl">Il pagante</div>
        </div>
        <div class="ric-firma-box">
          <div class="ric-firma-line"></div>
          <div class="ric-firma-lbl">Il cassiere / responsabile</div>
        </div>
      </div>
      <div class="ric-footer">${cfg.notaRicevuta||'Ricevuta non fiscale'}<br/>${cfg.nomeScuola} Â· ${cfg.annoScolastico||''}</div>
    `;
    window.print();
  };

  const rows = [
    {k:"Ricevuta nÂ°",         v: numRic},
    {k:"Data stampa",          v: dataStampa},
    {k:"Nominativo",           v: intestatario},
    {k:"Data pagamento",       v: dataPag},
    {k:"Descrizione",          v: entrata.desc||"Quota mensile"},
    ...(meseLabel ? [{k:"Competenza",   v: meseLabel}] : []),
    {k:"Metodo",               v: entrata.metodo||"â€”"},
  ];

  return (
    <Modal title="Anteprima ricevuta" onClose={onClose} wide>
      <div style={{padding:"20px 24px",display:"flex",flexDirection:"column",gap:16}}>

        {/* Preview card */}
        <div style={{background:"#fff",border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden",
          boxShadow:"0 4px 24px rgba(0,0,0,0.18)"}}>
          {/* Header ricevuta */}
          <div style={{background:`linear-gradient(135deg,${C.goldBg},#fff)`,
            borderBottom:`2px solid ${C.gold}`,padding:"18px 24px",
            display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
            <div>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:"#1a1a2e",lineHeight:1}}>
                {cfg.nomeScuola}
              </div>
              {cfg.tipoEnte && <div style={{fontSize:10,color:"#888",letterSpacing:"0.1em",textTransform:"uppercase",marginTop:2}}>{cfg.tipoEnte}</div>}
              {cfg.indirizzo && <div style={{fontSize:11,color:"#666",marginTop:4}}>{cfg.indirizzo}</div>}
              {cfg.codiceFiscale && <div style={{fontSize:11,color:"#666"}}>CF: {cfg.codiceFiscale}</div>}
            </div>
            <div style={{textAlign:"right"}}>
              <div style={{fontSize:10,color:"#888",letterSpacing:"0.1em",textTransform:"uppercase"}}>Ricevuta nÂ°</div>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:700,color:C.gold,lineHeight:1}}>{numRic}</div>
              <div style={{fontSize:11,color:"#888",marginTop:2}}>del {dataStampa}</div>
            </div>
          </div>
          {/* Body */}
          <div style={{padding:"0 24px"}}>
            {rows.map((r,i)=>(
              <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
                padding:"10px 0",borderBottom:i<rows.length-1?"1px solid #eee":"none"}}>
                <span style={{fontSize:12,color:"#666"}}>{r.k}</span>
                <span style={{fontSize:13,fontWeight:600,color:"#1a1a2e"}}>{r.v}</span>
              </div>
            ))}
          </div>
          {/* Importo */}
          <div style={{margin:"16px 24px",padding:"18px",textAlign:"center",
            border:`2px solid ${C.gold}`,borderRadius:10,background:C.goldBg}}>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:38,fontWeight:700,color:C.gold,lineHeight:1}}>
              {importoStr}
            </div>
            <div style={{fontSize:10,color:"#888",letterSpacing:"0.12em",textTransform:"uppercase",marginTop:4}}>Importo ricevuto</div>
          </div>
          {/* Footer */}
          <div style={{padding:"12px 24px 16px",borderTop:"1px solid #eee",textAlign:"center"}}>
            <div style={{fontSize:11,color:"#888",lineHeight:1.6}}>{cfg.notaRicevuta}</div>
            <div style={{fontSize:10,color:"#aaa",marginTop:2}}>{cfg.nomeScuola} Â· {cfg.annoScolastico}</div>
          </div>
        </div>

        <div style={{display:"flex",justifyContent:"flex-end",gap:10}}>
          <Btn variant="secondary" onClick={onClose}>Chiudi</Btn>
          <Btn onClick={handlePrint}>
            <Ic n="receipt" size={14} stroke={C.bg}/>Stampa ricevuta
          </Btn>
        </div>
      </div>
    </Modal>
  );
};

// SField usato dal SettingsDrawer della dashboard
const SField = ({ label, sub, ...props }) => (
  <div style={{display:"flex",flexDirection:"column",gap:5}}>
    <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase"}}>{label}</label>
    {sub && <div style={{fontSize:11,color:C.textDim,marginTop:-3}}>{sub}</div>}
    <input style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:8,
      color:C.text,fontSize:13,padding:"9px 13px",width:"100%",fontFamily:"'DM Sans',sans-serif"}}
      {...props}/>
  </div>
);




// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// AUTH â€” Input con icone e form login/registrazione/recupero

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ INPUT COMPONENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AuthInput = ({label,type="text",value,onChange,error,icon,right})=>{
  const [show,setShow]=useState(false);
  const t=type==="password"?(show?"text":"password"):type;
  return(
    <div className="inp" style={{display:"flex",flexDirection:"column",gap:7}}>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",fontWeight:500,transition:"color .2s"}}>{label}</label>
      <div style={{display:"flex",alignItems:"center",background:C.surface2,border:`1px solid ${error?C.red:C.border}`,
        borderRadius:10,overflow:"hidden",transition:"border-color .2s"}}>
        {icon&&<div style={{padding:"0 12px",color:C.textDim,flexShrink:0,display:"flex"}}><Ic n={icon} size={15} stroke={C.textDim}/></div>}
        <input type={t} value={value} onChange={onChange}
          style={{flex:1,background:"transparent",border:"none",color:C.text,fontSize:14,
            padding:icon?"11px 0":"11px 14px",fontFamily:"'DM Sans',sans-serif",width:"100%"}}/>
        {type==="password"&&(
          <button onClick={()=>setShow(p=>!p)} style={{background:"none",border:"none",cursor:"pointer",
            padding:"0 13px",color:C.textDim,display:"flex",flexShrink:0}}>
            <Ic n={show?"eyeOff":"eye"} size={15} stroke={C.textDim}/>
          </button>
        )}
        {right&&<div style={{padding:"0 12px",color:C.textDim,flexShrink:0}}>{right}</div>}
      </div>
      {error&&<span style={{fontSize:11,color:C.red,display:"flex",alignItems:"center",gap:5}}>
        <Ic n="alert" size={12} stroke={C.red}/>{error}
      </span>}
    </div>
  );
};

// â”€â”€â”€ PANNELLO SINISTRA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PanelloSinistra = ()=>{
  // Elementi decorativi geometrici â€” cerchi/linee ispirate a pentagrammi
  const righeDecorative = [0,1,2,3,4];
  const note = [
    {x:"18%",y:"22%",delay:0,  size:18,anim:"floatA 6s ease-in-out infinite"},
    {x:"72%",y:"15%",delay:1.2,size:13,anim:"floatB 7s 1.2s ease-in-out infinite"},
    {x:"85%",y:"55%",delay:0.5,size:22,anim:"floatC 5.5s .5s ease-in-out infinite"},
    {x:"12%",y:"68%",delay:2,  size:16,anim:"floatA 8s 2s ease-in-out infinite"},
    {x:"60%",y:"75%",delay:1,  size:12,anim:"floatB 6.5s 1s ease-in-out infinite"},
    {x:"40%",y:"30%",delay:1.8,size:10,anim:"floatC 7.5s 1.8s ease-in-out infinite"},
  ];

  return(
    <div style={{flex:"0 0 46%",background:`linear-gradient(160deg,#1a160f 0%,#0f0e0c 40%,#1c1409 100%)`,
      position:"relative",overflow:"hidden",display:"flex",flexDirection:"column",
      justifyContent:"space-between",padding:"48px 52px"}}>

      {/* Righe pentagramma */}
      <div style={{position:"absolute",inset:0,pointerEvents:"none"}}>
        {righeDecorative.map((i)=>(
          <div key={i} style={{position:"absolute",left:0,right:0,
            top:`${30+i*8}%`,height:"1px",
            background:`linear-gradient(90deg,transparent 0%,${C.goldDim}30 20%,${C.goldDim}30 80%,transparent 100%)`}}/>
        ))}
      </div>

      {/* Cerchio decorativo grande */}
      <div style={{position:"absolute",right:"-120px",top:"50%",transform:"translateY(-50%)",
        width:400,height:400,borderRadius:"50%",
        border:`1px solid ${C.goldDim}15`,pointerEvents:"none"}}/>
      <div style={{position:"absolute",right:"-80px",top:"50%",transform:"translateY(-50%)",
        width:300,height:300,borderRadius:"50%",
        border:`1px solid ${C.goldDim}20`,pointerEvents:"none"}}/>

      {/* Note musicali flottanti */}
      {note.map((n,i)=>(
        <div key={i} style={{position:"absolute",left:n.x,top:n.y,
          animation:n.anim,pointerEvents:"none",opacity:.25,color:C.gold}}>
          <Ic n="music" size={n.size} stroke={C.gold}/>
        </div>
      ))}

      {/* Contenuto */}
      <div style={{position:"relative",zIndex:1}}>
        <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:4}}>
          <div style={{width:34,height:34,borderRadius:9,background:C.gold,
            display:"flex",alignItems:"center",justifyContent:"center"}}>
            <Ic n="music" size={17} stroke={C.bg}/>
          </div>
          <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:16,fontWeight:600,letterSpacing:"0.01em"}}>
            Accademia Musicale
          </div>
        </div>
      </div>

      <div style={{position:"relative",zIndex:1}}>
        <div style={{fontFamily:"'Cormorant Garamond',serif",fontWeight:300,fontSize:48,
          lineHeight:1.1,letterSpacing:"-0.01em",marginBottom:20}}>
          La musica<br/>
          <em style={{color:C.gold}}>inizia qui.</em>
        </div>
        <p style={{fontSize:14,color:C.textMuted,lineHeight:1.75,maxWidth:320}}>
          Gestisci lezioni, repertorio, pagamenti e allievi della tua scuola di musica in un'unica piattaforma elegante.
        </p>
      </div>

      <div style={{position:"relative",zIndex:1,display:"flex",flexDirection:"column",gap:12}}>
        {[
          {icon:"music",   label:"Calendario e lezioni",    desc:"Vista giornaliera, settimanale e mensile"},
          {icon:"shield",  label:"Gestione pagamenti",      desc:"Rate, ricevute e contabilitÃ "},
          {icon:"edit",    label:"Repertorio musicale",     desc:"Catalogo brani e progressi allievi"},
        ].map(f=>(
          <div key={f.label} style={{display:"flex",alignItems:"center",gap:12}}>
            <div style={{width:32,height:32,borderRadius:8,background:`${C.gold}15`,
              border:`1px solid ${C.goldDim}40`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
              <Ic n={f.icon} size={14} stroke={C.gold}/>
            </div>
            <div>
              <div style={{fontSize:12,fontWeight:500,color:C.text}}>{f.label}</div>
              <div style={{fontSize:11,color:C.textDim}}>{f.desc}</div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// â”€â”€â”€ FORM LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FormLogin = ({onSuccess,onRegistrazione,onRecupero})=>{
  const [email,    setEmail]    = useState("");
  const [password, setPassword] = useState("");
  const [loading,  setLoading]  = useState(false);
  const [err,      setErr]      = useState({});

  // Credenziali demo
  const DEMO = {
    "admin@accademia.it":       {password:"admin123",   nome:"Marco Bianchi",   ruolo:"admin"},
    "segreteria@accademia.it":  {password:"segr2024",   nome:"Laura Esposito",  ruolo:"segreteria"},
    "rossi@accademia.it":       {password:"musica2024", nome:"Prof. Rossi",     ruolo:"docente"},
  };

  const validate=()=>{
    const e={};
    if(!email.trim())    e.email="Email obbligatoria";
    else if(!/\S+@\S+\.\S+/.test(email)) e.email="Email non valida";
    if(!password.trim()) e.password="Password obbligatoria";
    return e;
  };

  const handleLogin=()=>{
    const e=validate(); if(Object.keys(e).length){setErr(e);return;}
    setLoading(true);
    setTimeout(()=>{
      const u=DEMO[email.toLowerCase()];
      if(u&&u.password===password){
        onSuccess({email,nome:u.nome,ruolo:u.ruolo});
      } else {
        setErr({form:"Credenziali non valide. Prova con le credenziali demo sotto."});
        setLoading(false);
      }
    },900);
  };

  const handleKeyDown=(e)=>{if(e.key==="Enter")handleLogin();};

  return(
    <div style={{display:"flex",flexDirection:"column",gap:22}}>
      <div className="st1">
        <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:30,fontWeight:600,marginBottom:6}}>
          Bentornato
        </h1>
        <p style={{fontSize:13,color:C.textMuted}}>Accedi al tuo account per continuare</p>
      </div>

      {err.form&&(
        <div style={{background:C.redBg,border:`1px solid ${C.redBorder}`,borderRadius:10,padding:"11px 14px",
          display:"flex",alignItems:"flex-start",gap:9,animation:"slideIn .25s ease"}}>
          <Ic n="alert" size={15} stroke={C.red}/>
          <span style={{fontSize:13,color:C.red,lineHeight:1.5}}>{err.form}</span>
        </div>
      )}

      <div className="st2" style={{display:"flex",flexDirection:"column",gap:14}} onKeyDown={handleKeyDown}>
        <AuthInput label="Indirizzo email" type="email" icon="mail" value={email}
          onChange={e=>{setEmail(e.target.value);setErr(p=>({...p,email:"",form:""}));}}
          error={err.email} placeholder="nome@accademia.it"/>
        <AuthInput label="Password" type="password" icon="lock" value={password}
          onChange={e=>{setPassword(e.target.value);setErr(p=>({...p,password:"",form:""}));}}
          error={err.password} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
      </div>

      <div className="st3" style={{display:"flex",justifyContent:"flex-end"}}>
        <button onClick={onRecupero} style={{background:"none",border:"none",cursor:"pointer",
          fontSize:12,color:C.textMuted,fontFamily:"'DM Sans',sans-serif",
          textDecoration:"underline",textDecorationColor:C.border}}>
          Password dimenticata?
        </button>
      </div>

      <div className="st4">
        <button className="btn-gold" onClick={handleLogin} disabled={loading}
          style={{width:"100%",padding:"14px 0",borderRadius:12,border:"none",
            background:loading?C.goldDim:C.gold,color:C.bg,fontSize:14,fontWeight:600,
            cursor:loading?"not-allowed":"pointer",fontFamily:"'DM Sans',sans-serif",
            display:"flex",alignItems:"center",justifyContent:"center",gap:8,letterSpacing:"0.02em"}}>
          {loading?(
            <svg width={18} height={18} viewBox="0 0 24 24" style={{animation:"spin 1s linear infinite"}}>
              <circle cx="12" cy="12" r="10" fill="none" stroke={C.bg} strokeWidth="2.5" strokeDasharray="31.4" strokeDashoffset="7"/>
            </svg>
          ):<Ic n="check" size={15} stroke={C.bg}/>}
          {loading?"Accesso in corsoâ€¦":"Accedi"}
        </button>
      </div>

      {/* Credenziali demo */}
      <div className="st5" style={{background:C.goldBg,border:`1px solid ${C.goldDim}40`,
        borderRadius:12,padding:"14px 16px"}}>
        <div style={{fontSize:10,color:C.gold,letterSpacing:"0.1em",textTransform:"uppercase",fontWeight:600,marginBottom:10}}>
          Credenziali demo
        </div>
        {Object.entries(DEMO).map(([em,u])=>(
          <button key={em} onClick={()=>{setEmail(em);setPassword(u.password);setErr({});}}
            style={{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",
              background:"transparent",border:"none",cursor:"pointer",padding:"5px 0",
              borderBottom:`1px solid ${C.goldDim}20`,fontFamily:"'DM Sans',sans-serif"}}>
            <span style={{fontSize:11,color:C.text}}>{u.nome}</span>
            <span style={{fontSize:10,color:C.textMuted}}>{u.ruolo} Â· {em}</span>
          </button>
        ))}
      </div>

      <div style={{textAlign:"center",paddingTop:4}}>
        <span style={{fontSize:13,color:C.textMuted}}>Non hai un account? </span>
        <button onClick={onRegistrazione} style={{background:"none",border:"none",cursor:"pointer",
          fontSize:13,color:C.gold,fontFamily:"'DM Sans',sans-serif",fontWeight:500,textDecoration:"underline"}}>
          Richiedi accesso
        </button>
      </div>
    </div>
  );
};

// â”€â”€â”€ FORM RICHIEDI ACCESSO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FormRegistrazione = ({onBack})=>{
  const [step,    setStep]    = useState(1); // 1=dati, 2=inviato
  const [f,       setF]       = useState({nome:"",email:"",ruolo:"docente",messaggio:""});
  const [loading, setLoading] = useState(false);
  const [err,     setErr]     = useState({});
  const set=(k,v)=>setF(p=>({...p,[k]:v}));

  const RUOLI=[
    {id:"docente",    label:"Docente",       desc:"Accesso al calendario e repertorio"},
    {id:"segreteria", label:"Segreteria",    desc:"Allievi, pagamenti, calendario"},
    {id:"direttore",  label:"Direttore",     desc:"Accesso completo, senza impostazioni admin"},
  ];

  const validate=()=>{
    const e={};
    if(!f.nome.trim())  e.nome="Nome obbligatorio";
    if(!f.email.trim()||!/\S+@\S+\.\S+/.test(f.email)) e.email="Email non valida";
    return e;
  };

  const handleInvia=()=>{
    const e=validate(); if(Object.keys(e).length){setErr(e);return;}
    setLoading(true);
    setTimeout(()=>{setLoading(false);setStep(2);},1200);
  };

  if(step===2) return(
    <div style={{display:"flex",flexDirection:"column",gap:22,alignItems:"center",textAlign:"center",paddingTop:20}}>
      <div style={{width:64,height:64,borderRadius:"50%",background:C.greenBg,border:`2px solid ${C.greenBorder}`,
        display:"flex",alignItems:"center",justifyContent:"center",animation:"fadeUp .4s ease both"}}>
        <Ic n="send" size={28} stroke={C.green}/>
      </div>
      <div style={{animation:"fadeUp .4s .1s ease both"}}>
        <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600,marginBottom:10}}>
          Richiesta inviata!
        </h2>
        <p style={{fontSize:14,color:C.textMuted,lineHeight:1.7}}>
          La tua richiesta Ã¨ stata inviata agli amministratori.<br/>
          Riceverai un'email a <strong style={{color:C.text}}>{f.email}</strong><br/>
          quando il tuo account sarÃ  attivato.
        </p>
      </div>
      <div style={{background:C.goldBg,border:`1px solid ${C.goldDim}40`,borderRadius:10,
        padding:"12px 18px",animation:"fadeUp .4s .2s ease both"}}>
        <p style={{fontSize:12,color:C.textMuted,lineHeight:1.6}}>
          Solitamente l'attivazione avviene entro <strong style={{color:C.gold}}>24 ore</strong>.<br/>
          Se non ricevi notizie, contatta l'amministratore.
        </p>
      </div>
      <button onClick={onBack}
        style={{padding:"12px 28px",borderRadius:10,background:"transparent",
          border:`1px solid ${C.border}`,color:C.textMuted,cursor:"pointer",
          fontSize:13,fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:6,
          transition:"all .15s"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor=C.borderHover;e.currentTarget.style.color=C.text;}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;}}>
        <Ic n="left" size={14} stroke="currentColor"/>Torna al login
      </button>
    </div>
  );

  return(
    <div style={{display:"flex",flexDirection:"column",gap:20}}>
      <div className="st1">
        <button onClick={onBack} style={{display:"flex",alignItems:"center",gap:6,background:"none",
          border:"none",cursor:"pointer",color:C.textMuted,fontSize:12,fontFamily:"'DM Sans',sans-serif",
          marginBottom:16,padding:0}}>
          <Ic n="left" size={14} stroke={C.textMuted}/>Torna al login
        </button>
        <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,marginBottom:6}}>
          Richiedi accesso
        </h1>
        <p style={{fontSize:13,color:C.textMuted,lineHeight:1.5}}>
          Compila il modulo. Un amministratore approverÃ  la tua richiesta.
        </p>
      </div>

      <div className="st2" style={{display:"flex",flexDirection:"column",gap:13}}>
        <AuthInput label="Nome completo *" icon="user" value={f.nome}
          onChange={e=>{set("nome",e.target.value);setErr(p=>({...p,nome:""}));}}
          error={err.nome} placeholder="Es. Mario Rossi"/>
        <AuthInput label="Email *" type="email" icon="mail" value={f.email}
          onChange={e=>{set("email",e.target.value);setErr(p=>({...p,email:""}));}}
          error={err.email} placeholder="mario@esempio.it"/>
      </div>

      {/* Ruolo */}
      <div className="st3">
        <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:10}}>Ruolo richiesto</div>
        <div style={{display:"flex",flexDirection:"column",gap:7}}>
          {RUOLI.map(r=>(
            <button key={r.id} onClick={()=>set("ruolo",r.id)}
              style={{display:"flex",alignItems:"center",gap:12,padding:"11px 14px",borderRadius:10,
                border:`1.5px solid ${f.ruolo===r.id?C.gold:C.border}`,
                background:f.ruolo===r.id?C.goldBg:C.surface2,
                cursor:"pointer",textAlign:"left",transition:"all .15s"}}>
              <div style={{width:8,height:8,borderRadius:"50%",
                background:f.ruolo===r.id?C.gold:C.border,flexShrink:0,transition:"background .15s"}}/>
              <div>
                <div style={{fontSize:13,fontWeight:500,color:f.ruolo===r.id?C.gold:C.text}}>{r.label}</div>
                <div style={{fontSize:11,color:C.textDim,marginTop:1}}>{r.desc}</div>
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* Messaggio */}
      <div className="st4" style={{display:"flex",flexDirection:"column",gap:6}}>
        <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>
          Messaggio (opzionale)
        </label>
        <textarea value={f.messaggio} onChange={e=>set("messaggio",e.target.value)} rows={2}
          placeholder="Presentati brevemente e spiega il tuo ruolo nell'accademia..."
          style={{background:C.surface2,border:`1px solid ${C.border}`,borderRadius:10,
            color:C.text,fontSize:13,padding:"11px 14px",width:"100%",
            fontFamily:"'DM Sans',sans-serif",resize:"none"}}/>
      </div>

      <div className="st5">
        <button className="btn-gold" onClick={handleInvia} disabled={loading}
          style={{width:"100%",padding:"14px 0",borderRadius:12,border:"none",
            background:loading?C.goldDim:C.gold,color:C.bg,fontSize:14,fontWeight:600,
            cursor:loading?"not-allowed":"pointer",fontFamily:"'DM Sans',sans-serif",
            display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>
          {loading?(
            <svg width={18} height={18} viewBox="0 0 24 24" style={{animation:"spin 1s linear infinite"}}>
              <circle cx="12" cy="12" r="10" fill="none" stroke={C.bg} strokeWidth="2.5" strokeDasharray="31.4" strokeDashoffset="7"/>
            </svg>
          ):<Ic n="send" size={14} stroke={C.bg}/>}
          {loading?"Invio in corsoâ€¦":"Invia richiesta"}
        </button>
      </div>
    </div>
  );
};

// â”€â”€â”€ FORM RECUPERO PASSWORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FormRecupero = ({onBack})=>{
  const [email,   setEmail]   = useState("");
  const [loading, setLoading] = useState(false);
  const [sent,    setSent]    = useState(false);
  const [err,     setErr]     = useState("");

  const handleInvia=()=>{
    if(!email.trim()||!/\S+@\S+\.\S+/.test(email)){setErr("Email non valida");return;}
    setLoading(true);
    setTimeout(()=>{setLoading(false);setSent(true);},1000);
  };

  if(sent) return(
    <div style={{display:"flex",flexDirection:"column",gap:20,alignItems:"center",textAlign:"center",paddingTop:16}}>
      <div style={{width:60,height:60,borderRadius:"50%",background:C.greenBg,border:`2px solid ${C.greenBorder}`,
        display:"flex",alignItems:"center",justifyContent:"center",animation:"fadeUp .4s ease both"}}>
        <Ic n="mail" size={26} stroke={C.green}/>
      </div>
      <div style={{animation:"fadeUp .4s .1s ease both"}}>
        <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:600,marginBottom:8}}>Email inviata</h2>
        <p style={{fontSize:13,color:C.textMuted,lineHeight:1.7}}>
          Se l'account esiste, riceverai le istruzioni<br/>per reimpostare la password a<br/>
          <strong style={{color:C.text}}>{email}</strong>
        </p>
      </div>
      <button onClick={onBack}
        style={{padding:"11px 24px",borderRadius:10,background:"transparent",
          border:`1px solid ${C.border}`,color:C.textMuted,cursor:"pointer",
          fontSize:13,fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:6,
          transition:"all .15s"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor=C.borderHover;e.currentTarget.style.color=C.text;}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;}}>
        <Ic n="left" size={14} stroke="currentColor"/>Torna al login
      </button>
    </div>
  );

  return(
    <div style={{display:"flex",flexDirection:"column",gap:22}}>
      <div className="st1">
        <button onClick={onBack} style={{display:"flex",alignItems:"center",gap:6,background:"none",
          border:"none",cursor:"pointer",color:C.textMuted,fontSize:12,fontFamily:"'DM Sans',sans-serif",
          marginBottom:16,padding:0}}>
          <Ic n="left" size={14} stroke={C.textMuted}/>Torna al login
        </button>
        <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,marginBottom:6}}>
          Password dimenticata?
        </h1>
        <p style={{fontSize:13,color:C.textMuted,lineHeight:1.6}}>
          Inserisci la tua email e ti invieremo un link per reimpostare la password.
        </p>
      </div>
      <div className="st2">
        <AuthInput label="Indirizzo email" type="email" icon="mail" value={email}
          onChange={e=>{setEmail(e.target.value);setErr("");}}
          error={err} placeholder="nome@accademia.it"/>
      </div>
      <div className="st3">
        <button className="btn-gold" onClick={handleInvia} disabled={loading}
          style={{width:"100%",padding:"14px 0",borderRadius:12,border:"none",
            background:loading?C.goldDim:C.gold,color:C.bg,fontSize:14,fontWeight:600,
            cursor:loading?"not-allowed":"pointer",fontFamily:"'DM Sans',sans-serif",
            display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>
          {loading?(
            <svg width={18} height={18} viewBox="0 0 24 24" style={{animation:"spin 1s linear infinite"}}>
              <circle cx="12" cy="12" r="10" fill="none" stroke={C.bg} strokeWidth="2.5" strokeDasharray="31.4" strokeDashoffset="7"/>
            </svg>
          ):<Ic n="send" size={14} stroke={C.bg}/>}
          {loading?"Invio in corsoâ€¦":"Invia link di reset"}
        </button>
      </div>
    </div>
  );
};

// â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// DASHBOARD

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ COSTANTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const oggi   = new Date();
const ANNO   = oggi.getFullYear();
const MESE   = oggi.getMonth();
const GIORNO = oggi.getDay(); // 0=dom
const MESI   = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
                 "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
const GIORNI = ["Domenica","LunedÃ¬","MartedÃ¬","MercoledÃ¬","GiovedÃ¬","VenerdÃ¬","Sabato"];

const fmt  = n => `â‚¬ ${Number(n).toLocaleString("it-IT",{minimumFractionDigits:0,maximumFractionDigits:0})}`;
const fmtD = n => `â‚¬ ${Number(n).toLocaleString("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2})}`;

// â”€â”€â”€ DATI DEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ALLIEVI = [
  {id:"a1",name:"Sofia Marchetti",  instrument:"Pianoforte",teacher:"Prof. Rossi",   stato:"pagato", monthlyFee:120},
  {id:"a2",name:"Luca Ferrara",     instrument:"Chitarra",  teacher:"Prof. Bianchi", stato:"attesa", monthlyFee:100},
  {id:"a3",name:"Emma Conti",       instrument:"Violino",   teacher:"Prof. Rossi",   stato:"pagato", monthlyFee:120},
  {id:"a4",name:"Marco Ricci",      instrument:"Batteria",  teacher:"Prof. Verde",   stato:"scaduto",monthlyFee:110},
  {id:"a5",name:"Giulia Romano",    instrument:"Flauto",    teacher:"Prof. Bianchi", stato:"pagato", monthlyFee:100},
  {id:"a6",name:"Alessandro Gallo", instrument:"Pianoforte",teacher:"Prof. Rossi",   stato:"sospeso",monthlyFee:120},
  {id:"a7",name:"Chiara Esposito",  instrument:"Canto",     teacher:"Prof. Marino",  stato:"pagato", monthlyFee:115},
  {id:"a8",name:"Matteo Bruno",     instrument:"Chitarra",  teacher:"Prof. Bianchi", stato:"scaduto",monthlyFee:100},
];

const LEZIONI_OGGI = [
  {id:"l1",ora:"09:00",durata:60, allievo:"Sofia Marchetti",  strumento:"Pianoforte",docente:"Prof. Rossi",   aula:"Sala A", tipo:"individuale",confermata:true},
  {id:"l2",ora:"10:15",durata:45, allievo:"Emma Conti",       strumento:"Violino",   docente:"Prof. Rossi",   aula:"Sala A", tipo:"individuale",confermata:true},
  {id:"l3",ora:"11:00",durata:60, allievo:"Luca Ferrara",     strumento:"Chitarra",  docente:"Prof. Bianchi", aula:"Sala B", tipo:"individuale",confermata:false},
  {id:"l4",ora:"14:00",durata:90, allievo:"Ensemble Junior",  strumento:"Vari",      docente:"Prof. Rossi",   aula:"Sala C", tipo:"collettivo", confermata:true},
  {id:"l5",ora:"15:30",durata:45, allievo:"Giulia Romano",    strumento:"Flauto",    docente:"Prof. Bianchi", aula:"Sala B", tipo:"individuale",confermata:true},
  {id:"l6",ora:"16:30",durata:60, allievo:"Marco Ricci",      strumento:"Batteria",  docente:"Prof. Verde",   aula:"Sala D", tipo:"individuale",confermata:false},
  {id:"l7",ora:"18:00",durata:60, allievo:"Chiara Esposito",  strumento:"Canto",     docente:"Prof. Marino",  aula:"Sala A", tipo:"individuale",confermata:true},
];

const PROSSIMI_EVENTI = [
  {data:`${ANNO}-06-07`,titolo:"Saggio di fine anno",luogo:"Aula Magna",tipo:"saggio"},
  {data:`${ANNO}-06-14`,titolo:"Masterclass Chitarra",luogo:"Sala C",tipo:"masterclass"},
  {data:`${ANNO}-06-21`,titolo:"Concerto Estate",luogo:"Piazza del Comune",tipo:"concerto"},
  {data:`${ANNO}-07-10`,titolo:"Audizioni nuovi allievi",luogo:"Sala A",tipo:"audizione"},
];

// Dati finanziari mensili (gen-mag)
const FIN_MENSILE = [
  {m:"Gen", entr:1660, usc:2420},
  {m:"Feb", entr:1010, usc:2290},
  {m:"Mar", entr:1570, usc:2260},
  {m:"Apr", entr:1430, usc:2210},
  {m:"Mag", entr:1570, usc:3300},
];

const ATTIVITA_RECENTE = [
  {id:1,tipo:"pagamento",  desc:"Pagamento quota maggio",   sogg:"Sofia Marchetti",   quando:"Oggi, 09:15",  importo:120,  segno:1},
  {id:2,tipo:"pagamento",  desc:"Pagamento quota maggio",   sogg:"Emma Conti",        quando:"Oggi, 08:40",  importo:120,  segno:1},
  {id:3,tipo:"spesa",      desc:"Compenso mensile",         sogg:"Prof. Rossi",       quando:"Ieri, 14:00",  importo:980,  segno:-1},
  {id:4,tipo:"spesa",      desc:"Compenso mensile",         sogg:"Prof. Bianchi",     quando:"Ieri, 14:00",  importo:840,  segno:-1},
  {id:5,tipo:"allievo",    desc:"Nuovo allievo iscritto",   sogg:"Chiara Esposito",   quando:"2 giorni fa",  importo:null, segno:0},
  {id:6,tipo:"pagamento",  desc:"Pagamento iscrizione",     sogg:"Giulia Romano",     quando:"3 giorni fa",  importo:150,  segno:1},
  {id:7,tipo:"evento",     desc:"Masterclass confermata",   sogg:"Sala C â€” 14 Giugno",quando:"4 giorni fa",  importo:null, segno:0},
];

// â”€â”€â”€ OROLOGIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LiveClock = () => {
  const [now, setNow] = useState(new Date());
  useEffect(()=>{ const t=setInterval(()=>setNow(new Date()),1000); return ()=>clearInterval(t); },[]);
  const h=String(now.getHours()).padStart(2,"0");
  const m=String(now.getMinutes()).padStart(2,"0");
  const s=String(now.getSeconds()).padStart(2,"0");
  return (
    <div style={{textAlign:"right"}}>
      <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:36,fontWeight:300,letterSpacing:"0.04em",lineHeight:1,color:C.gold}}>
        {h}<span style={{animation:"pulse 2s infinite",display:"inline-block",margin:"0 2px"}}>:</span>{m}
        <span style={{fontSize:22,color:C.goldDim,marginLeft:4}}>{s}</span>
      </div>
      <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.12em",textTransform:"uppercase",marginTop:4}}>
        {GIORNI[oggi.getDay()]} {oggi.getDate()} {MESI[oggi.getMonth()]} {oggi.getFullYear()}
      </div>
    </div>
  );
};

// â”€â”€â”€ KPI CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KpiCard = ({ icon, label, value, sub, hex=C.gold, bg, trend, onClick }) => {
  const [displayed, setDisplayed] = useState(0);
  const isNum = typeof value === "number";

  useEffect(()=>{
    if(!isNum){ setDisplayed(value); return; }
    let start=0; const end=value; const dur=900;
    const step=()=>{ start+=Math.ceil((end-start)/8)+1; if(start>=end)start=end; setDisplayed(start); if(start<end)requestAnimationFrame(step); };
    setTimeout(()=>requestAnimationFrame(step),200);
  },[value]);

  return (
    <div className="kpi-card" onClick={onClick}
      style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,
        padding:"20px 22px",cursor:onClick?"pointer":"default",
        transition:"all 0.18s",position:"relative",overflow:"hidden",
        borderTop:`3px solid ${hex}20`}}
      onMouseEnter={e=>{if(onClick){e.currentTarget.style.borderColor=hex;e.currentTarget.style.borderTopColor=hex;}}}
      onMouseLeave={e=>{if(onClick){e.currentTarget.style.borderColor=C.border;e.currentTarget.style.borderTopColor=hex+"20";}}}>
      {/* Glow */}
      <div style={{position:"absolute",top:-30,right:-30,width:100,height:100,
        borderRadius:"50%",background:hex,opacity:0.04,pointerEvents:"none"}}/>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:14}}>
        <div style={{width:38,height:38,borderRadius:10,background:bg||`${hex}15`,
          display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
          <Ic n={icon} size={18} stroke={hex}/>
        </div>
        {trend!==undefined && (
          <div style={{display:"flex",alignItems:"center",gap:4,fontSize:11,
            color:trend>=0?C.green:C.red}}>
            <Ic n={trend>=0?"up":"down"} size={11} stroke={trend>=0?C.green:C.red}/>
            {Math.abs(trend)}%
          </div>
        )}
      </div>
      <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:34,fontWeight:600,
        color:hex,lineHeight:1,letterSpacing:"-0.01em",animation:"countUp 0.4s ease both"}}>
        {isNum ? displayed : value}
      </div>
      <div style={{fontSize:11,color:C.textMuted,marginTop:6,letterSpacing:"0.07em",textTransform:"uppercase"}}>{label}</div>
      {sub && <div style={{fontSize:12,color:C.textDim,marginTop:4}}>{sub}</div>}
    </div>
  );
};

// â”€â”€â”€ MINI GRAFICO FINANZIARIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MiniChart = ({ dati }) => {
  const maxVal = Math.max(...dati.flatMap(d=>[d.entr,d.usc]),1);
  const [hov, setHov] = useState(null);

  return (
    <div>
      <div style={{display:"flex",alignItems:"flex-end",gap:6,height:80,marginBottom:8}}>
        {dati.map((d,i)=>{
          const hE = Math.max((d.entr/maxVal)*76, d.entr>0?3:0);
          const hU = Math.max((d.usc/maxVal)*76,  d.usc>0?3:0);
          const isHov = hov===i;
          return (
            <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:0}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}>
              {isHov && (
                <div style={{position:"absolute",background:C.surface2,border:`1px solid ${C.border}`,
                  borderRadius:6,padding:"5px 8px",fontSize:10,whiteSpace:"nowrap",
                  transform:"translateY(-60px)",color:C.text,zIndex:10,pointerEvents:"none"}}>
                  <div style={{color:C.green}}>â†‘ {fmtD(d.entr)}</div>
                  <div style={{color:C.red}}>â†“ {fmtD(d.usc)}</div>
                </div>
              )}
              <div style={{display:"flex",gap:3,alignItems:"flex-end",width:"100%",justifyContent:"center",height:80,position:"relative"}}>
                <div className="bar-fill" style={{flex:1,height:hE,borderRadius:"3px 3px 0 0",
                  background:isHov?C.green:`${C.green}60`,transition:"background 0.15s",
                  animationDelay:`${i*0.06}s`}}/>
                <div className="bar-fill" style={{flex:1,height:hU,borderRadius:"3px 3px 0 0",
                  background:isHov?C.red:`${C.red}60`,transition:"background 0.15s",
                  animationDelay:`${i*0.06+0.03}s`}}/>
              </div>
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",gap:6}}>
        {dati.map((d,i)=>(
          <div key={i} style={{flex:1,textAlign:"center",fontSize:9,
            color:i===dati.length-1?C.gold:C.textDim,letterSpacing:"0.05em",
            fontWeight:i===dati.length-1?600:400}}>{d.m}</div>
        ))}
      </div>
    </div>
  );
};

// â”€â”€â”€ LESSON TIMELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LessonTimeline = ({ lezioni }) => {
  const oraNum = t => { const [h,m]=t.split(":").map(Number); return h*60+m; };
  const nowMins = oggi.getHours()*60+oggi.getMinutes();

  return (
    <div style={{display:"flex",flexDirection:"column",gap:3}}>
      {lezioni.map((l,i)=>{
        const startM = oraNum(l.ora);
        const endM   = startM + l.durata;
        const inCorso= nowMins>=startM && nowMins<endM;
        const passata = nowMins>=endM;
        const prossima= !passata && !inCorso && i===lezioni.findIndex(x=>oraNum(x.ora)>nowMins);

        const docenteColor = {
          "Prof. Rossi":C.gold,"Prof. Bianchi":C.teal,"Prof. Verde":C.blue,"Prof. Marino":C.purple
        }[l.docente]||C.textMuted;

        return (
          <div key={l.id} className="lesson-row"
            style={{display:"grid",gridTemplateColumns:"52px 4px 1fr auto",
              gap:10,alignItems:"center",padding:"9px 12px",borderRadius:10,
              background:inCorso?`${C.goldBg}cc`:passata?C.bg:C.surface,
              border:`1px solid ${inCorso?C.goldDim:passata?C.border+"60":C.border}`,
              opacity:passata?0.5:1}}>
            {/* Ora */}
            <div style={{textAlign:"right"}}>
              <div style={{fontSize:13,fontWeight:500,color:inCorso?C.gold:passata?C.textDim:C.text}}>{l.ora}</div>
              <div style={{fontSize:10,color:C.textDim}}>{l.durata}â€²</div>
            </div>
            {/* Indicatore */}
            <div style={{display:"flex",flexDirection:"column",alignItems:"center",height:"100%",gap:2}}>
              <div style={{width:4,height:4,borderRadius:"50%",flexShrink:0,
                background:inCorso?C.gold:passata?C.textDim:docenteColor,
                boxShadow:inCorso?`0 0 8px ${C.gold}`:undefined,
                animation:inCorso?"pulse 1.5s infinite":undefined}}/>
              {i<lezioni.length-1 && <div style={{flex:1,width:1,background:C.border}}/>}
            </div>
            {/* Contenuto */}
            <div>
              <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:2}}>
                <span style={{fontSize:13,fontWeight:500,color:inCorso?C.gold:C.text,
                  overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:160}}>
                  {l.allievo}
                </span>
                {inCorso && (
                  <span style={{fontSize:9,background:C.gold,color:C.bg,borderRadius:4,
                    padding:"1px 6px",fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",flexShrink:0}}>
                    In corso
                  </span>
                )}
                {prossima && (
                  <span style={{fontSize:9,background:C.blueBg,color:C.blue,borderRadius:4,
                    padding:"1px 6px",fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",flexShrink:0,
                    border:`1px solid ${C.blueBorder}`}}>
                    Prossima
                  </span>
                )}
                {!l.confermata && !passata && (
                  <span style={{fontSize:9,background:C.orangeBg,color:C.orange,borderRadius:4,
                    padding:"1px 6px",fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",flexShrink:0,
                    border:`1px solid ${C.orangeBorder}`}}>
                    Da confermare
                  </span>
                )}
              </div>
              <div style={{fontSize:11,color:C.textMuted,display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                <span style={{color:docenteColor}}>{l.docente}</span>
                <span>Â·</span>
                <span>{l.strumento}</span>
                <span>Â·</span>
                <span>{l.aula}</span>
              </div>
            </div>
            {/* Tipo */}
            <div style={{textAlign:"right",flexShrink:0}}>
              <span style={{fontSize:9,letterSpacing:"0.08em",textTransform:"uppercase",
                color:l.tipo==="collettivo"?C.purple:C.textDim}}>
                {l.tipo==="collettivo"?"Coll.":"Ind."}
              </span>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// â”€â”€â”€ STATO ALLIEVI DONUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const StatoAllievi = ({ allievi }) => {
  const conteggi = {
    pagato:  allievi.filter(a=>a.stato==="pagato").length,
    attesa:  allievi.filter(a=>a.stato==="attesa").length,
    scaduto: allievi.filter(a=>a.stato==="scaduto").length,
    sospeso: allievi.filter(a=>a.stato==="sospeso").length,
  };
  const tot = allievi.length;
  const cfg = [
    {k:"pagato", label:"Pagato",    hex:C.green},
    {k:"attesa", label:"In attesa", hex:C.orange},
    {k:"scaduto",label:"Scaduto",   hex:C.red},
    {k:"sospeso",label:"Sospeso",   hex:C.textMuted},
  ];

  // SVG donut
  const R=36, cx=44, cy=44, stroke=14;
  const circ=2*Math.PI*R;
  let offset=0;
  const slices=cfg.map(c=>{
    const pct=(conteggi[c.k]||0)/tot;
    const dash=pct*circ;
    const s={ ...c, pct, dash, offset };
    offset+=dash;
    return s;
  });

  return (
    <div style={{display:"flex",gap:16,alignItems:"center"}}>
      <svg width={88} height={88} style={{flexShrink:0}}>
        <circle cx={cx} cy={cy} r={R} fill="none" stroke={C.border} strokeWidth={stroke}/>
        {slices.filter(s=>s.dash>0).map((s,i)=>(
          <circle key={s.k} cx={cx} cy={cy} r={R} fill="none"
            stroke={s.hex} strokeWidth={stroke}
            strokeDasharray={`${s.dash} ${circ-s.dash}`}
            strokeDashoffset={-s.offset+circ/4}
            style={{transition:"stroke-dasharray 0.6s ease",animationDelay:`${i*0.1}s`}}/>
        ))}
        <text x={cx} y={cy+2} textAnchor="middle" dominantBaseline="middle"
          fontFamily="'Cormorant Garamond',serif" fontSize={22} fontWeight={600} fill={C.gold}>
          {tot}
        </text>
        <text x={cx} y={cy+16} textAnchor="middle" dominantBaseline="middle"
          fontFamily="'DM Sans',sans-serif" fontSize={8} fill={C.textDim} letterSpacing="0.08em">
          ALLIEVI
        </text>
      </svg>
      <div style={{display:"flex",flexDirection:"column",gap:7,flex:1}}>
        {cfg.map(c=>(
          <div key={c.k} style={{display:"flex",alignItems:"center",gap:8}}>
            <div style={{width:7,height:7,borderRadius:"50%",background:c.hex,flexShrink:0}}/>
            <div style={{flex:1,fontSize:12,color:C.textMuted}}>{c.label}</div>
            <div style={{fontSize:13,fontWeight:600,color:c.hex,fontFamily:"'Cormorant Garamond',serif",minWidth:18,textAlign:"right"}}>
              {conteggi[c.k]||0}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// â”€â”€â”€ EVENTI PROSSIMI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EventiCard = ({ eventi }) => {
  const tipoColor = {
    saggio:"gold",concerto:C.teal,masterclass:C.purple,audizione:C.blue
  };
  const tipoHex = {
    saggio:C.gold,concerto:C.teal,masterclass:C.purple,audizione:C.blue
  };

  return (
    <div style={{display:"flex",flexDirection:"column",gap:8}}>
      {eventi.map(e=>{
        const d=new Date(e.data+"T00:00:00");
        const diff=Math.ceil((d-oggi)/(1000*60*60*24));
        const hex=tipoHex[e.tipo]||C.textMuted;
        return (
          <div key={e.data} style={{display:"flex",gap:12,alignItems:"center",
            padding:"10px 14px",borderRadius:10,background:C.bg,border:`1px solid ${C.border}`,
            transition:"all 0.15s"}}
            onMouseEnter={ev=>ev.currentTarget.style.borderColor=hex}
            onMouseLeave={ev=>ev.currentTarget.style.borderColor=C.border}>
            {/* Data box */}
            <div style={{width:42,textAlign:"center",flexShrink:0}}>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:hex,lineHeight:1}}>
                {d.getDate()}
              </div>
              <div style={{fontSize:9,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>
                {MESI[d.getMonth()].slice(0,3)}
              </div>
            </div>
            <div style={{width:1,height:32,background:C.border,flexShrink:0}}/>
            {/* Info */}
            <div style={{flex:1,minWidth:0}}>
              <div style={{fontSize:13,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                {e.titolo}
              </div>
              <div style={{fontSize:11,color:C.textMuted,marginTop:1}}>
                {e.luogo}
              </div>
            </div>
            {/* Countdown */}
            <div style={{textAlign:"right",flexShrink:0}}>
              <div style={{fontSize:11,color:diff<=7?C.orange:C.textDim}}>
                {diff===0?"Oggi":diff===1?"Domani":`${diff}g`}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// â”€â”€â”€ ATTIVITÃ€ RECENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AttivitaFeed = ({ items }) => {
  const iconMap = { pagamento:"receipt",spesa:"down",allievo:"user",evento:"star" };
  const colorMap = { pagamento:C.green, spesa:C.red, allievo:C.gold, evento:C.purple };

  return (
    <div style={{display:"flex",flexDirection:"column",gap:1}}>
      {items.map((a,i)=>{
        const hex=colorMap[a.tipo]||C.textMuted;
        return (
          <div key={a.id} className="alert-row" style={{display:"flex",alignItems:"center",gap:12,
            padding:"10px 14px",borderRadius:9,transition:"background 0.12s",
            animationDelay:`${i*0.05}s`}}
            onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
            onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
            <div style={{width:30,height:30,borderRadius:8,display:"flex",alignItems:"center",
              justifyContent:"center",background:`${hex}15`,flexShrink:0}}>
              <Ic n={iconMap[a.tipo]} size={14} stroke={hex}/>
            </div>
            <div style={{flex:1,minWidth:0}}>
              <div style={{fontSize:12,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                {a.desc}
                {a.sogg && <span style={{color:C.textMuted,fontWeight:400}}> â€” {a.sogg}</span>}
              </div>
              <div style={{fontSize:11,color:C.textDim,marginTop:1}}>{a.quando}</div>
            </div>
            {a.importo!==null && (
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,
                color:a.segno>0?C.green:C.red,flexShrink:0}}>
                {a.segno>0?"+":"-"}{fmtD(a.importo)}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
};

// â”€â”€â”€ ALERT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AlertPanel = ({ allievi, lezioniOggi }) => {
  const morosi    = allievi.filter(a=>a.stato==="scaduto");
  const daConf    = lezioniOggi.filter(l=>!l.confermata);
  const sospesi   = allievi.filter(a=>a.stato==="sospeso");
  const alerts = [
    ...morosi.map(a=>({tipo:"scaduto", msg:`${a.name} â€” rate scadute`, hex:C.red, bg:C.redBg, bd:C.redBorder})),
    ...daConf.map(l=>({tipo:"lezione", msg:`${l.ora} ${l.allievo} â€” lezione da confermare`, hex:C.orange, bg:C.orangeBg, bd:C.orangeBorder})),
    ...sospesi.map(a=>({tipo:"sospeso",msg:`${a.name} â€” abbonamento sospeso`, hex:C.textMuted, bg:C.surface, bd:C.border})),
  ];
  if(alerts.length===0) return (
    <div style={{display:"flex",alignItems:"center",gap:10,padding:"14px 16px",
      background:C.greenBg,border:`1px solid ${C.greenBorder}`,borderRadius:10}}>
      <Ic n="check" size={15} stroke={C.green}/>
      <span style={{fontSize:13,color:C.green,fontWeight:500}}>Nessun alert â€” tutto in ordine</span>
    </div>
  );
  return (
    <div style={{display:"flex",flexDirection:"column",gap:6}}>
      {alerts.map((a,i)=>(
        <div key={i} className="alert-row" style={{display:"flex",alignItems:"center",gap:10,
          padding:"10px 14px",background:a.bg,border:`1px solid ${a.bd}`,borderRadius:9,
          animationDelay:`${i*0.06}s`}}>
          <Ic n="alert" size={14} stroke={a.hex}/>
          <span style={{fontSize:12,color:a.hex,fontWeight:500}}>{a.msg}</span>
        </div>
      ))}
    </div>
  );
};

// â”€â”€â”€ TOGGLE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ INPUT IMPOSTAZIONI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ MODALE IMPOSTAZIONI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PANNELLI_DEF = [
  {id:"kpi",       label:"KPI Cards",            desc:"Allievi, lezioni, entrate, uscite, saldo", icon:"chart",    sempre:true},
  {id:"lezioni",   label:"Lezioni di oggi",       desc:"Timeline con orari e stato",               icon:"calendar"},
  {id:"grafico",   label:"Andamento finanziario", desc:"Grafico mensile entrate/uscite",            icon:"chart"},
  {id:"pagamenti", label:"Stato pagamenti",       desc:"Donut con distribuzione allievi",           icon:"users"},
  {id:"eventi",    label:"Prossimi eventi",       desc:"Elenco eventi in calendario",               icon:"flag"},
  {id:"alert",     label:"Alert prioritari",      desc:"Morosi, lezioni da confermare",             icon:"alert"},
  {id:"attivita",  label:"AttivitÃ  recente",      desc:"Feed ultimi movimenti",                     icon:"clock"},
  {id:"azioni",    label:"Azioni rapide",         desc:"Shortcut ai flussi principali",             icon:"plus"},
];

const DASH_RUOLI = [
  {id:"admin",     label:"Amministratore", hex:C.gold,   desc:"Accesso completo + impostazioni"},
  {id:"direttore", label:"Direttore",      hex:C.purple, desc:"Dashboard completa, no impostazioni admin"},
  {id:"docente",   label:"Docente",        hex:C.teal,   desc:"Solo lezioni e repertorio"},
  {id:"segreteria",label:"Segreteria",     hex:C.blue,   desc:"Allievi e pagamenti"},
];

const SettingsDrawer = ({ open, onClose, panels, onPanels, config, onConfig, ruolo, onRuolo, anniScolastici:_anniScolasticiRaw, setAnniScolastici }) => {
  const anniScolastici = _anniScolasticiRaw || [];
  const [tab, setTab]     = useState("dashboard");
  const [draft, setDraft] = useState(config);
  const [logoMode, setLogoMode] = useState("icon"); // "icon" | "text" | "image"
  const isAdmin = ruolo==="admin";

  // Sync draft when config changes from outside
  useState(()=>setDraft(config),[config]);

  const setD = (k,v) => setDraft(p=>({...p,[k]:v}));

  const handleSave = () => {
    const annoAs = (anniScolastici||[]).find(a=>a.stato==="attivo");
    onConfig({...draft, annoInizioAttivo: annoAs?.annoInizio ?? draft.annoInizioAttivo});
    onClose();
  };

  if(!open) return null;

  return (
    <>
      {/* Overlay */}
      <div onClick={onClose} style={{position:"fixed",inset:0,zIndex:300,
        background:"rgba(0,0,0,0.7)",backdropFilter:"blur(3px)",animation:"fadeIn 0.2s ease"}}/>

      {/* Drawer */}
      <div style={{position:"fixed",top:0,right:0,bottom:0,zIndex:301,width:520,
        background:C.surface,borderLeft:`1px solid ${C.border}`,
        display:"flex",flexDirection:"column",animation:"slideDrawer 0.28s cubic-bezier(.4,0,.2,1)"}}>

        {/* Header */}
        <div style={{padding:"18px 22px",borderBottom:`1px solid ${C.border}`,
          display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <div style={{width:32,height:32,borderRadius:8,background:C.goldBg,
              display:"flex",alignItems:"center",justifyContent:"center"}}>
              <Ic n="settings" size={16} stroke={C.gold}/>
            </div>
            <div>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600}}>Impostazioni</div>
              <div style={{fontSize:11,color:C.textDim}}>Dashboard e configurazione sistema</div>
            </div>
          </div>
          <button onClick={onClose} style={{background:"none",border:"none",cursor:"pointer",
            color:C.textMuted,padding:6,display:"flex",borderRadius:6}}
            onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
            onMouseLeave={e=>e.currentTarget.style.background="none"}>
            <Ic n="x" size={18} stroke={C.textMuted}/>
          </button>
        </div>

        {/* Tabs */}
        <div style={{display:"flex",borderBottom:`1px solid ${C.border}`,flexShrink:0}}>
          {[
            ["dashboard","grid",    "Dashboard"],
            ...(isAdmin?[["admin","settings","Amministrazione"]]:  []),
          ].map(([v,ic,lbl])=>(
            <button key={v} onClick={()=>setTab(v)}
              style={{flex:1,padding:"12px 0",display:"flex",alignItems:"center",justifyContent:"center",
                gap:6,background:"none",border:"none",cursor:"pointer",fontSize:13,
                color:tab===v?C.gold:C.textMuted,fontFamily:"'DM Sans',sans-serif",
                borderBottom:`2px solid ${tab===v?C.gold:"transparent"}`,transition:"all 0.15s"}}>
              <Ic n={ic} size={13} stroke={tab===v?C.gold:C.textMuted}/>{lbl}
            </button>
          ))}
        </div>

        {/* Body */}
        <div style={{flex:1,overflow:"auto",padding:"20px 22px",display:"flex",flexDirection:"column",gap:20}}>

          {/* â”€â”€ TAB DASHBOARD â”€â”€ */}
          {tab==="dashboard" && (
            <>
              <div>
                <div style={{fontSize:13,fontWeight:500,marginBottom:4}}>Pannelli visibili</div>
                <div style={{fontSize:12,color:C.textDim,marginBottom:14}}>
                  Seleziona quali sezioni mostrare nella tua dashboard. Le KPI card sono sempre visibili.
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:6}}>
                  {PANNELLI_DEF.map(p=>{
                    const on = panels[p.id]!==false;
                    return (
                      <div key={p.id}
                        style={{display:"flex",alignItems:"center",gap:12,padding:"12px 14px",
                          borderRadius:10,border:`1px solid ${on&&!p.sempre?C.goldDim:C.border}`,
                          background:on&&!p.sempre?C.goldBg:C.bg,transition:"all 0.15s",
                          opacity:p.sempre?0.6:1}}>
                        <div style={{width:32,height:32,borderRadius:8,
                          background:on?`${C.gold}18`:C.surface,
                          display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                          <Ic n={p.icon} size={15} stroke={on?C.gold:C.textDim}/>
                        </div>
                        <div style={{flex:1}}>
                          <div style={{fontSize:13,fontWeight:500,color:on?C.text:C.textMuted}}>{p.label}</div>
                          <div style={{fontSize:11,color:C.textDim,marginTop:1}}>{p.desc}</div>
                        </div>
                        {p.sempre
                          ? <span style={{fontSize:10,color:C.textDim,letterSpacing:"0.06em"}}>FISSO</span>
                          : <Toggle value={on} onChange={v=>onPanels(prev=>({...prev,[p.id]:v}))}/>
                        }
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Ruolo simulazione */}
              <div>
                <div style={{fontSize:13,fontWeight:500,marginBottom:4}}>Ruolo corrente</div>
                <div style={{fontSize:12,color:C.textDim,marginBottom:12}}>
                  Simula la vista per ruolo diverso. In produzione il ruolo sarÃ  assegnato dall'amministratore.
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}} className="form-2col">
                  {DASH_RUOLI.map(r=>(
                    <button key={r.id} onClick={()=>onRuolo(r.id)}
                      style={{padding:"11px 14px",borderRadius:10,textAlign:"left",cursor:"pointer",
                        fontFamily:"'DM Sans',sans-serif",transition:"all 0.15s",
                        background:ruolo===r.id?`${r.hex}18`:C.bg,
                        border:`1.5px solid ${ruolo===r.id?r.hex:C.border}`}}>
                      <div style={{fontSize:13,fontWeight:500,color:ruolo===r.id?r.hex:C.text}}>{r.label}</div>
                      <div style={{fontSize:10,color:C.textDim,marginTop:3}}>{r.desc}</div>
                    </button>
                  ))}
                </div>
              </div>
            </>
          )}

          {/* â”€â”€ TAB AMMINISTRAZIONE â”€â”€ */}
          {tab==="admin" && isAdmin && (
            <>
              {/* IdentitÃ  */}
              <section>
                <div style={{fontSize:11,color:C.gold,letterSpacing:"0.1em",textTransform:"uppercase",
                  marginBottom:12,display:"flex",alignItems:"center",gap:6}}>
                  <div style={{height:1,width:16,background:C.goldDim}}/>
                  IdentitÃ  scuola
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:12}}>
                  <SField label="Nome associazione / scuola *"
                    value={draft.nomeScuola} onChange={e=>setD("nomeScuola",e.target.value)}
                    placeholder="Es. Accademia Musicale Roma"/>
                  <SField label="Sottotitolo / tipo ente"
                    value={draft.tipoEnte} onChange={e=>setD("tipoEnte",e.target.value)}
                    placeholder="Es. Associazione Musicale APS"/>
                  {/* Logo */}
                  <div>
                    <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",
                      textTransform:"uppercase",display:"block",marginBottom:8}}>Logo</label>
                    <div style={{display:"flex",gap:6,marginBottom:10}}>
                      {[["icon","Icona"],["text","Iniziali"],["image","Immagine URL"]].map(([v,l])=>(
                        <button key={v} onClick={()=>setLogoMode(v)}
                          style={{flex:1,padding:"7px 0",borderRadius:7,fontSize:12,cursor:"pointer",
                            fontFamily:"'DM Sans',sans-serif",
                            background:logoMode===v?C.goldBg:C.bg,
                            color:logoMode===v?C.gold:C.textMuted,
                            border:`1px solid ${logoMode===v?C.goldDim:C.border}`}}>{l}</button>
                      ))}
                    </div>
                    {logoMode==="icon" && (
                      <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                        {["music","star","flag","euro2","users","bell"].map(ic=>(
                          <button key={ic} onClick={()=>setD("logoIcon",ic)}
                            style={{width:40,height:40,borderRadius:9,cursor:"pointer",
                              display:"flex",alignItems:"center",justifyContent:"center",
                              background:draft.logoIcon===ic?C.goldBg:C.bg,
                              border:`1.5px solid ${draft.logoIcon===ic?C.gold:C.border}`}}>
                            <Ic n={ic} size={18} stroke={draft.logoIcon===ic?C.gold:C.textMuted}/>
                          </button>
                        ))}
                        {/* Colore logo */}
                        <div style={{display:"flex",gap:6,marginLeft:4,alignItems:"center"}}>
                          {[C.gold,C.teal,C.purple,C.blue,C.green,C.red].map(col=>(
                            <button key={col} onClick={()=>setD("logoColor",col)}
                              style={{width:22,height:22,borderRadius:"50%",cursor:"pointer",
                                background:col,border:`2px solid ${draft.logoColor===col?"#fff":col}`,
                                transition:"transform 0.1s",transform:draft.logoColor===col?"scale(1.2)":"scale(1)"}}/>
                          ))}
                        </div>
                      </div>
                    )}
                    {logoMode==="text" && (
                      <SField label="Testo iniziali (max 2 caratteri)"
                        value={draft.logoText} onChange={e=>setD("logoText",e.target.value.slice(0,2).toUpperCase())}
                        placeholder="AM" maxLength={2}/>
                    )}
                    {logoMode==="image" && (
                      <SField label="URL immagine logo"
                        value={draft.logoUrl} onChange={e=>setD("logoUrl",e.target.value)}
                        placeholder="https://..."/>
                    )}
                  </div>
                </div>
              </section>

              {/* Dati fiscali / ricevute */}
              <section>
                <div style={{fontSize:11,color:C.gold,letterSpacing:"0.1em",textTransform:"uppercase",
                  marginBottom:12,display:"flex",alignItems:"center",gap:6}}>
                  <div style={{height:1,width:16,background:C.goldDim}}/>
                  Dati ricevute e fatture
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:12}}>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}} className="form-2col">
                    <SField label="Codice fiscale / P.IVA"
                      value={draft.codiceFiscale} onChange={e=>setD("codiceFiscale",e.target.value)}
                      placeholder="00000000000"/>
                    <SField label="Codice SDI / PEC"
                      value={draft.sdi} onChange={e=>setD("sdi",e.target.value)}
                      placeholder="XXXXXXX o PEC"/>
                  </div>
                  <SField label="Sede legale / indirizzo"
                    value={draft.indirizzo} onChange={e=>setD("indirizzo",e.target.value)}
                    placeholder="Via della Musica 1, 00100 Roma (RM)"/>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}} className="form-2col">
                    <SField label="Telefono"
                      value={draft.telefono} onChange={e=>setD("telefono",e.target.value)}
                      placeholder="+39 06 1234567"/>
                    <SField label="Email"
                      value={draft.email} onChange={e=>setD("email",e.target.value)}
                      placeholder="info@accademia.it"/>
                  </div>
                  <SField label="IBAN bonifici"
                    value={draft.iban} onChange={e=>setD("iban",e.target.value)}
                    placeholder="IT00 X000 0000 0000 0000 0000 000"/>
                  <SField label="Nota a piÃ¨ di ricevuta"
                    value={draft.notaRicevuta} onChange={e=>setD("notaRicevuta",e.target.value)}
                    placeholder="Es. Associazione no-profit ex art. 148 TUIR"/>
                </div>
              </section>

              {/* Anno scolastico */}
              <section>
                <div style={{fontSize:11,color:C.gold,letterSpacing:"0.1em",textTransform:"uppercase",
                  marginBottom:12,display:"flex",alignItems:"center",gap:6}}>
                  <div style={{height:1,width:16,background:C.goldDim}}/>
                  Anno scolastico e calendario
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:12}}>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}} className="form-2col">
                    <SField label="Anno scolastico"
                      value={draft.annoScolastico} onChange={e=>setD("annoScolastico",e.target.value)}
                      placeholder="2024/2025"/>
                    <SField label="Inizio anno (data)"
                      type="date" value={draft.inizioAnno} onChange={e=>setD("inizioAnno",e.target.value)}/>
                  </div>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}} className="form-2col">
                    <SField label="Fine anno (data)"
                      type="date" value={draft.fineAnno} onChange={e=>setD("fineAnno",e.target.value)}/>
                    <SField label="Giorno saggio finale"
                      type="date" value={draft.dataSaggio} onChange={e=>setD("dataSaggio",e.target.value)}/>
                  </div>
                  <div>
                    <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",
                      display:"block",marginBottom:8}}>Mesi attivi (lezioni)</label>
                    <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>
                      {MESI.map((m,i)=>{
                        const on=(draft.mesiAttivi||[]).includes(i);
                        return (
                          <button key={i} onClick={()=>setD("mesiAttivi",
                            on?(draft.mesiAttivi||[]).filter(x=>x!==i):[...(draft.mesiAttivi||[]),i].sort())}
                            style={{padding:"5px 10px",borderRadius:6,fontSize:11,cursor:"pointer",
                              fontFamily:"'DM Sans',sans-serif",background:on?C.goldBg:C.bg,
                              color:on?C.gold:C.textDim,border:`1px solid ${on?C.goldDim:C.border}`}}>
                            {m.slice(0,3)}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </section>

              {/* Anni Scolastici */}
              <section>
                <div style={{fontSize:11,color:C.gold,letterSpacing:"0.1em",textTransform:"uppercase",
                  marginBottom:12,display:"flex",alignItems:"center",gap:6}}>
                  <div style={{height:1,width:16,background:C.goldDim}}/>
                  Storico anni scolastici
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:8}}>
                  {/* Lista anni */}
                  {anniScolastici.slice().sort((a,b)=>b.annoInizio-a.annoInizio).map(as=>{
                    const isAttivo = as.stato==="attivo";
                    return (
                      <div key={as.id} style={{background:C.bg,border:`1px solid ${isAttivo?C.gold:C.border}`,
                        borderRadius:10,padding:"12px 16px",
                        borderLeft:`3px solid ${isAttivo?C.gold:C.border}`}}>
                        <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:4}}>
                          <span style={{fontSize:14,fontWeight:600,color:isAttivo?C.gold:C.text}}>{as.label}</span>
                          {isAttivo && (
                            <span style={{fontSize:10,background:C.goldBg,color:C.gold,
                              border:`1px solid ${C.goldDim}`,borderRadius:4,padding:"1px 7px",
                              letterSpacing:"0.08em",textTransform:"uppercase"}}>Attivo</span>
                          )}
                          {as.stato==="archiviato" && (
                            <span style={{fontSize:10,background:C.bg,color:C.textDim,
                              border:`1px solid ${C.border}`,borderRadius:4,padding:"1px 7px",
                              letterSpacing:"0.08em",textTransform:"uppercase"}}>Archiviato</span>
                          )}
                        </div>
                        {as.note && <div style={{fontSize:11,color:C.textMuted,marginBottom:8}}>{as.note}</div>}
                        <div style={{display:"flex",gap:8}}>
                          {!isAttivo && (
                            <button onClick={()=>{
                              setAnniScolastici(p=>p.map(a=>({...a,stato:a.id===as.id?"attivo":"archiviato"})));
                              setConfig(p=>({...p,annoScolastico:as.label,annoInizioAttivo:as.annoInizio}));
                              setD("annoScolastico",as.label);
                            }}
                              style={{fontSize:11,padding:"3px 10px",borderRadius:6,cursor:"pointer",
                                background:C.goldBg,color:C.gold,border:`1px solid ${C.goldDim}`,
                                fontFamily:"'DM Sans',sans-serif"}}>
                              Imposta attivo
                            </button>
                          )}
                          <button onClick={()=>setAnniScolastici(p=>p.filter(a=>a.id!==as.id))}
                            disabled={isAttivo}
                            style={{fontSize:11,padding:"3px 10px",borderRadius:6,
                              cursor:isAttivo?"not-allowed":"pointer",opacity:isAttivo?0.3:1,
                              background:C.redBg,color:C.red,border:`1px solid ${C.redBorder}`,
                              fontFamily:"'DM Sans',sans-serif"}}>
                            Rimuovi
                          </button>
                        </div>
                      </div>
                    );
                  })}
                  {/* Nuovo anno scolastico */}
                  {(() => {
                    const attivoAs = anniScolastici.find(a=>a.stato==="attivo");
                    const nextAnno = attivoAs ? attivoAs.annoInizio+1 : new Date().getFullYear();
                    const nextLabel = `${nextAnno}/${nextAnno+1}`;
                    const esiste = anniScolastici.some(a=>a.annoInizio===nextAnno);
                    return !esiste ? (
                      <button onClick={()=>{
                        const newAs = {
                          id:`as-${nextAnno}`, label:nextLabel, annoInizio:nextAnno, stato:"archiviato", note:""
                        };
                        setAnniScolastici(p=>[...p, newAs]);
                      }}
                        style={{display:"flex",alignItems:"center",justifyContent:"center",gap:8,
                          padding:"10px 16px",borderRadius:10,cursor:"pointer",
                          background:"transparent",color:C.textMuted,border:`1px dashed ${C.border}`,
                          fontSize:12,fontFamily:"'DM Sans',sans-serif",width:"100%"}}>
                        <Ic n="plus" size={13} stroke={C.textMuted}/>
                        Crea anno {nextLabel}
                      </button>
                    ) : null;
                  })()}
                </div>
              </section>

              {/* Numerazione ricevute */}
              <section>
                <div style={{fontSize:11,color:C.gold,letterSpacing:"0.1em",textTransform:"uppercase",
                  marginBottom:12,display:"flex",alignItems:"center",gap:6}}>
                  <div style={{height:1,width:16,background:C.goldDim}}/>
                  Numerazione documenti
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}} className="form-2col">
                  <SField label="Prossimo numero ricevuta"
                    type="number" value={draft.progressivoRicevute}
                    onChange={e=>setD("progressivoRicevute",Number(e.target.value))}/>
                  <div style={{display:"flex",alignItems:"center",paddingTop:20}}>
                    <span style={{fontSize:12,color:C.textDim}}>
                      Formato: <span style={{color:C.gold,fontFamily:"'Cormorant Garamond',serif",fontSize:14}}>
                        {String(draft.progressivoRicevute||1).padStart(3,"0")}/{new Date().getFullYear()}
                      </span>
                    </span>
                  </div>
                </div>
              </section>
            </>
          )}

          {/* Messaggio non-admin */}
          {tab==="admin" && !isAdmin && (
            <div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",
              height:"100%",gap:14,padding:"40px 0",textAlign:"center"}}>
              <div style={{width:56,height:56,borderRadius:14,background:C.redBg,
                border:`1px solid ${C.redBorder}`,display:"flex",alignItems:"center",justifyContent:"center"}}>
                <Ic n="alert" size={24} stroke={C.red}/>
              </div>
              <div>
                <div style={{fontSize:16,fontWeight:500,marginBottom:6}}>Accesso riservato</div>
                <div style={{fontSize:13,color:C.textMuted}}>
                  Solo gli utenti con ruolo <strong style={{color:C.gold}}>Amministratore</strong> possono
                  modificare la configurazione del sistema.
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div style={{padding:"14px 22px",borderTop:`1px solid ${C.border}`,
          display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
          <div style={{fontSize:11,color:C.textDim}}>
            Ruolo: <span style={{color:DASH_RUOLI.find(r=>r.id===ruolo)?.hex||C.textMuted,fontWeight:500}}>
              {DASH_RUOLI.find(r=>r.id===ruolo)?.label}
            </span>
          </div>
          <div style={{display:"flex",gap:8}}>
            <button onClick={onClose}
              style={{padding:"8px 16px",background:"none",border:`1px solid ${C.border}`,borderRadius:8,
                color:C.textMuted,cursor:"pointer",fontSize:13,fontFamily:"'DM Sans',sans-serif"}}>
              Annulla
            </button>
            <button onClick={handleSave}
              style={{padding:"8px 18px",background:C.gold,border:"none",borderRadius:8,
                color:C.bg,cursor:"pointer",fontSize:13,fontFamily:"'DM Sans',sans-serif",fontWeight:500,
                display:"flex",alignItems:"center",gap:6}}>
              <Ic n="check" size={13} stroke={C.bg}/>Salva
            </button>
          </div>
        </div>
      </div>
    </>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP PRINCIPALE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Anno scolastico attivo (annoInizio = anno di settembre)
const annoScolasticoAttivo = oggi.getMonth()>=8 ? oggi.getFullYear() : oggi.getFullYear()-1;

const INIT_ANNI_SCOLASTICI = [
  { id:"as-2022", label:"2022/2023", annoInizio:2022, stato:"archiviato",
    note:"Anno regolare. Saggio: 10 giugno 2023." },
  { id:"as-2023", label:"2023/2024", annoInizio:2023, stato:"archiviato",
    note:"Anno con masterclass internazionale. Saggio: 8 giugno 2024." },
  { id:"as-2024", label:"2024/2025", annoInizio:2024, stato:"attivo",
    note:"Anno corrente." },
];

const CONFIG_DEFAULT = {
  nomeScuola:"Accademia Musicale", tipoEnte:"Sistema gestionale",
  logoIcon:"music", logoColor:C.gold, logoText:"AM", logoUrl:"",
  codiceFiscale:"", sdi:"", indirizzo:"Via della Musica 1, 00100 Roma (RM)",
  telefono:"", email:"", iban:"",
  notaRicevuta:"Associazione no-profit â€” ricevuta non fiscale",
  annoScolastico:"2024/2025",
  annoInizioAttivo: annoScolasticoAttivo,
  inizioAnno:`${ANNO}-09-01`, fineAnno:`${ANNO+1}-06-30`, dataSaggio:`${ANNO+1}-06-07`,
  mesiAttivi:[0,1,2,3,4,8,9,10,11],
  progressivoRicevute:29,
};

const DashboardView = ({ appUser, onNavigate, config:propConfig, setConfig:propSetConfig, anniScolastici:propAnni, setAnniScolastici:propSetAnni }) => {
  const [settingsOpen, setSettingsOpen] = useState(false);
    const [panels,  setPanels]  = useState({});  // pannelli visibili (default = tutti on)
    const [_config,  _setConfig]  = useState(CONFIG_DEFAULT);
    const [_anni,    _setAnni]    = useState(INIT_ANNI_SCOLASTICI);
    const config         = propConfig   ?? _config;
    const setConfig      = propSetConfig ?? _setConfig;
    const anniScolastici = propAnni     ?? _anni;
    const setAnniScolastici = propSetAnni ?? _setAnni;
    const [ruolo,   setRuolo]   = useState("admin");
  
    const isVisible = id => panels[id] !== false;
  
    // Calcoli KPI
    const entrMese = useMemo(()=>{
      const base=[120,100,120,100,115].reduce((t,v)=>t+v,0);
      const altri=1570-base;
      return base+altri;
    },[]);
    const uscMese    = 3300;
    const saldoAnno  = FIN_MENSILE.reduce((t,d)=>t+(d.entr-d.usc),0);
    const lezioniSettimana = 34;
    const allieviAttivi    = ALLIEVI.filter(a=>a.stato!=="sospeso").length;
    const lezioniOggi      = LEZIONI_OGGI.length;
    const oraNum  = t => { const [h,m]=t.split(":").map(Number); return h*60+m; };
    const nowMins = oggi.getHours()*60+oggi.getMinutes();
    const lezComplete = LEZIONI_OGGI.filter(l=>oraNum(l.ora)+l.durata<=nowMins).length;
    const morosi  = ALLIEVI.filter(a=>a.stato==="scaduto").length;
  
    // Render logo navbar
    const LogoMark = () => {
      if(config.logoUrl) return (
        <img src={config.logoUrl} alt="logo" style={{width:28,height:28,borderRadius:7,objectFit:"cover"}}
          onError={e=>e.target.style.display="none"}/>
      );
      if(config.logoText) return (
        <div style={{width:28,height:28,borderRadius:7,background:config.logoColor||C.gold,
          display:"flex",alignItems:"center",justifyContent:"center",
          fontFamily:"'Cormorant Garamond',serif",fontSize:13,fontWeight:600,color:C.bg}}>
          {config.logoText}
        </div>
      );
      return (
        <div style={{width:28,height:28,borderRadius:7,background:config.logoColor||C.gold,
          display:"flex",alignItems:"center",justifyContent:"center"}}>
          <Ic n={config.logoIcon||"music"} size={14} stroke={C.bg}/>
        </div>
      );
    };
  
    return (
      <>
        <style>{G+`@keyframes slideDrawer{from{transform:translateX(100%)}to{transform:translateX(0)}}`}</style>

```
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column"}}>

      {/* â”€â”€ NAVBAR â”€â”€ */}
      <header style={{background:C.surface,borderBottom:`1px solid ${C.border}`,
        padding:"0 28px",display:"flex",alignItems:"center",gap:0,flexShrink:0,height:56}}>
        <div style={{display:"flex",alignItems:"center",gap:10,height:"100%"}}>
          <LogoMark/>
          <div>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,lineHeight:1}}>
              {config.nomeScuola}
            </div>
            <div style={{fontSize:9,color:C.textDim,letterSpacing:"0.12em",textTransform:"uppercase"}}>
              {config.tipoEnte}
            </div>
          </div>
        </div>
        <div style={{marginLeft:"auto",display:"flex",alignItems:"center",gap:8}}>
          <button className="nav-btn" style={{background:"none",border:`1px solid ${C.border}`,
            borderRadius:8,padding:"6px 8px",cursor:"pointer",display:"flex",color:C.textMuted}}>
            <Ic n="bell" size={15} stroke={C.textMuted}/>
          </button>
          {/* Settings */}
          <button onClick={()=>setSettingsOpen(true)} className="nav-btn"
            style={{background:settingsOpen?C.goldBg:"none",
              border:`1px solid ${settingsOpen?C.goldDim:C.border}`,
              borderRadius:8,padding:"6px 8px",cursor:"pointer",display:"flex",
              color:settingsOpen?C.gold:C.textMuted,transition:"all 0.15s"}}>
            <Ic n="settings" size={15} stroke={settingsOpen?C.gold:C.textMuted}/>
          </button>
          {/* Ruolo badge */}
          <div style={{display:"flex",alignItems:"center",gap:8,padding:"4px 10px",
            borderRadius:8,border:`1px solid ${DASH_RUOLI.find(r=>r.id===ruolo)?.hex+"40"}`,
            background:`${DASH_RUOLI.find(r=>r.id===ruolo)?.hex}10`}}>
            <div style={{width:7,height:7,borderRadius:"50%",
              background:DASH_RUOLI.find(r=>r.id===ruolo)?.hex}}/>
            <span style={{fontSize:11,color:DASH_RUOLI.find(r=>r.id===ruolo)?.hex,fontWeight:500}}>
              {DASH_RUOLI.find(r=>r.id===ruolo)?.label}
            </span>
          </div>
        </div>
      </header>

      {/* â”€â”€ HERO HEADER â”€â”€ */}
      <div style={{background:`linear-gradient(135deg, ${C.surface} 0%, ${C.bg} 100%)`,
        borderBottom:`1px solid ${C.border}`,padding:"16px 20px",
        display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
        <div style={{animation:"fadeUp 0.4s ease both"}}>
          <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:30,fontWeight:300,letterSpacing:"0.02em",lineHeight:1}}>
            Buongiorno, <span style={{fontWeight:600,color:C.gold}}>
              {ruolo==="admin"?"Amministratore":ruolo==="direttore"?"Direttore":ruolo==="docente"?"Docente":"Segreteria"}
            </span>
          </h1>
          <p style={{fontSize:13,color:C.textMuted,marginTop:6}}>
            {config.annoScolastico} Â· {lezioniOggi} lezioni oggi Â· {lezComplete} completate Â· {lezioniOggi-lezComplete} rimanenti
          </p>
          <div style={{marginTop:10,width:220}}>
            <div style={{height:4,background:C.border,borderRadius:2,overflow:"hidden"}}>
              <div style={{height:"100%",borderRadius:2,background:C.gold,
                width:`${lezioniOggi>0?(lezComplete/lezioniOggi*100):0}%`,transition:"width 0.8s ease"}}/>
            </div>
          </div>
        </div>
        <LiveClock/>
      </div>

      {/* â”€â”€ BODY â”€â”€ */}
      <div style={{flex:1,padding:"16px 20px",display:"flex",flexDirection:"column",gap:16,overflow:"auto"}}>

        {/* â”€â”€ RIGA 1: KPI â”€â”€ */}
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:12}}>
          <KpiCard icon="users"    label="Allievi attivi"  value={allieviAttivi} sub={`${ALLIEVI.length} totali`} hex={C.gold}/>
          <KpiCard icon="calendar" label="Lezioni oggi"    value={lezioniOggi}   sub={`${lezioniSettimana} questa settimana`} hex={C.teal}/>
          <KpiCard icon="up"       label="Entrate mese"    value={fmt(entrMese)} hex={C.green} trend={+8}/>
          <KpiCard icon="down"     label="Uscite mese"     value={fmt(uscMese)}  hex={C.red}   trend={+12}/>
          <KpiCard icon="chart"    label={`Saldo ${ANNO}`} value={fmt(saldoAnno)} hex={saldoAnno>=0?C.green:C.red}/>
        </div>

        {/* â”€â”€ RIGA 2: AZIONI RAPIDE (full width) â”€â”€ */}
        {isVisible("azioni") && (
          <div className="section" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
            <div style={{padding:"13px 18px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
              <Ic n="plus" size={14} stroke={C.gold}/>
              <span style={{fontSize:12,fontWeight:500,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>Azioni rapide</span>
            </div>
            <div style={{padding:"14px 16px",display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:10}}>
              {[
                {icon:"receipt",  label:"Registra pagamento",    hex:C.green,  bg:C.greenBg,  bd:C.greenBorder,  nav:"contabilita"},
                {icon:"calendar", label:"Aggiungi lezione",       hex:C.teal,   bg:C.tealBg,   bd:C.tealBorder,   nav:"calendario"},
                {icon:"user",     label:"Nuovo allievo",          hex:C.gold,   bg:C.goldBg,   bd:C.goldDim,      nav:"allievi"},
                {icon:"down",     label:"Registra spesa",         hex:C.red,    bg:C.redBg,    bd:C.redBorder,    nav:"contabilita"},
                
                {icon:"music",    label:"Vai al repertorio",      hex:C.blue,   bg:C.blueBg,   bd:C.blueBorder,   nav:"repertorio"},
                {icon:"flag",     label:"Crea evento/concerto",   hex:C.purple, bg:C.purpleBg, bd:C.purpleBorder, nav:"concerti"},
              ].map(a=>(
                <button key={a.label} onClick={()=>onNavigate(a.nav)}
                  className="quick-action"
                  style={{display:"flex",alignItems:"center",gap:10,padding:"12px 16px",
                    background:a.bg,border:`1px solid ${a.bd}`,borderRadius:10,
                    cursor:"pointer",fontFamily:"'DM Sans',sans-serif",textAlign:"left",
                    width:"100%",transition:"all 0.15s"}}
                  onMouseEnter={e=>{e.currentTarget.style.filter="brightness(1.15)";e.currentTarget.style.transform="translateY(-1px)";}}
                  onMouseLeave={e=>{e.currentTarget.style.filter="";e.currentTarget.style.transform="";}}>
                  <div style={{width:32,height:32,borderRadius:8,background:`${a.hex}20`,border:`1px solid ${a.bd}`,
                    display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                    <Ic n={a.icon} size={16} stroke={a.hex}/>
                  </div>
                  <span style={{fontSize:13,color:a.hex,fontWeight:500}}>{a.label}</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* â”€â”€ RIGA 3: LEZIONI + GRAFICO â”€â”€ */}
        {(isVisible("lezioni")||isVisible("grafico")) && (
          <div style={{display:"grid",gap:16,gridTemplateColumns:"repeat(auto-fit,minmax(300px,1fr))"}}>

            {/* Lezioni oggi */}
            {isVisible("lezioni") && (
              <div className="section" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
                <div style={{padding:"14px 18px",borderBottom:`1px solid ${C.border}`,
                  display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <Ic n="calendar" size={14} stroke={C.gold}/>
                    <span style={{fontSize:12,fontWeight:500,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>Lezioni di oggi</span>
                  </div>
                  <div style={{display:"flex",alignItems:"center",gap:6}}>
                    <span style={{fontSize:11,color:C.textDim}}>{lezComplete}/{lezioniOggi}</span>
                    <div style={{width:48,height:4,background:C.border,borderRadius:2,overflow:"hidden"}}>
                      <div style={{height:"100%",width:`${lezioniOggi>0?lezComplete/lezioniOggi*100:0}%`,background:C.gold,borderRadius:2}}/>
                    </div>
                  </div>
                </div>
                <div style={{padding:14,maxHeight:380,overflow:"auto"}}>
                  <LessonTimeline lezioni={LEZIONI_OGGI}/>
                </div>
                <div style={{padding:"10px 18px",borderTop:`1px solid ${C.border}`}}>
                  <button onClick={()=>onNavigate("calendario")}
                    style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:C.gold,fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:5}}>
                    <Ic n="calendar" size={12} stroke={C.gold}/>Apri calendario â†’
                  </button>
                </div>
              </div>
            )}

            {/* Grafico andamento */}
            {isVisible("grafico") && (
              <div className="section" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
                <div style={{padding:"14px 18px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
                  <Ic n="chart" size={14} stroke={C.gold}/>
                  <span style={{fontSize:12,fontWeight:500,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>Andamento {ANNO}</span>
                </div>
                <div style={{padding:"18px 18px 12px"}}>
                  <MiniChart dati={FIN_MENSILE}/>
                  <div style={{marginTop:16,display:"flex",justifyContent:"space-between",alignItems:"center",paddingTop:12,borderTop:`1px solid ${C.border}`}}>
                    {[{lbl:"Entrate",hex:C.green},{lbl:"Uscite",hex:C.red}].map(x=>(
                      <div key={x.lbl} style={{display:"flex",alignItems:"center",gap:5}}>
                        <div style={{width:8,height:8,borderRadius:2,background:x.hex}}/>
                        <span style={{fontSize:10,color:C.textMuted}}>{x.lbl}</span>
                      </div>
                    ))}
                  </div>
                  <div style={{marginTop:14,display:"flex",flexDirection:"column",gap:8}}>
                    {[
                      {lbl:"Tot. entrate",val:fmt(FIN_MENSILE.reduce((t,d)=>t+d.entr,0)),hex:C.green},
                      {lbl:"Tot. uscite", val:fmt(FIN_MENSILE.reduce((t,d)=>t+d.usc,0)), hex:C.red},
                      {lbl:"Saldo",       val:fmt(saldoAnno), hex:saldoAnno>=0?C.green:C.red},
                    ].map(x=>(
                      <div key={x.lbl} style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                        <span style={{fontSize:11,color:C.textDim}}>{x.lbl}</span>
                        <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:16,fontWeight:600,color:x.hex}}>{x.val}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div style={{padding:"10px 18px",borderTop:`1px solid ${C.border}`}}>
                  <button onClick={()=>onNavigate("contabilita")}
                    style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:C.gold,fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:5}}>
                    <Ic n="euro" size={12} stroke={C.gold}/>Apri contabilitÃ  â†’
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        {/* â”€â”€ RIGA 4: PAGAMENTI + EVENTI â”€â”€ */}
        {(isVisible("pagamenti")||isVisible("eventi")) && (
          <div style={{display:"grid",gap:16,gridTemplateColumns:"repeat(auto-fit,minmax(300px,1fr))"}}>
            {isVisible("pagamenti") && (
              <div className="section" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
                <div style={{padding:"14px 18px",borderBottom:`1px solid ${C.border}`,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <Ic n="users" size={14} stroke={C.gold}/>
                    <span style={{fontSize:12,fontWeight:500,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>Stato pagamenti</span>
                  </div>
                  <button onClick={()=>onNavigate("allievi")}
                    style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:C.gold,fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:4}}>
                    Vedi allievi â†’
                  </button>
                </div>
                <div style={{padding:"16px 18px"}}>
                  <StatoAllievi allievi={ALLIEVI}/>
                </div>
              </div>
            )}
            {isVisible("eventi") && (
              <div className="section" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
                <div style={{padding:"14px 18px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
                  <Ic n="flag" size={14} stroke={C.gold}/>
                  <span style={{fontSize:12,fontWeight:500,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>Prossimi eventi</span>
                </div>
                <div style={{padding:14}}>
                  <EventiCard eventi={PROSSIMI_EVENTI}/>
                </div>
              </div>
            )}
          </div>
        )}

        {/* â”€â”€ RIGA 5: ALERT + ATTIVITÃ€ â”€â”€ */}
        {(isVisible("alert")||isVisible("attivita")) && (
          <div style={{display:"grid",gap:16,gridTemplateColumns:"repeat(auto-fit,minmax(300px,1fr))"}}>
            {isVisible("alert") && (
              <div className="section" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
                <div style={{padding:"14px 18px",borderBottom:`1px solid ${C.border}`,
                  display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <Ic n="alert" size={14} stroke={C.red}/>
                    <span style={{fontSize:12,fontWeight:500,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>Alert prioritari</span>
                  </div>
                  {morosi>0 && (
                    <span style={{background:C.redBg,color:C.red,border:`1px solid ${C.redBorder}`,
                      borderRadius:4,padding:"2px 8px",fontSize:10,fontWeight:700}}>
                      {morosi} critici
                    </span>
                  )}
                </div>
                <div style={{padding:14}}>
                  <AlertPanel allievi={ALLIEVI} lezioniOggi={LEZIONI_OGGI}/>
                </div>
                <div style={{padding:"10px 18px",borderTop:`1px solid ${C.border}`}}>
                  <button onClick={()=>onNavigate("allievi")}
                    style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:C.gold,fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:5}}>
                    <Ic n="users" size={12} stroke={C.gold}/>Gestisci allievi â†’
                  </button>
                </div>
              </div>
            )}
            {isVisible("attivita") && (
              <div className="section" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
                <div style={{padding:"14px 18px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
                  <Ic n="clock" size={14} stroke={C.gold}/>
                  <span style={{fontSize:12,fontWeight:500,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>AttivitÃ  recente</span>
                </div>
                <div style={{padding:"6px 4px"}}>
                  <AttivitaFeed items={ATTIVITA_RECENTE}/>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Footer */}
        <div style={{paddingBottom:8,textAlign:"center"}}>
          <span style={{fontSize:10,color:C.textDim,letterSpacing:"0.1em"}}>
            {config.nomeScuola.toUpperCase()} Â· SISTEMA GESTIONALE Â· {config.annoScolastico}
          </span>
        </div>
      </div>
    </div>

    <SettingsDrawer
      open={settingsOpen}
      onClose={()=>setSettingsOpen(false)}
      anniScolastici={anniScolastici}
      setAnniScolastici={setAnniScolastici}
      panels={panels}
      onPanels={setPanels}
      config={config}
      onConfig={setConfig}
      ruolo={ruolo}
      onRuolo={setRuolo}
    />
  </>
);
```

};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ANAGRAFICA ALLIEVI

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ DATI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INSTRUMENTS = [â€œPianoforteâ€,â€œChitarraâ€,â€œViolinoâ€,â€œFlautoâ€,â€œBatteriaâ€,â€œSaxofonoâ€,â€œTrombaâ€,â€œBassoâ€,â€œCantoâ€,â€œClarinettoâ€];
const TEACHERS    = [â€œProf. Rossiâ€,â€œProf. Bianchiâ€,â€œProf. Verdeâ€,â€œProf. Marinoâ€];
const LEVELS      = [â€œPrincipianteâ€,â€œElementareâ€,â€œIntermedioâ€,â€œAvanzatoâ€,â€œProfessionaleâ€];
const INS_COLORS  = { Pianoforte:C.gold, Chitarra:â€#4ade80â€, Violino:â€#60a5faâ€, Flauto:â€#c084fcâ€, Batteria:â€#fb923câ€, Saxofono:â€#f472b6â€, Tromba:â€#34d399â€, Basso:â€#a78bfaâ€, Canto:â€#fbbf24â€, Clarinetto:â€#2dd4bfâ€ };

const INIT_COURSES = [
{ id:â€œc1â€,  name:â€œPianoforteâ€,        type:â€œindividualeâ€, description:â€œLezione individuale di pianoforte classico e modernoâ€,       docenti:[â€œd1â€] },
{ id:â€œc2â€,  name:â€œChitarraâ€,          type:â€œindividualeâ€, description:â€œLezione individuale di chitarra classica, acustica ed elettricaâ€, docenti:[â€œd2â€] },
{ id:â€œc3â€,  name:â€œViolinoâ€,           type:â€œindividualeâ€, description:â€œLezione individuale di violino classicoâ€,                    docenti:[â€œd1â€] },
{ id:â€œc4â€,  name:â€œFlautoâ€,            type:â€œindividualeâ€, description:â€œLezione individuale di flauto traversoâ€,                    docenti:[â€œd2â€] },
{ id:â€œc5â€,  name:â€œBatteriaâ€,          type:â€œindividualeâ€, description:â€œLezione individuale di batteria e percussioniâ€,             docenti:[â€œd3â€] },
{ id:â€œc6â€,  name:â€œSaxofonoâ€,          type:â€œindividualeâ€, description:â€œLezione individuale di saxofonoâ€,                          docenti:[] },
{ id:â€œc7â€,  name:â€œTeoria e Solfeggioâ€,type:â€œcollettivoâ€,  description:â€œCorso collettivo di teoria musicale e solfeggioâ€,          docenti:[â€œd1â€,â€œd2â€] },
{ id:â€œc8â€,  name:â€œMusica dâ€™insiemeâ€,  type:â€œcollettivoâ€,  description:â€œEnsemble strumentale e musica da cameraâ€,                  docenti:[â€œd1â€,â€œd3â€] },
{ id:â€œc9â€,  name:â€œEar Trainingâ€,      type:â€œcollettivoâ€,  description:â€œAllenamento dellâ€™orecchio musicaleâ€,                       docenti:[â€œd4â€] },
{ id:â€œc10â€, name:â€œOrchestraâ€,         type:â€œcollettivoâ€,  description:â€œOrchestra della scuola, aperta a tutti gli strumentiâ€,     docenti:[â€œd1â€,â€œd2â€,â€œd3â€,â€œd4â€] },
];

// Helper: genera quote anno scolastico
const mkQuote = (annoInizio, mese, importo, stato, dataPag=â€â€) => ({
id: uid(), mese, anno: mese>=9 ? annoInizio : annoInizio+1,
importo, stato, dataPagamento: dataPag,
});

const INIT_STUDENTS = [
{ id:1, name:â€œSofia Marchettiâ€,  email:â€œsofia.marchetti@email.itâ€, phone:â€œ333 1234567â€, instrument:â€œPianoforteâ€, teacher:â€œProf. Rossiâ€,   level:â€œIntermedioâ€,   status:â€œattivoâ€,   monthlyFee:120, feeType:â€œfissoâ€,    birthdate:â€œ2010-03-15â€, enrollDate:â€œ2022-09-01â€, complementaryCourse:â€œc7â€,  notes:â€œPartecipa al saggio di primaveraâ€,
lessons:[{date:â€œ2025-02-17â€,topic:â€œScale e arpeggiâ€,attendance:â€œpresenteâ€,notes:â€â€},{date:â€œ2026-02-10â€,topic:â€œChopin Notturno Op.9â€,attendance:â€œpresenteâ€,notes:â€œOttimi progressiâ€},{date:â€œ2026-02-03â€,topic:â€œTecnica staccatoâ€,attendance:â€œassenteâ€,notes:â€œMalattiaâ€}],
repertorio:[
{id:â€œr1aâ€, titolo:â€œNotturno Op.9 n.2â€,   compositore:â€œF. Chopinâ€,    periodo:â€œRomanticoâ€,  stato:â€œin studioâ€,   dataInizio:â€œ2025-10-01â€, note:â€œLavoro sulla cantabilitÃ â€},
{id:â€œr1bâ€, titolo:â€œInvenzione n.1 BWV 772â€,compositore:â€œJ.S. Bachâ€,   periodo:â€œBaroccoâ€,    stato:â€œcompletatoâ€,  dataInizio:â€œ2024-09-01â€, note:â€œPresentato al saggio di nataleâ€},
{id:â€œr1câ€, titolo:â€œSonata K.331â€,          compositore:â€œW.A. Mozartâ€, periodo:â€œClassicoâ€,   stato:â€œin studioâ€,   dataInizio:â€œ2025-01-15â€, note:â€œI mov. Tema e variazioniâ€},
],
quote:[
mkQuote(annoScolasticoAttivo,9, 120,â€œpagatoâ€,â€œ2025-09-05â€),
mkQuote(annoScolasticoAttivo,10,120,â€œpagatoâ€,â€œ2025-10-03â€),
mkQuote(annoScolasticoAttivo,11,120,â€œpagatoâ€,â€œ2025-11-04â€),
mkQuote(annoScolasticoAttivo,12,120,â€œpagatoâ€,â€œ2025-12-02â€),
mkQuote(annoScolasticoAttivo,1, 120,â€œpagatoâ€,â€œ2026-01-07â€),
mkQuote(annoScolasticoAttivo,2, 120,â€œpagatoâ€,â€œ2026-02-03â€),
mkQuote(annoScolasticoAttivo,3, 120,â€œattesaâ€,â€â€),
mkQuote(annoScolasticoAttivo,4, 120,â€œattesaâ€,â€â€),
mkQuote(annoScolasticoAttivo,5, 120,â€œattesaâ€,â€â€),
]
},
{ id:2, name:â€œLuca Ferraraâ€,     email:â€œluca.ferrara@email.itâ€,    phone:â€œ345 7654321â€, instrument:â€œChitarraâ€,   teacher:â€œProf. Bianchiâ€, level:â€œElementareâ€,   status:â€œattivoâ€,   monthlyFee:100, feeType:â€œfissoâ€,    birthdate:â€œ2012-07-22â€, enrollDate:â€œ2023-01-15â€, complementaryCourse:â€œc7â€,  notes:â€â€,
lessons:[{date:â€œ2025-02-18â€,topic:â€œAccordi barreâ€,attendance:â€œpresenteâ€,notes:â€œDifficoltÃ  con il FAâ€}],
repertorio:[
{id:â€œr2aâ€, titolo:â€œRomanza dâ€™amoreâ€,        compositore:â€œAnonimoâ€,      periodo:â€œRomanticoâ€,  stato:â€œcompletatoâ€, dataInizio:â€œ2024-09-01â€, note:â€â€},
{id:â€œr2bâ€, titolo:â€œEstudio Op.60 n.6â€,      compositore:â€œM. Carcassiâ€,  periodo:â€œClassicoâ€,   stato:â€œin studioâ€,  dataInizio:â€œ2024-11-01â€, note:â€œDifficoltÃ  con il barrÃ© al III tastoâ€},
],
quote:[
mkQuote(annoScolasticoAttivo,9, 100,â€œpagatoâ€,â€œ2025-09-10â€),
mkQuote(annoScolasticoAttivo,10,100,â€œpagatoâ€,â€œ2025-10-08â€),
mkQuote(annoScolasticoAttivo,11,100,â€œpagatoâ€,â€œ2025-11-12â€),
mkQuote(annoScolasticoAttivo,12,100,â€œscadutoâ€,â€â€),
mkQuote(annoScolasticoAttivo,1, 100,â€œpagatoâ€,â€œ2026-01-20â€),
mkQuote(annoScolasticoAttivo,2, 100,â€œpagatoâ€,â€œ2026-02-10â€),
mkQuote(annoScolasticoAttivo,3, 100,â€œattesaâ€,â€â€),
mkQuote(annoScolasticoAttivo,4, 100,â€œattesaâ€,â€â€),
]
},
{ id:3, name:â€œEmma Contiâ€,       email:â€œemma.conti@email.itâ€,      phone:â€œ347 9876543â€, instrument:â€œViolinoâ€,   teacher:â€œProf. Rossiâ€,   level:â€œAvanzatoâ€,     status:â€œattivoâ€,   monthlyFee:130, feeType:â€œfissoâ€,    birthdate:â€œ2008-11-05â€, enrollDate:â€œ2020-09-01â€, complementaryCourse:â€œc10â€, notes:â€œCandidata esame conservatorioâ€,
lessons:[{date:â€œ2025-02-19â€,topic:â€œSonate Baroqueâ€,attendance:â€œpresenteâ€,notes:â€â€},{date:â€œ2025-02-12â€,topic:â€œBach Partitaâ€,attendance:â€œpresenteâ€,notes:â€œEccellenteâ€}],
repertorio:[
{id:â€œr3aâ€, titolo:â€œPartita n.2 in Re min. BWV 1004â€,compositore:â€œJ.S. Bachâ€,    periodo:â€œBaroccoâ€,   stato:â€œin studioâ€,   dataInizio:â€œ2024-09-01â€, note:â€œPreparazione esame conservatorioâ€},
{id:â€œr3bâ€, titolo:â€œConcerto in La min. Op.3 n.6â€,  compositore:â€œA. Vivaldiâ€,   periodo:â€œBaroccoâ€,   stato:â€œcompletatoâ€,  dataInizio:â€œ2024-09-01â€, note:â€œSaggio di dicembreâ€},
{id:â€œr3câ€, titolo:â€œSonata n.1 Op.105â€,             compositore:â€œR. Schumannâ€,  periodo:â€œRomanticoâ€, stato:â€œin studioâ€,   dataInizio:â€œ2025-02-01â€, note:â€œIniziato recentementeâ€},
],
quote:[
mkQuote(annoScolasticoAttivo,9, 130,â€œpagatoâ€,â€œ2025-09-02â€),
mkQuote(annoScolasticoAttivo,10,130,â€œpagatoâ€,â€œ2025-10-01â€),
mkQuote(annoScolasticoAttivo,11,130,â€œpagatoâ€,â€œ2025-11-04â€),
mkQuote(annoScolasticoAttivo,12,130,â€œpagatoâ€,â€œ2025-12-03â€),
mkQuote(annoScolasticoAttivo,1, 130,â€œpagatoâ€,â€œ2026-01-06â€),
mkQuote(annoScolasticoAttivo,2, 130,â€œpagatoâ€,â€œ2026-02-04â€),
mkQuote(annoScolasticoAttivo,3, 130,â€œattesaâ€,â€â€),
]
},
{ id:4, name:â€œMarco Ricciâ€,      email:â€œmarco.ricci@email.itâ€,     phone:â€œ339 1112233â€, instrument:â€œBatteriaâ€,  teacher:â€œProf. Verdeâ€,   level:â€œPrincipianteâ€, status:â€œinattivoâ€, monthlyFee:110, feeType:â€œvariabileâ€,birthdate:â€œ2005-04-18â€, enrollDate:â€œ2024-02-01â€, complementaryCourse:â€â€,    notes:â€œSospeso fino a marzoâ€,
lessons:[],
repertorio:[
{id:â€œr4aâ€, titolo:â€œGroove in 4/4â€,  compositore:â€œEsercizioâ€,  periodo:â€â€”â€, stato:â€œcompletatoâ€, dataInizio:â€œ2024-09-01â€, note:â€â€},
],
quote:[
mkQuote(annoScolasticoAttivo,9, 110,â€œpagatoâ€,â€œ2025-09-15â€),
mkQuote(annoScolasticoAttivo,10,110,â€œpagatoâ€,â€œ2025-10-18â€),
mkQuote(annoScolasticoAttivo,11,110,â€œscadutoâ€,â€â€),
mkQuote(annoScolasticoAttivo,12,110,â€œscadutoâ€,â€â€),
mkQuote(annoScolasticoAttivo,1, 110,â€œscadutoâ€,â€â€),
mkQuote(annoScolasticoAttivo,2, 110,â€œscadutoâ€,â€â€),
]
},
{ id:5, name:â€œGiulia Romanoâ€,    email:â€œgiulia.romano@email.itâ€,   phone:â€œ366 4455667â€, instrument:â€œFlautoâ€,    teacher:â€œProf. Bianchiâ€, level:â€œIntermedioâ€,   status:â€œattivoâ€,   monthlyFee:95,  feeType:â€œfissoâ€,    birthdate:â€œ2011-09-30â€, enrollDate:â€œ2022-10-01â€, complementaryCourse:â€œc9â€,  notes:â€â€,
lessons:[{date:â€œ2025-02-20â€,topic:â€œTecnica respirazioneâ€,attendance:â€œpresenteâ€,notes:â€â€}],
repertorio:[
{id:â€œr5aâ€, titolo:â€œSonata in Sol min.â€,     compositore:â€œG.P. Telemannâ€, periodo:â€œBaroccoâ€,  stato:â€œcompletatoâ€, dataInizio:â€œ2024-09-01â€, note:â€â€},
{id:â€œr5bâ€, titolo:â€œConcerto in Re mag.â€,    compositore:â€œJ. Quantzâ€,     periodo:â€œBaroccoâ€,  stato:â€œin studioâ€,  dataInizio:â€œ2024-12-01â€, note:â€œLavoro sullâ€™articolazioneâ€},
],
quote:[
mkQuote(annoScolasticoAttivo,9, 95,â€œpagatoâ€,â€œ2025-09-08â€),
mkQuote(annoScolasticoAttivo,10,95,â€œpagatoâ€,â€œ2025-10-06â€),
mkQuote(annoScolasticoAttivo,11,95,â€œpagatoâ€,â€œ2025-11-05â€),
mkQuote(annoScolasticoAttivo,12,95,â€œpagatoâ€,â€œ2025-12-09â€),
mkQuote(annoScolasticoAttivo,1, 95,â€œpagatoâ€,â€œ2026-01-13â€),
mkQuote(annoScolasticoAttivo,2, 95,â€œpagatoâ€,â€œ2026-02-11â€),
mkQuote(annoScolasticoAttivo,3, 95,â€œattesaâ€,â€â€),
mkQuote(annoScolasticoAttivo,4, 95,â€œattesaâ€,â€â€),
mkQuote(annoScolasticoAttivo,5, 95,â€œattesaâ€,â€â€),
]
},
{ id:6, name:â€œAlessandro Galloâ€, email:â€œa.gallo@email.itâ€,         phone:â€œ328 8899001â€, instrument:â€œPianoforteâ€,teacher:â€œProf. Rossiâ€,   level:â€œIntermedioâ€,   status:â€œattivoâ€,   monthlyFee:120, feeType:â€œfissoâ€,    birthdate:â€œ2009-01-12â€, enrollDate:â€œ2023-09-01â€, complementaryCourse:â€œc8â€,  notes:â€â€,
lessons:[],
repertorio:[
{id:â€œr6aâ€, titolo:â€œSonatina Op.36 n.1â€,  compositore:â€œM. Clementiâ€,   periodo:â€œClassicoâ€,  stato:â€œcompletatoâ€, dataInizio:â€œ2024-09-01â€, note:â€â€},
{id:â€œr6bâ€, titolo:â€œArabesque n.1â€,        compositore:â€œC. Debussyâ€,    periodo:â€œModernoâ€,   stato:â€œin studioâ€,  dataInizio:â€œ2025-01-10â€, note:â€œFocus sul colore timbricoâ€},
],
quote:[
mkQuote(annoScolasticoAttivo,9, 120,â€œpagatoâ€,â€œ2025-09-03â€),
mkQuote(annoScolasticoAttivo,10,120,â€œpagatoâ€,â€œ2025-10-07â€),
mkQuote(annoScolasticoAttivo,11,120,â€œpagatoâ€,â€œ2025-11-06â€),
mkQuote(annoScolasticoAttivo,12,120,â€œpagatoâ€,â€œ2025-12-05â€),
mkQuote(annoScolasticoAttivo,1, 120,â€œpagatoâ€,â€œ2026-01-08â€),
mkQuote(annoScolasticoAttivo,2, 120,â€œpagatoâ€,â€œ2026-02-06â€),
mkQuote(annoScolasticoAttivo,3, 120,â€œscadutoâ€,â€â€),
mkQuote(annoScolasticoAttivo,4, 120,â€œattesaâ€,â€â€),
]
},
];

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIONE CORSI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CourseForm = ({ initial, onSave, onClose, docenti:_docentiRaw }) => {
const docenti = _docentiRaw || [];
const [f, setF] = useState(initial || { name:â€â€, type:â€œcollettivoâ€, description:â€â€, docenti:[] });
const [err, setErr] = useState({});
const set = (k,v) => setF(p=>({â€¦p,[k]:v}));

const toggleDocente = (id) => {
setF(p => {
const cur = p.docenti || [];
return { â€¦p, docenti: cur.includes(id) ? cur.filter(x=>x!==id) : [â€¦cur,id] };
});
};

const handleSave = () => {
if(!f.name.trim()){ setErr({name:â€œNome obbligatorioâ€}); return; }
onSave({ â€¦f, docenti: f.docenti || [] });
};

const selDocenti = f.docenti || [];

return (
<>
<div style={{padding:24,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:16}}>
<Input label=â€œNome del corso *â€ value={f.name} onChange={e=>set(â€œnameâ€,e.target.value)} error={err.name} placeholder=â€œEs. Teoria avanzata, Coro voci biancheâ€¦â€/>
<div>
<label style={{fontSize:12,color:C.textMuted,letterSpacing:â€œ0.06emâ€,textTransform:â€œuppercaseâ€,display:â€œblockâ€,marginBottom:8}}>Tipo corso</label>
<div style={{display:â€œflexâ€,gap:12}}>
{[[â€œindividualeâ€,â€œsoloâ€,â€œIndividualeâ€,â€œ1 allievo per lezioneâ€,C.gold,â€#2e2308â€,C.goldDim],[â€œcollettivoâ€,â€œgroupâ€,â€œCollettivoâ€,â€œPiÃ¹ allievi insiemeâ€,C.purple,C.purpleBg,C.purpleBorder]].map(([val,icon,lbl,sub,col,bg,border])=>(
<button key={val} onClick={()=>set(â€œtypeâ€,val)} style={{flex:1,padding:â€œ14px 16pxâ€,borderRadius:10,border:`2px solid ${f.type===val?col:C.border}`,background:f.type===val?bg:C.bg,cursor:â€œpointerâ€,display:â€œflexâ€,alignItems:â€œcenterâ€,gap:10,transition:â€œall 0.15sâ€}}>
<Ic n={icon} size={18} color={f.type===val?col:C.textMuted}/>
<div style={{textAlign:â€œleftâ€}}>
<div style={{fontSize:13,fontWeight:500,color:f.type===val?col:C.text}}>{lbl}</div>
<div style={{fontSize:11,color:C.textMuted}}>{sub}</div>
</div>
</button>
))}
</div>
</div>
<Textarea label=â€œDescrizione (opzionale)â€ value={f.description} onChange={e=>set(â€œdescriptionâ€,e.target.value)} placeholder=â€œBreve descrizione del corsoâ€¦â€/>

```
    {/* â”€â”€ Docenti assegnati â”€â”€ */}
    <div>
      <label style={{fontSize:12,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase",display:"block",marginBottom:8}}>
        Docenti assegnati
      </label>
      {docenti.length === 0 ? (
        <p style={{fontSize:13,color:C.textDim}}>Nessun docente disponibile. Aggiungine uno dalla sezione <strong style={{color:C.gold}}>Docenti</strong>.</p>
      ) : (
        <div style={{display:"flex",flexDirection:"column",gap:8}}>
          {docenti.map(d => {
            const sel = selDocenti.includes(d.id);
            return (
              <button key={d.id} onClick={()=>toggleDocente(d.id)}
                style={{display:"flex",alignItems:"center",gap:12,padding:"11px 14px",borderRadius:10,
                  border:`2px solid ${sel ? d.colore||C.gold : C.border}`,
                  background: sel ? `${d.colore||C.gold}15` : C.bg,
                  cursor:"pointer",transition:"all 0.15s",textAlign:"left"}}>
                <div style={{width:34,height:34,borderRadius:"50%",background:`${d.colore||C.gold}25`,
                  border:`1px solid ${d.colore||C.gold}60`,display:"flex",alignItems:"center",
                  justifyContent:"center",fontSize:12,fontWeight:700,color:d.colore||C.gold,flexShrink:0}}>
                  {initials(d.nome)}
                </div>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:13,fontWeight:500,color:sel?d.colore||C.gold:C.text}}>{d.nome}</div>
                  <div style={{fontSize:11,color:C.textMuted}}>{Array.isArray(d.strumenti) ? d.strumenti.join(", ") : (d.strumenti||"â€”")}</div>
                </div>
                <div style={{width:18,height:18,borderRadius:4,border:`2px solid ${sel?d.colore||C.gold:C.border}`,
                  background:sel?d.colore||C.gold:"transparent",display:"flex",alignItems:"center",
                  justifyContent:"center",flexShrink:0,transition:"all 0.15s"}}>
                  {sel && <Ic n="check" size={10} color={C.bg}/>}
                </div>
              </button>
            );
          })}
        </div>
      )}
    </div>
  </div>
  <div style={{padding:"16px 24px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"flex-end",gap:10}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={handleSave}><Ic n="check" size={14} color={C.bg}/>{initial?.id?"Salva modifiche":"Crea corso"}</Btn>
  </div>
</>
```

);
};

// â”€â”€ Scheda dettaglio corso â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CourseDetail = ({ course, students, docenti:_docentiRaw, onBack, onEdit, onDelete }) => {
const docenti = _docentiRaw || [];
const isIndividuale = course.type === â€œindividualeâ€;
const col  = isIndividuale ? C.gold   : C.purple;
const bg   = isIndividuale ? â€œ#2e2308â€: C.purpleBg;
const bord = isIndividuale ? C.goldDim: C.purpleBorder;

const enrolled = isIndividuale
? students.filter(s => s.instrument === course.name)
: students.filter(s => s.complementaryCourse === course.id);

const attivi   = enrolled.filter(s=>s.status===â€œattivoâ€).length;
const totFee   = enrolled.filter(s=>s.status===â€œattivoâ€).reduce((sum,s)=>sum+s.monthlyFee,0);

const crsDocenti = docenti.filter(d => (course.docenti||[]).includes(d.id));

return (
<div style={{animation:â€œslideIn 0.25s easeâ€}}>
{/* Back */}
<button onClick={onBack} style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:6,background:â€œnoneâ€,border:â€œnoneâ€,cursor:â€œpointerâ€,color:C.textMuted,fontSize:13,marginBottom:20,padding:0,fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€}}>
<Ic n="back" size={16}/> Tutti i corsi
</button>

```
  {/* Header */}
  <div style={{display:"flex",alignItems:"center",gap:20,marginBottom:24}}>
    <div style={{width:56,height:56,borderRadius:14,background:bg,border:`2px solid ${bord}`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
      <Ic n={isIndividuale?"solo":"group"} size={24} color={col}/>
    </div>
    <div style={{flex:1}}>
      <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:4}}>
        <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600}}>{course.name}</h1>
        <Badge label={course.type} color={isIndividuale?"gold":"purple"}/>
      </div>
      {course.description && <p style={{fontSize:13,color:C.textMuted}}>{course.description}</p>}
    </div>
    <div style={{display:"flex",gap:8}}>
      <Btn variant="secondary" onClick={onEdit}><Ic n="edit" size={14}/>Modifica</Btn>
      <Btn danger onClick={onDelete}><Ic n="trash" size={14} color={C.red}/></Btn>
    </div>
  </div>

  {/* Statistiche rapide */}
  <div style={{display:"grid",gridTemplateColumns:isIndividuale?"repeat(auto-fit,minmax(140px,1fr))":"repeat(auto-fit,minmax(180px,1fr))",gap:12,marginBottom:24}}>
    {(isIndividuale
      ? [{ label:"Allievi iscritti", value:enrolled.length, sub:"totali" }, { label:"Allievi attivi", value:attivi, sub:"in corso" }, { label:"Incasso mensile", value:`â‚¬ ${totFee}`, sub:"allievi attivi" }]
      : [{ label:"Allievi iscritti", value:enrolled.length, sub:"totali" }, { label:"Allievi attivi", value:attivi, sub:"in corso" }]
    ).map(s=>(
      <div key={s.label} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"16px 18px"}}>
        <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:6}}>{s.label}</div>
        <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,color:col}}>{s.value}</div>
        <div style={{fontSize:11,color:C.textDim,marginTop:4}}>{s.sub}</div>
      </div>
    ))}
  </div>

  {/* Docenti assegnati */}
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden",marginBottom:16}}>
    <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
      <Ic n="teacher" size={14} color={C.textMuted}/>
      <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Docenti assegnati</span>
      <span style={{fontSize:11,color:C.textDim}}>({crsDocenti.length})</span>
    </div>
    {crsDocenti.length === 0 ? (
      <div style={{textAlign:"center",padding:"32px 0",color:C.textDim}}>
        <p style={{fontSize:13}}>Nessun docente assegnato â€” clicca <strong>Modifica</strong> per assegnarne uno</p>
      </div>
    ) : (
      <div style={{padding:16,display:"flex",flexWrap:"wrap",gap:10}}>
        {crsDocenti.map(d => (
          <div key={d.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",
            background:`${d.colore||C.gold}12`,border:`1px solid ${d.colore||C.gold}40`,
            borderRadius:10}}>
            <div style={{width:32,height:32,borderRadius:"50%",background:`${d.colore||C.gold}25`,
              border:`1px solid ${d.colore||C.gold}60`,display:"flex",alignItems:"center",
              justifyContent:"center",fontSize:12,fontWeight:700,color:d.colore||C.gold,flexShrink:0}}>
              {initials(d.nome)}
            </div>
            <div>
              <div style={{fontSize:13,fontWeight:500,color:d.colore||C.gold}}>{d.nome}</div>
              <div style={{fontSize:11,color:C.textMuted}}>{Array.isArray(d.strumenti) ? d.strumenti.join(", ") : (d.strumenti||"â€”")}</div>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>

  {/* Lista allievi */}
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
    <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
      <Ic n="user" size={14} color={C.textMuted}/>
      <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Allievi iscritti</span>
      <span style={{fontSize:11,color:C.textDim}}>({enrolled.length})</span>
    </div>

    {enrolled.length === 0 ? (
      <div style={{textAlign:"center",padding:"48px 0",color:C.textDim}}>
        <Ic n="user" size={28} color={C.textDim}/>
        <p style={{marginTop:12,fontSize:13}}>Nessun allievo iscritto a questo corso</p>
      </div>
    ) : (
      <table style={{width:"100%",borderCollapse:"collapse"}}>
        <thead>
          <tr style={{borderBottom:`1px solid ${C.border}`}}>
            {["Allievo","Insegnante","Livello","Quota mensile","Stato"].map(h=>(
              <th key={h} style={{padding:"11px 20px",textAlign:"left",fontSize:11,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {enrolled.map((s,i)=>{
            const ic = INS_COLORS[s.instrument]||C.gold;
            return (
              <tr key={s.id} style={{borderBottom:i<enrolled.length-1?`1px solid ${C.border}`:"none",transition:"background 0.12s"}}
                onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"13px 20px"}}>
                  <div style={{display:"flex",alignItems:"center",gap:10}}>
                    <div style={{width:34,height:34,borderRadius:"50%",background:`${ic}20`,border:`1px solid ${ic}40`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:700,color:ic,flexShrink:0}}>
                      {initials(s.name)}
                    </div>
                    <div>
                      <div style={{fontSize:14,fontWeight:500}}>{s.name}</div>
                      <div style={{fontSize:11,color:C.textMuted}}>{s.email||"â€”"}</div>
                    </div>
                  </div>
                </td>
                <td style={{padding:"13px 20px",fontSize:13,color:C.textMuted}}>{s.teacher}</td>
                <td style={{padding:"13px 20px",fontSize:13,color:C.textMuted}}>{s.level||"â€”"}</td>
                <td style={{padding:"13px 20px"}}>
                  <div style={{fontSize:14}}>â‚¬ {s.monthlyFee}</div>
                  <div style={{fontSize:11,color:C.textDim}}>{s.feeType}</div>
                </td>
                <td style={{padding:"13px 20px"}}>
                  <Badge label={s.status} color={s.status==="attivo"?"green":s.status==="sospeso"?"gold":"red"}/>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    )}
  </div>
</div>
```

);
};

// â”€â”€ Lista corsi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CourseManager = ({ courses, students, docenti:_docentiRaw, onAdd, onEdit, onDelete }) => {
const docenti = _docentiRaw || [];
const [modal,         setModal]         = useState(null);
const [target,        setTarget]        = useState(null);
const [selectedCourse,setSelectedCourse]= useState(null);

const individuali = courses.filter(c=>c.type===â€œindividualeâ€);
const collettivi  = courses.filter(c=>c.type===â€œcollettivoâ€);

const studentsIn = c => c.type === â€œindividualeâ€
? students.filter(s => s.instrument === c.name).length
: students.filter(s => s.complementaryCourse === c.id).length;

// Se un corso selezionato viene eliminato, torna alla lista
const handleDelete = (id) => { onDelete(id); setSelectedCourse(null); setModal(null); };

// Scheda dettaglio corso
if (selectedCourse) {
const live = courses.find(c=>c.id===selectedCourse.id) || selectedCourse;
return (
<>
<CourseDetail
course={live}
students={students}
docenti={docenti}
onBack={()=>setSelectedCourse(null)}
onEdit={()=>{ setTarget(live); setModal(â€œeditâ€); }}
onDelete={()=>{ setTarget(live); setModal(â€œdeleteâ€); }}
/>
{modal===â€œeditâ€   && target && <Modal title=â€œModifica corsoâ€ onClose={()=>setModal(null)}><CourseForm initial={target} docenti={docenti} onSave={d=>{onEdit({â€¦target,â€¦d});setSelectedCourse(p=>({â€¦p,â€¦d}));setModal(null);}} onClose={()=>setModal(null)}/></Modal>}
{modal===â€œdeleteâ€ && target && <ConfirmDelete label={target.name} description=â€œIl corso verrÃ  rimosso. Gli allievi iscritti perderanno lâ€™associazione al corso complementare.â€ onConfirm={()=>handleDelete(target.id)} onClose={()=>setModal(null)}/>}
</>
);
}

const CourseRow = ({ c, badgeColor }) => {
const n   = studentsIn(c);
const col = badgeColor===â€œpurpleâ€ ? C.purple : C.gold;
const bg  = badgeColor===â€œpurpleâ€ ? C.purpleBg : â€œ#2e2308â€;
const bd  = badgeColor===â€œpurpleâ€ ? C.purpleBorder : C.goldDim;
return (
<div onClick={()=>setSelectedCourse(c)}
style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:14,padding:â€œ14px 16pxâ€,background:C.bg,border:`1px solid ${C.border}`,borderRadius:10,cursor:â€œpointerâ€,transition:â€œall 0.15sâ€}}
onMouseEnter={e=>{ e.currentTarget.style.borderColor=col; e.currentTarget.style.background=bg+â€œ55â€; }}
onMouseLeave={e=>{ e.currentTarget.style.borderColor=C.border; e.currentTarget.style.background=C.bg; }}>
<div style={{width:38,height:38,borderRadius:8,background:bg,border:`1px solid ${bd}`,display:â€œflexâ€,alignItems:â€œcenterâ€,justifyContent:â€œcenterâ€,flexShrink:0}}>
<Ic n={badgeColor===â€œpurpleâ€?â€œgroupâ€:â€œsoloâ€} size={16} color={col}/>
</div>
<div style={{flex:1,minWidth:0}}>
<div style={{fontSize:14,fontWeight:500}}>{c.name}</div>
{c.description && <div style={{fontSize:12,color:C.textMuted,marginTop:2,overflow:â€œhiddenâ€,textOverflow:â€œellipsisâ€,whiteSpace:â€œnowrapâ€}}>{c.description}</div>}
</div>
<div style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:12,flexShrink:0}}>
{/* docenti assegnati â€” piccole icone */}
{(c.docenti||[]).length > 0 && (
<div style={{display:â€œflexâ€,alignItems:â€œcenterâ€}}>
{docenti.filter(d=>(c.docenti||[]).includes(d.id)).slice(0,3).map((d,i)=>(
<div key={d.id} title={d.nome} style={{width:22,height:22,borderRadius:â€œ50%â€,background:`${d.colore||C.gold}25`,
border:`2px solid ${C.bg}`,marginLeft:i===0?0:-6,
display:â€œflexâ€,alignItems:â€œcenterâ€,justifyContent:â€œcenterâ€,
fontSize:9,fontWeight:700,color:d.colore||C.gold,zIndex:3-i}}>
{initials(d.nome)}
</div>
))}
{(c.docenti||[]).length > 3 && (
<div style={{width:22,height:22,borderRadius:â€œ50%â€,background:C.surfaceHover,border:`2px solid ${C.bg}`,
display:â€œflexâ€,alignItems:â€œcenterâ€,justifyContent:â€œcenterâ€,fontSize:9,color:C.textMuted,marginLeft:-6}}>
+{(c.docenti||[]).length-3}
</div>
)}
</div>
)}
<span style={{background:bg,border:`1px solid ${bd}`,borderRadius:20,padding:â€œ3px 10pxâ€,fontSize:12,color:col,fontWeight:500}}>
{n} alliev{n===1?â€œoâ€:â€œiâ€}
</span>
{/* azioni â€” stopPropagation per non aprire la scheda */}
<button onClick={e=>{e.stopPropagation();setTarget(c);setModal(â€œeditâ€);}} style={{background:â€œnoneâ€,border:â€œnoneâ€,cursor:â€œpointerâ€,color:C.textMuted,padding:4,display:â€œflexâ€,borderRadius:6}}
onMouseEnter={e=>e.currentTarget.style.color=C.gold} onMouseLeave={e=>e.currentTarget.style.color=C.textMuted}><Ic n="edit" size={14}/></button>
<button onClick={e=>{e.stopPropagation();setTarget(c);setModal(â€œdeleteâ€);}} style={{background:â€œnoneâ€,border:â€œnoneâ€,cursor:â€œpointerâ€,color:C.textMuted,padding:4,display:â€œflexâ€,borderRadius:6}}
onMouseEnter={e=>e.currentTarget.style.color=C.red} onMouseLeave={e=>e.currentTarget.style.color=C.textMuted}><Ic n="trash" size={14}/></button>
<Ic n="arrow" size={16} color={C.textDim}/>
</div>
</div>
);
};

const SectionTitle = ({ icon, label, count, color }) => (
<div style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:8,marginBottom:10}}>
<Ic n={icon} size={14} color={color}/>
<span style={{fontSize:12,letterSpacing:â€œ0.08emâ€,textTransform:â€œuppercaseâ€,color:C.textMuted}}>{label}</span>
<span style={{fontSize:11,color:C.textDim}}>({count})</span>
</div>
);

return (
<div style={{display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:24}}>
<div style={{display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,alignItems:â€œflex-startâ€}}>
<div>
<h1 style={{fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€,fontSize:32,fontWeight:600}}>Gestione Corsi</h1>
<p style={{color:C.textMuted,fontSize:14,marginTop:4}}>{individuali.length} corsi individuali Â· {collettivi.length} corsi collettivi</p>
</div>
<Btn onClick={()=>setModal(â€œaddâ€)}><Ic n="plus" size={14} color={C.bg}/>Nuovo corso</Btn>
</div>

```
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:24,display:"flex",flexDirection:"column",gap:24}}>
    <div>
      <SectionTitle icon="solo" label="Corsi Individuali (strumento)" count={individuali.length} color={C.gold}/>
      <div style={{display:"flex",flexDirection:"column",gap:8}}>
        {individuali.length===0 && <div style={{fontSize:13,color:C.textDim,padding:"8px 0"}}>Nessun corso individuale</div>}
        {individuali.map(c=><CourseRow key={c.id} c={c} badgeColor="gold"/>)}
      </div>
    </div>
    <div style={{borderTop:`1px solid ${C.border}`}}/>
    <div>
      <SectionTitle icon="group" label="Corsi Collettivi / Complementari" count={collettivi.length} color={C.purple}/>
      <div style={{display:"flex",flexDirection:"column",gap:8}}>
        {collettivi.length===0 && <div style={{fontSize:13,color:C.textDim,padding:"8px 0"}}>Nessun corso collettivo</div>}
        {collettivi.map(c=><CourseRow key={c.id} c={c} badgeColor="purple"/>)}
      </div>
    </div>
  </div>

  {modal==="add"    && <Modal title="Nuovo corso" onClose={()=>setModal(null)}><CourseForm docenti={docenti} onSave={d=>{onAdd(d);setModal(null);}} onClose={()=>setModal(null)}/></Modal>}
  {modal==="edit"   && target && <Modal title="Modifica corso" onClose={()=>setModal(null)}><CourseForm initial={target} docenti={docenti} onSave={d=>{onEdit({...target,...d});setModal(null);}} onClose={()=>setModal(null)}/></Modal>}
  {modal==="delete" && target && <ConfirmDelete label={target.name} description="Il corso verrÃ  rimosso. Gli allievi iscritti perderanno l'associazione al corso complementare." onConfirm={()=>handleDelete(target.id)} onClose={()=>setModal(null)}/>}
</div>
```

);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM ALLIEVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const emptyStudent = { name:â€â€,email:â€â€,phone:â€â€,instrument:â€â€,teacher:â€â€,level:â€â€,status:â€œattivoâ€,monthlyFee:â€â€,nomeRicevuta:â€â€,feeType:â€œfissoâ€,birthdate:â€â€,enrollDate:â€â€,complementaryCourse:â€â€,notes:â€â€ };

const validate = f => {
const e = {};
if(!f.name.trim()) e.name=â€œNome obbligatorioâ€;
if(f.email && !/^[^\s@]+@[^\s@]+.[^\s@]+$/.test(f.email)) e.email=â€œEmail non validaâ€;
if(!f.instrument) e.instrument=â€œStrumento obbligatorioâ€;
if(!f.teacher)    e.teacher=â€œInsegnante obbligatorioâ€;
if(!f.monthlyFee || isNaN(f.monthlyFee) || Number(f.monthlyFee)<=0) e.monthlyFee=â€œImporto non validoâ€;
return e;
};

const StudentForm = ({ initial, onSave, onClose, courses }) => {
const [f, setF] = useState(initial || emptyStudent);
const [errors, setErrors] = useState({});
const set = (k,v) => setF(p=>({â€¦p,[k]:v}));

const collettivi = courses.filter(c=>c.type===â€œcollettivoâ€);

const handleSubmit = () => {
const e = validate(f);
if(Object.keys(e).length){ setErrors(e); return; }
onSave({â€¦f, monthlyFee:Number(f.monthlyFee), lessons:f.lessons||[]});
};

return (
<>
<div style={{padding:24,display:â€œgridâ€,gridTemplateColumns:â€œ1fr 1frâ€,gap:16}} className=â€œform-2colâ€>

```
    <SectionDivider label="Dati anagrafici"/>
    <div style={{gridColumn:"1/-1"}}><Input label="Nome completo *" value={f.name} onChange={e=>set("name",e.target.value)} error={errors.name} placeholder="Es. Sofia Marchetti"/></div>
    <Input label="Email" type="email" value={f.email} onChange={e=>set("email",e.target.value)} error={errors.email} placeholder="email@esempio.it"/>
    <Input label="Telefono" value={f.phone} onChange={e=>set("phone",e.target.value)} placeholder="333 1234567"/>
    <Input label="Data di nascita" type="date" value={f.birthdate} onChange={e=>set("birthdate",e.target.value)}/>
    <Input label="Data iscrizione" type="date" value={f.enrollDate} onChange={e=>set("enrollDate",e.target.value)}/>
    <div style={{gridColumn:"1/-1"}}>
      <Input label="Nome per ricevuta" value={f.nomeRicevuta||""} onChange={e=>set("nomeRicevuta",e.target.value)}
        placeholder={f.name||"Lascia vuoto per usare il nome dell'allievo"}/>
      <div style={{fontSize:11,color:C.textDim,marginTop:4}}>
        Per allievi minorenni inserire il nome del genitore/tutore intestatario della ricevuta.
      </div>
    </div>

    <SectionDivider label="Corsi"/>

    {/* Corso principale */}
    <div style={{gridColumn:"1/-1"}}>
      <label style={{fontSize:12,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase",display:"block",marginBottom:6}}>Corso principale â€” strumento *</label>
      <div style={{display:"flex",gap:10,alignItems:"center"}}>
        <select value={f.instrument} onChange={e=>set("instrument",e.target.value)}
          style={{flex:1,background:C.bg,border:`1px solid ${errors.instrument?C.red:C.border}`,borderRadius:8,color:f.instrument?C.text:C.textDim,fontSize:14,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",appearance:"none"}}>
          <option value="">â€” seleziona strumento â€”</option>
          {INSTRUMENTS.map(i=><option key={i} value={i}>{i}</option>)}
        </select>
        <div style={{width:38,height:38,borderRadius:8,background:"#2e2308",border:`1px solid ${C.goldDim}`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
          <Ic n="music" size={16} color={f.instrument?(INS_COLORS[f.instrument]||C.gold):C.textDim}/>
        </div>
      </div>
      {errors.instrument && <span style={{fontSize:11,color:C.red,marginTop:4,display:"block"}}>{errors.instrument}</span>}
    </div>

    {/* Corso complementare â€” pill selector */}
    <div style={{gridColumn:"1/-1"}}>
      <label style={{fontSize:12,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase",display:"block",marginBottom:8}}>Corso complementare â€” collettivo</label>
      {collettivi.length===0
        ? <p style={{fontSize:12,color:C.textDim}}>Nessun corso collettivo disponibile. Creane uno dalla sezione <strong style={{color:C.gold}}>Corsi</strong>.</p>
        : <div style={{display:"flex",flexWrap:"wrap",gap:8}}>
            <button onClick={()=>set("complementaryCourse","")}
              style={{padding:"8px 16px",borderRadius:20,border:`2px solid ${!f.complementaryCourse?C.border:C.border}`,background:!f.complementaryCourse?C.surfaceHover:C.bg,cursor:"pointer",fontSize:13,color:!f.complementaryCourse?C.text:C.textMuted,fontFamily:"'DM Sans',sans-serif",transition:"all 0.12s"}}>
              Nessuno
            </button>
            {collettivi.map(c=>(
              <button key={c.id} onClick={()=>set("complementaryCourse",c.id)}
                style={{padding:"8px 16px",borderRadius:20,border:`2px solid ${f.complementaryCourse===c.id?C.purple:C.border}`,background:f.complementaryCourse===c.id?C.purpleBg:C.bg,cursor:"pointer",fontSize:13,color:f.complementaryCourse===c.id?C.purple:C.textMuted,fontFamily:"'DM Sans',sans-serif",fontWeight:f.complementaryCourse===c.id?500:400,transition:"all 0.12s"}}>
                {c.name}
              </button>
            ))}
          </div>
      }
    </div>

    <SectionDivider label="Didattica"/>
    <Sel label="Insegnante *" value={f.teacher} onChange={e=>set("teacher",e.target.value)} options={TEACHERS} error={errors.teacher}/>
    <Sel label="Livello" value={f.level} onChange={e=>set("level",e.target.value)} options={LEVELS}/>
    <Sel label="Stato" value={f.status} onChange={e=>set("status",e.target.value)} options={["attivo","inattivo","sospeso"]}/>

    <SectionDivider label="Quota"/>
    <Input label="Quota mensile (â‚¬) *" type="number" value={f.monthlyFee} onChange={e=>set("monthlyFee",e.target.value)} error={errors.monthlyFee} placeholder="100"/>
    <Sel label="Tipo quota" value={f.feeType} onChange={e=>set("feeType",e.target.value)} options={["fisso","variabile"]}/>

    <div style={{gridColumn:"1/-1",marginTop:4}}>
      <Textarea label="Note" value={f.notes} onChange={e=>set("notes",e.target.value)} placeholder="Note aggiuntive sull'allievo..."/>
    </div>
  </div>
  <div style={{padding:"16px 24px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"flex-end",gap:10}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={handleSubmit}><Ic n="check" size={14} color={C.bg}/>{initial?.id?"Salva modifiche":"Aggiungi allievo"}</Btn>
  </div>
</>
```

);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGISTRO LEZIONI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LessonLog = ({ lessons:_lessonsRaw, studentId, onAddLesson }) => {
const lessons = _lessonsRaw || [];
const [showForm, setShowForm] = useState(false);
const [form, setForm] = useState({ date:new Date().toISOString().split(â€œTâ€)[0], topic:â€â€, attendance:â€œpresenteâ€, notes:â€â€ });
const set = (k,v) => setForm(p=>({â€¦p,[k]:v}));
const handleAdd = () => {
if(!form.topic.trim()) return;
onAddLesson(studentId, {â€¦form});
setForm({ date:new Date().toISOString().split(â€œTâ€)[0], topic:â€â€, attendance:â€œpresenteâ€, notes:â€â€ });
setShowForm(false);
};
return (
<div>
<div style={{display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,alignItems:â€œcenterâ€,marginBottom:16}}>
<h3 style={{fontSize:13,letterSpacing:â€œ0.08emâ€,textTransform:â€œuppercaseâ€,color:C.textMuted}}>Registro Lezioni ({lessons.length})</h3>
<Btn small onClick={()=>setShowForm(p=>!p)}><Ic n="plus" size={12} color={C.bg}/>Aggiungi</Btn>
</div>
{showForm && (
<div style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:10,padding:16,marginBottom:16,display:â€œgridâ€,gridTemplateColumns:â€œ1fr 1frâ€,gap:12,animation:â€œfadeIn 0.2s easeâ€}} className=â€œform-2colâ€>
<Input label=â€œDataâ€ type=â€œdateâ€ value={form.date} onChange={e=>set(â€œdateâ€,e.target.value)}/>
<Sel label=â€œPresenzaâ€ value={form.attendance} onChange={e=>set(â€œattendanceâ€,e.target.value)} options={[â€œpresenteâ€,â€œassenteâ€,â€œgiustificatoâ€]}/>
<div style={{gridColumn:â€œ1/-1â€}}><Input label=â€œArgomento *â€ value={form.topic} onChange={e=>set(â€œtopicâ€,e.target.value)} placeholder=â€œEs. Scale maggiori, Bach Invenzione n.1â€¦â€/></div>
<div style={{gridColumn:â€œ1/-1â€}}><Textarea label=â€œNote insegnanteâ€ value={form.notes} onChange={e=>set(â€œnotesâ€,e.target.value)} placeholder=â€œOsservazioni, compiti per casaâ€¦â€/></div>
<div style={{gridColumn:â€œ1/-1â€,display:â€œflexâ€,gap:8,justifyContent:â€œflex-endâ€}}>
<Btn small variant=â€œsecondaryâ€ onClick={()=>setShowForm(false)}>Annulla</Btn>
<Btn small onClick={handleAdd}><Ic n="check" size={12} color={C.bg}/>Salva lezione</Btn>
</div>
</div>
)}
{lessons.length===0 && !showForm && <div style={{textAlign:â€œcenterâ€,padding:â€œ32px 0â€,color:C.textDim,fontSize:13}}>Nessuna lezione registrata</div>}
<div style={{display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:8}}>
{[â€¦lessons].sort((a,b)=>new Date(b.date)-new Date(a.date)).map((l,i)=>(
<div key={i} style={{display:â€œflexâ€,gap:12,padding:â€œ12px 14pxâ€,background:C.bg,borderRadius:8,border:`1px solid ${C.border}`}}>
<div style={{flexShrink:0,minWidth:72,fontSize:11,color:C.textMuted,paddingTop:2}}>{fmtDate(l.date)}</div>
<div style={{flex:1}}>
<div style={{fontSize:14,fontWeight:500,marginBottom:2}}>{l.topic}</div>
{l.notes && <div style={{fontSize:12,color:C.textMuted}}>{l.notes}</div>}
</div>
<Badge label={l.attendance} color={l.attendance===â€œpresenteâ€?â€œgreenâ€:l.attendance===â€œgiustificatoâ€?â€œgoldâ€:â€œredâ€}/>
</div>
))}
</div>
</div>
);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDA DETTAGLIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const StudentDetail = ({ student, courses, lessons:_lessonsRaw, entrate:_allEntrateRaw, setEntrate, annoInizioAttivo, onEdit, onDelete, onBack, onAddLesson, onUpdateStudent, config:propConfig }) => {
const isMobile = useIsMobile();
const lessons = _lessonsRaw || [];
const allEntrate = _allEntrateRaw || [];
const accentHex = INS_COLORS[student.instrument] || C.gold;
const comp   = courses.find(c => c.id === student.complementaryCourse);

// Anno scolastico e selettore mese â”€â”€ tutti gli hook PRIMA di qualsiasi return
const nowDate   = new Date(today);
const curYear   = nowDate.getFullYear();
const curMonth  = nowDate.getMonth() + 1;
const annoInizio = annoInizioAttivo ?? (curMonth >= 9 ? curYear : curYear - 1);
const MESI_LABEL_L = [â€œGennaioâ€,â€œFebbraioâ€,â€œMarzoâ€,â€œAprileâ€,â€œMaggioâ€,â€œGiugnoâ€,â€œLuglioâ€,â€œAgostoâ€,â€œSettembreâ€,â€œOttobreâ€,â€œNovembreâ€,â€œDicembreâ€];
const MESI_LABEL_S = [â€œGenâ€,â€œFebâ€,â€œMarâ€,â€œAprâ€,â€œMagâ€,â€œGiuâ€,â€œLugâ€,â€œAgoâ€,â€œSetâ€,â€œOttâ€,â€œNovâ€,â€œDicâ€];
const MESI_AS = [
{m:9,y:annoInizio},{m:10,y:annoInizio},{m:11,y:annoInizio},{m:12,y:annoInizio},
{m:1,y:annoInizio+1},{m:2,y:annoInizio+1},{m:3,y:annoInizio+1},
{m:4,y:annoInizio+1},{m:5,y:annoInizio+1},{m:6,y:annoInizio+1},
];
const isFuture = x => new Date(x.y, x.m-1, 1) > new Date(curYear, curMonth-1, 1);
const defaultSelMese = MESI_AS.find(x => x.m===curMonth && x.y===curYear) || MESI_AS[MESI_AS.length-1];

const [tab,      setTab]      = useState(â€œinfoâ€);
const [selMese,  setSelMese]  = useState(defaultSelMese);
const [showLezForm, setShowLezForm] = useState(false);
const [lezForm, setLezForm]   = useState({ date: new Date().toISOString().split(â€œTâ€)[0], topic:â€â€, attendance:â€œpresenteâ€, notes:â€â€ });
const [ricevutaEnt, setRicevutaEnt] = useState(null); // entrata da stampare
const config = propConfig ?? CONFIG_DEFAULT;

// Lezioni globali per questo allievo
const lezStudente = lessons.filter(l => studentInLesson(l, student.name));
const lezMese     = (m, y) => lezStudente.filter(l => { const [ly,lm] = l.date.split(â€-â€).map(Number); return ly===y && lm===m; });
const lezSel      = lezMese(selMese.m, selMese.y);

// Andamento anno per grafici
const andamento = MESI_AS.map(x => {
const n = lezMese(x.m, x.y).length;
return { label: MESI_LABEL_S[x.m-1], n, m:x.m, y:x.y,
isSel: x.m===selMese.m && x.y===selMese.y, isFut: isFuture(x) };
});
const maxN = Math.max(â€¦andamento.map(x => x.n), 1);

// Quote anno scolastico corrente
// Quote: leggiamo da sharedEntrate (fonte unica di veritÃ )
const entrateStudent = allEntrate.filter(e =>
e.studentId === student.id &&
MESI_AS.some(x => x.m === e.mese && x.y === e.anno)
);
const totaleVersato   = entrateStudent.reduce((t,e) => t + e.importo, 0);
const entrataPerMese  = (m, y) => entrateStudent.find(e => e.mese===m && e.anno===y);

// Repertorio
const repertorio = student.repertorio || [];
const repInStudio   = repertorio.filter(r => r.stato === â€œin studioâ€);
const repCompletato = repertorio.filter(r => r.stato === â€œcompletatoâ€);

// Selettore mese UI
const MeseSelector = () => (
<div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:â€œ12px 16pxâ€,marginBottom:20}}>
<div style={{fontSize:10,color:C.textDim,letterSpacing:â€œ0.1emâ€,textTransform:â€œuppercaseâ€,marginBottom:10}}>
Anno scolastico {annoInizio}/{String(annoInizio+1).slice(-2)}
</div>
<div style={{display:â€œflexâ€,gap:6,flexWrap:â€œwrapâ€}}>
{MESI_AS.map(x => {
const isS  = x.m===selMese.m && x.y===selMese.y;
const isF  = isFuture(x);
const hasD = lezMese(x.m, x.y).length > 0;
return (
<button key={`${x.y}-${x.m}`} onClick={()=>!isF && setSelMese(x)} disabled={isF}
style={{padding:â€œ5px 12pxâ€,borderRadius:20,fontSize:12,fontWeight:isS?600:400,
border:`1px solid ${isS?accentHex:hasD?accentHex+"50":C.border}`,
background:isS?accentHex:hasD?accentHex+â€œ15â€:C.bg,
color:isS?C.bg:isF?C.textDim:hasD?accentHex:C.textMuted,
cursor:isF?â€œnot-allowedâ€:â€œpointerâ€,opacity:isF?0.4:1,transition:â€œall 0.15sâ€}}>
{MESI_LABEL_S[x.m-1]}
{hasD && !isF && <span style={{display:â€œinline-blockâ€,width:4,height:4,borderRadius:â€œ50%â€,
background:isS?C.bg:accentHex,marginLeft:5,verticalAlign:â€œmiddleâ€}}/>}
</button>
);
})}
</div>
</div>
);

// Grafico barre anno scolastico
const GraficoAS = () => (
<div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:â€œ16px 20pxâ€,marginBottom:16}}>
<div style={{display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,alignItems:â€œcenterâ€,marginBottom:14}}>
<div style={{fontSize:11,color:C.textMuted,letterSpacing:â€œ0.07emâ€,textTransform:â€œuppercaseâ€}}>Andamento anno scolastico</div>
<div style={{fontSize:11,color:C.textDim}}>Totale: {andamento.reduce((t,x)=>t+x.n,0)} lezioni</div>
</div>
<div style={{display:â€œflexâ€,alignItems:â€œflex-endâ€,gap:4,height:80}}>
{andamento.map(x => (
<div key={`${x.y}-${x.m}`} onClick={()=>!x.isFut && setSelMese({m:x.m,y:x.y})}
style={{flex:1,display:â€œflexâ€,flexDirection:â€œcolumnâ€,alignItems:â€œcenterâ€,gap:4,cursor:x.isFut?â€œdefaultâ€:â€œpointerâ€}}>
<div style={{fontSize:9,color:x.isSel?accentHex:C.textDim,fontWeight:x.isSel?700:400,lineHeight:1}}>
{x.isFut?â€â€:x.n||â€â€}
</div>
<div style={{width:â€œ100%â€,borderRadius:â€œ3px 3px 0 0â€,minHeight:4,
background:x.isFut?C.border:x.isSel?accentHex:`${accentHex}45`,
height:`${x.isFut?4:Math.round((x.n/maxN)*60)+4}px`,
outline:x.isSel?`2px solid ${accentHex}`:â€œnoneâ€,outlineOffset:1,transition:â€œall 0.2sâ€}}/>
<div style={{fontSize:9,color:x.isSel?accentHex:C.textDim,textTransform:â€œuppercaseâ€,fontWeight:x.isSel?700:400}}>{x.label}</div>
</div>
))}
</div>
</div>
);

// â”€â”€ handlers quote â€” scrivono su sharedEntrate â”€â”€
const registraPagamento = (m, y) => {
const MESI_ALL = [â€œGennaioâ€,â€œFebbraioâ€,â€œMarzoâ€,â€œAprileâ€,â€œMaggioâ€,â€œGiugnoâ€,â€œLuglioâ€,â€œAgostoâ€,â€œSettembreâ€,â€œOttobreâ€,â€œNovembreâ€,â€œDicembreâ€];
const newE = {
id: uid(), studentId:student.id, studentName:student.name,
importo: student.monthlyFee, mese:m, anno:y,
data: new Date().toISOString().split(â€œTâ€)[0],
metodo:â€œBonifico bancarioâ€,
desc:`Quota mensile ${MESI_ALL[m-1]} ${y} â€” ${student.name}`,
};
setEntrate(p=>[â€¦p,newE]);
};
const eliminaPagamento = (id) => setEntrate(p=>p.filter(e=>e.id!==id));

const TABS = [
{id:â€œinfoâ€,       label:â€œInformazioniâ€, icon:â€œuserâ€},
{id:â€œlezioniâ€,    label:â€œLezioniâ€,      icon:â€œcalendarâ€},
{id:â€œrepertorioâ€, label:â€œRepertorioâ€,   icon:â€œmusicâ€},
{id:â€œquoteâ€,      label:â€œQuoteâ€,        icon:â€œeuroâ€},
];

return (
<div style={{animation:â€œslideIn 0.25s easeâ€}}>
<button onClick={onBack} style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:6,background:â€œnoneâ€,border:â€œnoneâ€,cursor:â€œpointerâ€,color:C.textMuted,fontSize:13,marginBottom:20,padding:0,fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€}}>
<Ic n="back" size={16}/> Tutti gli allievi
</button>

```
  {/* Header */}
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,marginBottom:24,padding:"16px 20px",borderTop:`3px solid ${accentHex}`}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
      <div style={{display:"flex",alignItems:"center",gap:16}}>
        <div style={{width:60,height:60,borderRadius:"50%",background:`${accentHex}20`,border:`2px solid ${accentHex}40`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,fontWeight:700,accentHex,fontFamily:"'Cormorant Garamond',serif"}}>
          {initials(student.name)}
        </div>
        <div>
          <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600,marginBottom:6}}>{student.name}</h1>
          <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"}}>
            <Badge label={student.instrument} accentHex="gold"/>
            {comp && <Badge label={comp.name} accentHex="purple"/>}
            <span style={{color:C.textDim}}>Â·</span>
            <span style={{fontSize:13,color:C.textMuted}}>{student.teacher}</span>
            <span style={{color:C.textDim}}>Â·</span>
            <Badge label={student.status} accentHex={student.status==="attivo"?"green":student.status==="sospeso"?"gold":"red"}/>
          </div>
        </div>
      </div>
      <div style={{display:"flex",gap:8}}>
        <Btn variant="secondary" onClick={onEdit}><Ic n="edit" size={14}/>Modifica</Btn>
        <Btn danger onClick={onDelete}><Ic n="trash" size={14} accentHex={C.red}/></Btn>
      </div>
    </div>
    {/* KPI strip â€” aggiornano col mese selezionato */}
    <div style={{display:"grid",gridTemplateColumns:isMobile?"1fr 1fr":"repeat(4,1fr)",gap:isMobile?10:12,marginTop:20,paddingTop:20,borderTop:`1px solid ${C.border}`}}>
      {[
        {label:"Quota mensile",        value:`â‚¬ ${student.monthlyFee}`,    sub:student.feeType,   hex:C.gold},
        {label:`Lez. ${MESI_LABEL_S[selMese.m-1]}`, value:lezSel.length,  sub:"lezioni",          hex:accentHex},
        {label:"Brani in studio",      value:repInStudio.length,           sub:"repertorio",       hex:C.purple},
        {label:"Versato anno",         value:`â‚¬ ${totaleVersato}`,         sub:`${entrateStudent.length} rate pagate`, hex:C.green},
      ].map(k => (
        <div key={k.label} style={{background:C.bg,borderRadius:10,padding:"12px 16px",border:`1px solid ${C.border}`}}>
          <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:k.hex,lineHeight:1}}>{k.value}</div>
          <div style={{fontSize:10,color:C.textDim,textTransform:"uppercase",letterSpacing:"0.08em",marginTop:4}}>{k.label}</div>
          <div style={{fontSize:10,color:C.textDim,marginTop:2}}>{k.sub}</div>
        </div>
      ))}
    </div>
  </div>

  {/* Tabs */}
  <div style={{display:"flex",borderBottom:`1px solid ${C.border}`,marginBottom:22}}>
    {TABS.map(t => (
      <button key={t.id} onClick={()=>setTab(t.id)}
        style={{display:"flex",alignItems:"center",gap:6,padding:"10px 18px",background:"none",
          border:"none",borderBottom:`2px solid ${tab===t.id?accentHex:"transparent"}`,
          color:tab===t.id?accentHex:C.textMuted,cursor:"pointer",fontFamily:"'DM Sans',sans-serif",
          fontSize:13,transition:"all 0.15s",marginBottom:-1}}>
        <Ic n={t.icon} size={13} stroke={tab===t.id?accentHex:C.textMuted}/>{t.label}
      </button>
    ))}
  </div>

  {/* â”€â”€ INFORMAZIONI â”€â”€ */}
  {tab==="info" && (
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}} className="form-2col">
      {[
        {icon:"mail",    label:"Email",       value:student.email||"â€”"},
        {icon:"phone",   label:"Telefono",     value:student.phone||"â€”"},
        {icon:"user",    label:"EtÃ ",          value:student.birthdate?`${age(student.birthdate)} anni`:"â€”"},
        {icon:"music",   label:"Livello",      value:student.level||"â€”"},
        {icon:"calendar",label:"Iscritto dal", value:fmtDate(student.enrollDate)||"â€”"},
        {icon:"euro",    label:"Quota mensile",value:`â‚¬ ${student.monthlyFee} (${student.feeType})`},
      ].map(r => (
        <div key={r.label} style={{display:"flex",gap:12,alignItems:"flex-start",padding:"14px 16px",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10}}>
          <Ic n={r.icon} size={16} accentHex={C.textMuted}/>
          <div>
            <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase",marginBottom:3}}>{r.label}</div>
            <div style={{fontSize:14}}>{r.value}</div>
          </div>
        </div>
      ))}
      {comp && (
        <div style={{display:"flex",gap:12,alignItems:"flex-start",padding:"14px 16px",background:C.purpleBg,border:`1px solid ${C.purpleBorder}`,borderRadius:10}}>
          <Ic n="group" size={16} accentHex={C.purple}/>
          <div>
            <div style={{fontSize:11,color:C.purple,letterSpacing:"0.06em",textTransform:"uppercase",marginBottom:3,opacity:0.7}}>Corso complementare</div>
            <div style={{fontSize:14,color:C.purple,fontWeight:500}}>{comp.name}</div>
            {comp.description && <div style={{fontSize:12,color:C.textMuted,marginTop:2}}>{comp.description}</div>}
          </div>
        </div>
      )}
      {student.notes && (
        <div style={{gridColumn:"1/-1",padding:"14px 16px",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10}}>
          <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase",marginBottom:6}}>Note</div>
          <div style={{fontSize:13,color:C.textMuted,lineHeight:1.6}}>{student.notes}</div>
        </div>
      )}
    </div>
  )}

  {/* â”€â”€ LEZIONI â”€â”€ */}
  {tab==="lezioni" && (
    <div>
      <MeseSelector/>
      <GraficoAS/>
      {/* Lista lezioni mese selezionato */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden",marginBottom:16}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <Ic n="calendar" size={14} stroke={C.textMuted}/>
            <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>
              {MESI_LABEL_L[selMese.m-1]} {selMese.y}
            </span>
          </div>
          <div style={{display:"flex",gap:10,alignItems:"center"}}>
            <span style={{fontSize:12,color:C.textDim}}>{lezSel.length} lezioni</span>
            {lezSel.filter(l=>l.attendance==="presente").length>0 && (
              <span style={{fontSize:11,background:C.greenBg,color:C.green,border:`1px solid ${C.greenBorder}`,borderRadius:4,padding:"2px 8px"}}>
                {lezSel.filter(l=>l.attendance==="presente").length} pres.
              </span>
            )}
            {lezSel.filter(l=>l.attendance==="assente").length>0 && (
              <span style={{fontSize:11,background:C.redBg,color:C.red,border:`1px solid ${C.redBorder}`,borderRadius:4,padding:"2px 8px"}}>
                {lezSel.filter(l=>l.attendance==="assente").length} ass.
              </span>
            )}
          </div>
        </div>
        {lezSel.length===0 ? (
          <div style={{textAlign:"center",padding:"40px 0",color:C.textDim,fontSize:13}}>
            {isFuture(selMese)?"Mese non ancora iniziato":"Nessuna lezione registrata"}
          </div>
        ) : (
          lezSel.slice().sort((a,b)=>a.date.localeCompare(b.date)||a.hour.localeCompare(b.hour)).map((l,i) => (
            <div key={l.id} style={{display:"grid",gridTemplateColumns:"90px 1fr auto",gap:12,alignItems:"center",
              padding:"12px 20px",borderBottom:i<lezSel.length-1?`1px solid ${C.border}`:"none",
              borderLeft:`3px solid ${isColl(l)?C.purple:"transparent"}`,
              background:isColl(l)?`${C.purple}06`:"transparent"}}>
              <div>
                <div style={{fontSize:11,color:C.textDim}}>{new Date(l.date+"T00:00:00").toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})}</div>
                <div style={{fontSize:13,fontWeight:600,color:isColl(l)?C.purple:accentHex}}>{l.hour}</div>
              </div>
              <div>
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <span style={{fontSize:13,fontWeight:500}}>{isColl(l)?l.courseName:l.topic||"â€”"}</span>
                  {isColl(l) && <span style={{fontSize:10,background:C.purpleBg,color:C.purple,
                    border:`1px solid ${C.purpleBorder}`,borderRadius:4,padding:"1px 6px",letterSpacing:"0.05em"}}>collettiva</span>}
                </div>
                <div style={{fontSize:11,color:C.textMuted}}>
                  {isColl(l)
                    ? `${(l.students||[]).length} allievi Â· ${l.room||"â€”"} Â· ${l.teacher}`
                    : `${l.instrument} Â· ${l.room||"â€”"} Â· ${l.teacher}`}
                </div>
              </div>
              {l.attendance
                ? <Badge label={l.attendance} accentHex={l.attendance==="presente"?"green":l.attendance==="assente"?"red":"gold"}/>
                : <span style={{fontSize:11,color:C.textDim}}>â€”</span>
              }
            </div>
          ))
        )}
      </div>
      {/* Tabella riepilogo anno */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`}}>
          <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Riepilogo anno scolastico</span>
        </div>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:`1px solid ${C.border}`,background:C.bg}}>
              {["Mese","Lezioni","Presenti","Assenti","Tasso pres."].map(h=>(
                <th key={h} style={{padding:"10px 18px",textAlign:"left",fontSize:10,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {MESI_AS.map((x,i) => {
              const lm   = lezMese(x.m, x.y);
              const pres = lm.filter(l=>l.attendance==="presente").length;
              const ass  = lm.filter(l=>l.attendance==="assente").length;
              const att  = lm.filter(l=>l.attendance).length;
              const tasso= att>0 ? Math.round((pres/att)*100) : null;
              const isS  = x.m===selMese.m && x.y===selMese.y;
              const isF  = isFuture(x);
              return (
                <tr key={i} onClick={()=>!isF&&setSelMese(x)}
                  style={{borderBottom:i<MESI_AS.length-1?`1px solid ${C.border}`:"none",
                    background:isS?`${accentHex}12`:"transparent",
                    cursor:isF?"default":"pointer",opacity:isF?0.45:1,transition:"background 0.12s"}}
                  onMouseEnter={e=>{if(!isF&&!isS)e.currentTarget.style.background=C.surfaceHover;}}
                  onMouseLeave={e=>{e.currentTarget.style.background=isS?`${accentHex}12`:"transparent";}}>
                  <td style={{padding:"11px 18px",fontSize:13,fontWeight:isS?600:400,color:isS?accentHex:C.text}}>
                    {MESI_LABEL_L[x.m-1]} {x.y}
                  </td>
                  <td style={{padding:"11px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:isF?C.textDim:lm.length>0?accentHex:C.textDim}}>
                    {isF?"â€”":lm.length}
                  </td>
                  <td style={{padding:"11px 18px",fontSize:13,color:C.green}}>{isF?"â€”":pres||"â€”"}</td>
                  <td style={{padding:"11px 18px",fontSize:13,color:ass>0?C.red:C.textDim}}>{isF?"â€”":ass||"â€”"}</td>
                  <td style={{padding:"11px 18px"}}>
                    {!isF && tasso!==null ? (
                      <div style={{display:"flex",alignItems:"center",gap:8}}>
                        <div style={{flex:1,height:4,background:C.border,borderRadius:2,maxWidth:60}}>
                          <div style={{height:"100%",borderRadius:2,background:tasso>=80?C.green:tasso>=60?C.gold:C.red,width:`${tasso}%`}}/>
                        </div>
                        <span style={{fontSize:12,color:tasso>=80?C.green:tasso>=60?C.gold:C.red}}>{tasso}%</span>
                      </div>
                    ) : <span style={{color:C.textDim}}>â€”</span>}
                  </td>
                </tr>
              );
            })}
          </tbody>
          <tfoot>
            <tr style={{borderTop:`2px solid ${C.border}`,background:C.bg}}>
              <td style={{padding:"11px 18px",fontSize:12,color:C.textMuted,fontWeight:600}}>TOTALE ANNO</td>
              <td style={{padding:"11px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,accentHex}}>
                {andamento.reduce((t,x)=>t+x.n,0)}
              </td>
              <td style={{padding:"11px 18px",fontSize:13,color:C.green}}>
                {andamento.reduce((t,x)=>t+lezMese(x.m,x.y).filter(l=>l.attendance==="presente").length,0)}
              </td>
              <td style={{padding:"11px 18px",fontSize:13,color:C.red}}>
                {andamento.reduce((t,x)=>t+lezMese(x.m,x.y).filter(l=>l.attendance==="assente").length,0)}
              </td>
              <td/>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  )}

  {/* â”€â”€ REPERTORIO â”€â”€ */}
  {tab==="repertorio" && (
    <div style={{display:"flex",flexDirection:"column",gap:16}}>
      {/* KPI strip */}
      <div className="stat-strip-3">
        {[
          {label:"In studio",    value:repInStudio.length,   hex:accentHex,   sub:"brani correnti"},
          {label:"Completati",   value:repCompletato.length, hex:C.green, sub:"studiati quest'anno"},
          {label:"Totale",       value:repertorio.length,    hex:C.textMuted, sub:"nel registro"},
        ].map(k => (
          <div key={k.label} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"16px 18px",borderTop:`3px solid ${k.hex}30`}}>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,color:k.hex,lineHeight:1}}>{k.value}</div>
            <div style={{fontSize:11,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.07em",marginTop:6}}>{k.label}</div>
            <div style={{fontSize:11,color:C.textDim,marginTop:2}}>{k.sub}</div>
          </div>
        ))}
      </div>

      {/* Brani in studio */}
      {repInStudio.length > 0 && (
        <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
          <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
            <div style={{width:8,height:8,borderRadius:"50%",background:accentHex}}/>
            <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>In studio</span>
          </div>
          {repInStudio.map((b,i) => (
            <div key={b.id} style={{padding:"14px 20px",borderBottom:i<repInStudio.length-1?`1px solid ${C.border}`:"none",
              display:"grid",gridTemplateColumns:"1fr auto",gap:12,alignItems:"start"}}>
              <div>
                <div style={{fontSize:14,fontWeight:600,marginBottom:3}}>{b.titolo}</div>
                <div style={{fontSize:12,color:C.textMuted}}>{b.compositore} Â· <span style={{color:`${accentHex}cc`,fontStyle:"italic"}}>{b.periodo}</span></div>
                {b.note && <div style={{fontSize:12,color:C.textDim,marginTop:4,fontStyle:"italic"}}>{b.note}</div>}
              </div>
              <div style={{textAlign:"right",flexShrink:0}}>
                <div style={{fontSize:11,color:C.textDim}}>dal {fmtDate(b.dataInizio)}</div>
                <span style={{display:"inline-block",marginTop:4,fontSize:10,background:`${accentHex}20`,accentHex,border:`1px solid ${accentHex}50`,borderRadius:4,padding:"2px 8px",textTransform:"uppercase",letterSpacing:"0.07em"}}>in studio</span>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Brani completati */}
      {repCompletato.length > 0 && (
        <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
          <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
            <div style={{width:8,height:8,borderRadius:"50%",background:C.green}}/>
            <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Completati</span>
          </div>
          {repCompletato.map((b,i) => (
            <div key={b.id} style={{padding:"14px 20px",borderBottom:i<repCompletato.length-1?`1px solid ${C.border}`:"none",
              display:"grid",gridTemplateColumns:"1fr auto",gap:12,alignItems:"start",opacity:0.75}}>
              <div>
                <div style={{fontSize:14,fontWeight:500,marginBottom:3}}>{b.titolo}</div>
                <div style={{fontSize:12,color:C.textMuted}}>{b.compositore} Â· <span style={{fontStyle:"italic"}}>{b.periodo}</span></div>
                {b.note && <div style={{fontSize:12,color:C.textDim,marginTop:4,fontStyle:"italic"}}>{b.note}</div>}
              </div>
              <div style={{textAlign:"right",flexShrink:0}}>
                <div style={{fontSize:11,color:C.textDim}}>dal {fmtDate(b.dataInizio)}</div>
                <span style={{display:"inline-block",marginTop:4,fontSize:10,background:C.greenBg,color:C.green,border:`1px solid ${C.greenBorder}`,borderRadius:4,padding:"2px 8px",textTransform:"uppercase",letterSpacing:"0.07em"}}>completato</span>
              </div>
            </div>
          ))}
        </div>
      )}

      {repertorio.length === 0 && (
        <div style={{textAlign:"center",padding:"56px 0",color:C.textDim,fontSize:14}}>
          Nessun brano nel registro
        </div>
      )}
    </div>
  )}

  {/* â”€â”€ QUOTE â”€â”€ */}
  {tab==="quote" && (
    <div>
      <MeseSelector/>
      {/* Grafico a barre entrate anno scolastico */}
      {(() => {
        const vals = MESI_AS.map(x=>entrataPerMese(x.m,x.y)?.importo||0);
        const maxV = Math.max(...vals, 1);
        const totAnno = vals.reduce((t,v)=>t+v,0);
        const MESI_S2 = ["Set","Ott","Nov","Dic","Gen","Feb","Mar","Apr","Mag","Giu"];
        return (
          <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"16px 20px",marginBottom:16}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
              <span style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase"}}>Andamento anno scolastico</span>
              <span style={{fontSize:11,color:C.textDim}}>Totale incassato: â‚¬{totAnno.toLocaleString("it-IT")}</span>
            </div>
            <div style={{display:"flex",alignItems:"flex-end",gap:4,height:80}}>
              {MESI_AS.map((x,i)=>{
                const isS=x.m===selMese.m&&x.y===selMese.y, isF=isFuture(x);
                const v=vals[i], h=isF?4:Math.round((v/maxV)*64)+4;
                return (
                  <div key={i} onClick={()=>!isF&&setSelMese(x)}
                    style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:3,cursor:isF?"default":"pointer"}}>
                    <div style={{fontSize:9,color:isS?accentHex:C.textDim,fontWeight:isS?700:400}}>{(!isF&&v>0)?`â‚¬${v}`:""}</div>
                    <div style={{width:"100%",borderRadius:"3px 3px 0 0",minHeight:4,height:h,
                      background:isF?C.border:isS?accentHex:`${accentHex}45`,
                      outline:isS?`2px solid ${accentHex}`:"none",outlineOffset:1,transition:"all 0.2s"}}/>
                    <div style={{fontSize:9,color:isS?accentHex:C.textDim,textTransform:"uppercase",fontWeight:isS?700:400}}>{MESI_S2[i]}</div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      })()}
      {/* KPI mese selezionato */}
      {(() => {
        const entSel  = entrataPerMese(selMese.m, selMese.y);
        const pm = selMese.m===1?12:selMese.m-1, py = selMese.m===1?selMese.y-1:selMese.y;
        const entPrev = entrataPerMese(pm, py);
        const MESI_ALL2 = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
        const MESI_S3 = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
        return (
          <>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:12,marginBottom:16}}>
              {[
                {label:"Quota mensile",           value:`â‚¬${student.monthlyFee}`,         desc:student.feeType,      hex:accentHex},
                {label:`Stato ${MESI_S3[selMese.m-1]} ${selMese.y}`,
                 value: entSel?"Pagata":"Non pagata",
                 desc:  entSel?`il ${new Date(entSel.data+"T00:00:00").toLocaleDateString("it-IT")}`:
                        isFuture(selMese)?"mese futuro":"quota mancante",
                 hex:   entSel?C.green:isFuture(selMese)?C.textDim:C.red},
                {label:`Incassato ${MESI_S3[selMese.m-1]}`,
                 value: entSel?`â‚¬${entSel.importo.toLocaleString("it-IT")}`:"â€”",
                 desc:  entPrev?`mese prec.: â‚¬${entPrev.importo}`:"primo mese",
                 hex:   entSel?C.green:C.textDim},
              ].map(k=>(
                <div key={k.label} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"18px 20px",borderTop:`3px solid ${k.hex}30`}}>
                  <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,color:k.hex,lineHeight:1,marginBottom:6}}>{k.value}</div>
                  <div style={{fontSize:11,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.07em"}}>{k.label}</div>
                  <div style={{fontSize:11,color:C.textDim,marginTop:4}}>{k.desc}</div>
                </div>
              ))}
            </div>
            {/* Dettaglio mese selezionato */}
            <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden",marginBottom:16}}>
              <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,
                display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                <span style={{fontSize:12,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase"}}>
                  Dettaglio {MESI_ALL2[selMese.m-1]} {selMese.y}
                </span>
                <span style={{fontSize:13,fontWeight:600,color:entSel?C.green:C.textDim}}>
                  {entSel?`â‚¬${entSel.importo.toLocaleString("it-IT")}`:"Non pagata"}
                </span>
              </div>
              {entSel ? (
                <div style={{display:"grid",gridTemplateColumns:"80px 1fr auto",gap:12,alignItems:"center",padding:"14px 20px"}}>
                  <div>
                    <div style={{fontSize:11,color:C.textDim}}>{new Date(entSel.data+"T00:00:00").toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})}</div>
                  </div>
                  <div>
                    <div style={{fontSize:13,fontWeight:500}}>{entSel.desc}</div>
                    <div style={{fontSize:11,color:C.textMuted,marginTop:2}}>{entSel.metodo}</div>
                  </div>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <div style={{fontSize:15,fontWeight:600,color:C.green}}>â‚¬{entSel.importo}</div>
                    <button onClick={()=>setRicevutaEnt(entSel)} title="Stampa ricevuta"
                      style={{background:C.goldBg,border:`1px solid ${C.goldDim}`,borderRadius:6,
                        cursor:"pointer",color:C.gold,padding:"4px 8px",display:"flex",alignItems:"center",gap:4,fontSize:11}}
                      onMouseEnter={e=>{e.currentTarget.style.background=C.gold;e.currentTarget.style.color=C.bg;}}
                      onMouseLeave={e=>{e.currentTarget.style.background=C.goldBg;e.currentTarget.style.color=C.gold;}}>
                      <Ic n="receipt" size={12} stroke="currentColor"/>Ricevuta
                    </button>
                    <button onClick={()=>eliminaPagamento(entSel.id)}
                      style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4,display:"flex",borderRadius:6}}
                      onMouseEnter={e=>e.currentTarget.style.color=C.red}
                      onMouseLeave={e=>e.currentTarget.style.color=C.textMuted}>
                      <Ic n="trash" size={14} stroke="currentColor"/>
                    </button>
                  </div>
                </div>
              ) : (
                <div style={{padding:"24px 20px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <span style={{fontSize:13,color:C.textDim,fontStyle:"italic"}}>
                    {isFuture(selMese)?"Mese non ancora iniziato":"Quota non registrata"}
                  </span>
                  {!isFuture(selMese) && (
                    <button onClick={()=>registraPagamento(selMese.m,selMese.y)}
                      style={{padding:"8px 18px",borderRadius:8,cursor:"pointer",
                        background:C.greenBg,color:C.green,border:`1px solid ${C.greenBorder}`,
                        fontFamily:"'DM Sans',sans-serif",fontSize:13,fontWeight:500,
                        display:"flex",alignItems:"center",gap:6}}>
                      <Ic n="check" size={14} stroke={C.green}/>Registra pagamento
                    </button>
                  )}
                </div>
              )}
            </div>
          </>
        );
      })()}
      {/* Tabella quote anno scolastico */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`}}>
          <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>
            Quote anno scolastico {annoInizio}/{String(annoInizio+1).slice(-2)}
          </span>
        </div>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:`1px solid ${C.border}`,background:C.bg}}>
              {["Mese","Importo","Stato","vs mese prec.",""].map(h=>(
                <th key={h} style={{padding:"10px 18px",textAlign:"left",fontSize:10,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {MESI_AS.map((x,i)=>{
              const pm = x.m===1?12:x.m-1, py = x.m===1?x.y-1:x.y;
              const ent  = entrataPerMese(x.m,x.y);
              const entP = entrataPerMese(pm,py);
              const isS  = x.m===selMese.m&&x.y===selMese.y;
              const isF  = isFuture(x);
              const stColor = ent?C.green:isF?C.textDim:C.red;
              const stBg    = ent?C.greenBg:isF?C.bg:C.redBg;
              const stBd    = ent?C.greenBorder:isF?C.border:C.redBorder;
              const stato   = ent?"pagata":isF?"futuro":"non pagata";
              return (
                <tr key={i} onClick={()=>!isF&&setSelMese(x)}
                  style={{borderBottom:i<MESI_AS.length-1?`1px solid ${C.border}`:"none",
                    background:isS?`${accentHex}12`:"transparent",
                    cursor:isF?"default":"pointer",opacity:isF?0.45:1,transition:"background 0.12s"}}
                  onMouseEnter={e=>{if(!isF&&!isS)e.currentTarget.style.background=C.surfaceHover;}}
                  onMouseLeave={e=>{e.currentTarget.style.background=isS?`${accentHex}12`:"transparent";}}>
                  <td style={{padding:"11px 18px",fontSize:13,fontWeight:isS?600:400,color:isS?accentHex:C.text}}>
                    {["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][x.m-1]} {x.y}
                  </td>
                  <td style={{padding:"11px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,
                    color:ent?C.green:isF?C.textDim:C.red}}>
                    {isF?"â€”":ent?`â‚¬${ent.importo}`:`â‚¬${student.monthlyFee}`}
                  </td>
                  <td style={{padding:"11px 18px"}}>
                    <span style={{fontSize:11,background:stBg,color:stColor,border:`1px solid ${stBd}`,
                      borderRadius:4,padding:"2px 8px",letterSpacing:"0.06em"}}>{stato}</span>
                  </td>
                  <td style={{padding:"11px 18px"}}>
                    {!isF && (
                      ent && entP ? (
                        <span style={{fontSize:12,color:C.green}}>= mese prec.</span>
                      ) : ent && !entP ? (
                        <span style={{fontSize:11,color:C.textDim}}>primo pagamento</span>
                      ) : !ent && entP ? (
                        <span style={{fontSize:12,color:C.red}}>mese prec. pagata</span>
                      ) : (
                        <span style={{color:C.textDim}}>â€”</span>
                      )
                    )}
                    {isF && <span style={{color:C.textDim}}>â€”</span>}
                  </td>
                  <td style={{padding:"11px 12px"}} onClick={e=>e.stopPropagation()}>
                    {ent && (
                      <button onClick={()=>setRicevutaEnt(ent)} title="Stampa ricevuta"
                        style={{background:C.goldBg,border:`1px solid ${C.goldDim}`,borderRadius:6,
                          cursor:"pointer",color:C.gold,padding:"3px 8px",display:"flex",alignItems:"center",gap:4,fontSize:11,
                          fontFamily:"'DM Sans',sans-serif"}}
                        onMouseEnter={e=>{e.currentTarget.style.background=C.gold;e.currentTarget.style.color=C.bg;}}
                        onMouseLeave={e=>{e.currentTarget.style.background=C.goldBg;e.currentTarget.style.color=C.gold;}}>
                        <Ic n="receipt" size={11} stroke="currentColor"/>
                      </button>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
          <tfoot>
            <tr style={{borderTop:`2px solid ${C.border}`,background:C.bg}}>
              <td style={{padding:"11px 18px",fontSize:12,color:C.textMuted,fontWeight:600}}>TOTALE ANNO</td>
              <td style={{padding:"11px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:C.green}}>
                â‚¬{totaleVersato.toLocaleString("it-IT")}
              </td>
              <td style={{padding:"11px 18px",fontSize:12,color:C.textMuted}}>
                {entrateStudent.length} su {MESI_AS.filter(x=>!isFuture(x)).length} mesi
              </td>
              <td style={{padding:"11px 18px"}}/><td/>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  )}
  {ricevutaEnt && (
    <RicevutaModal
      entrata={ricevutaEnt}
      student={student}
      config={config}
      onClose={()=>setRicevutaEnt(null)}
    />
  )}
</div>
```

);
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTA ALLIEVI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const StudentList = ({ students, courses, onSelect, onAdd, onEdit, onDelete }) => {
const [search, setSearch]           = useState(â€â€);
const [filterInstrument, setFI]     = useState(â€â€);
const [filterStatus, setFS]         = useState(â€â€);
const [filterCourse, setFC]         = useState(â€â€);
const [showFilters, setShowFilters] = useState(false);

const collettivi = courses.filter(c=>c.type===â€œcollettivoâ€);

const filtered = students.filter(s=>{
const q    = search.toLowerCase();
const comp = courses.find(c=>c.id===s.complementaryCourse);
return (!q || s.name.toLowerCase().includes(q) || s.instrument.toLowerCase().includes(q) || s.email?.toLowerCase().includes(q) || comp?.name.toLowerCase().includes(q))
&& (!filterInstrument || s.instrument===filterInstrument)
&& (!filterStatus     || s.status===filterStatus)
&& (!filterCourse     || s.complementaryCourse===filterCourse);
});

const hasFilters = filterInstrument||filterStatus||filterCourse;

return (
<div style={{display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:20}}>
<div style={{display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,alignItems:â€œflex-startâ€,flexWrap:â€œwrapâ€,gap:12}}>
<div>
<h1 style={{fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€,fontSize:â€œclamp(22px,4vw,32px)â€,fontWeight:600}}>Anagrafica Allievi</h1>
<p style={{color:C.textMuted,fontSize:14,marginTop:4}}>{students.filter(s=>s.status===â€œattivoâ€).length} attivi Â· {students.length} totali</p>
</div>
<Btn onClick={onAdd}><Ic n="plus" size={14} color={C.bg}/>Nuovo allievo</Btn>
</div>

```
  <div style={{display:"flex",gap:10}}>
    <div style={{position:"relative",flex:1}}>
      <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:C.textDim}}><Ic n="search" size={16}/></span>
      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cerca per nome, strumento, corso complementare..."
        style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,color:C.text,fontSize:14,padding:"10px 14px 10px 40px",fontFamily:"'DM Sans',sans-serif"}}/>
    </div>
    <Btn variant={showFilters||hasFilters?"primary":"secondary"} onClick={()=>setShowFilters(p=>!p)}>
      <Ic n="filter" size={14} color={showFilters||hasFilters?C.bg:C.textMuted}/>
      Filtri {hasFilters?`(${[filterInstrument,filterStatus,filterCourse].filter(Boolean).length})`:""}
    </Btn>
  </div>

  {showFilters && (
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:10,padding:"12px 14px",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,animation:"fadeIn 0.2s ease",alignItems:"end"}}>
      <Sel label="Strumento" value={filterInstrument} onChange={e=>setFI(e.target.value)} options={INSTRUMENTS}/>
      <Sel label="Stato" value={filterStatus} onChange={e=>setFS(e.target.value)} options={["attivo","inattivo","sospeso"]}/>
      <Sel label="Corso complementare" value={filterCourse} onChange={e=>setFC(e.target.value)} options={collettivi.map(c=>({value:c.id,label:c.name}))}/>
      <Btn small variant="ghost" onClick={()=>{setFI("");setFS("");setFC("");}}>Reset</Btn>
    </div>
  )}

  <div style={{fontSize:12,color:C.textDim}}>{filtered.length} alliev{filtered.length!==1?"i":"o"} trovat{filtered.length!==1?"i":"o"}</div>

  <div className="table-outer" style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
    <div>
    {filtered.length===0
      ? <div style={{textAlign:"center",padding:"48px 0",color:C.textDim}}><Ic n="search" size={28} color={C.textDim}/><p style={{marginTop:12,fontSize:13}}>Nessun allievo trovato</p></div>
      : <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:`1px solid ${C.border}`}}>
              {[
                {l:"Allievo",cls:""},
                {l:"Corso principale",cls:""},
                {l:"Corso complementare",cls:"hide-mobile"},
                {l:"Insegnante",cls:"hide-mobile"},
                {l:"Quota",cls:""},
                {l:"Stato",cls:"resp-hide"},
                {l:"",cls:""},
              ].map(({l:h,cls})=>(
                <th key={h} className={cls} style={{padding:"11px 16px",textAlign:"left",fontSize:11,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {filtered.map((s,i)=>{
              const ic   = INS_COLORS[s.instrument]||C.gold;
              const comp = courses.find(c=>c.id===s.complementaryCourse);
              return (
                <tr key={s.id} style={{borderBottom:i<filtered.length-1?`1px solid ${C.border}`:"none",cursor:"pointer",transition:"background 0.12s"}}
                  onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
                  onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                  <td style={{padding:"13px 16px"}} onClick={()=>onSelect(s)}>
                    <div style={{display:"flex",alignItems:"center",gap:10}}>
                      <div style={{width:34,height:34,borderRadius:"50%",background:`${ic}20`,border:`1px solid ${ic}40`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:700,color:ic,flexShrink:0}}>
                        {initials(s.name)}
                      </div>
                      <div>
                        <div style={{fontSize:14,fontWeight:500}}>{s.name}</div>
                        <div style={{fontSize:11,color:C.textMuted}}>{s.email||"â€”"}</div>
                      </div>
                    </div>
                  </td>
                  <td style={{padding:"13px 16px"}} onClick={()=>onSelect(s)}><Badge label={s.instrument} color="gold"/></td>
                  <td className="hide-mobile" style={{padding:"13px 16px"}} onClick={()=>onSelect(s)}>{comp?<Badge label={comp.name} color="purple"/>:<span style={{fontSize:12,color:C.textDim}}>â€”</span>}</td>
                  <td className="hide-mobile" style={{padding:"13px 16px",fontSize:13,color:C.textMuted}} onClick={()=>onSelect(s)}>{s.teacher}</td>
                  <td style={{padding:"13px 16px"}} onClick={()=>onSelect(s)}>
                    <div style={{fontSize:14}}>â‚¬ {s.monthlyFee}</div>
                    <div style={{fontSize:11,color:C.textDim}}>{s.feeType}</div>
                  </td>
                  <td className="resp-hide" style={{padding:"13px 16px"}} onClick={()=>onSelect(s)}>
                    <Badge label={s.status} color={s.status==="attivo"?"green":s.status==="sospeso"?"gold":"red"}/>
                  </td>
                  <td style={{padding:"13px 16px"}}>
                    <div style={{display:"flex",gap:4,justifyContent:"flex-end"}}>
                      <button onClick={e=>{e.stopPropagation();onEdit(s);}} style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:6,borderRadius:6,display:"flex"}}
                        onMouseEnter={e=>e.currentTarget.style.color=C.gold} onMouseLeave={e=>e.currentTarget.style.color=C.textMuted}><Ic n="edit" size={14}/></button>
                      <button onClick={e=>{e.stopPropagation();onDelete(s);}} style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:6,borderRadius:6,display:"flex"}}
                        onMouseEnter={e=>e.currentTarget.style.color=C.red} onMouseLeave={e=>e.currentTarget.style.color=C.textMuted}><Ic n="trash" size={14}/></button>
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
    }
    </div>
  </div>
</div>
```

);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP ROOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AllieviView = ({ students:propStudents, setStudents:propSetStudents, courses:propCourses, setCourses:propSetCourses, lessons:propLessons, entrate:propEntrate, setEntrate:propSetEntrate, annoInizioAttivo, config:propConfig }) => {
const isMobile = useIsMobile();
const [_students, _setStudents] = useState(INIT_STUDENTS);
const [_courses,  _setCourses]  = useState(INIT_COURSES);
const students    = propStudents    ?? _students;
const setStudents = propSetStudents ?? _setStudents;
const courses     = propCourses     ?? _courses;
const setCourses  = propSetCourses  ?? _setCourses;
const lessons     = propLessons     ?? [];
const entrate     = propEntrate    ?? [];
const setEntrate  = propSetEntrate ?? (()=>{});
const [view,     setView]     = useState(â€œlistâ€);
const [selected, setSelected] = useState(null);
const [modal,    setModal]    = useState(null);

const closeModal = () => setModal(null);

const handleAddStudent    = d  => { setStudents(p=>[â€¦p,{â€¦d,id:uid(),lessons:[]}]); closeModal(); };
const handleEditStudent   = d  => { setStudents(p=>p.map(s=>s.id===d.id?{â€¦s,â€¦d}:s)); if(selected?.id===d.id) setSelected(p=>({â€¦p,â€¦d})); closeModal(); };
const handleDeleteStudent = () => { setStudents(p=>p.filter(s=>s.id!==selected?.id)); setView(â€œlistâ€); setSelected(null); closeModal(); };
const handleAddLesson     = (sid,lesson) => {
setStudents(p=>p.map(s=>s.id===sid?{â€¦s,lessons:[â€¦(s.lessons||[]),lesson]}:s));
setSelected(p=>p?.id===sid?{â€¦p,lessons:[â€¦(p.lessons||[]),lesson]}:p);
};

return (
<>
<div style={{maxWidth:1200,margin:â€œ0 autoâ€,padding:â€œclamp(12px, 3vw, 32px)â€}}>
{view===â€œlistâ€ && (
<StudentList
students={students} courses={courses}
onSelect={s=>{setSelected(s);setView(â€œdetailâ€);}}
onAdd={()=>setModal(â€œaddâ€)}
onEdit={s=>{setSelected(s);setModal(â€œeditâ€);}}
onDelete={s=>{setSelected(s);setModal(â€œdeleteâ€);}}
/>
)}
{view===â€œdetailâ€ && selected && (
<StudentDetail
student={students.find(s=>s.id===selected.id)||selected}
courses={courses}
lessons={lessons}
entrate={entrate}
setEntrate={setEntrate}
annoInizioAttivo={annoInizioAttivo}
config={propConfig}
onEdit={()=>setModal(â€œeditâ€)}
onDelete={()=>setModal(â€œdeleteâ€)}
onBack={()=>setView(â€œlistâ€)}
onAddLesson={handleAddLesson}
onUpdateStudent={d=>setStudents(p=>p.map(s=>s.id===d.id?d:s))}
/>
)}
</div>
{modal===â€œaddâ€    && <Modal title="Nuovo allievo" onClose={closeModal} wide><StudentForm onSave={handleAddStudent} onClose={closeModal} courses={courses}/></Modal>}
{modal===â€œeditâ€   && selected && <Modal title="Modifica allievo" onClose={closeModal} wide><StudentForm initial={students.find(s=>s.id===selected.id)} onSave={handleEditStudent} onClose={closeModal} courses={courses}/></Modal>}
{modal===â€œdeleteâ€ && selected && <ConfirmDelete label={selected.name} description="Questa azione Ã¨ irreversibile." onConfirm={handleDeleteStudent} onClose={closeModal}/>}
</>
);
};

const CorsiView = ({ courses:propCourses, setCourses:propSetCourses, students:propStudents, setStudents:propSetStudents, docenti:propDocenti }) => {
const [_courses,  _setCourses]  = useState(INIT_COURSES);
const [_students, _setStudents] = useState(INIT_STUDENTS);
const courses     = propCourses     ?? _courses;
const setCourses  = propSetCourses  ?? _setCourses;
const students    = propStudents    ?? _students;
const setStudents = propSetStudents ?? _setStudents;
const docenti     = propDocenti     ?? [];

const handleAddCourse  = d  => setCourses(p=>[â€¦p,{â€¦d,id:uid()}]);
const handleEditCourse = d  => setCourses(p=>p.map(c=>c.id===d.id?{â€¦c,â€¦d}:c));
const handleDelCourse  = id => {
setCourses(p=>p.filter(c=>c.id!==id));
setStudents(p=>p.map(s=>s.complementaryCourse===id?{â€¦s,complementaryCourse:â€â€}:s));
};

return (
<div style={{maxWidth:1200,margin:â€œ0 autoâ€,padding:â€œclamp(12px, 3vw, 32px)â€}}>
<CourseManager
courses={courses}
students={students}
docenti={docenti}
onAdd={handleAddCourse}
onEdit={handleEditCourse}
onDelete={handleDelCourse}
/>
</div>
);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CALENDARIO LEZIONI

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DAYS_SHORT  = [â€œLunâ€,â€œMarâ€,â€œMerâ€,â€œGioâ€,â€œVenâ€,â€œSabâ€,â€œDomâ€];
const DAYS_FULL   = [â€œLunedÃ¬â€,â€œMartedÃ¬â€,â€œMercoledÃ¬â€,â€œGiovedÃ¬â€,â€œVenerdÃ¬â€,â€œSabatoâ€,â€œDomenicaâ€];
const MONTHS      = [â€œGennaioâ€,â€œFebbraioâ€,â€œMarzoâ€,â€œAprileâ€,â€œMaggioâ€,â€œGiugnoâ€,â€œLuglioâ€,â€œAgostoâ€,â€œSettembreâ€,â€œOttobreâ€,â€œNovembreâ€,â€œDicembreâ€];
const HOURS       = Array.from({length:15},(_,i)=>`${(i+8).toString().padStart(2,"0")}:00`);
const STUDENTS_LIST = [â€œSofia Marchettiâ€,â€œLuca Ferraraâ€,â€œEmma Contiâ€,â€œMarco Ricciâ€,â€œGiulia Romanoâ€,â€œAlessandro Galloâ€];
const ROOMS       = [â€œSala Aâ€,â€œSala Bâ€,â€œSala Câ€,â€œSala Grandeâ€,â€œStudio 1â€];
const RECURRENCE_OPTS = [â€œNessunaâ€,â€œOgni settimanaâ€,â€œOgni 2 settimaneâ€,â€œOgni meseâ€];
const DIFFICULTY_OPTS = [â€œPrincipianteâ€,â€œElementareâ€,â€œIntermedioâ€,â€œAvanzatoâ€,â€œProfessionaleâ€];
const TONALITY_OPTS   = [
â€œDo maggioreâ€,â€œSol maggioreâ€,â€œRe maggioreâ€,â€œLa maggioreâ€,â€œMi maggioreâ€,â€œSi maggioreâ€,â€œFa# maggioreâ€,â€œDo# maggioreâ€,
â€œFa maggioreâ€,â€œSiâ™­ maggioreâ€,â€œMiâ™­ maggioreâ€,â€œLaâ™­ maggioreâ€,â€œReâ™­ maggioreâ€,â€œSolâ™­ maggioreâ€,â€œDoâ™­ maggioreâ€,
â€œLa minoreâ€,â€œMi minoreâ€,â€œSi minoreâ€,â€œFa# minoreâ€,â€œDo# minoreâ€,â€œSol# minoreâ€,â€œRe# minoreâ€,â€œLa# minoreâ€,
â€œRe minoreâ€,â€œSol minoreâ€,â€œDo minoreâ€,â€œFa minoreâ€,â€œSiâ™­ minoreâ€,â€œMiâ™­ minoreâ€,â€œLaâ™­ minoreâ€,
â€œScala cromaticaâ€,â€œScala pentatonicaâ€,â€œBluesâ€,â€œModale - Doricoâ€,â€œModale - Frigioâ€,â€œModale - Lidioâ€,
];

const INIT_REPERTORIO = [
{ id:â€œr1â€,  title:â€œNotturno in Miâ™­ maggiore Op.9 n.2â€, composer:â€œFrÃ©dÃ©ric Chopinâ€,   tonality:â€œMiâ™­ maggioreâ€, difficulty:â€œAvanzatoâ€,      type:â€œindividualeâ€, notes:â€œCelebre notturno, richiede fraseggio cantabileâ€ },
{ id:â€œr2â€,  title:â€œInvenzione n.1 in Do maggioreâ€,      composer:â€œJohann S. Bachâ€,    tonality:â€œDo maggioreâ€,  difficulty:â€œIntermedioâ€,     type:â€œindividualeâ€, notes:â€œContrappunto a due vociâ€ },
{ id:â€œr3â€,  title:â€œPartita n.2 in Re minore BWV 1004â€, composer:â€œJohann S. Bachâ€,    tonality:â€œRe minoreâ€,    difficulty:â€œProfessionaleâ€,  type:â€œindividualeâ€, notes:â€œPer violino soloâ€ },
{ id:â€œr4â€,  title:â€œSonata K.331 in La maggioreâ€,        composer:â€œW.A. Mozartâ€,       tonality:â€œLa maggioreâ€,  difficulty:â€œIntermedioâ€,     type:â€œindividualeâ€, notes:â€œTema con variazioni, RondÃ² alla Turcaâ€ },
{ id:â€œr5â€,  title:â€œAccordi jazz - Standard ii-V-Iâ€,     composer:â€œTraditionalâ€,       tonality:â€œScala cromaticaâ€,difficulty:â€œIntermedioâ€,   type:â€œindividualeâ€, notes:â€œProgressione fondamentale jazzâ€ },
{ id:â€œr6â€,  title:â€œOde alla Gioiaâ€,                     composer:â€œLudwig van Beethovenâ€,tonality:â€œRe maggioreâ€, difficulty:â€œElementareâ€,    type:â€œcollettivoâ€,  notes:â€œArrangiamento per orchestra scolasticaâ€ },
{ id:â€œr7â€,  title:â€œCanon in Reâ€,                        composer:â€œJohann Pachelbelâ€,  tonality:â€œRe maggioreâ€,  difficulty:â€œIntermedioâ€,     type:â€œcollettivoâ€,  notes:â€œEnsemble dâ€™archi e fiatiâ€ },
{ id:â€œr8â€,  title:â€œGreensleevesâ€,                       composer:â€œTraditionalâ€,       tonality:â€œRe minoreâ€,    difficulty:â€œElementareâ€,     type:â€œcollettivoâ€,  notes:â€œArrangiamento coraleâ€ },
];

// Strumento â†’ colore: chiave INS_HEX per evitare conflitti col nome CSS â€œcolorâ€
const INS_HEX = {
Pianoforte: C.gold,
Chitarra:   â€œ#4ade80â€,
Violino:    â€œ#60a5faâ€,
Flauto:     â€œ#c084fcâ€,
Batteria:   â€œ#fb923câ€,
Saxofono:   â€œ#f472b6â€,
Tromba:     â€œ#34d399â€,
Basso:      â€œ#a78bfaâ€,
Canto:      â€œ#fbbf24â€,
Clarinetto: â€œ#2dd4bfâ€,
};
const insHex = (instrument) => INS_HEX[instrument] || C.gold;

// Presenza â†’ colore
const attHex = (att) =>
att === â€œpresenteâ€    ? C.green :
att === â€œassenteâ€     ? C.red   :
att === â€œgiustificatoâ€? C.gold  :
att === â€œrecuperoâ€    ? C.blue  : C.textDim;

const attBadge = (att) =>
att === â€œpresenteâ€    ? â€œgreenâ€ :
att === â€œassenteâ€     ? â€œredâ€   :
att === â€œrecuperoâ€    ? â€œblueâ€  : â€œgoldâ€;

const today    = new Date();
const addDays  = (d, n) => { const dt = new Date(d); dt.setDate(dt.getDate()+n); return dt; };
// Helpers lezioni collettive
const isColl      = l => l?.tipo === â€œcollettivoâ€;
const isProva     = l => l?.tipo === â€œprovaâ€;
const lessonHex   = l => isColl(l) ? C.purple : isProva(l) ? C.teal : insHex(l?.instrument||â€â€);
const studentInLesson = (l, name) =>
isColl(l) ? (l.students||[]).some(s=>s.name===name) : l.student===name;
const lessonLabel = l => isColl(l)
? (l.courseName||â€œCollettivaâ€)
: (l.student||â€â€);
const isSameDay = (a, b) => yyyymmdd(a) === yyyymmdd(b);

const startOfWeek = (d) => {
const dt = new Date(d);
const dow = dt.getDay();
dt.setDate(dt.getDate() - ((dow === 0 ? 7 : dow) - 1));
dt.setHours(0,0,0,0);
return dt;
};

const fmtFull  = (d) => `${DAYS_FULL[((d.getDay()||7)-1)]} ${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`;
const fmtShort = (d) => `${d.getDate()} ${MONTHS[d.getMonth()].slice(0,3)}`;

// Demo data
const makeLesson = (daysOffset, hour, student, instrument, teacher, room, topic, attendance=â€â€, recurrence=â€œNessunaâ€) => {
const d = new Date(today); d.setDate(d.getDate()+daysOffset);
return { id:uid(), date:yyyymmdd(d), hour, student, instrument, teacher, room, topic, attendance, recurrence, notes:â€â€ };
};
const makeLessonDate = (dateStr, hour, student, instrument, teacher, room, topic, attendance=â€â€) => ({
id:uid(), date:dateStr, hour, student, instrument, teacher, room, topic, attendance, recurrence:â€œNessunaâ€, notes:â€â€
});
const thisYear = today.getFullYear();
const thisMonth = today.getMonth()+1; // 1-based
const pad2 = n => String(n).padStart(2,â€œ0â€);
const ym = (month, year=thisYear) => `${year}-${pad2(month)}`;

const INIT_LESSONS = (() => {
// Anno scolastico: Sep anno_prec -> Giu anno_corrente (o Sep corrente -> Giu prossimo)
const ref  = new Date(today);
const refY = ref.getFullYear();
const refM = ref.getMonth()+1;
// anno scolastico corrente parte da settembre
const annoInizio = refM >= 9 ? refY : refY-1;

const makeD = (year, month, day, hour, student, instrument, teacher, room, topic, attendance=â€œpresenteâ€) => {
const dd = String(day).padStart(2,â€œ0â€);
const mm = String(month).padStart(2,â€œ0â€);
return { id:uid(), date:`${year}-${mm}-${dd}`, hour, student, instrument, teacher, room, topic, attendance, recurrence:â€œNessunaâ€, notes:â€â€ };
};

const lessons = [];
// mese corrente + prossimi 5 giorni
lessons.push(makeLesson(0,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œScale e arpeggiâ€,â€œpresenteâ€,â€œOgni settimanaâ€));
lessons.push(makeLesson(0,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œSonate Baroqueâ€,â€œpresenteâ€,â€œOgni settimanaâ€));
lessons.push(makeLesson(0,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œTecnica respirazioneâ€,â€â€,â€œOgni settimanaâ€));
lessons.push(makeLesson(1,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œAccordi barreâ€,â€â€,â€œOgni settimanaâ€));
lessons.push(makeLesson(1,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œChopin Notturnoâ€,â€â€,â€œOgni settimanaâ€));
lessons.push(makeLesson(3,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œBach Partitaâ€,â€â€,â€œOgni settimanaâ€));
lessons.push(makeLesson(3,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œRudimentiâ€,â€â€,â€â€));
lessons.push(makeLesson(4,  â€œ10:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œVivaldi Sonataâ€,â€â€,â€œOgni settimanaâ€));
lessons.push(makeLesson(-1, â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œScale minoriâ€,â€œpresenteâ€,â€œOgni settimanaâ€));
lessons.push(makeLesson(-1, â€œ14:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œFingerpickingâ€,â€œpresenteâ€,â€â€));
lessons.push(makeLesson(-2, â€œ10:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œVibratoâ€,â€œassenteâ€,â€œOgni settimanaâ€));
lessons.push(makeLesson(-3, â€œ09:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œTecnica staccatoâ€,â€œpresenteâ€,â€â€));
lessons.push(makeLesson(-4, â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œRudimenti baseâ€,â€œpresenteâ€,â€â€));
lessons.push(makeLesson(-5, â€œ14:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œScale maggioriâ€,â€œpresenteâ€,â€â€));

// Dati storici per i mesi dellâ€™anno scolastico
const DATA_STORICI = [
// [month_offset_from_sep, day, hour, student, instrument, teacher, room, topic, att]
// Settembre
[0,  5,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œPresentazione programmaâ€,â€œpresenteâ€],
[0,  7,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œPresentazione programmaâ€,â€œpresenteâ€],
[0,  9,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œPresentazione programmaâ€,â€œpresenteâ€],
[0, 12,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œHanon op.1â€,â€œpresenteâ€],
[0, 12,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œEsercizi di intonazioneâ€,â€œpresenteâ€],
[0, 14,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œScale diatonicheâ€,â€œpresenteâ€],
[0, 16,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œParadiddle baseâ€,â€œpresenteâ€],
[0, 19,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œCzerny op.299â€,â€œpresenteâ€],
[0, 19,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œSevcik op.1â€,â€œassenteâ€],
[0, 21,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œTaffanel-Gaubertâ€,â€œpresenteâ€],
[0, 26,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œBach invenzioneâ€,â€œpresenteâ€],
[0, 26,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œClementi sonatinaâ€,â€œpresenteâ€],
[0, 28,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œArpeggiâ€,â€œpresenteâ€],
[0, 28,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œGroove 4/4â€,â€œpresenteâ€],
// Ottobre
[1,  3,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œBeethoven sonatinaâ€,â€œpresenteâ€],
[1,  3,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œKreutzer op.42 n.1â€,â€œpresenteâ€],
[1,  5,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œCarcassi op.60â€,â€œpresenteâ€],
[1,  5,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œQuantz sonataâ€,â€œpresenteâ€],
[1,  7,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œTriplet feelâ€,â€œpresenteâ€],
[1, 10,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œMozart KV 331â€,â€œpresenteâ€],
[1, 10,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œKreutzer n.2â€,â€œassenteâ€],
[1, 10,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œScale in ottaveâ€,â€œpresenteâ€],
[1, 14,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œGiuliani op.1â€,â€œpresenteâ€],
[1, 14,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œDevienne sonataâ€,â€œpresenteâ€],
[1, 17,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œChopin valzerâ€,â€œpresenteâ€],
[1, 21,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œTarrega studioâ€,â€œpresenteâ€],
[1, 21,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œShuffle bluesâ€,â€œpresenteâ€],
[1, 24,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œBach partitaâ€,â€œpresenteâ€],
[1, 28,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œScarlatti K.1â€,â€œpresenteâ€],
[1, 28,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œHanon velocitÃ â€,â€œpresenteâ€],
// Novembre
[2,  4,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œChopin notturnoâ€,â€œpresenteâ€],
[2,  4,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œVivaldi concertoâ€,â€œpresenteâ€],
[2,  4,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œBach sonataâ€,â€œpresenteâ€],
[2,  6,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œBarriosâ€,â€œpresenteâ€],
[2,  6,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œJazz swingâ€,â€œassenteâ€],
[2, 11,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œLiszt studioâ€,â€œpresenteâ€],
[2, 11,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œTelemann fantasiaâ€,â€œpresenteâ€],
[2, 13,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œVilla-Lobosâ€,â€œpresenteâ€],
[2, 13,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œDebussy arabesqueâ€,â€œpresenteâ€],
[2, 13,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œFill poliritmiciâ€,â€œpresenteâ€],
[2, 18,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œRavel sonatineâ€,â€œpresenteâ€],
[2, 20,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œKuhlau op.51â€,â€œassenteâ€],
[2, 25,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œPreparazione saggioâ€,â€œpresenteâ€],
[2, 25,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œPreparazione saggioâ€,â€œpresenteâ€],
[2, 27,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œPreparazione saggioâ€,â€œpresenteâ€],
// Dicembre
[3,  2,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œSaggio natale - proveâ€,â€œpresenteâ€],
[3,  2,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œSaggio natale - proveâ€,â€œpresenteâ€],
[3,  4,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œSaggio natale - proveâ€,â€œpresenteâ€],
[3,  4,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œSaggio natale - proveâ€,â€œpresenteâ€],
[3,  9,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œFinale repertorioâ€,â€œpresenteâ€],
[3, 11,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œFinale repertorioâ€,â€œpresenteâ€],
[3, 16,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œUltima lezioneâ€,â€œpresenteâ€],
[3, 16,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œUltima lezioneâ€,â€œpresenteâ€],
// Gennaio (annoInizio+1)
[4,  8,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œRipresa annoâ€,â€œpresenteâ€],
[4,  8,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œRipresa annoâ€,â€œpresenteâ€],
[4, 10,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œRipresa annoâ€,â€œpresenteâ€],
[4, 13,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œScarlattiâ€,â€œpresenteâ€],
[4, 15,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œLatin grooveâ€,â€œpresenteâ€],
[4, 20,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œBach invenzione 8â€,â€œpresenteâ€],
[4, 20,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œHandel sonataâ€,â€œpresenteâ€],
[4, 22,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œHotteterreâ€,â€œpresenteâ€],
[4, 27,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œBeethoven op.49â€,â€œpresenteâ€],
// Febbraio
[5,  3,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œChopin studioâ€,â€œpresenteâ€],
[5,  3,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œSor op.6â€,â€œpresenteâ€],
[5,  5,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œMendelssohn concertoâ€,â€œpresenteâ€],
[5,  5,  â€œ16:00â€,â€œMarco Ricciâ€,â€œBatteriaâ€,â€œProf. Verdeâ€,â€œSala Bâ€,â€œAfro-cubanâ€,â€œpresenteâ€],
[5, 10,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œScale minoriâ€,â€œpresenteâ€],
[5, 10,  â€œ15:00â€,â€œGiulia Romanoâ€,â€œFlautoâ€,â€œProf. Bianchiâ€,â€œSala Câ€,â€œTelemannâ€,â€œassenteâ€],
[5, 12,  â€œ14:00â€,â€œAlessandro Galloâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œClementi op.36â€,â€œpresenteâ€],
[5, 17,  â€œ11:00â€,â€œEmma Contiâ€,â€œViolinoâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œKreutzer n.12â€,â€œpresenteâ€],
[5, 17,  â€œ10:00â€,â€œLuca Ferraraâ€,â€œChitarraâ€,â€œProf. Bianchiâ€,â€œSala Bâ€,â€œGiuliani arpeggiâ€,â€œpresenteâ€],
[5, 24,  â€œ09:00â€,â€œSofia Marchettiâ€,â€œPianoforteâ€,â€œProf. Rossiâ€,â€œSala Aâ€,â€œScarlatti K.466â€,â€œpresenteâ€],
];

DATA_STORICI.forEach(([moff, day, â€¦rest]) => {
// moff: 0=Set, 1=Ott, 2=Nov, 3=Dic, 4=Gen, 5=Feb, 6=Mar, 7=Apr, 8=Mag, 9=Giu
let month, year;
if(moff <= 3) {       // Set-Dic anno inizio
month = 9 + moff;
year  = annoInizio;
} else {              // Gen-Giu anno successivo
month = moff - 3;   // 4->1(Gen), 5->2(Feb)â€¦
year  = annoInizio + 1;
}
// Non aggiungere lezioni future (dopo oggi)
const d = new Date(year, month-1, day);
if(d > ref) return;
lessons.push(makeD(year, month, day, â€¦rest));
});

return lessons;
})();

// â”€â”€â”€ FORM LEZIONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const emptyLesson = { date:yyyymmdd(today), hour:â€œ09:00â€, student:â€â€, instrument:â€â€, teacher:â€â€, room:â€â€, topic:â€â€, attendance:â€â€, recurrence:â€œNessunaâ€, notes:â€â€, exercises:â€â€, repertorioIds:[] };

const LessonForm = ({ initial, onSave, onClose, repertorio:_repertorioRaw, onAddBrano }) => {
const repertorio = _repertorioRaw || [];
const [showBranoForm, setShowBranoForm] = useState(false);
const [f, setF] = useState(initial || emptyLesson);
const [err, setErr] = useState({});
const set = (k, v) => setF(p => ({ â€¦p, [k]:v }));

const hours = Array.from({length:49}, (_, i) => {
const h = Math.floor(i/4)+8;
const m = (i%4)*15;
return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;
}).filter(h => h <= â€œ22:00â€);

const validate = () => {
const e = {};
if(!f.date)       e.date       = â€œData obbligatoriaâ€;
if(!f.hour)       e.hour       = â€œOrario obbligatorioâ€;
if(!f.student)    e.student    = â€œAllievo obbligatorioâ€;
if(!f.instrument) e.instrument = â€œStrumento obbligatorioâ€;
if(!f.teacher)    e.teacher    = â€œInsegnante obbligatorioâ€;
return e;
};

const handleSave = () => {
const e = validate();
if(Object.keys(e).length){ setErr(e); return; }
onSave(f);
};

const ATT_STYLES = {
presente:    { bg:C.greenBg,  fg:C.green,  bd:C.greenBorder  },
assente:     { bg:C.redBg,    fg:C.red,    bd:C.redBorder    },
giustificato:{ bg:â€#2e2308â€,  fg:C.gold,   bd:C.goldDim      },
recupero:    { bg:C.blueBg,   fg:C.blue,   bd:C.blueBorder   },
};

const SDiv = ({ label }) => (
<div style={{gridColumn:â€œ1/-1â€, fontSize:10, color:C.textDim, letterSpacing:â€œ0.12emâ€,
textTransform:â€œuppercaseâ€, paddingBottom:4, borderBottom:`1px solid ${C.border}`, marginTop:4}}>
{label}
</div>
);

return (
<>
<div style={{padding:22, display:â€œgridâ€, gridTemplateColumns:â€œ1fr 1frâ€, gap:14}} className=â€œform-2colâ€>
<SDiv label="Quando"/>
<Input label=â€œData *â€ type=â€œdateâ€ value={f.date} onChange={e => set(â€œdateâ€, e.target.value)} error={err.date}/>
<Sel label=â€œOrario *â€ value={f.hour} onChange={e => set(â€œhourâ€, e.target.value)} options={hours} error={err.hour}/>

```
    <SDiv label="Chi"/>
    <Sel label="Allievo *"    value={f.student}    onChange={e => set("student", e.target.value)}    options={STUDENTS_LIST} error={err.student}/>
    <Sel label="Strumento *"  value={f.instrument} onChange={e => set("instrument", e.target.value)} options={INSTRUMENTS}   error={err.instrument}/>
    <Sel label="Insegnante *" value={f.teacher}    onChange={e => set("teacher", e.target.value)}    options={TEACHERS}      error={err.teacher}/>
    <Sel label="Sala"         value={f.room}       onChange={e => set("room", e.target.value)}       options={ROOMS}/>

    <SDiv label="Contenuto"/>
    <div style={{gridColumn:"1/-1"}}><Input label="Argomento" value={f.topic} onChange={e => set("topic", e.target.value)} placeholder="Es. Scale maggiori, Chopin Notturno..."/></div>
    <div style={{gridColumn:"1/-1"}}><Textarea label="Note"   value={f.notes} onChange={e => set("notes", e.target.value)} placeholder="Note aggiuntive..."/></div>
    <div style={{gridColumn:"1/-1"}}><Textarea label="Esercizi da svolgere" value={f.exercises} onChange={e => set("exercises", e.target.value)} placeholder="Es. Studiare scale in Do maggiore, ripetere battute 12-24..."/></div>

    <SDiv label="Presenza"/>
    <div style={{gridColumn:"1/-1", display:"flex", gap:8}}>
      {["presente","assente","giustificato","recupero"].map(a => {
        const s = ATT_STYLES[a];
        const active = f.attendance === a;
        return (
          <button key={a} onClick={() => set("attendance", active ? "" : a)}
            style={{flex:1, padding:"9px 12px", borderRadius:8,
              border:`2px solid ${active ? s.bd : C.border}`,
              background: active ? s.bg : C.bg,
              cursor:"pointer", fontSize:13,
              color: active ? s.fg : C.textMuted,
              fontFamily:"'DM Sans',sans-serif", fontWeight: active ? 500 : 400,
              textTransform:"capitalize", transition:"all 0.12s"}}>
            {a}
          </button>
        );
      })}
    </div>

    <SDiv label="Repertorio studiato"/>
    <div style={{gridColumn:"1/-1", display:"flex", flexDirection:"column", gap:8}}>
      <>
            {/* Tendina di selezione */}
            <select
              value=""
              onChange={e => {
                const id = e.target.value;
                if(!id) return;
                const ids = f.repertorioIds||[];
                if(!ids.includes(id)) set("repertorioIds", [...ids, id]);
              }}
              style={{background:C.bg, border:`1px solid ${C.border}`, borderRadius:8,
                color:C.textMuted, fontSize:13, padding:"10px 14px", width:"100%",
                fontFamily:"'DM Sans',sans-serif", appearance:"none", cursor:"pointer"}}>
              <option value="">{repertorio.length === 0 ? "Nessun brano nel catalogo" : "+ Aggiungi brano al repertorio..."}</option>
              {["individuale","collettivo"].map(tipo => {
                const group = repertorio.filter(b => b.type === tipo && !(f.repertorioIds||[]).includes(b.id));
                if(group.length === 0) return null;
                return (
                  <optgroup key={tipo} label={tipo === "individuale" ? "â”€â”€ Individuali â”€â”€" : "â”€â”€ Collettivi â”€â”€"}>
                    {group.map(b => (
                      <option key={b.id} value={b.id}>
                        {b.title} â€” {b.composer}{b.tonality ? ` (${b.tonality})` : ""}
                      </option>
                    ))}
                  </optgroup>
                );
              })}
            </select>

            {/* Pills dei brani selezionati */}
            {(f.repertorioIds||[]).length > 0 && (
              <div style={{display:"flex", flexDirection:"column", gap:6}}>
                {(f.repertorioIds||[]).map(id => {
                  const b = repertorio.find(r => r.id === id);
                  if(!b) return null;
                  const typeHex = b.type === "collettivo" ? C.purple : C.gold;
                  const typeBg  = b.type === "collettivo" ? C.purpleBg : "#2e2308";
                  const typeBd  = b.type === "collettivo" ? C.purpleBorder : C.goldDim;
                  return (
                    <div key={id} style={{display:"flex", alignItems:"center", gap:10,
                      padding:"8px 12px", borderRadius:8,
                      border:`1px solid ${typeBd}`, background:typeBg}}>
                      <Ic n="note" size={13} stroke={typeHex}/>
                      <div style={{flex:1, minWidth:0}}>
                        <div style={{fontSize:13, fontWeight:500, color:typeHex,
                          overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"}}>{b.title}</div>
                        <div style={{fontSize:11, color:C.textMuted}}>
                          {b.composer}{b.tonality ? ` Â· ${b.tonality}` : ""}
                        </div>
                      </div>
                      <button onClick={() => set("repertorioIds", (f.repertorioIds||[]).filter(i=>i!==id))}
                        style={{background:"none", border:"none", cursor:"pointer", padding:4,
                          display:"flex", borderRadius:4, flexShrink:0, color:C.textMuted,
                          transition:"color 0.12s"}}
                        onMouseEnter={e => e.currentTarget.style.color=C.red}
                        onMouseLeave={e => e.currentTarget.style.color=C.textMuted}>
                        <Ic n="x" size={14} stroke="currentColor"/>
                      </button>
                    </div>
                  );
                })}
              </div>
            )}

            {/* Pulsante aggiungi nuovo brano */}
            {!showBranoForm && (
              <button onClick={() => setShowBranoForm(true)}
                style={{display:"flex", alignItems:"center", gap:7, padding:"8px 12px",
                  background:"none", border:`1px dashed ${C.goldDim}`, borderRadius:8,
                  cursor:"pointer", color:C.goldDim, fontSize:12,
                  fontFamily:"'DM Sans',sans-serif", transition:"all 0.15s", width:"fit-content"}}
                onMouseEnter={e => { e.currentTarget.style.borderColor=C.gold; e.currentTarget.style.color=C.gold; }}
                onMouseLeave={e => { e.currentTarget.style.borderColor=C.goldDim; e.currentTarget.style.color=C.goldDim; }}>
                <Ic n="plus" size={13} stroke="currentColor"/>
                Crea nuovo brano e aggiungilo
              </button>
            )}

            {/* Form inline inserimento brano */}
            {showBranoForm && (
              <div style={{border:`1px solid ${C.goldDim}`, borderRadius:10, overflow:"hidden"}}>
                <div style={{display:"flex", justifyContent:"space-between", alignItems:"center",
                  padding:"10px 14px", background:"#2e2308", borderBottom:`1px solid ${C.goldDim}`}}>
                  <span style={{fontSize:12, color:C.gold, fontWeight:500, display:"flex", alignItems:"center", gap:6}}>
                    <Ic n="plus" size={13} stroke={C.gold}/>Nuovo brano nel catalogo
                  </span>
                  <button onClick={() => setShowBranoForm(false)}
                    style={{background:"none", border:"none", cursor:"pointer", color:C.textMuted, display:"flex", padding:2}}>
                    <Ic n="x" size={15} stroke={C.textMuted}/>
                  </button>
                </div>
                <div style={{padding:14, display:"flex", flexDirection:"column", gap:10, background:C.surface}}>
                  <BranoFormInline
                    onSave={b => {
                      const newId = "r_"+Date.now();
                      const newBrano = {...b, id:newId};
                      onAddBrano(newBrano);
                      set("repertorioIds", [...(f.repertorioIds||[]), newId]);
                      setShowBranoForm(false);
                    }}
                    onClose={() => setShowBranoForm(false)}
                    compact
                  />
                </div>
              </div>
            )}
          </>
      
    </div>

    <SDiv label="Ricorrenza"/>
    <div style={{gridColumn:"1/-1", display:"flex", gap:8, flexWrap:"wrap"}}>
      {RECURRENCE_OPTS.map(r => (
        <button key={r} onClick={() => set("recurrence", r)}
          style={{padding:"8px 14px", borderRadius:20,
            border:`2px solid ${f.recurrence === r ? C.blue : C.border}`,
            background: f.recurrence === r ? C.blueBg : C.bg,
            cursor:"pointer", fontSize:12,
            color: f.recurrence === r ? C.blue : C.textMuted,
            fontFamily:"'DM Sans',sans-serif", fontWeight: f.recurrence === r ? 500 : 400,
            transition:"all 0.12s", display:"flex", alignItems:"center", gap:6}}>
          {r !== "Nessuna" && <Ic n="repeat" size={12} stroke={f.recurrence === r ? C.blue : C.textMuted}/>}
          {r}
        </button>
      ))}
    </div>
  </div>

  <div style={{padding:"14px 22px", borderTop:`1px solid ${C.border}`, display:"flex", justifyContent:"flex-end", gap:10}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={handleSave}><Ic n="check" size={14} stroke={C.bg}/>{initial?.id ? "Salva modifiche" : "Aggiungi lezione"}</Btn>
  </div>
</>
```

);
};

// â”€â”€â”€ PILL LEZIONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LessonPill = ({ lesson, onClick, compact=false }) => {
const hex    = lessonHex(lesson);        // viola per collettive, colore strumento per individuali
const dotHex = attHex(lesson.attendance);

const bgNormal  = `${hex}15`;
const bdNormal  = `${hex}35`;
const bgHover   = `${hex}28`;
const bdHover   = `${hex}65`;

return (
<div
onClick={onClick}
style={{
background: bgNormal,
border: `1px solid ${bdNormal}`,
borderLeft: `3px solid ${hex}`,
borderRadius: 6,
padding: compact ? â€œ3px 5pxâ€ : â€œ7px 9pxâ€,
cursor: â€œpointerâ€,
transition: â€œall 0.15sâ€,
overflow: â€œhiddenâ€,
minWidth: 0,
width: â€œ100%â€,
boxSizing: â€œborder-boxâ€,
}}
onMouseEnter={e => {
e.currentTarget.style.background  = bgHover;
e.currentTarget.style.borderColor = bdHover;
}}
onMouseLeave={e => {
e.currentTarget.style.background  = bgNormal;
e.currentTarget.style.borderColor = bdNormal;
}}
>
{/* Riga 1: ora Â· nome/corso */}
{(() => {
let label = â€œâ€;
if(lesson.tipo===â€œcollettivoâ€) label = lesson.hour + â€œ Â· â€œ + (lesson.courseName||â€œCollettivaâ€);
else if(lesson.tipo===â€œprovaâ€) label = lesson.hour + â€œ Â· Provaâ€;
else label = lesson.hour + â€œ Â· â€œ + (lesson.student||â€â€).split(â€ â€œ)[0];
// Tronca etichetta se troppo lunga per celle strette
if(compact && label.length > 16) label = label.slice(0, 15) + â€œâ€¦â€;
return (
<div style={{display:â€œflexâ€, justifyContent:â€œspace-betweenâ€, alignItems:â€œflex-startâ€, gap:4}}>
<div style={{fontSize: compact ? 10 : 12, fontWeight:600, color:hex,
lineHeight:1.2, overflow:â€œhiddenâ€, textOverflow:â€œellipsisâ€, whiteSpace:â€œnowrapâ€,
flex:1, minWidth:0, maxWidth:â€œ100%â€}}>
{label}
</div>
{lesson.tipo===â€œcollettivoâ€ && (
<div style={{fontSize:9, color:C.purple, fontWeight:700, flexShrink:0}}>
{â€\u25CFâ€}{(lesson.students||[]).length}
</div>
)}
{lesson.tipo===â€œprovaâ€ && (
<span style={{fontSize:9, color:C.teal, fontWeight:700, textTransform:â€œuppercaseâ€, flexShrink:0}}>
prova{lesson.iscritto ? â€œ \u2713â€ : â€œâ€}
</span>
)}
{lesson.tipo!==â€œcollettivoâ€ && lesson.tipo!==â€œprovaâ€ && lesson.attendance && (
<div style={{width:6, height:6, borderRadius:â€œ50%â€, background:dotHex, flexShrink:0, marginTop:2}}/>
)}
</div>
);
})()}
{/* Riga 2: sottotitolo */}
<div style={{fontSize:9, color:hex, opacity:0.75, marginTop:1,
overflow:â€œhiddenâ€, textOverflow:â€œellipsisâ€, whiteSpace:â€œnowrapâ€, minWidth:0}}>
{lesson.tipo===â€œcollettivoâ€
? (lesson.students||[]).length + â€œ allieviâ€
: lesson.tipo===â€œprovaâ€
? (lesson.instrument||â€â€) + (lesson.phone ? â€œ \u00b7 â€œ + lesson.phone : â€œâ€)
: lesson.instrument||â€â€}
</div>
</div>
);
};

// â”€â”€â”€ MODAL DETTAGLIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LessonDetailModal = ({ lesson, onEdit, onDelete, onAttendance, onIscrizione, onClose, role, nextLessonDate, students }) => {
const canEdit = role === â€˜adminâ€™ || role === â€˜docenteâ€™;
const studentsList = students || [];
const hex = insHex(lesson.instrument);
const ATT_STYLES = {
presente:    { bg:C.greenBg,  fg:C.green,  bd:C.greenBorder  },
assente:     { bg:C.redBg,    fg:C.red,    bd:C.redBorder    },
giustificato:{ bg:â€#2e2308â€,  fg:C.gold,   bd:C.goldDim      },
recupero:    { bg:C.blueBg,   fg:C.blue,   bd:C.blueBorder   },
};

const [showIscrizionePanel, setShowIscrizionePanel] = useState(false);
const [iscrizioneStudent, setIscrizioneStudent] = useState(â€â€);

return (
<Modal title="Dettaglio lezione" onClose={onClose}>
<div style={{padding:22, display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:16}}>
<div style={{display:â€œflexâ€, gap:14, alignItems:â€œcenterâ€}}>
<div style={{width:46, height:46, borderRadius:10,
background: lesson.tipo===â€œcollettivoâ€ ? C.purpleBg : lesson.tipo===â€œprovaâ€ ? C.tealBg : `${hex}20`,
border:`1px solid ${lesson.tipo==="collettivo" ? C.purpleBorder : lesson.tipo==="prova" ? C.tealBorder : `${hex}40`}`,
display:â€œflexâ€, alignItems:â€œcenterâ€, justifyContent:â€œcenterâ€, flexShrink:0}}>
<Ic n={lesson.tipo===â€œcollettivoâ€?â€œgroupâ€:lesson.tipo===â€œprovaâ€?â€œuserâ€:â€œmusicâ€}
size={20} stroke={lesson.tipo===â€œcollettivoâ€?C.purple:lesson.tipo===â€œprovaâ€?C.teal:hex}/>
</div>
<div style={{flex:1}}>
{lesson.tipo===â€œcollettivoâ€ ? (
<>
<div style={{fontSize:17, fontWeight:600, fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€}}>{lesson.courseName}</div>
<div style={{fontSize:13, color:C.purple, marginTop:2}}>Lezione collettiva Â· {lesson.teacher}</div>
</>
) : lesson.tipo===â€œprovaâ€ ? (
<>
<div style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:8,flexWrap:â€œwrapâ€}}>
<div style={{fontSize:17, fontWeight:600, fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€, color:C.teal}}>
{lesson.contactName || â€œLezione di provaâ€}
</div>
{lesson.iscritto
? <span style={{fontSize:11,background:C.greenBg,color:C.green,
border:`1px solid ${C.greenBorder}`,borderRadius:4,padding:â€œ2px 8pxâ€,fontWeight:600}}>
Iscritto âœ“{lesson.student ? ` â€” ${lesson.student}` : â€œâ€}
</span>
: <span style={{fontSize:11,background:C.tealBg,color:C.teal,
border:`1px solid ${C.tealBorder}`,borderRadius:4,padding:â€œ2px 8pxâ€}}>
Non ancora iscritto
</span>
}
</div>
<div style={{fontSize:13, color:C.teal, opacity:0.85, marginTop:2}}>
{lesson.instrument}{lesson.teacher ? ` Â· ${lesson.teacher}` : â€œâ€}
{lesson.phone
? <span style={{color:C.textMuted, display:â€œinline-flexâ€, alignItems:â€œcenterâ€, gap:4}}>
{â€ Â· â€œ}ðŸ“ž <span style={{color:C.teal,fontWeight:500}}>{lesson.phone}</span>
</span>
: â€œâ€}
</div>
</>
) : (
<>
<div style={{fontSize:17, fontWeight:600, fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€}}>{lesson.student}</div>
<div style={{fontSize:13, color:hex, marginTop:2}}>{lesson.instrument}</div>
</>
)}
</div>
{lesson.recurrence !== â€œNessunaâ€ && <Badge label={lesson.recurrence} variant="blue"/>}
{lesson.tipo===â€œcollettivoâ€ && <Badge label="Collettiva" variant="purple"/>}
{lesson.tipo===â€œprovaâ€ && <Badge label="Prova" variant="teal"/>}
</div>

```
    <div className="info-grid">
      {[
        {icon:"cal",   label:"Data",       value:fmtFull(new Date(lesson.date+"T00:00:00"))},
        {icon:"clock", label:"Orario",     value:lesson.hour},
        {icon:"user",  label:"Insegnante", value:lesson.teacher},
        {icon:"music", label:"Sala",       value:lesson.room || "â€”"},
      ].map(r => (
        <div key={r.label} style={{display:"flex", gap:8, padding:"10px 12px",
          background:C.bg, borderRadius:8, border:`1px solid ${C.border}`}}>
          <Ic n={r.icon} size={14} stroke={C.textMuted}/>
          <div>
            <div style={{fontSize:10, color:C.textMuted, letterSpacing:"0.06em", textTransform:"uppercase"}}>{r.label}</div>
            <div style={{fontSize:13, marginTop:2}}>{r.value}</div>
          </div>
        </div>
      ))}
    </div>

    {lesson.tipo==="collettivo" && (lesson.students||[]).length > 0 && (
      <div style={{padding:"12px 14px", background:C.purpleBg, borderRadius:8, border:`1px solid ${C.purpleBorder}`}}>
        <div style={{fontSize:10, color:C.purple, letterSpacing:"0.06em", textTransform:"uppercase", marginBottom:8}}>
          Allievi ({(lesson.students||[]).length})
        </div>
        <div style={{display:"flex", flexDirection:"column", gap:5}}>
          {(lesson.students||[]).map(s => (
            <div key={s.id} style={{display:"flex", alignItems:"center", gap:8}}>
              <div style={{width:26, height:26, borderRadius:"50%", flexShrink:0,
                background:`${insHex(s.instrument)}20`, border:`1px solid ${insHex(s.instrument)}40`,
                display:"flex", alignItems:"center", justifyContent:"center",
                fontSize:10, fontWeight:700, color:insHex(s.instrument)}}>
                {initials(s.name)}
              </div>
              <div style={{flex:1}}>
                <span style={{fontSize:13, fontWeight:500}}>{s.name}</span>
                <span style={{fontSize:11, color:C.textMuted, marginLeft:8}}>{s.instrument}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}
    {lesson.topic && (
      <div style={{padding:"12px 14px", background:C.bg, borderRadius:8, border:`1px solid ${C.border}`}}>
        <div style={{fontSize:10, color:C.textMuted, letterSpacing:"0.06em", textTransform:"uppercase", marginBottom:4}}>Argomento</div>
        <div style={{fontSize:13}}>{lesson.topic}</div>
      </div>
    )}
    {lesson.notes && (
      <div style={{padding:"12px 14px", background:C.bg, borderRadius:8, border:`1px solid ${C.border}`}}>
        <div style={{fontSize:10, color:C.textMuted, letterSpacing:"0.06em", textTransform:"uppercase", marginBottom:4}}>Note</div>
        <div style={{fontSize:13, color:C.textMuted}}>{lesson.notes}</div>
      </div>
    )}
    {lesson.tipo !== "prova" && (
      <div style={{padding:"12px 14px", background:C.blueBg, borderRadius:8, border:`1px solid ${C.blueBorder}`}}>
        <div style={{fontSize:10, color:C.blue, letterSpacing:"0.06em", textTransform:"uppercase", marginBottom:6, opacity:0.8}}>Esercizi da svolgere</div>
        {lesson.exercises
          ? <div style={{fontSize:13, color:C.text, lineHeight:1.6}}>{lesson.exercises}</div>
          : <div style={{fontSize:13, color:C.textDim, fontStyle:"italic"}}>Nessun esercizio assegnato</div>
        }
      </div>
    )}

    {/* Repertorio */}
    {(lesson.repertorioIds||[]).length > 0 && (
      <div>
        <div style={{fontSize:10, color:C.textMuted, letterSpacing:"0.08em", textTransform:"uppercase", marginBottom:8}}>Brani studiati</div>
        <div style={{display:"flex", flexDirection:"column", gap:6}}>
          {(lesson.repertorioIds||[]).map(id => {
            const b = (window.__repertorio__||[]).find(r=>r.id===id);
            if(!b) return null;
            const typeHex = b.type==="collettivo"?C.purple:C.gold;
            const typeBg  = b.type==="collettivo"?C.purpleBg:"#2e2308";
            const typeBd  = b.type==="collettivo"?C.purpleBorder:C.goldDim;
            return (
              <div key={id} style={{display:"flex", alignItems:"center", gap:10, padding:"10px 12px",
                background:typeBg, border:`1px solid ${typeBd}`, borderRadius:8}}>
                <Ic n="note" size={14} stroke={typeHex}/>
                <div style={{flex:1, minWidth:0}}>
                  <div style={{fontSize:13, fontWeight:500, color:typeHex}}>{b.title}</div>
                  <div style={{fontSize:11, color:C.textMuted}}>{b.composer}{b.tonality ? ` Â· ${b.tonality}` : ""}</div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    )}

    <div>
      <div style={{fontSize:10, color:C.textMuted, letterSpacing:"0.08em", textTransform:"uppercase", marginBottom:8}}>Segna presenza</div>
      <div className="att-row" style={{display:"flex", gap:8}}>
        {["presente","assente","giustificato","recupero"].map(a => {
          const s = ATT_STYLES[a];
          const active = lesson.attendance === a;
          return (
            <button key={a} onClick={() => canEdit && onAttendance(lesson.id, active ? "" : a)}
              style={{flex:1, padding:"9px 0", borderRadius:8,
                border:`2px solid ${active ? s.bd : C.border}`,
                background: active ? s.bg : C.bg,
                cursor: canEdit ? "pointer" : "default", fontSize:12,
                color: active ? s.fg : C.textMuted,
                opacity: canEdit ? 1 : 0.5,
                fontFamily:"'DM Sans',sans-serif", fontWeight: active ? 600 : 400,
                textTransform:"capitalize", transition:"all 0.12s"}}>
              {a}
            </button>
          );
        })}
      </div>
      {/* Feedback prossima lezione */}
      {lesson.recurrence && lesson.recurrence !== "Nessuna" && (
        <div style={{marginTop:10, padding:"10px 14px", borderRadius:8,
          background: nextLessonDate ? C.greenBg : C.surface,
          border:`1px solid ${nextLessonDate ? C.greenBorder : C.border}`,
          display:"flex", alignItems:"center", gap:8}}>
          <Ic n="repeat" size={14} stroke={nextLessonDate ? C.green : C.textDim}/>
          <div style={{flex:1}}>
            {nextLessonDate ? (
              <>
                <div style={{fontSize:12, color:C.green, fontWeight:600}}>
                  Prossima lezione creata
                </div>
                <div style={{fontSize:11, color:C.textMuted, marginTop:1}}>
                  {fmtFull(new Date(nextLessonDate+"T00:00:00"))} Â· {lesson.hour} Â· {lesson.teacher}
                </div>
              </>
            ) : (
              <div style={{fontSize:12, color:C.textDim}}>
                Lezione {lesson.recurrence.toLowerCase()} â€” la prossima verrÃ  creata segnando la presenza
              </div>
            )}
          </div>
          {!nextLessonDate && lesson.attendance && (
            <span style={{fontSize:10, color:C.textDim, fontStyle:"italic"}}>giÃ  pianificata</span>
          )}
        </div>
      )}
    </div>

    {/* â”€â”€ Pannello iscrizione (solo lezioni prova) â”€â”€ */}
    {lesson.tipo==="prova" && canEdit && (
      <div style={{padding:"14px 16px", background:lesson.iscritto?C.greenBg:C.tealBg,
        border:`1px solid ${lesson.iscritto?C.greenBorder:C.tealBorder}`, borderRadius:10}}>
        <div style={{display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom: showIscrizionePanel&&!lesson.iscritto ? 12 : 0}}>
          <div style={{display:"flex", alignItems:"center", gap:8}}>
            <Ic n={lesson.iscritto?"check":"user"} size={15} stroke={lesson.iscritto?C.green:C.teal}/>
            <div>
              <div style={{fontSize:12, fontWeight:600, color:lesson.iscritto?C.green:C.teal}}>
                {lesson.iscritto ? `Iscritto â€” ${lesson.student||""}` : "Allievo non ancora iscritto"}
              </div>
              {!lesson.iscritto && (
                <div style={{fontSize:11, color:C.teal, opacity:0.8, marginTop:1}}>
                  Collega a un allievo esistente quando si iscrive
                </div>
              )}
            </div>
          </div>
          {!lesson.iscritto && (
            <button onClick={()=>setShowIscrizionePanel(v=>!v)}
              style={{background:C.teal,color:C.bg,border:"none",borderRadius:7,padding:"6px 13px",
                cursor:"pointer",fontSize:12,fontFamily:"'DM Sans',sans-serif",fontWeight:600}}>
              {showIscrizionePanel ? "Annulla" : "Segna iscritto"}
            </button>
          )}
          {lesson.iscritto && onIscrizione && (
            <button onClick={()=>onIscrizione(lesson.id, "", false)}
              style={{background:"none",color:C.textDim,border:`1px solid ${C.border}`,borderRadius:7,
                padding:"5px 10px",cursor:"pointer",fontSize:11,fontFamily:"'DM Sans',sans-serif"}}>
              Rimuovi iscrizione
            </button>
          )}
        </div>
        {showIscrizionePanel && !lesson.iscritto && (
          <div style={{display:"flex", gap:8, alignItems:"center", marginTop:4}}>
            <select value={iscrizioneStudent} onChange={e=>setIscrizioneStudent(e.target.value)}
              style={{flex:1, background:C.surface, border:`1px solid ${C.tealBorder}`, borderRadius:8,
                color:iscrizioneStudent?C.text:C.textMuted, fontSize:13, padding:"9px 12px",
                fontFamily:"'DM Sans',sans-serif", appearance:"none"}}>
              <option value="">â€” seleziona allievo â€”</option>
              {studentsList.filter(s=>s.status==="attivo").map(s=>(
                <option key={s.id} value={s.name}>{s.name} Â· {s.instrument}</option>
              ))}
              <option value="__nuovo__">+ Nuovo allievo (da creare)</option>
            </select>
            <button
              disabled={!iscrizioneStudent}
              onClick={()=>{
                if(onIscrizione) onIscrizione(lesson.id, iscrizioneStudent, true);
                setShowIscrizionePanel(false);
              }}
              style={{background:iscrizioneStudent?C.green:"#1a2a1a",color:iscrizioneStudent?C.bg:C.textDim,
                border:"none",borderRadius:7,padding:"9px 16px",cursor:iscrizioneStudent?"pointer":"not-allowed",
                fontSize:12,fontFamily:"'DM Sans',sans-serif",fontWeight:600,flexShrink:0,transition:"all 0.12s"}}>
              Conferma
            </button>
          </div>
        )}
      </div>
    )}

  </div>

  <div style={{padding:"14px 22px", borderTop:`1px solid ${C.border}`, display:"flex", justifyContent:"space-between", alignItems:"center"}}>
    {canEdit ? (
      <>
        <Btn danger onClick={onDelete}><Ic n="trash" size={14} stroke={C.red}/>Elimina</Btn>
        <Btn variant="secondary" onClick={onEdit}><Ic n="edit" size={14} stroke={C.textMuted}/>Modifica</Btn>
      </>
    ) : (
      <div style={{display:"flex",alignItems:"center",gap:8,color:C.textDim,fontSize:12,width:"100%",justifyContent:"center"}}>
        <Ic n="lock" size={14} stroke={C.textDim}/>
        Solo docenti e amministratori possono modificare le lezioni
      </div>
    )}
  </div>
</Modal>
```

);
};

// â”€â”€â”€ VISTA GIORNALIERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DayView = ({ date, lessons, onSelect }) => {
const dayLessons = lessons
.filter(l => l.date === yyyymmdd(date))
.sort((a, b) => a.hour.localeCompare(b.hour));

if(dayLessons.length === 0) return (
<div style={{textAlign:â€œcenterâ€, padding:â€œ64px 0â€, color:C.textDim}}>
<Ic n="cal" size={32} stroke={C.textDim}/>
<p style={{marginTop:12, fontSize:14}}>Nessuna lezione programmata</p>
<p style={{fontSize:12, marginTop:4}}>Usa il + per aggiungerne una</p>
</div>
);

return (
<div style={{display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:10}}>
{dayLessons.map(l => {
const hex = lessonHex(l);
const dotHex = l.attendance ? attHex(l.attendance) : null;
return (
<div key={l.id} onClick={() => onSelect(l)}
style={{display:â€œflexâ€, gap:16, padding:â€œ16px 18pxâ€, background:C.surface,
border:`1px solid ${C.border}`, borderLeft:`4px solid ${hex}`,
borderRadius:10, cursor:â€œpointerâ€, transition:â€œall 0.15sâ€}}
onMouseEnter={e => { e.currentTarget.style.background = C.surfaceHover; }}
onMouseLeave={e => { e.currentTarget.style.background = C.surface; }}>
<div style={{width:52, flexShrink:0, textAlign:â€œcenterâ€, paddingTop:2}}>
<div style={{fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€, fontSize:22,
fontWeight:600, color:hex, lineHeight:1}}>{l.hour}</div>
<div style={{fontSize:10, color:C.textDim, marginTop:2}}>ora</div>
</div>
<div style={{flex:1, minWidth:0}}>
{l.tipo===â€œcollettivoâ€ ? (
<>
<div style={{display:â€œflexâ€, alignItems:â€œcenterâ€, gap:8, marginBottom:4, flexWrap:â€œwrapâ€}}>
<span style={{fontSize:15, fontWeight:600}}>{l.courseName}</span>
<span style={{fontSize:11, background:C.purpleBg, color:C.purple,
border:`1px solid ${C.purpleBorder}`, borderRadius:4, padding:â€œ1px 7pxâ€,
letterSpacing:â€œ0.05emâ€}}>Collettiva</span>
{l.recurrence !== â€œNessunaâ€ && <Ic n="repeat" size={12} stroke={C.textDim}/>}
</div>
<div style={{display:â€œflexâ€, gap:12, fontSize:12, color:C.textMuted, flexWrap:â€œwrapâ€}}>
{l.teacher && <span>{l.teacher}</span>}
{l.room    && <span>Â· {l.room}</span>}
<span>Â· {(l.students||[]).length} allievi</span>
</div>
{(l.students||[]).length > 0 && (
<div style={{display:â€œflexâ€, gap:5, marginTop:6, flexWrap:â€œwrapâ€}}>
{(l.students||[]).map(s => (
<span key={s.id} style={{fontSize:10, padding:â€œ1px 7pxâ€, borderRadius:10,
background:`${insHex(s.instrument)}18`, color:insHex(s.instrument),
border:`1px solid ${insHex(s.instrument)}40`}}>
{s.name.split(â€ â€œ)[0]}
</span>
))}
</div>
)}
{l.topic && <div style={{fontSize:12, color:C.textMuted, marginTop:6, fontStyle:â€œitalicâ€}}>â€{l.topic}â€</div>}
</>
) : l.tipo===â€œprovaâ€ ? (
<>
<div style={{display:â€œflexâ€, alignItems:â€œcenterâ€, gap:8, marginBottom:4, flexWrap:â€œwrapâ€}}>
<span style={{fontSize:15, fontWeight:600, color:C.teal}}>
{l.contactName || â€œLezione provaâ€}
</span>
<span style={{fontSize:11, background:C.tealBg, color:C.teal,
border:`1px solid ${C.tealBorder}`, borderRadius:4, padding:â€œ1px 7pxâ€,
letterSpacing:â€œ0.05emâ€}}>Prova</span>
{l.iscritto
? <span style={{fontSize:11, background:C.greenBg, color:C.green,
border:`1px solid ${C.greenBorder}`, borderRadius:4, padding:â€œ1px 7pxâ€,fontWeight:600}}>
Iscritto âœ“
</span>
: <span style={{fontSize:11, background:C.tealBg, color:C.teal,
border:`1px solid ${C.tealBorder}`, borderRadius:4, padding:â€œ1px 7pxâ€}}>
Non iscritto
</span>
}
</div>
<div style={{display:â€œflexâ€, gap:12, fontSize:12, color:C.textMuted, flexWrap:â€œwrapâ€}}>
<span style={{color:C.teal}}>{l.instrument}</span>
{l.teacher && <span>Â· {l.teacher}</span>}
{l.room    && <span>Â· {l.room}</span>}
{l.phone   && <span style={{color:C.teal}}>Â· ðŸ“ž {l.phone}</span>}
</div>
{l.notes && <div style={{fontSize:12, color:C.textMuted, marginTop:6, fontStyle:â€œitalicâ€}}>{l.notes}</div>}
</>
) : (
<>
<div style={{display:â€œflexâ€, alignItems:â€œcenterâ€, gap:8, marginBottom:4, flexWrap:â€œwrapâ€}}>
<span style={{fontSize:15, fontWeight:600}}>{l.student}</span>
<span style={{fontSize:12, color:hex}}>{l.instrument}</span>
{l.recurrence !== â€œNessunaâ€ && <Ic n="repeat" size={12} stroke={C.textDim}/>}
{dotHex && <div style={{width:7, height:7, borderRadius:â€œ50%â€, background:dotHex}}/>}
</div>
<div style={{display:â€œflexâ€, gap:12, fontSize:12, color:C.textMuted, flexWrap:â€œwrapâ€}}>
{l.teacher && <span>{l.teacher}</span>}
{l.room    && <span>Â· {l.room}</span>}
</div>
{l.topic && <div style={{fontSize:12, color:C.textMuted, marginTop:6, fontStyle:â€œitalicâ€}}>â€{l.topic}â€</div>}
</>
)}
</div>
{l.tipo !== â€œcollettivoâ€ && l.attendance && (
<div style={{flexShrink:0, alignSelf:â€œcenterâ€}}>
<Badge label={l.attendance} variant={attBadge(l.attendance)}/>
</div>
)}
</div>
);
})}
</div>
);
};

// â”€â”€â”€ VISTA SETTIMANALE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WeekView = ({ weekStart, lessons, onSelect }) => {
const days = Array.from({length:7}, (_, i) => addDays(weekStart, i));

return (
<div style={{overflowX:â€œautoâ€,WebkitOverflowScrolling:â€œtouchâ€}}>
<div style={{minWidth:480}}>
{/* header */}
<div style={{display:â€œgridâ€, gridTemplateColumns:â€œ52px repeat(7,1fr)â€,
borderBottom:`1px solid ${C.border}`, position:â€œstickyâ€, top:0, background:C.surface, zIndex:2}}>
<div/>
{days.map((d, i) => {
const isToday = isSameDay(d, today);
return (
<div key={i} style={{padding:â€œ8px 4pxâ€, textAlign:â€œcenterâ€, borderLeft:`1px solid ${C.border}`, minWidth:0, overflow:â€œhiddenâ€}}>
<div style={{fontSize:11, color:C.textMuted, letterSpacing:â€œ0.06emâ€, textTransform:â€œuppercaseâ€}}>{DAYS_SHORT[i]}</div>
<div style={{fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€, fontSize:20, fontWeight:600, marginTop:2,
color: isToday ? C.gold : C.text,
background: isToday ? `${C.gold}15` : undefined,
borderRadius: isToday ? 6 : undefined,
padding: isToday ? â€œ1px 6pxâ€ : undefined}}>
{d.getDate()}
</div>
</div>
);
})}
</div>
{/* righe orarie */}
{HOURS.map(hour => (
<div key={hour} style={{display:â€œgridâ€, gridTemplateColumns:â€œ52px repeat(7,1fr)â€,
borderBottom:`1px solid ${C.border}20`}}>
<div style={{padding:â€œ8px 6px 0â€, fontSize:11, color:C.textDim, textAlign:â€œrightâ€, paddingRight:8}}>{hour}</div>
{days.map((d, i) => {
const cellLessons = lessons.filter(l => l.date === yyyymmdd(d) && l.hour === hour);
return (
<div key={i} style={{borderLeft:`1px solid ${C.border}20`, minHeight:58, padding:3,
display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:2, minWidth:0, overflow:â€œhiddenâ€}}>
{cellLessons.map(l => (
<LessonPill key={l.id} lesson={l} onClick={() => onSelect(l)} compact/>
))}
</div>
);
})}
</div>
))}
</div>
</div>
);
};

// â”€â”€â”€ VISTA MENSILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MonthView = ({ year, month, lessons, onSelect, onDayClick }) => {
const firstDay  = new Date(year, month, 1);
const startDow  = (firstDay.getDay() || 7) - 1;
const totalDays = new Date(year, month+1, 0).getDate();
const cells = [
â€¦Array.from({length:startDow}, () => null),
â€¦Array.from({length:totalDays}, (_, i) => i+1),
];
while(cells.length % 7 !== 0) cells.push(null);

return (
<div>
<div style={{display:â€œgridâ€, gridTemplateColumns:â€œrepeat(7,1fr)â€, borderBottom:`1px solid ${C.border}`}}>
{DAYS_SHORT.map(d => (
<div key={d} style={{padding:â€œ8px 0â€, textAlign:â€œcenterâ€, fontSize:11,
letterSpacing:â€œ0.06emâ€, textTransform:â€œuppercaseâ€, color:C.textMuted}}>{d}</div>
))}
</div>
<div style={{display:â€œgridâ€, gridTemplateColumns:â€œrepeat(7,1fr)â€}}>
{cells.map((day, idx) => {
if(!day) return (
<div key={idx} style={{minHeight:90, borderBottom:`1px solid ${C.border}20`, borderRight:`1px solid ${C.border}20`}}/>
);
const d = new Date(year, month, day);
const dayStr = yyyymmdd(d);
const dayLessons = lessons.filter(l => l.date === dayStr);
const isToday = isSameDay(d, today);
return (
<div key={idx} onClick={() => onDayClick(d)}
style={{minHeight:â€œclamp(60px, 10vw, 90px)â€, borderBottom:`1px solid ${C.border}20`,
borderRight:`1px solid ${C.border}20`, padding:4, cursor:â€œpointerâ€, transition:â€œbackground 0.1sâ€}}
onMouseEnter={e => { e.currentTarget.style.background = C.surfaceHover; }}
onMouseLeave={e => { e.currentTarget.style.background = â€œtransparentâ€; }}>
<div style={{display:â€œflexâ€, justifyContent:â€œspace-betweenâ€, alignItems:â€œcenterâ€, marginBottom:4}}>
<span style={{fontSize:12, fontWeight:500,
color: isToday ? C.gold : C.text,
background: isToday ? `${C.gold}15` : undefined,
borderRadius: isToday ? 4 : undefined,
padding: isToday ? â€œ1px 5pxâ€ : undefined}}>
{day}
</span>
{dayLessons.length > 0 && <span style={{fontSize:10, color:C.textDim}}>{dayLessons.length}</span>}
</div>
<div style={{display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:2}}>
{dayLessons.slice(0,3).map(l => (
<LessonPill key={l.id} lesson={l} onClick={e => { e.stopPropagation(); onSelect(l); }} compact/>
))}
{dayLessons.length > 3 && (
<div style={{fontSize:10, color:C.textDim, paddingLeft:4}}>+{dayLessons.length-3} altre</div>
)}
</div>
</div>
);
})}
</div>
</div>
);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPERTORIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const emptyBrano = { title:â€â€, composer:â€â€, tonality:â€â€, difficulty:â€œIntermedioâ€, type:â€œindividualeâ€, notes:â€â€ };

const BranoFormInline = ({ initial, onSave, onClose, compact=false }) => {
const [f, setF] = useState(initial || emptyBrano);
const [err, setErr] = useState({});
const set = (k, v) => setF(p => ({â€¦p, [k]:v}));

const handleSave = () => {
const e = {};
if(!f.title.trim())    e.title    = â€œTitolo obbligatorioâ€;
if(!f.composer.trim()) e.composer = â€œCompositore obbligatorioâ€;
if(Object.keys(e).length){ setErr(e); return; }
onSave(f);
};

return (
<>
<div style={{padding:compact?10:22, display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:compact?8:14}}>
<Input label=â€œTitolo *â€ value={f.title} onChange={e=>set(â€œtitleâ€,e.target.value)} error={err.title} placeholder=â€œEs. Notturno Op.9 n.2â€/>
<Input label=â€œCompositore *â€ value={f.composer} onChange={e=>set(â€œcomposerâ€,e.target.value)} error={err.composer} placeholder=â€œEs. FrÃ©dÃ©ric Chopinâ€/>
<Sel label=â€œTonalitÃ  / Scalaâ€ value={f.tonality} onChange={e=>set(â€œtonalityâ€,e.target.value)} options={TONALITY_OPTS}/>
<Sel label=â€œLivello di difficoltÃ â€ value={f.difficulty} onChange={e=>set(â€œdifficultyâ€,e.target.value)} options={DIFFICULTY_OPTS}/>
<div>
<label style={{fontSize:12, color:C.textMuted, letterSpacing:â€œ0.06emâ€, textTransform:â€œuppercaseâ€, display:â€œblockâ€, marginBottom:8}}>Tipo brano</label>
<div style={{display:â€œflexâ€, gap:10}}>
{[[â€œindividualeâ€,â€œsoloâ€,C.gold,â€#2e2308â€,C.goldDim],[â€œcollettivoâ€,â€œgroupâ€,C.purple,C.purpleBg,C.purpleBorder]].map(([val,icon,fg,bg,bd]) => (
<button key={val} onClick={()=>set(â€œtypeâ€,val)} style={{flex:1, padding:â€œ12px 14pxâ€, borderRadius:10,
border:`2px solid ${f.type===val?fg:C.border}`, background:f.type===val?bg:C.bg,
cursor:â€œpointerâ€, display:â€œflexâ€, alignItems:â€œcenterâ€, gap:10, transition:â€œall 0.15sâ€}}>
<Ic n={icon} size={16} stroke={f.type===val?fg:C.textMuted}/>
<div style={{textAlign:â€œleftâ€}}>
<div style={{fontSize:13, fontWeight:500, color:f.type===val?fg:C.text, textTransform:â€œcapitalizeâ€}}>{val}</div>
<div style={{fontSize:11, color:C.textMuted}}>{val===â€œindividualeâ€?â€œStudio personaleâ€:â€œEnsemble / orchestraâ€}</div>
</div>
</button>
))}
</div>
</div>
<Textarea label=â€œNote / annotazioniâ€ value={f.notes} onChange={e=>set(â€œnotesâ€,e.target.value)} placeholder=â€œNote aggiuntive, indicazioni tecnicheâ€¦â€/>
</div>
<div style={{padding:compact?â€œ10px 10pxâ€:â€œ14px 22pxâ€, borderTop:`1px solid ${C.border}`, display:â€œflexâ€, justifyContent:â€œflex-endâ€, gap:8}}>
<Btn small={compact} variant="secondary" onClick={onClose}>Annulla</Btn>
<Btn small={compact} onClick={handleSave}><Ic n="check" size={14} stroke={C.bg}/>{initial?.id?â€œSalva modificheâ€:â€œAggiungi branoâ€}</Btn>
</div>
</>
);
};

const DIFF_COLORS = {
Principiante: { fg:C.green,  bg:C.greenBg,  bd:C.greenBorder  },
Elementare:   { fg:C.blue,   bg:C.blueBg,   bd:C.blueBorder   },
Intermedio:   { fg:C.gold,   bg:â€#2e2308â€,  bd:C.goldDim      },
Avanzato:     { fg:C.orange, bg:C.orangeBg, bd:C.orangeBorder },
Professionale:{ fg:C.red,    bg:C.redBg,    bd:C.redBorder    },
};
const DiffBadge = ({ diff }) => {
const dc = DIFF_COLORS[diff] || DIFF_COLORS.Intermedio;
return (
<span style={{fontSize:10,fontWeight:600,letterSpacing:â€œ0.06emâ€,
background:dc.bg, color:dc.fg, border:`1px solid ${dc.bd}`,
borderRadius:4, padding:â€œ2px 7pxâ€}}>
{diff||â€â€”â€}
</span>
);
};
const TipoBadge = ({ tipo }) => {
const isCol = tipo===â€œcollettivoâ€;
return (
<span style={{fontSize:10,fontWeight:600,letterSpacing:â€œ0.06emâ€,
background:isCol?C.purpleBg:â€#2e2308â€,
color:isCol?C.purple:C.gold,
border:`1px solid ${isCol?C.purpleBorder:C.goldDim}`,
borderRadius:4, padding:â€œ2px 7pxâ€}}>
{tipo||â€â€”â€}
</span>
);
};

const CalRepertorioTab = ({ repertorio, lessons, onAdd, onEdit, onDelete, canEdit }) => {
const [modal,      setModal]   = useState(null);
const [target,     setTarget]  = useState(null);
const [search,     setSearch]  = useState(â€â€);
const [filterType, setFT]      = useState(â€â€);
const [filterDiff, setFD]      = useState(â€â€);
const [filterComp, setFC]      = useState(â€â€);
const [expanded,   setExpanded]= useState(null); // id del brano espanso

const usageCount = id => lessons.filter(l => (l.repertorioIds||[]).includes(id)).length;

// Lista compositori unici per dropdown
const composers = [â€¦new Set(repertorio.map(b => b.composer))].sort();

const hasFilters = search || filterType || filterDiff || filterComp;

const filtered = repertorio.filter(b => {
const q = search.toLowerCase();
return (
(!q || b.title.toLowerCase().includes(q) || b.composer.toLowerCase().includes(q) || (b.tonality||â€â€).toLowerCase().includes(q))
&& (!filterType || b.type === filterType)
&& (!filterDiff || b.difficulty === filterDiff)
&& (!filterComp || b.composer === filterComp)
);
}).sort((a,b) => a.title.localeCompare(b.title));

const individuali = filtered.filter(b => b.type === â€œindividualeâ€);
const collettivi  = filtered.filter(b => b.type === â€œcollettivoâ€);

// â”€â”€ Riga compatta con espansione accordion â”€â”€
const BranoRow = ({ b }) => {
const dc      = DIFF_COLORS[b.difficulty] || DIFF_COLORS.Intermedio;
const typeHex = b.type === â€œcollettivoâ€ ? C.purple : C.gold;
const typeBg  = b.type === â€œcollettivoâ€ ? C.purpleBg : â€œ#2e2308â€;
const typeBd  = b.type === â€œcollettivoâ€ ? C.purpleBorder : C.goldDim;
const uses    = usageCount(b.id);
const open    = expanded === b.id;

```
return (
  <div style={{borderBottom:`1px solid ${C.border}20`}}>
    {/* Riga principale â€” clic per espandere */}
    <div onClick={() => setExpanded(open ? null : b.id)}
      style={{display:"flex", alignItems:"center", gap:12, padding:"11px 16px",
        cursor:"pointer", transition:"background 0.12s", background: open ? C.surfaceHover : "transparent"}}
      onMouseEnter={e => { if(!open) e.currentTarget.style.background = C.surfaceHover; }}
      onMouseLeave={e => { if(!open) e.currentTarget.style.background = "transparent"; }}>

      {/* Chevron */}
      <div style={{width:16, flexShrink:0, transition:"transform 0.2s",
        transform: open ? "rotate(90deg)" : "rotate(0deg)", color:C.textDim}}>
        <Ic n="right" size={14} stroke={C.textDim}/>
      </div>

      {/* Titolo + compositore */}
      <div style={{flex:"0 0 38%", minWidth:0}}>
        <div style={{fontSize:13, fontWeight:500, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"}}>{b.title}</div>
        <div style={{fontSize:11, color:C.textMuted, marginTop:1}}>{b.composer}</div>
      </div>

      {/* TonalitÃ  */}
      <div style={{flex:"0 0 18%", fontSize:12, color:C.textMuted, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"}}>
        {b.tonality || <span style={{color:C.textDim}}>â€”</span>}
      </div>

      {/* Badge difficoltÃ  */}
      <div style={{flex:"0 0 120px"}}>
        <span style={{fontSize:11, padding:"2px 8px", borderRadius:4,
          border:`1px solid ${dc.bd}`, background:dc.bg, color:dc.fg, whiteSpace:"nowrap"}}>
          {b.difficulty}
        </span>
      </div>

      {/* Badge tipo */}
      <div style={{flex:"0 0 90px"}}>
        <span style={{fontSize:11, padding:"2px 8px", borderRadius:4,
          border:`1px solid ${typeBd}`, background:typeBg, color:typeHex, whiteSpace:"nowrap"}}>
          {b.type}
        </span>
      </div>

      {/* Utilizzi */}
      <div style={{flex:"0 0 70px", textAlign:"right", fontSize:11, color:C.textDim}}>
        {uses > 0 ? `${uses} lez.` : "â€”"}
      </div>

      {/* Azioni */}
      {canEdit && (
        <div style={{display:"flex", gap:2, flexShrink:0}} onClick={e => e.stopPropagation()}>
          <button onClick={() => { setTarget(b); setModal("edit"); }}
            style={{background:"none", border:"none", cursor:"pointer", color:C.textMuted, padding:"4px 6px", display:"flex", borderRadius:6}}
            onMouseEnter={e => e.currentTarget.style.color=C.gold}
            onMouseLeave={e => e.currentTarget.style.color=C.textMuted}>
            <Ic n="edit" size={13} stroke="currentColor"/>
          </button>
          <button onClick={() => { setTarget(b); setModal("delete"); }}
            style={{background:"none", border:"none", cursor:"pointer", color:C.textMuted, padding:"4px 6px", display:"flex", borderRadius:6}}
            onMouseEnter={e => e.currentTarget.style.color=C.red}
            onMouseLeave={e => e.currentTarget.style.color=C.textMuted}>
            <Ic n="trash" size={13} stroke="currentColor"/>
          </button>
        </div>
      )}
    </div>

    {/* Pannello espanso */}
    {open && (
      <div style={{padding:"12px 16px 14px 44px", background:C.surfaceHover,
        borderTop:`1px solid ${C.border}20`, display:"flex", flexDirection:"column", gap:8}}>
        {b.notes
          ? <p style={{fontSize:13, color:C.textMuted, lineHeight:1.6, fontStyle:"italic"}}>{b.notes}</p>
          : <p style={{fontSize:12, color:C.textDim, fontStyle:"italic"}}>Nessuna annotazione</p>
        }
        <div style={{fontSize:11, color:C.textDim}}>
          Usato in <strong style={{color:uses>0?C.gold:C.textDim}}>{uses}</strong> {uses===1?"lezione":"lezioni"}
        </div>
      </div>
    )}
  </div>
);
```

};

// â”€â”€ Sezione collassabile â”€â”€
const AccordionSection = ({ label, items, typeHex, icon }) => {
const [open, setOpen] = useState(true);
return (
<div style={{background:C.surface, border:`1px solid ${C.border}`, borderRadius:12, overflow:â€œhiddenâ€}} className=â€œtable-scrollâ€>
{/* Header sezione */}
<button onClick={() => setOpen(p => !p)}
style={{width:â€œ100%â€, display:â€œflexâ€, alignItems:â€œcenterâ€, gap:10, padding:â€œ13px 16pxâ€,
background:â€œnoneâ€, border:â€œnoneâ€, cursor:â€œpointerâ€, borderBottom: open ? `1px solid ${C.border}` : â€œnoneâ€,
transition:â€œbackground 0.12sâ€}}
onMouseEnter={e => e.currentTarget.style.background=C.surfaceHover}
onMouseLeave={e => e.currentTarget.style.background=â€œnoneâ€}>
<Ic n={icon} size={14} stroke={typeHex}/>
<span style={{fontSize:12, letterSpacing:â€œ0.08emâ€, textTransform:â€œuppercaseâ€, color:C.textMuted, fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€}}>{label}</span>
<span style={{fontSize:11, color:C.textDim}}>({items.length})</span>
<div style={{marginLeft:â€œautoâ€, transition:â€œtransform 0.2sâ€, transform: open ? â€œrotate(90deg)â€ : â€œrotate(0deg)â€}}>
<Ic n="right" size={14} stroke={C.textDim}/>
</div>
</button>

```
    {open && (
      <>
        {/* Header colonne */}
        <div style={{display:"flex", alignItems:"center", gap:12, padding:"7px 16px",
          borderBottom:`1px solid ${C.border}`, background:C.bg}}>
          <div style={{width:16, flexShrink:0}}/>
          <div style={{flex:"0 0 38%", fontSize:10, color:C.textDim, letterSpacing:"0.08em", textTransform:"uppercase"}}>Titolo / Compositore</div>
          <div style={{flex:"0 0 18%", fontSize:10, color:C.textDim, letterSpacing:"0.08em", textTransform:"uppercase"}}>TonalitÃ </div>
          <div style={{flex:"0 0 120px", fontSize:10, color:C.textDim, letterSpacing:"0.08em", textTransform:"uppercase"}}>DifficoltÃ </div>
          <div style={{flex:"0 0 90px", fontSize:10, color:C.textDim, letterSpacing:"0.08em", textTransform:"uppercase"}}>Tipo</div>
          <div style={{flex:"0 0 70px", fontSize:10, color:C.textDim, letterSpacing:"0.08em", textTransform:"uppercase", textAlign:"right"}}>Lezioni</div>
          {canEdit && <div style={{width:56}}/>}
        </div>
        {items.map(b => <BranoRow key={b.id} b={b}/>)}
      </>
    )}
  </div>
);
```

};

return (
<div style={{flex:1, padding:24, overflow:â€œautoâ€}}>
<div style={{maxWidth:1100, margin:â€œ0 autoâ€, display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:16}}>

```
    {/* Header */}
    <div style={{display:"flex", justifyContent:"space-between", alignItems:"center"}}>
      <div>
        <h1 style={{fontFamily:"'Cormorant Garamond',serif", fontSize:32, fontWeight:600}}>Repertorio</h1>
        <p style={{color:C.textMuted, fontSize:14, marginTop:4}}>
          {repertorio.length} brani totali Â· {repertorio.filter(b=>b.type==="individuale").length} individuali Â· {repertorio.filter(b=>b.type==="collettivo").length} collettivi
        </p>
      </div>
      {canEdit && <Btn onClick={()=>setModal("add")}><Ic n="plus" size={14} stroke={C.bg}/>Nuovo brano</Btn>}
    </div>

    {/* Barra ricerca + filtri a tendina */}
    <div style={{background:C.surface, border:`1px solid ${C.border}`, borderRadius:12, padding:"14px 16px",
      display:"flex", gap:10, flexWrap:"wrap", alignItems:"center"}}>
      {/* Ricerca */}
      <div style={{position:"relative", flex:"1 1 220px", minWidth:180}}>
        <span style={{position:"absolute", left:11, top:"50%", transform:"translateY(-50%)"}}>
          <Ic n="search" size={15} stroke={C.textDim}/>
        </span>
        <input value={search} onChange={e => setSearch(e.target.value)}
          placeholder="Cerca titolo, compositore, tonalitÃ ..."
          style={{width:"100%", background:C.bg, border:`1px solid ${search?C.goldDim:C.border}`,
            borderRadius:8, color:C.text, fontSize:13, padding:"9px 12px 9px 36px",
            fontFamily:"'DM Sans',sans-serif", transition:"border-color 0.15s"}}/>
      </div>

      {/* Tendina tipo */}
      <select value={filterType} onChange={e => setFT(e.target.value)}
        style={{flex:"0 0 130px", background:C.bg, border:`1px solid ${filterType?C.goldDim:C.border}`,
          borderRadius:8, color:filterType?C.gold:C.textMuted, fontSize:13,
          padding:"9px 12px", fontFamily:"'DM Sans',sans-serif", appearance:"none", cursor:"pointer"}}>
        <option value="">Tutti i tipi</option>
        <option value="individuale">Individuale</option>
        <option value="collettivo">Collettivo</option>
      </select>

      {/* Tendina difficoltÃ  */}
      <select value={filterDiff} onChange={e => setFD(e.target.value)}
        style={{flex:"0 0 155px", background:C.bg, border:`1px solid ${filterDiff?C.goldDim:C.border}`,
          borderRadius:8, color:filterDiff?C.gold:C.textMuted, fontSize:13,
          padding:"9px 12px", fontFamily:"'DM Sans',sans-serif", appearance:"none", cursor:"pointer"}}>
        <option value="">Tutte le difficoltÃ </option>
        {DIFFICULTY_OPTS.map(d => <option key={d} value={d}>{d}</option>)}
      </select>

      {/* Tendina compositore */}
      <select value={filterComp} onChange={e => setFC(e.target.value)}
        style={{flex:"0 0 180px", background:C.bg, border:`1px solid ${filterComp?C.goldDim:C.border}`,
          borderRadius:8, color:filterComp?C.gold:C.textMuted, fontSize:13,
          padding:"9px 12px", fontFamily:"'DM Sans',sans-serif", appearance:"none", cursor:"pointer"}}>
        <option value="">Tutti i compositori</option>
        {composers.map(c => <option key={c} value={c}>{c}</option>)}
      </select>

      {/* Reset filtri */}
      {hasFilters && (
        <button onClick={() => { setSearch(""); setFT(""); setFD(""); setFC(""); }}
          style={{background:"none", border:`1px solid ${C.border}`, borderRadius:8,
            color:C.textMuted, fontSize:12, padding:"9px 14px", cursor:"pointer",
            fontFamily:"'DM Sans',sans-serif", display:"flex", alignItems:"center", gap:5,
            transition:"all 0.12s", whiteSpace:"nowrap"}}
          onMouseEnter={e => { e.currentTarget.style.borderColor=C.red; e.currentTarget.style.color=C.red; }}
          onMouseLeave={e => { e.currentTarget.style.borderColor=C.border; e.currentTarget.style.color=C.textMuted; }}>
          <Ic n="x" size={13} stroke="currentColor"/>Azzera filtri
        </button>
      )}

      {/* Risultati */}
      <span style={{fontSize:12, color:C.textDim, marginLeft:"auto", whiteSpace:"nowrap"}}>
        {filtered.length} / {repertorio.length} brani
      </span>
    </div>

    {/* Sezioni accordion */}
    {filtered.length === 0 ? (
      <div style={{textAlign:"center", padding:"48px 0", color:C.textDim}}>
        <Ic n="note" size={32} stroke={C.textDim}/>
        <p style={{marginTop:12, fontSize:14}}>Nessun brano trovato</p>
        {hasFilters && <p style={{fontSize:12, marginTop:4}}>Prova ad azzera i filtri</p>}
      </div>
    ) : (
      <div style={{display:"flex", flexDirection:"column", gap:12}}>
        {individuali.length > 0 && (
          <AccordionSection label="Brani individuali" items={individuali} typeHex={C.gold} icon="solo"/>
        )}
        {collettivi.length > 0 && (
          <AccordionSection label="Brani collettivi" items={collettivi} typeHex={C.purple} icon="group"/>
        )}
      </div>
    )}
  </div>

  {modal==="add"    && <Modal title="Nuovo brano" onClose={()=>setModal(null)}><BranoFormInline onSave={b=>{onAdd(b);setModal(null);}} onClose={()=>setModal(null)}/></Modal>}
  {modal==="edit"   && target && <Modal title="Modifica brano" onClose={()=>setModal(null)}><BranoFormInline initial={target} onSave={b=>{onEdit({...target,...b});setModal(null);}} onClose={()=>setModal(null)}/></Modal>}
  {modal==="delete" && target && <ConfirmDelete label={target.title} onConfirm={()=>{onDelete(target.id);setModal(null);}} onClose={()=>setModal(null)}/>}
</div>
```

);
};

// â”€â”€â”€ FORM LEZIONE COLLETTIVA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CollectiveLessonForm = ({ courses, students, docenti:_docentiRaw, onSave, onClose }) => {
const docenti = _docentiRaw || [];
const collettivi = courses.filter(c => c.type === â€œcollettivoâ€);

const [step,        setStep]       = useState(1);      // 1=corso  2=dettagli+allievi
const [selCourse,   setSelCourse]  = useState(null);
const [selStudents, setSelStudents]= useState([]);      // id[] allievi selezionati
const [form, setForm] = useState({
date:      yyyymmdd(today),
hour:      â€œ15:00â€,
teacherId: â€œâ€,
room:      â€œâ€,
topic:     â€œâ€,
notes:     â€œâ€,
exercises: â€œâ€,
recurrence:â€œNessunaâ€,
});
const [err, setErr] = useState({});
const set = (k,v) => setForm(p=>({â€¦p,[k]:v}));

// Docenti assegnati al corso selezionato
const courseDocenti = selCourse
? docenti.filter(d => (selCourse.docenti||[]).includes(d.id))
: [];

// Allievi iscritti al corso e attivi
const enrolled = selCourse
? students.filter(s => s.complementaryCourse === selCourse.id && s.status === â€œattivoâ€)
: [];

const toggleStudent = id =>
setSelStudents(p => p.includes(id) ? p.filter(x=>x!==id) : [â€¦p, id]);
const selectAll   = () => setSelStudents(enrolled.map(s=>s.id));
const deselectAll = () => setSelStudents([]);

// Quando cambia il corso resetta il docente se non Ã¨ nel nuovo corso
const handleCourseSelect = (c) => {
setSelCourse(c);
setSelStudents([]);
// pre-seleziona il docente se câ€™Ã¨ uno solo
const docs = docenti.filter(d => (c.docenti||[]).includes(d.id));
set(â€œteacherIdâ€, docs.length === 1 ? docs[0].id : â€œâ€);
};

const validate = () => {
const e = {};
if (!form.date)                    e.date      = â€œData obbligatoriaâ€;
if (!form.hour)                    e.hour      = â€œOrario obbligatorioâ€;
if (!form.teacherId)               e.teacherId = â€œSeleziona il docenteâ€;
if (selStudents.length === 0)      e.students  = â€œSeleziona almeno un allievoâ€;
return e;
};

const handleSave = () => {
const e = validate();
if (Object.keys(e).length) { setErr(e); return; }
const teacherObj = docenti.find(d => d.id === form.teacherId);
const studObjs   = selStudents.map(id => {
const s = students.find(x => x.id === id);
return { id: s.id, name: s.name, instrument: s.instrument, level: s.level||â€â€ };
});
onSave({
id:         uid(),
tipo:       â€œcollettivoâ€,
courseId:   selCourse.id,
courseName: selCourse.name,
date:       form.date,
hour:       form.hour,
teacher:    teacherObj?.nome || teacherObj?.name || â€œâ€,
teacherId:  form.teacherId,
room:       form.room,
topic:      form.topic || selCourse.name,
notes:      form.notes,
exercises:  form.exercises,
recurrence: form.recurrence,
attendance: â€œâ€,
// campo compat. individuale (nome del corso per visualizzazioni legacy)
student:    selCourse.name,
instrument: â€œVariâ€,
// array allievi â€” la vera struttura collettiva
students:   studObjs,
});
};

// â”€â”€ STEP 1: scegli corso â”€â”€
if (step === 1) return (
<>
<div style={{padding:22, display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:14}}>
<p style={{fontSize:13, color:C.textMuted, margin:0}}>
Seleziona la materia integrativa per cui creare la sessione collettiva.
</p>
{collettivi.length === 0 ? (
<div style={{textAlign:â€œcenterâ€, padding:â€œ32px 0â€, color:C.textDim, fontSize:13}}>
Nessun corso collettivo configurato. Aggiungine uno dalla sezione <strong>Corsi</strong>.
</div>
) : (
<div style={{display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:8}}>
{collettivi.map(c => {
const nIscritti = students.filter(s=>s.complementaryCourse===c.id&&s.status===â€œattivoâ€).length;
const nDocenti  = (c.docenti||[]).length;
const isS = selCourse?.id === c.id;
return (
<button key={c.id} onClick={() => handleCourseSelect(c)}
style={{display:â€œflexâ€, alignItems:â€œcenterâ€, gap:14, padding:â€œ14px 16pxâ€,
borderRadius:10, cursor:â€œpointerâ€, textAlign:â€œleftâ€, width:â€œ100%â€,
border:`2px solid ${isS?C.purple:C.border}`,
background:isS?C.purpleBg:C.surface, transition:â€œall 0.15sâ€,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€}}>
<div style={{width:40, height:40, borderRadius:10, background:`${C.purple}20`,
border:`1px solid ${C.purpleBorder}`, display:â€œflexâ€, alignItems:â€œcenterâ€,
justifyContent:â€œcenterâ€, flexShrink:0}}>
<Ic n="group" size={18} stroke={C.purple}/>
</div>
<div style={{flex:1}}>
<div style={{fontSize:14, fontWeight:600, color:isS?C.purple:C.text}}>{c.name}</div>
{c.description && <div style={{fontSize:11, color:C.textMuted, marginTop:2}}>{c.description}</div>}
</div>
<div style={{textAlign:â€œrightâ€, flexShrink:0}}>
<div style={{fontSize:16, fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€, fontWeight:600,
color:nIscritti>0?C.purple:C.textDim}}>{nIscritti}</div>
<div style={{fontSize:9, color:C.textDim, textTransform:â€œuppercaseâ€, letterSpacing:â€œ0.06emâ€}}>allievi</div>
<div style={{fontSize:9, color:C.textDim, marginTop:1}}>{nDocenti} doc.</div>
</div>
</button>
);
})}
</div>
)}
</div>
<div style={{padding:â€œ14px 22pxâ€, borderTop:`1px solid ${C.border}`,
display:â€œflexâ€, justifyContent:â€œspace-betweenâ€}}>
<Btn variant="secondary" onClick={onClose}>Annulla</Btn>
<Btn onClick={() => { if(selCourse) setStep(2); }}>
Avanti <Ic n="right" size={14} stroke={C.bg}/>
</Btn>
</div>
</>
);

// â”€â”€ STEP 2: docente + dettagli + allievi â”€â”€
return (
<>
<div style={{padding:22, display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:14,
maxHeight:â€œ74vhâ€, overflowY:â€œautoâ€}}>

```
    {/* Header corso */}
    <div style={{display:"flex", alignItems:"center", gap:10, padding:"10px 14px",
      background:C.purpleBg, border:`1px solid ${C.purpleBorder}`, borderRadius:8}}>
      <Ic n="group" size={16} stroke={C.purple}/>
      <div style={{flex:1}}>
        <div style={{fontSize:13, fontWeight:600, color:C.purple}}>{selCourse.name}</div>
        {selCourse.description && <div style={{fontSize:11, color:C.textMuted, marginTop:1}}>{selCourse.description}</div>}
      </div>
      <button onClick={() => { setStep(1); setSelStudents([]); }}
        style={{background:"none", border:`1px solid ${C.border}`, borderRadius:6,
          cursor:"pointer", color:C.textMuted, fontSize:11, padding:"3px 10px",
          fontFamily:"'DM Sans',sans-serif"}}>
        Cambia
      </button>
    </div>

    {/* Selezione docente */}
    <div>
      <label style={{fontSize:11, color:err.teacherId?C.red:C.textMuted,
        letterSpacing:"0.07em", textTransform:"uppercase", display:"block", marginBottom:8}}>
        Docente *
      </label>
      {courseDocenti.length === 0 ? (
        <p style={{fontSize:12, color:C.textDim, fontStyle:"italic"}}>
          Nessun docente assegnato a questo corso. Modificalo dalla sezione Corsi.
        </p>
      ) : (
        <div style={{display:"flex", gap:8, flexWrap:"wrap"}}>
          {courseDocenti.map(d => {
            const isS = form.teacherId === d.id;
            return (
              <button key={d.id} onClick={() => set("teacherId", d.id)}
                style={{display:"flex", alignItems:"center", gap:8, padding:"8px 14px",
                  borderRadius:10, cursor:"pointer", textAlign:"left",
                  border:`2px solid ${isS?C.gold:C.border}`,
                  background:isS?C.goldBg:C.surface, transition:"all 0.12s",
                  fontFamily:"'DM Sans',sans-serif"}}>
                <div style={{width:30, height:30, borderRadius:"50%", flexShrink:0,
                  background:`${C.gold}20`, border:`1px solid ${C.goldDim}`,
                  display:"flex", alignItems:"center", justifyContent:"center",
                  fontSize:11, fontWeight:700, color:C.gold}}>
                  {initials(d.nome||d.name||"")}
                </div>
                <div>
                  <div style={{fontSize:13, fontWeight:500, color:isS?C.gold:C.text}}>
                    {d.nome||d.name}
                  </div>
                  <div style={{fontSize:10, color:C.textMuted}}>{d.strumenti||d.instrument||""}</div>
                </div>
              </button>
            );
          })}
        </div>
      )}
      {err.teacherId && <div style={{fontSize:11, color:C.red, marginTop:4}}>{err.teacherId}</div>}
    </div>

    {/* Data, orario, sala */}
    <div style={{display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))", gap:12}}>
      <Input label="Data *" type="date" value={form.date}
        onChange={e=>set("date",e.target.value)} error={err.date}/>
      <Input label="Orario *" type="time" value={form.hour}
        onChange={e=>set("hour",e.target.value)} error={err.hour}/>
      <Input label="Sala" value={form.room}
        onChange={e=>set("room",e.target.value)} placeholder="Es. Sala A"/>
    </div>
    <Input label="Argomento" value={form.topic}
      onChange={e=>set("topic",e.target.value)}
      placeholder={`Es. Introduzione a ${selCourse.name}`}/>
    <Textarea label="Note" value={form.notes}
      onChange={e=>set("notes",e.target.value)} placeholder="Annotazioni..."/>

    {/* Ricorrenza */}
    <div>
      <label style={{fontSize:11, color:C.textMuted, letterSpacing:"0.07em",
        textTransform:"uppercase", display:"block", marginBottom:8}}>Ricorrenza</label>
      <div style={{display:"flex", gap:6, flexWrap:"wrap"}}>
        {RECURRENCE_OPTS.map(r => (
          <button key={r} onClick={() => set("recurrence",r)}
            style={{padding:"6px 14px", borderRadius:20, fontSize:12,
              border:`2px solid ${form.recurrence===r?C.blue:C.border}`,
              background:form.recurrence===r?C.blueBg:C.bg,
              color:form.recurrence===r?C.blue:C.textMuted, cursor:"pointer",
              fontFamily:"'DM Sans',sans-serif", display:"flex", alignItems:"center",
              gap:5, transition:"all 0.12s"}}>
            {r!=="Nessuna" && <Ic n="repeat" size={11} stroke={form.recurrence===r?C.blue:C.textMuted}/>}
            {r}
          </button>
        ))}
      </div>
    </div>

    {/* Selezione allievi */}
    <div>
      <div style={{display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:8}}>
        <label style={{fontSize:11, color:err.students?C.red:C.textMuted,
          letterSpacing:"0.07em", textTransform:"uppercase"}}>
          Allievi iscritti *
        </label>
        <div style={{display:"flex", gap:6}}>
          <button onClick={selectAll}
            style={{fontSize:11, padding:"2px 10px", borderRadius:6, cursor:"pointer",
              background:C.purpleBg, color:C.purple, border:`1px solid ${C.purpleBorder}`,
              fontFamily:"'DM Sans',sans-serif"}}>Tutti</button>
          <button onClick={deselectAll}
            style={{fontSize:11, padding:"2px 10px", borderRadius:6, cursor:"pointer",
              background:C.bg, color:C.textMuted, border:`1px solid ${C.border}`,
              fontFamily:"'DM Sans',sans-serif"}}>Nessuno</button>
        </div>
      </div>
      {err.students && <div style={{fontSize:11, color:C.red, marginBottom:6}}>{err.students}</div>}

      {enrolled.length === 0 ? (
        <div style={{padding:"20px 0", textAlign:"center", color:C.textDim, fontSize:13}}>
          Nessun allievo attivo iscritto a questo corso.
        </div>
      ) : (
        <div style={{display:"flex", flexDirection:"column", gap:5}}>
          {enrolled.map(s => {
            const isSel = selStudents.includes(s.id);
            const sc    = insHex(s.instrument);
            return (
              <button key={s.id} onClick={() => toggleStudent(s.id)}
                style={{display:"flex", alignItems:"center", gap:10, padding:"9px 12px",
                  borderRadius:8, cursor:"pointer", textAlign:"left", width:"100%",
                  border:`2px solid ${isSel?sc:C.border}`,
                  background:isSel?`${sc}10`:C.surface, transition:"all 0.12s",
                  fontFamily:"'DM Sans',sans-serif"}}>
                {/* checkbox */}
                <div style={{width:18, height:18, borderRadius:5, flexShrink:0,
                  border:`2px solid ${isSel?sc:C.border}`, background:isSel?sc:"transparent",
                  display:"flex", alignItems:"center", justifyContent:"center",
                  transition:"all 0.12s"}}>
                  {isSel && <Ic n="check" size={10} stroke={C.bg}/>}
                </div>
                {/* avatar */}
                <div style={{width:30, height:30, borderRadius:"50%", flexShrink:0,
                  background:`${sc}20`, border:`1px solid ${sc}40`,
                  display:"flex", alignItems:"center", justifyContent:"center",
                  fontSize:10, fontWeight:700, color:sc}}>
                  {initials(s.name)}
                </div>
                <div style={{flex:1}}>
                  <div style={{fontSize:13, fontWeight:500, color:isSel?sc:C.text}}>{s.name}</div>
                  <div style={{fontSize:11, color:C.textMuted}}>{s.instrument} Â· {s.level||"â€”"}</div>
                </div>
                {isSel && <Ic n="check" size={13} stroke={sc}/>}
              </button>
            );
          })}
        </div>
      )}

      {/* Riepilogo */}
      {selStudents.length > 0 && (
        <div style={{marginTop:8, padding:"8px 14px", background:C.purpleBg,
          border:`1px solid ${C.purpleBorder}`, borderRadius:8, fontSize:12,
          color:C.purple, display:"flex", alignItems:"center", gap:6}}>
          <Ic n="group" size={13} stroke={C.purple}/>
          {selStudents.length} allievo/i Â· 1 lezione con tutti gli allievi assegnati
        </div>
      )}
    </div>
  </div>

  <div style={{padding:"14px 22px", borderTop:`1px solid ${C.border}`,
    display:"flex", justifyContent:"space-between", alignItems:"center"}}>
    <Btn variant="secondary" onClick={() => setStep(1)}>
      <Ic n="left" size={14} stroke={C.textMuted}/>Indietro
    </Btn>
    <Btn onClick={handleSave}>
      <Ic n="check" size={14} stroke={C.bg}/>
      Crea lezione{selStudents.length>0?` (${selStudents.length} allievi)`:""}
    </Btn>
  </div>
</>
```

);
};

// â”€â”€â”€ FORM LEZIONE PROVA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const emptyProva = {
date: yyyymmdd(today), hour:â€œ09:00â€, teacher:â€â€, instrument:â€â€,
room:â€â€, phone:â€â€, contactName:â€â€, notes:â€â€, student:â€â€, iscritto:false, attendance:â€â€,
};

const TrialLessonForm = ({ docenti:_docentiRaw, courses:_coursesRaw, initial, onSave, onClose, date }) => {
const docenti = _docentiRaw || [];
const courses = _coursesRaw || [];
const [f, setF] = useState(initial || {â€¦emptyProva, date: date || yyyymmdd(today)});
const [err, setErr] = useState({});
const set = (k,v) => setF(p=>({â€¦p,[k]:v}));

// Corsi individuali + collettivi come opzioni strumento/corso
const corsiOpts = [
â€¦courses.filter(c=>c.type===â€œcollettivoâ€).map(c=>({id:c.id, label:c.name})),
â€¦[â€œPianoforteâ€,â€œViolinoâ€,â€œChitarraâ€,â€œFlautoâ€,â€œBatteriaâ€,â€œCantoâ€,â€œSassofonoâ€,â€œTrombaâ€,â€œVioloncelloâ€,â€œSolfeggioâ€]
.filter(s => !courses.find(c=>c.name===s))
.map(s=>({id:s, label:s}))
];

const validate = () => {
const e = {};
if(!f.teacher)    e.teacher    = â€œSeleziona un docenteâ€;
if(!f.instrument) e.instrument = â€œSeleziona un corso/strumentoâ€;
if(!f.date)       e.date       = â€œData obbligatoriaâ€;
if(!f.hour)       e.hour       = â€œOrario obbligatorioâ€;
if(!f.phone.trim()) e.phone    = â€œRecapito obbligatorioâ€;
return e;
};

const handleSave = () => {
const e = validate();
if(Object.keys(e).length){ setErr(e); return; }
onSave({
â€¦f, id: uid(), tipo:â€œprovaâ€,
student: â€œâ€, iscritto: false, attendance:â€â€,
recurrence:â€œNessunaâ€, repertorioIds:[],
});
};

return (
<>
<div style={{padding:22, display:â€œflexâ€, flexDirection:â€œcolumnâ€, gap:14}}>
{/* Banner informativo */}
<div style={{padding:â€œ10px 14pxâ€, background:C.tealBg, border:`1px solid ${C.tealBorder}`,
borderRadius:8, display:â€œflexâ€, alignItems:â€œcenterâ€, gap:10}}>
<Ic n="user" size={15} stroke={C.teal}/>
<div>
<div style={{fontSize:12, fontWeight:600, color:C.teal}}>Lezione di prova</div>
<div style={{fontSize:11, color:C.teal, opacity:0.8, marginTop:1}}>
Nessun allievo ancora iscritto â€” il contatto verrÃ  collegato allâ€™allievo dopo lâ€™iscrizione
</div>
</div>
</div>

```
    {/* Nome contatto */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:12}} className="form-2col">
      <div>
        <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Nome contatto</label>
        <input value={f.contactName} onChange={e=>set("contactName",e.target.value)}
          placeholder="Es. Marco Rossi"
          style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
            color:C.text,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",boxSizing:"border-box"}}/>
      </div>
      <div>
        <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Recapito telefonico *</label>
        <input type="tel" value={f.phone} onChange={e=>set("phone",e.target.value)}
          placeholder="Es. 333 1234567"
          style={{width:"100%",background:C.surface,border:`1px solid ${err.phone?C.red:C.border}`,
            borderRadius:8,color:C.text,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",boxSizing:"border-box"}}/>
        {err.phone && <div style={{fontSize:11,color:C.red,marginTop:4}}>{err.phone}</div>}
      </div>
    </div>

    {/* Docente */}
    <div>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>
        Docente *
      </label>
      <select value={f.teacher} onChange={e=>set("teacher",e.target.value)}
        style={{width:"100%",background:C.surface,border:`1px solid ${err.teacher?C.red:C.border}`,
          borderRadius:8,color:f.teacher?C.text:C.textMuted,fontSize:13,padding:"10px 14px",
          fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
        <option value="">â€” seleziona docente â€”</option>
        {docenti.map(d=>(
          <option key={d.id} value={d.teacherKey||d.nome}>{d.nome} Â· {d.strumenti}</option>
        ))}
      </select>
      {err.teacher && <div style={{fontSize:11,color:C.red,marginTop:4}}>{err.teacher}</div>}
    </div>

    {/* Corso / Strumento */}
    <div>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>
        Corso / Strumento *
      </label>
      <select value={f.instrument} onChange={e=>set("instrument",e.target.value)}
        style={{width:"100%",background:C.surface,border:`1px solid ${err.instrument?C.red:C.border}`,
          borderRadius:8,color:f.instrument?C.text:C.textMuted,fontSize:13,padding:"10px 14px",
          fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
        <option value="">â€” seleziona corso â€”</option>
        {corsiOpts.map(c=><option key={c.id} value={c.label}>{c.label}</option>)}
      </select>
      {err.instrument && <div style={{fontSize:11,color:C.red,marginTop:4}}>{err.instrument}</div>}
    </div>

    {/* Data e Orario */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:12}} className="form-2col">
      <div>
        <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Data *</label>
        <input type="date" value={f.date} onChange={e=>set("date",e.target.value)}
          style={{width:"100%",background:C.surface,border:`1px solid ${err.date?C.red:C.border}`,
            borderRadius:8,color:C.text,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",boxSizing:"border-box"}}/>
        {err.date && <div style={{fontSize:11,color:C.red,marginTop:4}}>{err.date}</div>}
      </div>
      <div>
        <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Orario *</label>
        <input type="time" value={f.hour} onChange={e=>set("hour",e.target.value)}
          style={{width:"100%",background:C.surface,border:`1px solid ${err.hour?C.red:C.border}`,
            borderRadius:8,color:C.text,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",boxSizing:"border-box"}}/>
        {err.hour && <div style={{fontSize:11,color:C.red,marginTop:4}}>{err.hour}</div>}
      </div>
    </div>

    {/* Sala */}
    <div>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Sala</label>
      <input value={f.room} onChange={e=>set("room",e.target.value)}
        placeholder="Es. Sala A"
        style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
          color:C.text,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",boxSizing:"border-box"}}/>
    </div>

    {/* Note */}
    <div>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Note</label>
      <textarea value={f.notes} onChange={e=>set("notes",e.target.value)} rows={3}
        placeholder="Motivazioni, interessi musicali, strumento richiesto..."
        style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
          color:C.text,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",
          resize:"vertical",lineHeight:1.5,boxSizing:"border-box"}}/>
    </div>
  </div>

  <div style={{padding:"14px 22px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"flex-end",gap:10}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={handleSave} style={{background:C.teal, borderColor:C.teal}}>
      <Ic n="user" size={14} stroke={C.bg}/>Crea lezione prova
    </Btn>
  </div>
</>
```

);
};

// â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CalendarioView = ({ lessons:propLessons, setLessons:propSetLessons, courses:_propCoursesRaw, students:_propStudentsRaw, docenti:_propDocentiRaw }) => {
const isMobile = useIsMobile();
const propCourses = _propCoursesRaw || [];
const propStudents = _propStudentsRaw || [];
const propDocenti = _propDocentiRaw || [];
const [_lessons, _setLessons] = useState(INIT_LESSONS);
const lessons    = propLessons    ?? _lessons;
const setLessons = propSetLessons ?? _setLessons;
const [viewMode,  setViewMode]  = useState(â€œdayâ€);
const [curDate,   setCurDate]   = useState(new Date(today));
const [modal,     setModal]     = useState(null);
const [selLesson, setSelLesson] = useState(null);
const [addDate,   setAddDate]   = useState(null);
const [role,      setRole]      = useState(â€œadminâ€); // admin | docente | allievo
const currentStudent = â€œSofia Marchettiâ€; // in produzione verrÃ  dal sistema di login
const [repertorio,  setRepertorio] = useState(INIT_REPERTORIO);
const [appView,     setAppView]    = useState(â€œcalendarioâ€); // calendario | repertorio

```
const closeModal = () => { setModal(null); setSelLesson(null); setAddDate(null); setNextLessonCreated(null); };

const navigate = (dir) => {
  const d = new Date(curDate);
  if(viewMode === "day")   d.setDate(d.getDate()+dir);
  if(viewMode === "week")  d.setDate(d.getDate()+dir*7);
  if(viewMode === "month") d.setMonth(d.getMonth()+dir);
  setCurDate(d);
};

const navLabel = useMemo(() => {
  if(viewMode === "day")   return fmtFull(curDate);
  if(viewMode === "month") return `${MONTHS[curDate.getMonth()]} ${curDate.getFullYear()}`;
  const ws = startOfWeek(curDate);
  const we = addDays(ws, 6);
  return `${fmtShort(ws)} â€“ ${fmtShort(we)} ${we.getFullYear()}`;
}, [viewMode, curDate]);

const weekStart = startOfWeek(curDate);

// Espone il repertorio globalmente per il modal dettaglio (workaround senza prop drilling)
window.__repertorio__ = repertorio;

const [nextLessonCreated, setNextLessonCreated] = useState(null);

const handleAdd        = (data)      => { setLessons(p => [...p, {...data, id:uid()}]); closeModal(); };
const handleAddProva   = (data)      => { setLessons(p => [...p, data]); closeModal(); };
const handleIscrizioneProva = (id, studentName, iscritto) => {
  setLessons(p => p.map(l => l.id === id
    ? {...l, iscritto, student: iscritto ? studentName : ""}
    : l
  ));
};
const handleAddCollective  = (lesson) => { setLessons(p => [...p, lesson]); closeModal(); };
const handleEdit       = (data)      => { setLessons(p => p.map(l => l.id === data.id ? {...l,...data} : l)); closeModal(); };
const handleDelete     = ()          => { setLessons(p => p.filter(l => l.id !== selLesson?.id)); closeModal(); };
const handleAttendance = (id, val) => {
  setLessons(prev => {
    const updated = prev.map(l => l.id === id ? {...l, attendance:val} : l);

    // Se segno presenza (qualsiasi valore) su lezione ricorrente â†’ crea la prossima
    const lesson = prev.find(l => l.id === id);
    if (lesson && val && val !== "" && lesson.recurrence && lesson.recurrence !== "Nessuna") {
      const daysMap = { "Ogni settimana":7, "Ogni 2 settimane":14, "Ogni mese":30 };
      const gap     = daysMap[lesson.recurrence] || 7;
      const nextDate = yyyymmdd(addDays(new Date(lesson.date+"T00:00:00"), gap));

      // Evita duplicati: controlla se esiste giÃ  una lezione stesso studente/ora/data
      const exists = updated.some(l =>
        l.date === nextDate &&
        l.hour === lesson.hour &&
        (isColl(lesson)
          ? l.courseId === lesson.courseId
          : l.student  === lesson.student)
      );
      if (!exists) {
        const nextLesson = {
          ...lesson,
          id:         uid(),
          date:       nextDate,
          attendance: "",
          notes:      "",
          exercises:  "",
        };
        setNextLessonCreated(nextDate); // feedback toast
        return [...updated, nextLesson];
      }
    }
    return updated;
  });
  setSelLesson(p => p ? {...p, attendance:val} : p);
};

const [filterCorso,   setFilterCorso]   = useState("");
const [filterDocente, setFilterDocente] = useState("");
const [filterTipo,    setFilterTipo]    = useState("");

const visibleLessons = useMemo(() => {
  let ls = role === "allievo"
    ? lessons.filter(l => studentInLesson(l, currentStudent))
    : lessons;
  if (filterCorso) {
    ls = ls.filter(l =>
      isColl(l)
        ? l.courseId === filterCorso
        : l.instrument === filterCorso
    );
  }
  if (filterDocente) {
    ls = ls.filter(l => l.teacher === filterDocente);
  }
  if (filterTipo) {
    if (filterTipo === "prova")     ls = ls.filter(l => isProva(l));
    else if (filterTipo === "collettivo") ls = ls.filter(l => isColl(l));
    else if (filterTipo === "normale")    ls = ls.filter(l => !isProva(l) && !isColl(l));
  }
  return ls;
}, [lessons, role, filterCorso, filterDocente, filterTipo]);

const todayStr     = yyyymmdd(today);
const todayLessons = visibleLessons.filter(l => l.date === todayStr);
const ws           = startOfWeek(today);
const we           = addDays(ws, 6);
const weekLessons  = visibleLessons.filter(l => l.date >= yyyymmdd(ws) && l.date <= yyyymmdd(we));
const pending      = visibleLessons.filter(l => l.date <= todayStr && !l.attendance).length;

return (
  <>
    <style>{G}</style>
    <div style={{minHeight:"100vh", background:C.bg, display:"flex", flexDirection:"column"}}>

      {/* Navbar */}
      <div style={{background:C.surface, borderBottom:`1px solid ${C.border}`,
        padding:"0 16px", display:"flex", alignItems:"center", flexShrink:0, flexWrap:"wrap"}}>
        <div style={{display:"flex", alignItems:"center", gap:10, padding:"14px 0"}}>
          <div style={{width:26, height:26, borderRadius:6, background:C.gold,
            display:"flex", alignItems:"center", justifyContent:"center"}}>
            <Ic n="music" size={13} stroke={C.bg}/>
          </div>
          <span style={{fontFamily:"'Cormorant Garamond',serif", fontSize:15, fontWeight:600}}>Accademia Musicale Â· Calendario</span>
        </div>
      </div>

      {/* Calendario sempre visibile */}
      {true && <>

      {/* Stats ribbon */}
      <div style={{background:C.surface, borderBottom:`1px solid ${C.border}`,
        padding:"8px 16px", display:"flex", gap:16, flexShrink:0, overflowX:"auto", WebkitOverflowScrolling:"touch"}}>
        {[
          { label:"Oggi",                  count:todayLessons.length, sub:"lezioni",       hex:C.gold   },
          { label:"Questa settimana",       count:weekLessons.length,  sub:"lezioni",       hex:C.blue   },
          { label:"Presenza da segnare",    count:pending,             sub:"lezioni passate", hex:pending > 0 ? C.orange : C.green },
        ].map(s => (
          <div key={s.label} style={{display:"flex", alignItems:"center", gap:10}}>
            <div style={{fontFamily:"'Cormorant Garamond',serif", fontSize:24, fontWeight:600, color:s.hex}}>{s.count}</div>
            <div style={{fontSize:11}}>
              <div style={{color:s.hex, opacity:0.8, textTransform:"uppercase", letterSpacing:"0.06em", fontSize:10}}>{s.label}</div>
              <div style={{color:C.textDim}}>{s.sub}</div>
            </div>
            <div style={{width:1, height:30, background:C.border, marginLeft:12}}/>
          </div>
        ))}
      </div>

      {/* Toolbar */}
      <div className="cal-toolbar" style={{padding:isMobile?"10px 12px":"14px 24px", display:"flex", justifyContent:"space-between",
        alignItems:"center", flexShrink:0, gap:isMobile?8:12, flexWrap:"wrap"}}>
        <div style={{display:"flex", alignItems:"center", gap:8}}>
          <button onClick={() => navigate(-1)} style={{background:C.surface, border:`1px solid ${C.border}`,
            borderRadius:8, color:C.textMuted, padding:"7px 10px", cursor:"pointer", display:"flex"}}>
            <Ic n="left" size={16} stroke={C.textMuted}/>
          </button>
          <button onClick={() => navigate(1)} style={{background:C.surface, border:`1px solid ${C.border}`,
            borderRadius:8, color:C.textMuted, padding:"7px 10px", cursor:"pointer", display:"flex"}}>
            <Ic n="right" size={16} stroke={C.textMuted}/>
          </button>
          <button onClick={() => setCurDate(new Date(today))}
            style={{background:C.surface, border:`1px solid ${C.border}`, borderRadius:8,
              color:C.textMuted, padding:"7px 12px", cursor:"pointer", fontSize:12,
              fontFamily:"'DM Sans',sans-serif", display:"flex", alignItems:"center", gap:6}}>
            <Ic n="today" size={13} stroke={C.textMuted}/>Oggi
          </button>
          <span className="cal-nav-label" style={{fontFamily:"'Cormorant Garamond',serif", fontSize:18, fontWeight:600,
            marginLeft:4, color:C.text, whiteSpace:"nowrap"}}>{navLabel}</span>
        </div>

        <div className="cal-toolbar-right" style={{display:"flex", gap:8, alignItems:"center", flexWrap:"wrap"}}>
          <div style={{display:"flex", background:C.surface, border:`1px solid ${C.border}`,
            borderRadius:8, overflow:"hidden"}}>
            {[["day","Giorno","day"],["week","Settimana","week"],["month","Mese","cal"]].map(([v, lbl, icon]) => (
              <button key={v} onClick={() => setViewMode(v)}
                style={{padding:"7px 10px", border:"none",
                  background: viewMode === v ? `${C.gold}20` : "transparent",
                  color: viewMode === v ? C.gold : C.textMuted,
                  cursor:"pointer", fontSize:12, fontFamily:"'DM Sans',sans-serif",
                  display:"flex", alignItems:"center", gap:4, transition:"all 0.12s",
                  borderRight:`1px solid ${C.border}`}}>
                <Ic n={icon} size={13} stroke={viewMode === v ? C.gold : C.textMuted}/>
                <span className="tb-label">{lbl}</span>
              </button>
            ))}
          </div>
          {(role === "admin" || role === "docente") && (
            <div style={{display:"flex",gap:8}}>
              <Btn variant="secondary" onClick={() => { setAddDate(viewMode==="day"?yyyymmdd(curDate):yyyymmdd(today)); setModal("addprova"); }}
                style={{border:`1px solid ${C.teal}`,color:C.teal,background:C.tealBg}}>
                <Ic n="user" size={14} stroke={C.teal}/><span className="tb-label">Lezione prova</span>
              </Btn>
              <Btn variant="secondary" onClick={() => setModal("addcoll")}
                style={{border:`1px solid ${C.purple}`,color:C.purple,background:C.purpleBg}}>
                <Ic n="group" size={14} stroke={C.purple}/><span className="tb-label">Collettiva</span>
              </Btn>
              <Btn onClick={() => { setAddDate(viewMode === "day" ? yyyymmdd(curDate) : yyyymmdd(today)); setModal("add"); }}>
                <Ic n="plus" size={14} stroke={C.bg}/><span className="tb-label">Nuova lezione</span>
              </Btn>
            </div>
          )}
        </div>
      </div>

      {/* Barra filtri */}
      {(role === "admin" || role === "docente") && (() => {
        // Valori unici di docente e corso dalle lezioni
        const docenteOpts = [...new Set(lessons.map(l=>l.teacher).filter(Boolean))].sort();
        // Corsi: collettivi (dal nome) + strumenti individuali
        const corsiColl = [...new Map(
          lessons.filter(isColl).map(l=>[l.courseId, {id:l.courseId, label:l.courseName||"Collettiva", coll:true}])
        ).values()];
        const strumentiInd = [...new Set(
          lessons.filter(l=>!isColl(l)).map(l=>l.instrument).filter(Boolean)
        )].sort().map(s=>({id:s, label:s, coll:false}));
        const corsiOpts = [...corsiColl, ...strumentiInd];
        const hasFilter = filterCorso || filterDocente || filterTipo;
        return (
          <div style={{padding:"6px 16px 8px", background:C.surface,
            borderBottom:`1px solid ${C.border}`, display:"flex", alignItems:"center",
            gap:8, flexWrap:"wrap", flexShrink:0, overflowX:"auto"}}>
            <Ic n="filter" size={13} stroke={C.textDim}/>
            {/* Filtro corso/strumento */}
            <div style={{position:"relative", display:"flex", alignItems:"center"}}>
              <select value={filterCorso} onChange={e=>setFilterCorso(e.target.value)}
                style={{appearance:"none", background:filterCorso?C.goldBg:C.bg,
                  border:`1px solid ${filterCorso?C.goldDim:C.border}`, borderRadius:8,
                  padding:"5px 28px 5px 10px", fontSize:12, color:filterCorso?C.gold:C.textMuted,
                  cursor:"pointer", fontFamily:"'DM Sans',sans-serif", minWidth:0}}>
                <option value="">Tutti i corsi</option>
                {corsiColl.length>0 && <optgroup label="Corsi collettivi">
                  {corsiColl.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}
                </optgroup>}
                {strumentiInd.length>0 && <optgroup label="Strumenti individuali">
                  {strumentiInd.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}
                </optgroup>}
              </select>
              <Ic n="right" size={11} stroke={filterCorso?C.gold:C.textDim}
                style={{position:"absolute", right:8, pointerEvents:"none", transform:"rotate(90deg)"}}/>
            </div>
            {/* Filtro docente */}
            <div style={{position:"relative", display:"flex", alignItems:"center"}}>
              <select value={filterDocente} onChange={e=>setFilterDocente(e.target.value)}
                style={{appearance:"none", background:filterDocente?C.goldBg:C.bg,
                  border:`1px solid ${filterDocente?C.goldDim:C.border}`, borderRadius:8,
                  padding:"5px 28px 5px 10px", fontSize:12, color:filterDocente?C.gold:C.textMuted,
                  cursor:"pointer", fontFamily:"'DM Sans',sans-serif", minWidth:0}}>
                <option value="">Tutti i docenti</option>
                {docenteOpts.map(d=><option key={d} value={d}>{d}</option>)}
              </select>
              <Ic n="right" size={11} stroke={filterDocente?C.gold:C.textDim}
                style={{position:"absolute", right:8, pointerEvents:"none", transform:"rotate(90deg)"}}/>
            </div>
            {/* Filtro tipo lezione */}
            <div style={{position:"relative", display:"flex", alignItems:"center"}}>
              <select value={filterTipo} onChange={e=>setFilterTipo(e.target.value)}
                style={{appearance:"none", background:filterTipo?C.tealBg:C.bg,
                  border:`1px solid ${filterTipo?C.tealBorder:C.border}`, borderRadius:8,
                  padding:"5px 28px 5px 10px", fontSize:12, color:filterTipo?C.teal:C.textMuted,
                  cursor:"pointer", fontFamily:"'DM Sans',sans-serif", minWidth:0}}>
                <option value="">Tutti i tipi</option>
                <option value="normale">Individuali</option>
                <option value="collettivo">Collettive</option>
                <option value="prova">Lezioni prova</option>
              </select>
              <Ic n="right" size={11} stroke={filterTipo?C.teal:C.textDim}
                style={{position:"absolute", right:8, pointerEvents:"none", transform:"rotate(90deg)"}}/>
            </div>

            {/* Reset filtri */}
            {hasFilter && (
              <button onClick={()=>{setFilterCorso(""); setFilterDocente(""); setFilterTipo("");}}
                style={{display:"flex", alignItems:"center", gap:5, padding:"5px 10px",
                  borderRadius:8, border:`1px solid ${C.border}`, background:C.bg,
                  cursor:"pointer", fontSize:11, color:C.textMuted,
                  fontFamily:"'DM Sans',sans-serif"}}>
                <Ic n="x" size={11} stroke={C.textMuted}/>Reset
              </button>
            )}
            {hasFilter && (
              <span style={{fontSize:11, color:C.textDim, marginLeft:4}}>
                {visibleLessons.length} lezione/i
              </span>
            )}
          </div>
        );
      })()}

      {/* Contenuto */}
      <div style={{flex:1, padding:"0 12px 12px", overflow:"auto"}}>
        <div style={{background:C.surface, border:`1px solid ${C.border}`, borderRadius:12, overflow:"hidden"}} className="table-scroll">
          {viewMode === "day"   && <div style={{padding:20}}><DayView date={curDate} lessons={visibleLessons} onSelect={l => { setSelLesson(l); setModal("detail"); }}/></div>}
          {viewMode === "week"  && <WeekView  weekStart={weekStart} lessons={visibleLessons} onSelect={l => { setSelLesson(l); setModal("detail"); }}/>}
          {viewMode === "month" && <MonthView year={curDate.getFullYear()} month={curDate.getMonth()} lessons={visibleLessons} onSelect={l => { setSelLesson(l); setModal("detail"); }} onDayClick={d => { setCurDate(d); setViewMode("day"); }}/>}
        </div>
      </div>
      </>}
    </div>

    {modal === "add" && (
      <Modal title="Nuova lezione" onClose={closeModal} wide>
        <LessonForm initial={addDate ? {...emptyLesson, date:addDate} : undefined} onSave={handleAdd} onClose={closeModal} repertorio={repertorio} onAddBrano={b => setRepertorio(p=>[...p,b])}/>
      </Modal>
    )}
    {modal === "edit" && selLesson && (
      <Modal title="Modifica lezione" onClose={closeModal} wide>
        <LessonForm initial={selLesson} onSave={handleEdit} onClose={closeModal} repertorio={repertorio} onAddBrano={b => setRepertorio(p=>[...p,b])}/>
      </Modal>
    )}
    {modal === "detail" && selLesson && (
      <LessonDetailModal
        lesson={lessons.find(l => l.id === selLesson.id) || selLesson}
        onEdit={() => setModal("edit")}
        onDelete={() => setModal("delete")}
        onAttendance={handleAttendance}
        onIscrizione={handleIscrizioneProva}
        students={propStudents}
        nextLessonDate={selLesson?.recurrence && selLesson.recurrence !== 'Nessuna' ? nextLessonCreated : null}
        onClose={closeModal}
        role={role}/>
    )}
    {modal === "delete" && selLesson && (
      <ConfirmDel label={selLesson.student} onConfirm={handleDelete} onClose={closeModal}/>
    )}
    {modal === "addcoll" && (
      <Modal title="Nuova lezione collettiva" onClose={closeModal} wide>
        <CollectiveLessonForm
          courses={propCourses}
          students={propStudents}
          docenti={propDocenti}
          onSave={handleAddCollective}
          onClose={closeModal}/>
      </Modal>
    )}
    {modal === "addprova" && (
      <Modal title="Lezione di prova" onClose={closeModal} wide>
        <TrialLessonForm
          docenti={propDocenti}
          courses={propCourses}
          date={addDate}
          onSave={handleAddProva}
          onClose={closeModal}/>
      </Modal>
    )}
  </>
);
```

};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CONTABILITÃ€

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ COSTANTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ANNO_ATT = new Date().getFullYear();
const MESE_ATT = new Date().getMonth();
const CATEGORIE = [
{ id:â€œdocentiâ€,       label:â€œCompensi docentiâ€,   hex:C.gold,   bg:C.goldBg,    bd:C.goldDim    },
{ id:â€œpulizieâ€,       label:â€œPulizieâ€,             hex:C.teal,   bg:C.tealBg,    bd:C.tealBorder },
{ id:â€œrappresentanzaâ€,label:â€œRappresentanzaâ€,      hex:C.purple, bg:C.purpleBg,  bd:C.purpleBorder},
{ id:â€œmaterialeâ€,     label:â€œAcquisto materialeâ€,  hex:C.blue,   bg:C.blueBg,    bd:C.blueBorder },
{ id:â€œutenzeâ€,        label:â€œUtenzeâ€,              hex:C.orange, bg:C.orangeBg,  bd:C.orangeBorder},
{ id:â€œmanutenzioneâ€,  label:â€œManutenzioneâ€,        hex:C.red,    bg:C.redBg,     bd:C.redBorder  },
{ id:â€œaltroâ€,         label:â€œAltroâ€,               hex:C.textMuted,bg:C.surface, bd:C.border     },
];
const catById = id => CATEGORIE.find(c=>c.id===id)||CATEGORIE[CATEGORIE.length-1];

const METODI_PAG = [â€œBonifico bancarioâ€,â€œContantiâ€,â€œCarta / POSâ€,â€œPayPal / Satispayâ€,â€œAssegnoâ€];

const DOCENTI = [
{id:â€œd1â€,name:â€œProf. Rossiâ€,   instrument:â€œPianoforte / Violinoâ€, baseOraria:35},
{id:â€œd2â€,name:â€œProf. Bianchiâ€, instrument:â€œChitarra / Flautoâ€,    baseOraria:35},
{id:â€œd3â€,name:â€œProf. Verdeâ€,   instrument:â€œBatteriaâ€,             baseOraria:35},
{id:â€œd4â€,name:â€œProf. Marinoâ€,  instrument:â€œCantoâ€,                baseOraria:35},
];

// â”€â”€â”€ DATI DEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mkSpesa = (id,categoria,desc,importo,mese,anno,metodo,data,docenteId=null,note=â€â€) =>
({id,categoria,desc,importo,mese,anno,metodo,data,docenteId,note});

const INIT_SPESE = [
// Compensi docenti
mkSpesa(â€œe001â€,â€œdocentiâ€,â€œCompenso mensile Prof. Rossiâ€,   980, 0,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-01-28`,â€œd1â€),
mkSpesa(â€œe002â€,â€œdocentiâ€,â€œCompenso mensile Prof. Bianchiâ€, 840, 0,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-01-28`,â€œd2â€),
mkSpesa(â€œe003â€,â€œdocentiâ€,â€œCompenso mensile Prof. Verdeâ€,   700, 0,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-01-28`,â€œd3â€),
mkSpesa(â€œe004â€,â€œdocentiâ€,â€œCompenso mensile Prof. Rossiâ€,   980, 1,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-02-28`,â€œd1â€),
mkSpesa(â€œe005â€,â€œdocentiâ€,â€œCompenso mensile Prof. Bianchiâ€, 840, 1,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-02-28`,â€œd2â€),
mkSpesa(â€œe006â€,â€œdocentiâ€,â€œCompenso mensile Prof. Verdeâ€,   700, 1,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-02-28`,â€œd3â€),
mkSpesa(â€œe007â€,â€œdocentiâ€,â€œCompenso mensile Prof. Rossiâ€,   980, 2,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-03-28`,â€œd1â€),
mkSpesa(â€œe008â€,â€œdocentiâ€,â€œCompenso mensile Prof. Bianchiâ€, 840, 2,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-03-28`,â€œd2â€),
mkSpesa(â€œe009â€,â€œdocentiâ€,â€œCompenso mensile Prof. Verdeâ€,   700, 2,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-03-28`,â€œd3â€),
mkSpesa(â€œe010â€,â€œdocentiâ€,â€œCompenso mensile Prof. Rossiâ€,   980, 3,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-04-28`,â€œd1â€),
mkSpesa(â€œe011â€,â€œdocentiâ€,â€œCompenso mensile Prof. Bianchiâ€, 840, 3,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-04-28`,â€œd2â€),
mkSpesa(â€œe012â€,â€œdocentiâ€,â€œCompenso mensile Prof. Verdeâ€,   700, 3,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-04-28`,â€œd3â€),
mkSpesa(â€œe013â€,â€œdocentiâ€,â€œCompenso mensile Prof. Rossiâ€,   980, 4,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-05-28`,â€œd1â€),
mkSpesa(â€œe014â€,â€œdocentiâ€,â€œCompenso mensile Prof. Bianchiâ€, 840, 4,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-05-28`,â€œd2â€),
mkSpesa(â€œe015â€,â€œdocentiâ€,â€œCompenso mensile Prof. Verdeâ€,   700, 4,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-05-28`,â€œd3â€),
// Pulizie
mkSpesa(â€œe020â€,â€œpulizieâ€,â€œServizio pulizia mensileâ€,180,0,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-01-31`),
mkSpesa(â€œe021â€,â€œpulizieâ€,â€œServizio pulizia mensileâ€,180,1,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-02-28`),
mkSpesa(â€œe022â€,â€œpulizieâ€,â€œServizio pulizia mensileâ€,180,2,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-03-31`),
mkSpesa(â€œe023â€,â€œpulizieâ€,â€œServizio pulizia mensileâ€,180,3,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-04-30`),
mkSpesa(â€œe024â€,â€œpulizieâ€,â€œServizio pulizia mensileâ€,180,4,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-05-31`),
// Rappresentanza
mkSpesa(â€œe030â€,â€œrappresentanzaâ€,â€œSaggio fine anno â€” cateringâ€,320,4,ANNO_ATT,â€œCarta / POSâ€,`${ANNO_ATT}-05-15`),
mkSpesa(â€œe031â€,â€œrappresentanzaâ€,â€œStampa programmi di salaâ€,95,4,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-05-10`),
// Materiale
mkSpesa(â€œe040â€,â€œmaterialeâ€,â€œAcquisto spartiti e metodiâ€,210,0,ANNO_ATT,â€œCarta / POSâ€,`${ANNO_ATT}-01-15`),
mkSpesa(â€œe041â€,â€œmaterialeâ€,â€œPelli batteriaâ€,145,2,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-03-20`),
mkSpesa(â€œe042â€,â€œmaterialeâ€,â€œCorde chitarra (stock)â€,88,3,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-04-10`),
// Utenze
mkSpesa(â€œe050â€,â€œutenzeâ€,â€œBolletta luce Gennaioâ€,240,0,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-01-20`),
mkSpesa(â€œe051â€,â€œutenzeâ€,â€œBolletta luce Febbraioâ€,230,1,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-02-20`),
mkSpesa(â€œe052â€,â€œutenzeâ€,â€œBolletta luce Marzoâ€,195,2,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-03-20`),
mkSpesa(â€œe053â€,â€œutenzeâ€,â€œBolletta luce Aprileâ€,175,3,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-04-20`),
mkSpesa(â€œe054â€,â€œutenzeâ€,â€œBolletta luce Maggioâ€,160,4,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-05-20`),
mkSpesa(â€œe055â€,â€œutenzeâ€,â€œInternet + telefonoâ€,45,0,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-01-05`),
mkSpesa(â€œe056â€,â€œutenzeâ€,â€œInternet + telefonoâ€,45,1,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-02-05`),
mkSpesa(â€œe057â€,â€œutenzeâ€,â€œInternet + telefonoâ€,45,2,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-03-05`),
mkSpesa(â€œe058â€,â€œutenzeâ€,â€œInternet + telefonoâ€,45,3,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-04-05`),
mkSpesa(â€œe059â€,â€œutenzeâ€,â€œInternet + telefonoâ€,45,4,ANNO_ATT,â€œBonifico bancarioâ€,`${ANNO_ATT}-05-05`),
// Manutenzione
mkSpesa(â€œe060â€,â€œmanutenzioneâ€,â€œAccordatura pianoforte Sala Aâ€,120,1,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-02-14`),
mkSpesa(â€œe061â€,â€œmanutenzioneâ€,â€œRiparazione pedaliera batteriaâ€,65,3,ANNO_ATT,â€œContantiâ€,`${ANNO_ATT}-04-22`),
];

// Entrate demo (quote allievi â€” per il saldo netto)
// Quote pagate (entrate) â€” fonte di veritÃ  per i pagamenti degli allievi
// mese: 1-indexed (1=Gen, 12=Dic); anno: anno solare del mese
const mkQ = (id, sid, sname, importo, mese, anno, data, metodo=â€œBonifico bancarioâ€) => ({
id, studentId:sid, studentName:sname, importo, mese, anno, data, metodo,
categoria:â€œquotaâ€,
desc:`Quota mensile ${["","Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][mese]} ${anno} â€” ${sname}`
});
const AS = annoScolasticoAttivo; // anno inizio a.s. corrente (es. 2025)
const INIT_ENTRATE_QUOTE = (()=>{
let n=1;
const addNum = (e) => {
const anno = e.anno || new Date().getFullYear();
return {â€¦e, numRicevuta: String(n++).padStart(3,â€œ0â€)+â€/â€+anno};
};
return [
// â”€â”€ Sofia Marchetti (id:1, â‚¬120) â”€â”€
mkQ(â€œq001â€,1,â€œSofia Marchettiâ€,  120, 9, AS,   `${AS}-09-05`),
mkQ(â€œq002â€,1,â€œSofia Marchettiâ€,  120,10, AS,   `${AS}-10-03`),
mkQ(â€œq003â€,1,â€œSofia Marchettiâ€,  120,11, AS,   `${AS}-11-04`),
mkQ(â€œq004â€,1,â€œSofia Marchettiâ€,  120,12, AS,   `${AS}-12-02`),
mkQ(â€œq005â€,1,â€œSofia Marchettiâ€,  120, 1, AS+1, `${AS+1}-01-07`),
mkQ(â€œq006â€,1,â€œSofia Marchettiâ€,  120, 2, AS+1, `${AS+1}-02-03`),
// â”€â”€ Luca Ferrara (id:2, â‚¬100) â€” dicembre non pagato â”€â”€
mkQ(â€œq011â€,2,â€œLuca Ferraraâ€,     100, 9, AS,   `${AS}-09-10`),
mkQ(â€œq012â€,2,â€œLuca Ferraraâ€,     100,10, AS,   `${AS}-10-08`),
mkQ(â€œq013â€,2,â€œLuca Ferraraâ€,     100,11, AS,   `${AS}-11-12`),
mkQ(â€œq015â€,2,â€œLuca Ferraraâ€,     100, 1, AS+1, `${AS+1}-01-20`),
mkQ(â€œq016â€,2,â€œLuca Ferraraâ€,     100, 2, AS+1, `${AS+1}-02-10`),
// â”€â”€ Emma Conti (id:3, â‚¬130) â”€â”€
mkQ(â€œq021â€,3,â€œEmma Contiâ€,       130, 9, AS,   `${AS}-09-02`),
mkQ(â€œq022â€,3,â€œEmma Contiâ€,       130,10, AS,   `${AS}-10-01`),
mkQ(â€œq023â€,3,â€œEmma Contiâ€,       130,11, AS,   `${AS}-11-04`),
mkQ(â€œq024â€,3,â€œEmma Contiâ€,       130,12, AS,   `${AS}-12-03`),
mkQ(â€œq025â€,3,â€œEmma Contiâ€,       130, 1, AS+1, `${AS+1}-01-06`),
mkQ(â€œq026â€,3,â€œEmma Contiâ€,       130, 2, AS+1, `${AS+1}-02-04`),
// â”€â”€ Marco Ricci (id:4, â‚¬110) â€” inattivo da nov â”€â”€
mkQ(â€œq031â€,4,â€œMarco Ricciâ€,      110, 9, AS,   `${AS}-09-15`),
mkQ(â€œq032â€,4,â€œMarco Ricciâ€,      110,10, AS,   `${AS}-10-18`,â€œContantiâ€),
// â”€â”€ Giulia Romano (id:5, â‚¬95) â”€â”€
mkQ(â€œq041â€,5,â€œGiulia Romanoâ€,    95,  9, AS,   `${AS}-09-08`),
mkQ(â€œq042â€,5,â€œGiulia Romanoâ€,    95, 10, AS,   `${AS}-10-06`),
mkQ(â€œq043â€,5,â€œGiulia Romanoâ€,    95, 11, AS,   `${AS}-11-05`),
mkQ(â€œq044â€,5,â€œGiulia Romanoâ€,    95, 12, AS,   `${AS}-12-09`),
mkQ(â€œq045â€,5,â€œGiulia Romanoâ€,    95,  1, AS+1, `${AS+1}-01-13`),
mkQ(â€œq046â€,5,â€œGiulia Romanoâ€,    95,  2, AS+1, `${AS+1}-02-11`),
// â”€â”€ Alessandro Gallo (id:6, â‚¬120) â”€â”€
mkQ(â€œq051â€,6,â€œAlessandro Galloâ€, 120, 9, AS,   `${AS}-09-03`),
mkQ(â€œq052â€,6,â€œAlessandro Galloâ€, 120,10, AS,   `${AS}-10-07`),
mkQ(â€œq053â€,6,â€œAlessandro Galloâ€, 120,11, AS,   `${AS}-11-06`),
mkQ(â€œq054â€,6,â€œAlessandro Galloâ€, 120,12, AS,   `${AS}-12-05`),
mkQ(â€œq055â€,6,â€œAlessandro Galloâ€, 120, 1, AS+1, `${AS+1}-01-08`),
mkQ(â€œq056â€,6,â€œAlessandro Galloâ€, 120, 2, AS+1, `${AS+1}-02-06`),
].map(addNum);
})();

// â”€â”€â”€ FORM SPESA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SpesaForm = ({ initial, onSave, onClose }) => {
const [f, setF] = useState(initial || {
categoria:â€œdocentiâ€, desc:â€â€, importo:â€â€,
mese:MESE_ATT, anno:ANNO_ATT,
metodo:â€œBonifico bancarioâ€, data:yyyymmdd(oggi),
docenteId:â€â€, note:â€â€
});
const [err, setErr] = useState({});
const set = (k,v) => setF(p=>({â€¦p,[k]:v}));

const validate = () => {
const e={};
if(!f.desc.trim())                          e.desc    = â€œDescrizione obbligatoriaâ€;
if(!f.importo||isNaN(f.importo)||Number(f.importo)<=0) e.importo = â€œImporto non validoâ€;
if(!f.data)                                 e.data    = â€œData obbligatoriaâ€;
return e;
};

const handleSave = () => {
const e = validate();
if(Object.keys(e).length){ setErr(e); return; }
// Auto-compila desc per docente
let desc = f.desc;
if(f.categoria===â€œdocentiâ€&&f.docenteId&&!f.desc) {
const d = DOCENTI.find(x=>x.id===f.docenteId);
if(d) desc = `Compenso mensile ${d.name}`;
}
onSave({â€¦f, desc, importo:Number(f.importo)});
};

const cat = catById(f.categoria);

return (
<>
<div style={{padding:22,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:14}}>

```
    {/* Categoria */}
    <div>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:8}}>Categoria</label>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))",gap:6}}>
        {CATEGORIE.map(c=>(
          <button key={c.id} onClick={()=>set("categoria",c.id)}
            style={{padding:"8px 6px",borderRadius:8,border:`2px solid ${f.categoria===c.id?c.hex:C.border}`,
              background:f.categoria===c.id?c.bg:C.bg,cursor:"pointer",fontSize:11,textAlign:"center",
              color:f.categoria===c.id?c.hex:C.textMuted,fontFamily:"'DM Sans',sans-serif",
              fontWeight:f.categoria===c.id?500:400,transition:"all 0.12s",lineHeight:1.3}}>
            {c.label}
          </button>
        ))}
      </div>
    </div>

    {/* Se categoria = docenti, mostra select docente */}
    {f.categoria==="docenti" && (
      <Sel label="Docente" value={f.docenteId} onChange={e=>{ set("docenteId",e.target.value); const d=DOCENTI.find(x=>x.id===e.target.value); if(d) set("desc",`Compenso mensile ${d.name}`); }}
        options={[{value:"",label:"â€” seleziona docente â€”"},...DOCENTI.map(d=>({value:d.id,label:d.name}))]}/>
    )}

    <Input label="Descrizione *" value={f.desc} onChange={e=>set("desc",e.target.value)} error={err.desc} placeholder="Es. Bolletta luce gennaio, Spartiti..."/>

    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:12}} className="form-2col">
      <Input label="Importo (â‚¬) *" type="number" value={f.importo} onChange={e=>set("importo",e.target.value)} error={err.importo} placeholder="0.00"/>
      <Input label="Data *" type="date" value={f.data} onChange={e=>set("data",e.target.value)} error={err.data}/>
      <Sel label="Mese di riferimento" value={f.mese} onChange={e=>set("mese",Number(e.target.value))}
        options={MESI.map((m,i)=>({value:i,label:m}))}/>
      <Input label="Anno" type="number" value={f.anno} onChange={e=>set("anno",Number(e.target.value))}/>
    </div>

    <Sel label="Metodo di pagamento" value={f.metodo} onChange={e=>set("metodo",e.target.value)} options={METODI_PAG}/>
    <Textarea label="Note" value={f.note} onChange={e=>set("note",e.target.value)} placeholder="Note aggiuntive..."/>
  </div>
  <div style={{padding:"14px 22px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"flex-end",gap:10}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={handleSave}><Ic n="check" size={14} stroke={C.bg}/>{initial?.id?"Salva modifiche":"Registra spesa"}</Btn>
  </div>
</>
```

);
};

// â”€â”€â”€ VISTA DOCENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DocenteView = ({ docente, spese, onBack }) => {
const speseDoc = spese.filter(s=>s.docenteId===docente.id).sort((a,b)=>b.data.localeCompare(a.data));
const totAnno  = speseDoc.filter(s=>s.anno===ANNO_ATT).reduce((t,s)=>t+s.importo,0);

const perMese = MESI.map((m,i)=>({
mese:m, idx:i,
spese: speseDoc.filter(s=>s.mese===i&&s.anno===ANNO_ATT),
tot:   speseDoc.filter(s=>s.mese===i&&s.anno===ANNO_ATT).reduce((t,s)=>t+s.importo,0),
})).filter(m=>m.spese.length>0);

return (
<div>
<button onClick={onBack} style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:6,background:â€œnoneâ€,
border:â€œnoneâ€,cursor:â€œpointerâ€,color:C.textMuted,fontSize:13,marginBottom:20,padding:0,fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€}}>
<Ic n="left" size={16} stroke={C.textMuted}/>Tutti i docenti
</button>

```
  <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:24}}>
    <div style={{width:52,height:52,borderRadius:14,background:C.goldBg,border:`2px solid ${C.goldDim}`,
      display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
      <Ic n="user" size={24} stroke={C.gold}/>
    </div>
    <div>
      <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600}}>{docente.name}</h1>
      <p style={{fontSize:13,color:C.textMuted,marginTop:2}}>{docente.instrument}</p>
    </div>
    <div style={{marginLeft:"auto",textAlign:"right"}}>
      <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.06em",textTransform:"uppercase"}}>Pagato {ANNO_ATT}</div>
      <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,color:C.gold}}>{fmt(totAnno)}</div>
    </div>
  </div>

  {/* Storico per mese */}
  <div style={{display:"flex",flexDirection:"column",gap:10}}>
    {perMese.length===0 && (
      <div style={{textAlign:"center",padding:"40px 0",color:C.textDim,fontSize:13}}>Nessun compenso registrato</div>
    )}
    {perMese.map(m=>(
      <div key={m.idx} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,overflow:"hidden"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
          padding:"11px 16px",borderBottom:`1px solid ${C.border}`,background:C.bg}}>
          <span style={{fontSize:12,letterSpacing:"0.06em",textTransform:"uppercase",color:C.textMuted}}>{m.mese} {ANNO_ATT}</span>
          <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600,color:C.gold}}>{fmt(m.tot)}</span>
        </div>
        {m.spese.map(s=>(
          <div key={s.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
            padding:"10px 16px",borderBottom:`1px solid ${C.border}20`}}>
            <div>
              <div style={{fontSize:13}}>{s.desc}</div>
              <div style={{fontSize:11,color:C.textMuted,marginTop:2}}>
                {new Date(s.data+"T00:00:00").toLocaleDateString("it-IT")} Â· {s.metodo}
              </div>
            </div>
            <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:16,fontWeight:600,color:C.gold}}>{fmt(s.importo)}</span>
          </div>
        ))}
      </div>
    ))}
  </div>
</div>
```

);
};

// â”€â”€â”€ REPORT / SALDO NETTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ReportView = ({ spese, entrate }) => {
const [anno, setAnno] = useState(ANNO_ATT);

const speseAnno    = spese.filter(s=>s.anno===anno);
const entrateAnno  = entrate.filter(e=>e.anno===anno);

const totUscite  = speseAnno.reduce((t,s)=>t+s.importo,0);
const totEntrate = entrateAnno.reduce((t,e)=>t+e.importo,0);
const saldo      = totEntrate - totUscite;

// Per categoria
const perCat = CATEGORIE.map(c=>({
â€¦c,
tot: speseAnno.filter(s=>s.categoria===c.id).reduce((t,s)=>t+s.importo,0),
n:   speseAnno.filter(s=>s.categoria===c.id).length,
})).filter(c=>c.tot>0).sort((a,b)=>b.tot-a.tot);

// Per mese (entrate vs uscite)
const datiMesi = MESI.map((m,i)=>({
mese:m,
uscite:  speseAnno.filter(s=>s.mese===i).reduce((t,s)=>t+s.importo,0),
entrate: entrateAnno.filter(e=>e.mese===i).reduce((t,e)=>t+e.importo,0),
}));
const maxVal = Math.max(â€¦datiMesi.flatMap(d=>[d.uscite,d.entrate]),1);

return (
<div style={{display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:20}}>

```
  {/* Header */}
  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
    <div>
      <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:600}}>Report & saldo netto</h2>
      <p style={{color:C.textMuted,fontSize:13,marginTop:3}}>Anno {anno}</p>
    </div>
    <div style={{display:"flex",alignItems:"center",gap:8}}>
      <button onClick={()=>setAnno(p=>p-1)} style={{background:C.surface,border:`1px solid ${C.border}`,
        borderRadius:8,color:C.textMuted,padding:"7px 10px",cursor:"pointer",display:"flex"}}>
        <Ic n="left" size={16} stroke={C.textMuted}/>
      </button>
      <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,minWidth:60,textAlign:"center"}}>{anno}</span>
      <button onClick={()=>setAnno(p=>p+1)} style={{background:C.surface,border:`1px solid ${C.border}`,
        borderRadius:8,color:C.textMuted,padding:"7px 10px",cursor:"pointer",display:"flex"}}>
        <Ic n="right" size={16} stroke={C.textMuted}/>
      </button>
    </div>
  </div>

  {/* KPI saldo */}
  <div className="stat-strip-3">
    {[
      {label:"Entrate totali",  val:fmt(totEntrate), hex:C.green, icon:"arrow_up"},
      {label:"Uscite totali",   val:fmt(totUscite),  hex:C.red,   icon:"arrow_dn"},
      {label:"Saldo netto",     val:fmt(saldo),      hex:saldo>=0?C.green:C.red, icon:saldo>=0?"arrow_up":"arrow_dn"},
    ].map(k=>(
      <div key={k.label} style={{background:C.surface,border:`1px solid ${k.hex}30`,borderRadius:12,padding:"18px 20px",
        borderLeft:`4px solid ${k.hex}`}}>
        <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:8}}>
          <Ic n={k.icon} size={14} stroke={k.hex}/>
          <span style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase"}}>{k.label}</span>
        </div>
        <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,color:k.hex}}>{k.val}</div>
      </div>
    ))}
  </div>

  {/* Grafico entrate vs uscite */}
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:20}}>
    <div style={{display:"flex",alignItems:"center",gap:16,marginBottom:16}}>
      <span style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>Entrate vs Uscite mensili</span>
      <div style={{display:"flex",gap:12,marginLeft:"auto"}}>
        {[{lbl:"Entrate",hex:C.green},{lbl:"Uscite",hex:C.red}].map(l=>(
          <div key={l.lbl} style={{display:"flex",alignItems:"center",gap:5}}>
            <div style={{width:10,height:10,borderRadius:2,background:l.hex}}/>
            <span style={{fontSize:11,color:C.textMuted}}>{l.lbl}</span>
          </div>
        ))}
      </div>
    </div>
    <div style={{display:"flex",alignItems:"flex-end",gap:4,height:130}}>
      {datiMesi.map((d,i)=>{
        const hE = maxVal>0?Math.max((d.entrate/maxVal)*120,d.entrate>0?3:0):0;
        const hU = maxVal>0?Math.max((d.uscite/maxVal)*120,d.uscite>0?3:0):0;
        const isCur = i===MESE_ATT&&anno===ANNO_ATT;
        return (
          <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:2}}>
            <div style={{display:"flex",gap:2,alignItems:"flex-end",width:"100%",justifyContent:"center",height:126}}>
              <div title={`Entrate: ${fmt(d.entrate)}`} style={{flex:1,height:hE,borderRadius:"3px 3px 0 0",
                background:isCur?C.green:`${C.green}55`,transition:"height 0.3s",minHeight:0}}/>
              <div title={`Uscite: ${fmt(d.uscite)}`} style={{flex:1,height:hU,borderRadius:"3px 3px 0 0",
                background:isCur?C.red:`${C.red}55`,transition:"height 0.3s",minHeight:0}}/>
            </div>
            <div style={{fontSize:9,color:isCur?C.gold:C.textDim,letterSpacing:"0.04em"}}>
              {d.mese.slice(0,3).toUpperCase()}
            </div>
          </div>
        );
      })}
    </div>
  </div>

  {/* Breakdown per categoria */}
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
    <div style={{padding:"13px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8}}>
      <Ic n="tag" size={14} stroke={C.textMuted}/>
      <span style={{fontSize:11,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Uscite per categoria</span>
    </div>
    {perCat.length===0?(
      <div style={{padding:"30px 0",textAlign:"center",color:C.textDim,fontSize:13}}>Nessuna spesa registrata</div>
    ):(
      <div style={{padding:"12px 0"}}>
        {perCat.map(c=>{
          const pct = totUscite>0?(c.tot/totUscite*100):0;
          return (
            <div key={c.id} style={{padding:"10px 20px",display:"flex",alignItems:"center",gap:14,
              transition:"background 0.1s"}}
              onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
              onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
              {/* Dot categoria */}
              <div style={{width:10,height:10,borderRadius:"50%",background:c.hex,flexShrink:0}}/>
              {/* Nome */}
              <div style={{width:160,flexShrink:0}}>
                <div style={{fontSize:13,fontWeight:500}}>{c.label}</div>
                <div style={{fontSize:11,color:C.textMuted}}>{c.n} voc{c.n===1?"e":"i"}</div>
              </div>
              {/* Barra */}
              <div style={{flex:1,height:8,background:C.border,borderRadius:4,overflow:"hidden"}}>
                <div style={{height:"100%",width:`${pct}%`,background:c.hex,borderRadius:4,transition:"width 0.4s ease"}}/>
              </div>
              {/* % e importo */}
              <div style={{textAlign:"right",flexShrink:0,minWidth:100}}>
                <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:16,fontWeight:600,color:c.hex}}>{fmt(c.tot)}</div>
                <div style={{fontSize:11,color:C.textMuted}}>{pct.toFixed(1)}%</div>
              </div>
            </div>
          );
        })}
      </div>
    )}
  </div>

  {/* Tabella mensile dettagliata */}
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
    <div style={{padding:"13px 20px",borderBottom:`1px solid ${C.border}`}}>
      <span style={{fontSize:11,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Dettaglio mensile</span>
    </div>
    <table style={{width:"100%",borderCollapse:"collapse"}}>
      <thead>
        <tr style={{background:C.bg,borderBottom:`1px solid ${C.border}`}}>
          {["Mese","Entrate","Uscite","Saldo"].map(h=>(
            <th key={h} style={{padding:"9px 16px",textAlign:"left",fontSize:10,
              letterSpacing:"0.07em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
          ))}
        </tr>
      </thead>
      <tbody>
        {datiMesi.map((d,i)=>{
          const sl = d.entrate - d.uscite;
          const isCur = i===MESE_ATT&&anno===ANNO_ATT;
          return (
            <tr key={i} style={{borderBottom:`1px solid ${C.border}20`,
              background:isCur?C.goldBg:"transparent",transition:"background 0.1s"}}
              onMouseEnter={e=>{if(!isCur)e.currentTarget.style.background=C.surfaceHover;}}
              onMouseLeave={e=>{if(!isCur)e.currentTarget.style.background="transparent";}}>
              <td style={{padding:"10px 16px",fontSize:13,fontWeight:isCur?600:400,color:isCur?C.gold:C.text}}>{d.mese}</td>
              <td style={{padding:"10px 16px",fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,color:d.entrate>0?C.green:C.textDim}}>{d.entrate>0?fmt(d.entrate):"â€”"}</td>
              <td style={{padding:"10px 16px",fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,color:d.uscite>0?C.red:C.textDim}}>{d.uscite>0?fmt(d.uscite):"â€”"}</td>
              <td style={{padding:"10px 16px",fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,
                color:sl>0?C.green:sl<0?C.red:C.textDim}}>{(d.entrate>0||d.uscite>0)?fmt(sl):"â€”"}</td>
            </tr>
          );
        })}
        <tr style={{borderTop:`2px solid ${C.border}`,background:C.bg}}>
          <td style={{padding:"12px 16px",fontWeight:600,color:C.gold,fontSize:13}}>Totale {anno}</td>
          <td style={{padding:"12px 16px",fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600,color:C.green}}>{fmt(totEntrate)}</td>
          <td style={{padding:"12px 16px",fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600,color:C.red}}>{fmt(totUscite)}</td>
          <td style={{padding:"12px 16px",fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:saldo>=0?C.green:C.red}}>{fmt(saldo)}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
```

);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP PRINCIPALE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ FORM QUOTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CAT_ENTRATE = [
{ id:â€œquotaâ€,        label:â€œQuota mensileâ€,     icon:â€œreceiptâ€, student:true  },
{ id:â€œiscrizioneâ€,   label:â€œIscrizione annualeâ€, icon:â€œstarâ€,    student:true  },
{ id:â€œconcertoâ€,     label:â€œConcertoâ€,           icon:â€œmusicâ€,   student:false },
{ id:â€œeventoâ€,       label:â€œEvento / Saggioâ€,    icon:â€œcalendarâ€,student:false },
{ id:â€œaltroâ€,        label:â€œAltroâ€,              icon:â€œplusâ€,    student:false },
];

const EntrataForm = ({ students, initial, onSave, onClose }) => {
const MESI_ALL = [â€œGennaioâ€,â€œFebbraioâ€,â€œMarzoâ€,â€œAprileâ€,â€œMaggioâ€,â€œGiugnoâ€,
â€œLuglioâ€,â€œAgostoâ€,â€œSettembreâ€,â€œOttobreâ€,â€œNovembreâ€,â€œDicembreâ€];
const [f, setF] = useState(initial || {
categoria: â€œquotaâ€,
studentId: â€œâ€, importo: â€œâ€, mese: new Date().getMonth()+1,
anno: new Date().getFullYear(), data: yyyymmdd(today),
metodo: â€œBonifico bancarioâ€, desc: â€œâ€, note: â€œâ€,
});
const [err, setErr] = useState({});
const set = (k,v) => setF(p=>({â€¦p,[k]:v}));

const catObj     = CAT_ENTRATE.find(c=>c.id===f.categoria)||CAT_ENTRATE[0];
const needStudent = catObj.student;
const selStudent  = needStudent ? students.find(s=>s.id===Number(f.studentId)) : null;

const handleStudentChange = (e) => {
const s = students.find(st=>st.id===Number(e.target.value));
set(â€œstudentIdâ€, e.target.value);
if(s && f.categoria===â€œquotaâ€) set(â€œimportoâ€, s.monthlyFee);
if(s && f.categoria===â€œiscrizioneâ€) set(â€œimportoâ€, s.monthlyFee * 2);
};

const validate = () => {
const e = {};
if(needStudent && !f.studentId) e.studentId = â€œSeleziona un allievoâ€;
if(!f.importo||isNaN(f.importo)||Number(f.importo)<=0) e.importo = â€œImporto non validoâ€;
if(!f.data)                     e.data      = â€œData obbligatoriaâ€;
if(!needStudent && !f.desc.trim()) e.desc   = â€œDescrizione obbligatoriaâ€;
return e;
};

const handleSave = () => {
const e = validate();
if(Object.keys(e).length){ setErr(e); return; }
const s = needStudent ? students.find(st=>st.id===Number(f.studentId)) : null;
const nomeMese = MESI_ALL[f.mese-1];
const autoDesc = f.categoria===â€œquotaâ€
? `Quota mensile ${nomeMese} ${f.anno}${s?` â€” ${s.name}`:""}`
: f.categoria===â€œiscrizioneâ€
? `Iscrizione ${f.anno}/${Number(f.anno)+1}${s?` â€” ${s.name}`:""}`
: f.desc;
onSave({
â€¦f,
studentId:   needStudent ? Number(f.studentId) : null,
studentName: s?.name || â€œâ€,
importo:     Number(f.importo),
mese:        Number(f.mese),
anno:        Number(f.anno),
desc:        autoDesc || f.desc,
});
};

return (
<>
<div style={{padding:22,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:14}}>
{/* Categoria */}
<div>
<label style={{fontSize:11,color:C.textMuted,letterSpacing:â€œ0.07emâ€,textTransform:â€œuppercaseâ€,display:â€œblockâ€,marginBottom:8}}>Categoria *</label>
<div style={{display:â€œflexâ€,gap:6,flexWrap:â€œwrapâ€}}>
{CAT_ENTRATE.map(c=>{
const isS=f.categoria===c.id;
return (
<button key={c.id} onClick={()=>{set(â€œcategoriaâ€,c.id); if(!c.student){set(â€œstudentIdâ€,â€â€);}}}
style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:6,padding:â€œ7px 14pxâ€,borderRadius:20,
border:`2px solid ${isS?C.green:C.border}`,background:isS?C.greenBg:C.bg,
color:isS?C.green:C.textMuted,cursor:â€œpointerâ€,fontSize:12,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,fontWeight:isS?600:400,transition:â€œall 0.12sâ€}}>
<Ic n={c.icon} size={12} stroke={isS?C.green:C.textMuted}/>
{c.label}
</button>
);
})}
</div>
</div>

```
    {/* Allievo (solo per categorie che lo richiedono) */}
    {needStudent && (
      <div>
        <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Allievo *</label>
        <select value={f.studentId} onChange={handleStudentChange}
          style={{width:"100%",background:C.surface,border:`1px solid ${err.studentId?C.red:C.border}`,borderRadius:8,
            color:f.studentId?C.text:C.textMuted,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",appearance:"none"}}>
          <option value="">â€” seleziona allievo â€”</option>
          {students.filter(s=>s.status==="attivo").map(s=>(
            <option key={s.id} value={s.id}>{s.name} ({s.instrument})</option>
          ))}
        </select>
        {err.studentId && <div style={{fontSize:11,color:C.red,marginTop:4}}>{err.studentId}</div>}
      </div>
    )}

    {selStudent && (
      <div style={{padding:"10px 14px",background:C.goldBg,border:`1px solid ${C.goldDim}`,borderRadius:8,
        display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <span style={{fontSize:12,color:C.gold}}>
          {f.categoria==="quota"?"Quota mensile prevista":"Importo suggerito"}
        </span>
        <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600,color:C.gold}}>
          â‚¬{f.categoria==="quota"?selStudent.monthlyFee:selStudent.monthlyFee*2} / {f.categoria==="quota"?"mese":"anno"}
        </span>
      </div>
    )}

    {/* Descrizione (per categorie senza allievo o Altro) */}
    {(!needStudent || f.categoria==="altro") && (
      <Input label="Descrizione *" value={f.desc} onChange={e=>set("desc",e.target.value)}
        error={err.desc} placeholder={`Es. ${catObj.label}â€¦`}/>
    )}

    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:12}} className="form-2col">
      {(f.categoria==="quota" || f.categoria==="iscrizione") && (
        <div>
          <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",display:"block",marginBottom:6}}>Mese di riferimento</label>
          <select value={f.mese} onChange={e=>set("mese",Number(e.target.value))}
            style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
              color:C.text,fontSize:13,padding:"10px 14px",fontFamily:"'DM Sans',sans-serif",appearance:"none"}}>
            {MESI_ALL.map((m,i)=><option key={i+1} value={i+1}>{m}</option>)}
          </select>
        </div>
      )}
      <Input label="Anno" type="number" value={f.anno} onChange={e=>set("anno",Number(e.target.value))}/>
      <Input label="Importo (â‚¬) *" type="number" value={f.importo} onChange={e=>set("importo",e.target.value)} error={err.importo}/>
      <Input label="Data *" type="date" value={f.data} onChange={e=>set("data",e.target.value)} error={err.data}/>
    </div>
    <Sel label="Metodo di pagamento" value={f.metodo} onChange={e=>set("metodo",e.target.value)} options={METODI_PAG}/>
    <Textarea label="Note" value={f.note} onChange={e=>set("note",e.target.value)} placeholder="Note aggiuntive..."/>
  </div>
  <div style={{padding:"14px 22px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"flex-end",gap:10}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={handleSave}><Ic n="check" size={14} stroke={C.bg}/>{initial?.id?"Salva modifiche":"Registra entrata"}</Btn>
  </div>
</>
```

);
};

// Navbar interna alla ContabilitÃ 
const Navbar = ({ tab, setTab, onSelDoc, onSetModal, onSetModalQuota }) => (

  <div style={{background:C.surface, borderBottom:`1px solid ${C.border}`,
    padding:"0 16px", display:"flex", alignItems:"center", gap:4, flexShrink:0, flexWrap:"wrap"}}>
    <div style={{display:"flex",alignItems:"center",gap:8,paddingRight:20,marginRight:8,
      borderRight:`1px solid ${C.border}`}}>
      <Ic n="euro" size={14} stroke={C.gold}/>
      <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:14,fontWeight:600,color:C.gold}}>ContabilitÃ </span>
    </div>
    {[
      {id:"spese",   label:"Uscite",   icon:"down"},
      {id:"entrate", label:"Entrate",  icon:"up"},
      {id:"docenti", label:"Docenti",  icon:"user"},
      {id:"report",  label:"Report",   icon:"chart"},
    ].map(t=>(
      <button key={t.id} onClick={()=>{ setTab(t.id); onSelDoc?.(); }}
        style={{display:"flex",alignItems:"center",gap:6,padding:"0 16px",
          alignSelf:"stretch",background:"none",border:"none",
          borderBottom:`2px solid ${tab===t.id?C.gold:"transparent"}`,
          color:tab===t.id?C.gold:C.textMuted,cursor:"pointer",
          fontSize:13,fontFamily:"'DM Sans',sans-serif",transition:"all 0.15s",
          minHeight:48}}>
        <Ic n={t.icon} size={13} stroke={tab===t.id?C.gold:C.textMuted}/>{t.label}
      </button>
    ))}
    <div style={{marginLeft:"auto",display:"flex",gap:8}}>
      {tab==="entrate"  && onSetModalQuota && (
        <Btn small onClick={onSetModalQuota}><Ic n="plus" size={13} stroke={C.bg}/>Nuova entrata</Btn>
      )}
      {tab==="spese"  && onSetModal && (
        <Btn small onClick={onSetModal}><Ic n="plus" size={13} stroke={C.bg}/>Registra spesa</Btn>
      )}
    </div>
  </div>
);

const ContabilitaView = ({ students:propStudents, entrate:propEntrate, setEntrate:propSetEntrate, config:propConfig, setConfig:propSetConfig }) => {
const isMobile = useIsMobile();
const [_entrate, _setEntrate] = useState(INIT_ENTRATE_QUOTE);
const entrate    = propEntrate    ?? _entrate;
const setEntrate = propSetEntrate ?? _setEntrate;
const students   = propStudents   ?? [];
const config     = propConfig     ?? CONFIG_DEFAULT;
const setConfig  = propSetConfig  ?? (()=>{});
const [spese,    setSpese]    = useState(INIT_SPESE);
const [tab,      setTab]      = useState(â€œspeseâ€);
const [modal,    setModal]    = useState(null);
const [selSpesa, setSelSpesa] = useState(null);
const [selQuota, setSelQuota] = useState(null);
const [selDoc,   setSelDoc]   = useState(null);
const [search,   setSearch]   = useState(â€â€);
const [filterCat,setFCat]     = useState(â€â€);
const [filterMese,setFMese]   = useState(â€â€);
const [searchQ,  setSearchQ]  = useState(â€â€);
const [filterQMese,setFQMese] = useState(â€â€);

```
const closeModal = () => { setModal(null); setSelSpesa(null); setSelQuota(null); };
const handleAdd    = d => { setSpese(p=>[...p,{...d,id:uid()}]); closeModal(); };
const handleEdit   = d => { setSpese(p=>p.map(x=>x.id===d.id?{...x,...d}:x)); closeModal(); };
const handleDel    = () => { setSpese(p=>p.filter(x=>x.id!==selSpesa?.id)); closeModal(); };
const handleAddQ   = d => {
  const anno = d.anno || new Date().getFullYear();
  const progressivo = config.progressivoRicevute || 1;
  const numRicevuta = String(progressivo).padStart(3,"0") + "/" + anno;
  setEntrate(p=>[...p,{...d, id:uid(), numRicevuta}]);
  setConfig(p=>({...p, progressivoRicevute: progressivo + 1}));
  closeModal();
};
const handleEditQ  = d => { setEntrate(p=>p.map(x=>x.id===d.id?{...x,...d}:x)); closeModal(); };
const handleDelQ   = () => { setEntrate(p=>p.filter(x=>x.id!==selQuota?.id)); closeModal(); };

// Stats ribbon
const MESE_C = new Date().getMonth()+1; // 1-indexed
const totMese    = spese.filter(s=>s.mese===MESE_ATT&&s.anno===ANNO_ATT).reduce((t,s)=>t+s.importo,0);
const totAnno    = spese.filter(s=>s.anno===ANNO_ATT).reduce((t,s)=>t+s.importo,0);
const totDocAnno = spese.filter(s=>s.anno===ANNO_ATT&&s.categoria==="docenti").reduce((t,s)=>t+s.importo,0);
const totQuoteAnno = entrate.filter(e=>e.anno===ANNO_ATT||(e.anno===ANNO_ATT-1&&e.mese>=9)).reduce((t,e)=>t+e.importo,0);
const totQuoteMese = entrate.filter(e=>e.mese===MESE_C&&e.anno===new Date().getFullYear()).reduce((t,e)=>t+e.importo,0);

// Spese filtrate
const filtered = spese.filter(s=>{
  const q=search.toLowerCase();
  return s.anno===ANNO_ATT
    &&(!q||s.desc.toLowerCase().includes(q)||(s.note||"").toLowerCase().includes(q))
    &&(!filterCat||s.categoria===filterCat)
    &&(!filterMese||s.mese===Number(filterMese));
}).sort((a,b)=>b.data.localeCompare(a.data));

// Aggregato docenti
const docenteStats = useMemo(()=>DOCENTI.map(d=>({
  ...d,
  totAnno: spese.filter(s=>s.docenteId===d.id&&s.anno===ANNO_ATT).reduce((t,s)=>t+s.importo,0),
  ultimoPag: spese.filter(s=>s.docenteId===d.id).sort((a,b)=>b.data.localeCompare(a.data))[0]?.data||null,
})),[spese]);

// Vista dettaglio docente
if(selDoc) {
  const d = DOCENTI.find(x=>x.id===selDoc);
  return (
    <>
      <style>{G}</style>
      <div style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column"}}>
        <Navbar tab={tab} setTab={setTab} onSelDoc={()=>setSelDoc(null)} onSetModalQuota={()=>setModal('addq')}/>
        <div style={{flex:1,padding:24,overflow:"auto"}}>
          <DocenteView docente={d} spese={spese} onBack={()=>setSelDoc(null)}/>
        </div>
      </div>
    </>
  );
}

return (
  <>
    <style>{G}</style>
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column"}}>
      <Navbar tab={tab} setTab={t=>{ setTab(t); setSelDoc(null); }} onSetModal={()=>setModal("add")} onSetModalQuota={()=>setModal('addq')}/>

      {/* Stats ribbon */}
      <div style={{background:C.surface,borderBottom:`1px solid ${C.border}`,
        padding:"10px 24px",display:"flex",gap:0,flexShrink:0,alignItems:"center"}}>
        {[
          {label:"Entrate (a.s.)",  val:fmt(totQuoteAnno), hex:C.green},
          {label:"Entrate mese",      val:fmt(totQuoteMese), hex:C.green,  opacity:0.7},
          {label:`Uscite totali ${ANNO_ATT}`,val:fmt(totAnno),      hex:C.red},
          {label:"Compensi docenti",         val:fmt(totDocAnno),   hex:C.gold},
        ].map((s,i)=>(
          <div key={s.label} style={{display:"flex",alignItems:"center",gap:10,paddingRight:24,marginRight:i<3?24:0,
            borderRight:i<3?`1px solid ${C.border}`:"none",opacity:s.opacity||1}}>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:s.hex}}>{s.val}</div>
            <div style={{fontSize:10,color:s.hex,opacity:0.8,textTransform:"uppercase",letterSpacing:"0.06em",maxWidth:90,lineHeight:1.3}}>{s.label}</div>
          </div>
        ))}
        <div style={{marginLeft:"auto"}}/>
      </div>

      <div style={{flex:1,padding:24,overflow:"auto"}}>

        {/* TAB SPESE */}
        {tab==="spese" && (
          <div style={{display:"flex",flexDirection:"column",gap:14}}>

            {/* Filtri */}
            <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
              <div style={{position:"relative",flex:"1 1 200px"}}>
                <span style={{position:"absolute",left:11,top:"50%",transform:"translateY(-50%)"}}>
                  <Ic n="search" size={15} stroke={C.textDim}/>
                </span>
                <input value={search} onChange={e=>setSearch(e.target.value)}
                  placeholder="Cerca spesa..."
                  style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
                    color:C.text,fontSize:13,padding:"9px 12px 9px 36px",fontFamily:"'DM Sans',sans-serif"}}/>
              </div>
              <select value={filterCat} onChange={e=>setFCat(e.target.value)}
                style={{background:C.surface,border:`1px solid ${filterCat?C.goldDim:C.border}`,borderRadius:8,
                  color:filterCat?C.gold:C.textMuted,fontSize:13,padding:"9px 12px",fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
                <option value="">Tutte le categorie</option>
                {CATEGORIE.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}
              </select>
              <select value={filterMese} onChange={e=>setFMese(e.target.value)}
                style={{background:C.surface,border:`1px solid ${filterMese?C.goldDim:C.border}`,borderRadius:8,
                  color:filterMese?C.gold:C.textMuted,fontSize:13,padding:"9px 12px",fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
                <option value="">Tutti i mesi</option>
                {MESI.map((m,i)=><option key={i} value={i}>{m}</option>)}
              </select>
              {(search||filterCat||filterMese)&&(
                <button onClick={()=>{setSearch("");setFCat("");setFMese("");}}
                  style={{background:"none",border:`1px solid ${C.border}`,borderRadius:8,color:C.textMuted,
                    fontSize:12,padding:"9px 12px",cursor:"pointer",fontFamily:"'DM Sans',sans-serif",
                    display:"flex",alignItems:"center",gap:5}}
                  onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;}}
                  onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;}}>
                  <Ic n="x" size={13} stroke="currentColor"/>Azzera
                </button>
              )}
              <span style={{fontSize:12,color:C.textDim,marginLeft:"auto"}}>{filtered.length} voci</span>
            </div>

            {/* Lista spese */}
            <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
              <div style={{overflowX:"auto",WebkitOverflowScrolling:"touch"}}>
              <div style={{display:"grid",gridTemplateColumns:"auto 2fr 1fr 1fr 1fr auto",minWidth:520,
                padding:"9px 18px",borderBottom:`1px solid ${C.border}`,background:C.bg}}>
                {["Cat.","Descrizione","Mese","Metodo","Importo",""].map(h=>(
                  <div key={h} style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>{h}</div>
                ))}
              </div>
              {filtered.length===0?(
                <div style={{padding:"40px 0",textAlign:"center",color:C.textDim,fontSize:13}}>Nessuna spesa trovata</div>
              ):filtered.map((s,i)=>{
                const cat = catById(s.categoria);
                const doc = s.docenteId?DOCENTI.find(d=>d.id===s.docenteId):null;
                return (
                  <div key={s.id} style={{display:"grid",gridTemplateColumns:"auto 2fr 1fr 1fr 1fr auto",minWidth:520,
                    padding:"12px 18px",borderBottom:i<filtered.length-1?`1px solid ${C.border}20`:"none",
                    alignItems:"center",transition:"background 0.1s"}}
                    onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
                    onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                    {/* Badge categoria */}
                    <div style={{marginRight:10}}>
                      <span style={{display:"inline-block",width:9,height:9,borderRadius:"50%",background:cat.hex}}/>
                    </div>
                    {/* Descrizione */}
                    <div>
                      <div style={{fontSize:13,fontWeight:500}}>{s.desc}</div>
                      <div style={{fontSize:11,color:C.textMuted,marginTop:1}}>
                        {new Date(s.data+"T00:00:00").toLocaleDateString("it-IT")}
                        {doc && <> Â· <span style={{color:cat.hex}}>{doc.name}</span></>}
                        {s.note && <> Â· {s.note}</>}
                      </div>
                    </div>
                    {/* Mese */}
                    <div style={{fontSize:12,color:C.textMuted}}>{MESI[s.mese]}</div>
                    {/* Metodo */}
                    <div style={{fontSize:12,color:C.textMuted}}>{s.metodo}</div>
                    {/* Importo */}
                    <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:17,fontWeight:600,color:C.red}}>{fmt(s.importo)}</div>
                    {/* Azioni */}
                    <div style={{display:"flex",gap:2}}>
                      <button onClick={()=>{setSelSpesa(s);setModal("edit");}}
                        style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4,display:"flex",borderRadius:6}}
                        onMouseEnter={e=>e.currentTarget.style.color=C.gold}
                        onMouseLeave={e=>e.currentTarget.style.color=C.textMuted}>
                        <Ic n="edit" size={13} stroke="currentColor"/>
                      </button>
                      <button onClick={()=>{setSelSpesa(s);setModal("delete");}}
                        style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4,display:"flex",borderRadius:6}}
                        onMouseEnter={e=>e.currentTarget.style.color=C.red}
                        onMouseLeave={e=>e.currentTarget.style.color=C.textMuted}>
                        <Ic n="trash" size={13} stroke="currentColor"/>
                      </button>
                    </div>
                  </div>
                );
              })}
              </div>
            </div>
          </div>
        )}

        {/* TAB DOCENTI */}
        {tab==="docenti" && (
          <div style={{display:"flex",flexDirection:"column",gap:12}}>
            <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr auto",minWidth:480,
                padding:"9px 18px",borderBottom:`1px solid ${C.border}`,background:C.bg}}>
                {["Docente","Strumenti","Pagato anno","Ultimo pagamento",""].map(h=>(
                  <div key={h} style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>{h}</div>
                ))}
              </div>
              {docenteStats.map((d,i)=>(
                <div key={d.id} onClick={()=>setSelDoc(d.id)}
                  style={{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr auto",minWidth:480,
                    padding:"14px 18px",borderBottom:i<docenteStats.length-1?`1px solid ${C.border}20`:"none",
                    cursor:"pointer",transition:"background 0.12s",alignItems:"center"}}
                  onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
                  onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                  <div style={{display:"flex",alignItems:"center",gap:10}}>
                    <div style={{width:36,height:36,borderRadius:"50%",background:C.goldBg,
                      border:`1px solid ${C.goldDim}`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                      <Ic n="user" size={16} stroke={C.gold}/>
                    </div>
                    <div>
                      <div style={{fontSize:14,fontWeight:500}}>{d.name}</div>
                    </div>
                  </div>
                  <div style={{fontSize:12,color:C.textMuted}}>{d.instrument}</div>
                  <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:17,fontWeight:600,color:C.gold}}>
                    {d.totAnno>0?fmt(d.totAnno):"â€”"}
                  </div>
                  <div style={{fontSize:12,color:C.textMuted}}>
                    {d.ultimoPag?new Date(d.ultimoPag+"T00:00:00").toLocaleDateString("it-IT"):"â€”"}
                  </div>
                  <Ic n="right" size={16} stroke={C.textDim}/>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* TAB QUOTE */}
        {tab==="entrate" && (() => {
          const MESI_ALL = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
          const curY = new Date().getFullYear(), curM = new Date().getMonth()+1;
          const qFiltrate = entrate
            .filter(e=>{
              const q = searchQ.toLowerCase();
              return (!q||e.studentName.toLowerCase().includes(q)||e.desc.toLowerCase().includes(q))
                && (!filterQMese||Number(filterQMese)===e.mese);
            })
            .sort((a,b)=>b.data.localeCompare(a.data));
          const totQFiltrate = qFiltrate.reduce((t,e)=>t+e.importo,0);

          // Riepilogo per allievo (usato in tabella studenti)
          const stSummary = students.map(s=>{
            const pagamenti = entrate.filter(e=>e.studentId===s.id);
            const totPag    = pagamenti.reduce((t,e)=>t+e.importo,0);
            const ultPag    = pagamenti.sort((a,b)=>b.data.localeCompare(a.data))[0];
            return {...s, totPag, ultPag:ultPag?.data||null, nPagamenti:pagamenti.length};
          });

          return (
            <div style={{display:"flex",flexDirection:"column",gap:16}}>
              {/* Riepilogo per allievo */}
              <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
                <div style={{padding:"12px 20px",borderBottom:`1px solid ${C.border}`,
                  display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Riepilogo quote per allievo</span>
                  <span style={{fontSize:12,color:C.green,fontWeight:600}}>Totale incassato a.s.: {fmt(totQuoteAnno)}</span>
                </div>
                <table style={{width:"100%",borderCollapse:"collapse"}}>
                  <thead>
                    <tr style={{background:C.bg,borderBottom:`1px solid ${C.border}`}}>
                      {["Allievo","Strumento","Quota mensile","Quote pagate","Totale incassato","Ultimo pagamento"].map(h=>(
                        <th key={h} style={{padding:"9px 18px",textAlign:"left",fontSize:10,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {stSummary.map((s,i)=>(
                      <tr key={s.id} style={{borderBottom:i<stSummary.length-1?`1px solid ${C.border}20`:"none",
                        transition:"background 0.1s"}}
                        onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
                        onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                        <td style={{padding:"12px 18px"}}>
                          <div style={{fontSize:14,fontWeight:500}}>{s.name}</div>
                          <Badge label={s.status} color={s.status==="attivo"?"green":s.status==="sospeso"?"gold":"red"}/>
                        </td>
                        <td style={{padding:"12px 18px"}}><Badge label={s.instrument} color="gold"/></td>
                        <td style={{padding:"12px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:16,fontWeight:600,color:C.gold}}>â‚¬{s.monthlyFee}</td>
                        <td style={{padding:"12px 18px",fontSize:13,color:C.textMuted}}>{s.nPagamenti} pagam.</td>
                        <td style={{padding:"12px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:17,fontWeight:600,color:s.totPag>0?C.green:C.textDim}}>
                          {s.totPag>0?fmt(s.totPag):"â€”"}
                        </td>
                        <td style={{padding:"12px 18px",fontSize:12,color:C.textMuted}}>
                          {s.ultPag?new Date(s.ultPag+"T00:00:00").toLocaleDateString("it-IT"):"â€”"}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Lista pagamenti filtrata */}
              <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
                <div style={{position:"relative",flex:"1 1 200px"}}>
                  <span style={{position:"absolute",left:11,top:"50%",transform:"translateY(-50%)"}}><Ic n="search" size={15} stroke={C.textDim}/></span>
                  <input value={searchQ} onChange={e=>setSearchQ(e.target.value)} placeholder="Cerca descrizione, allievo..."
                    style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
                      color:C.text,fontSize:13,padding:"9px 12px 9px 36px",fontFamily:"'DM Sans',sans-serif"}}/>
                </div>
                <select value={filterQMese} onChange={e=>setFQMese(e.target.value)}
                  style={{background:C.surface,border:`1px solid ${filterQMese?C.goldDim:C.border}`,borderRadius:8,
                    color:filterQMese?C.gold:C.textMuted,fontSize:13,padding:"9px 12px",fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
                  <option value="">Tutti i mesi</option>
                  {MESI_ALL.map((m,i)=><option key={i+1} value={i+1}>{m}</option>)}
                </select>
                {(searchQ||filterQMese)&&(
                  <button onClick={()=>{setSearchQ("");setFQMese("");}}
                    style={{background:"none",border:`1px solid ${C.border}`,borderRadius:8,color:C.textMuted,fontSize:12,padding:"9px 12px",
                      cursor:"pointer",fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:5}}
                    onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;}}
                    onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;}}>
                    <Ic n="x" size={13} stroke="currentColor"/>Azzera
                  </button>
                )}
                <span style={{fontSize:12,color:C.textDim}}>{qFiltrate.length} entrate Â· {fmt(totQFiltrate)}</span>
              </div>

              <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
                <div style={{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr 100px auto",minWidth:480,
                  padding:"9px 18px",borderBottom:`1px solid ${C.border}`,background:C.bg}}>
                  {["Descrizione","Categoria","Data","Metodo","Importo",""].map(h=>(
                    <div key={h} style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>{h}</div>
                  ))}
                </div>
                {qFiltrate.length===0?(
                  <div style={{padding:"40px 0",textAlign:"center",color:C.textDim,fontSize:13}}>Nessun pagamento trovato</div>
                ):qFiltrate.map((e,i)=>(
                  <div key={e.id} style={{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr 100px auto",minWidth:520,
                    padding:"12px 18px",borderBottom:i<qFiltrate.length-1?`1px solid ${C.border}20`:"none",
                    alignItems:"center",transition:"background 0.1s"}}
                    onMouseEnter={el=>el.currentTarget.style.background=C.surfaceHover}
                    onMouseLeave={el=>el.currentTarget.style.background="transparent"}>
                    <div>
                      <div style={{fontSize:13,fontWeight:500}}>{e.desc||e.studentName||"â€”"}</div>
                      {e.numRicevuta&&<div style={{fontSize:11,color:C.gold,marginTop:1,fontFamily:"'Cormorant Garamond',serif",letterSpacing:"0.05em"}}>Ric. nÂ° {e.numRicevuta}</div>}
                      {e.studentName&&e.categoria!=="quota"&&<div style={{fontSize:11,color:C.textMuted,marginTop:1}}>{e.studentName}</div>}
                      {e.note&&<div style={{fontSize:11,color:C.textDim,marginTop:1}}>{e.note}</div>}
                    </div>
                    <div>
                      {(()=>{const c=CAT_ENTRATE.find(x=>x.id===e.categoria)||{label:"Quota",icon:"receipt"};
                        return <span style={{fontSize:11,padding:"2px 8px",borderRadius:10,background:C.greenBg,
                          color:C.green,border:`1px solid ${C.greenBorder}`}}>{c.label}</span>;})()}
                    </div>
                    <div style={{fontSize:13,color:C.textMuted}}>
                      {new Date(e.data+"T00:00:00").toLocaleDateString("it-IT")}
                    </div>
                    <div style={{fontSize:12,color:C.textMuted}}>{e.metodo}</div>
                    <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:17,fontWeight:600,color:C.green}}>{fmt(e.importo)}</div>
                    <div style={{display:"flex",gap:2}}>
                      <button onClick={()=>{setSelQuota(e);setModal("ricevuta");}}
                        title="Stampa ricevuta"
                        style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4,display:"flex",borderRadius:6}}
                        onMouseEnter={el=>el.currentTarget.style.color=C.gold}
                        onMouseLeave={el=>el.currentTarget.style.color=C.textMuted}>
                        <Ic n="receipt" size={13} stroke="currentColor"/>
                      </button>
                      <button onClick={()=>{setSelQuota(e);setModal("editq");}}
                        style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4,display:"flex",borderRadius:6}}
                        onMouseEnter={el=>el.currentTarget.style.color=C.gold}
                        onMouseLeave={el=>el.currentTarget.style.color=C.textMuted}>
                        <Ic n="edit" size={13} stroke="currentColor"/>
                      </button>
                      <button onClick={()=>{setSelQuota(e);setModal("deleteq");}}
                        style={{background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4,display:"flex",borderRadius:6}}
                        onMouseEnter={el=>el.currentTarget.style.color=C.red}
                        onMouseLeave={el=>el.currentTarget.style.color=C.textMuted}>
                        <Ic n="trash" size={13} stroke="currentColor"/>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        })()}

        {/* TAB REPORT */}
        {tab==="report" && <ReportView spese={spese} entrate={entrate}/>}
      </div>
    </div>

    {modal==="add"    && <Modal title="Registra spesa" onClose={closeModal} wide><SpesaForm onSave={handleAdd} onClose={closeModal}/></Modal>}
    {modal==="edit"   && selSpesa && <Modal title="Modifica spesa" onClose={closeModal} wide><SpesaForm initial={selSpesa} onSave={handleEdit} onClose={closeModal}/></Modal>}
    {modal==="delete" && selSpesa && <ConfirmDel label={selSpesa.desc} onConfirm={handleDel} onClose={closeModal}/>}
    {modal==="addq"   && <Modal title="Nuova entrata" onClose={closeModal} wide><EntrataForm students={students} onSave={handleAddQ} onClose={closeModal}/></Modal>}
    {modal==="editq"  && selQuota && <Modal title="Modifica entrata" onClose={closeModal} wide><EntrataForm students={students} initial={selQuota} onSave={handleEditQ} onClose={closeModal}/></Modal>}
    {modal==="deleteq"&& selQuota && <ConfirmDel label={selQuota.desc} onConfirm={handleDelQ} onClose={closeModal}/>}
    {modal==="ricevuta" && selQuota && (
      <RicevutaModal
        entrata={selQuota}
        student={students.find(s=>s.id===selQuota.studentId)}
        config={config}
        onClose={closeModal}
      />
    )}
  </>
);
```

};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// REPERTORIO

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ COSTANTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIFFICULTY = [
{id:â€œPrincipianteâ€, hex:C.green,  bg:C.greenBg,  bd:C.greenBorder,  rank:1},
{id:â€œElementareâ€,   hex:C.blue,   bg:C.blueBg,   bd:C.blueBorder,   rank:2},
{id:â€œIntermedioâ€,   hex:C.gold,   bg:C.goldBg,   bd:C.goldDim,      rank:3},
{id:â€œAvanzatoâ€,     hex:C.orange, bg:C.orangeBg, bd:C.orangeBorder, rank:4},
{id:â€œProfessionaleâ€,hex:C.red,    bg:C.redBg,    bd:C.redBorder,    rank:5},
];
const diffById = id => DIFFICULTY.find(d=>d.id===id)||DIFFICULTY[2];

const PERIODI = [
{id:â€œBaroccoâ€,      hex:â€#a78bfaâ€},
{id:â€œClassicoâ€,     hex:C.blue},
{id:â€œRomanticoâ€,    hex:C.gold},
{id:â€œModernoâ€,      hex:C.teal},
{id:â€œContemporaneoâ€,hex:C.orange},
{id:â€œJazz/Bluesâ€,   hex:â€#f472b6â€},
{id:â€œFolk/Popâ€,     hex:C.green},
{id:â€œTraditionalâ€,  hex:C.textMuted},
];
const periodoById = id => PERIODI.find(p=>p.id===id)||PERIODI[7];

const INSEGNANTI = [â€œProf. Rossiâ€,â€œProf. Bianchiâ€,â€œProf. Verdeâ€,â€œProf. Marinoâ€];

// â”€â”€â”€ DATI DEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INIT_BRANI = [
{id:â€œb1â€,  title:â€œNotturno in Miâ™­ maggiore Op.9 n.2â€,  composer:â€œFrÃ©dÃ©ric Chopinâ€,    periodo:â€œRomanticoâ€,  tonality:â€œMiâ™­ maggioreâ€, difficulty:â€œAvanzatoâ€,      tipo:â€œindividualeâ€,
note:â€œCelebre notturno, richiede fraseggio cantabile e tocco morbido. Fondamentale lavorare sul rubato.â€,
allievi:[â€œSofia Marchettiâ€,â€œAlessandro Galloâ€], insegnante:â€œProf. Rossiâ€,
lezioni:7, dataPrima:â€œ2024-10-15â€, dataUltima:â€œ2025-05-20â€},

{id:â€œb2â€,  title:â€œInvenzione n.1 in Do maggiore BWV 772â€, composer:â€œJohann S. Bachâ€,     periodo:â€œBaroccoâ€,    tonality:â€œDo maggioreâ€,  difficulty:â€œIntermedioâ€,    tipo:â€œindividualeâ€,
note:â€œContrappunto a due voci. Attenzione allâ€™indipendenza delle mani.â€,
allievi:[â€œLuca Ferraraâ€,â€œEmma Contiâ€], insegnante:â€œProf. Rossiâ€,
lezioni:5, dataPrima:â€œ2025-01-10â€, dataUltima:â€œ2025-04-28â€},

{id:â€œb3â€,  title:â€œPartita n.2 in Re minore BWV 1004â€,   composer:â€œJohann S. Bachâ€,     periodo:â€œBaroccoâ€,    tonality:â€œRe minoreâ€,    difficulty:â€œProfessionaleâ€, tipo:â€œindividualeâ€,
note:â€œPer violino solo. Chaconne finale Ã¨ uno dei pezzi piÃ¹ impegnativi del repertorio violinistico.â€,
allievi:[â€œEmma Contiâ€], insegnante:â€œProf. Rossiâ€,
lezioni:12, dataPrima:â€œ2024-09-01â€, dataUltima:â€œ2025-05-22â€},

{id:â€œb4â€,  title:â€œSonata K.331 in La maggioreâ€,          composer:â€œW.A. Mozartâ€,        periodo:â€œClassicoâ€,   tonality:â€œLa maggioreâ€,  difficulty:â€œIntermedioâ€,    tipo:â€œindividualeâ€,
note:â€œTema con variazioni, RondÃ² alla Turca nel finale. Classico del repertorio pianistico.â€,
allievi:[â€œGiulia Romanoâ€,â€œSofia Marchettiâ€], insegnante:â€œProf. Bianchiâ€,
lezioni:8, dataPrima:â€œ2025-02-01â€, dataUltima:â€œ2025-05-15â€},

{id:â€œb5â€,  title:â€œStandard Jazz ii-V-I in Do maggioreâ€,  composer:â€œTraditionalâ€,        periodo:â€œJazz/Bluesâ€,  tonality:â€œDo maggioreâ€, difficulty:â€œIntermedioâ€,    tipo:â€œindividualeâ€,
note:â€œProgressione fondamentale jazz. Lavorare su voicings e improvvisazione.â€,
allievi:[â€œMarco Ricciâ€,â€œDavide Russoâ€], insegnante:â€œProf. Verdeâ€,
lezioni:4, dataPrima:â€œ2025-03-10â€, dataUltima:â€œ2025-05-18â€},

{id:â€œb6â€,  title:â€œStudio op.10 n.1 in Do maggioreâ€,      composer:â€œFrÃ©dÃ©ric Chopinâ€,    periodo:â€œRomanticoâ€,  tonality:â€œDo maggioreâ€,  difficulty:â€œProfessionaleâ€, tipo:â€œindividualeâ€,
note:â€œStudio per lâ€™estensione della mano destra. Tecnica impegnativa.â€,
allievi:[â€œSofia Marchettiâ€], insegnante:â€œProf. Rossiâ€,
lezioni:3, dataPrima:â€œ2025-04-05â€, dataUltima:â€œ2025-05-10â€},

{id:â€œb7â€,  title:â€œOde alla Gioia (Sinfonia n.9)â€,         composer:â€œLudwig van Beethovenâ€,periodo:â€œClassicoâ€,  tonality:â€œRe maggioreâ€,  difficulty:â€œElementareâ€,    tipo:â€œcollettivoâ€,
note:â€œArrangiamento per orchestra scolastica. Eseguito al saggio di fine anno.â€,
allievi:[â€œSofia Marchettiâ€,â€œLuca Ferraraâ€,â€œEmma Contiâ€,â€œMarco Ricciâ€,â€œGiulia Romanoâ€,â€œAlessandro Galloâ€], insegnante:â€œProf. Rossiâ€,
lezioni:15, dataPrima:â€œ2025-01-15â€, dataUltima:â€œ2025-05-22â€},

{id:â€œb8â€,  title:â€œCanon in Reâ€,                           composer:â€œJohann Pachelbelâ€,   periodo:â€œBaroccoâ€,   tonality:â€œRe maggioreâ€,  difficulty:â€œElementareâ€,    tipo:â€œcollettivoâ€,
note:â€œEnsemble dâ€™archi. Buona introduzione al suonare in gruppo.â€,
allievi:[â€œEmma Contiâ€,â€œGiulia Romanoâ€,â€œChiara Espositoâ€], insegnante:â€œProf. Bianchiâ€,
lezioni:6, dataPrima:â€œ2025-02-20â€, dataUltima:â€œ2025-04-30â€},

{id:â€œb9â€,  title:â€œGreensleevesâ€,                          composer:â€œTraditionalâ€,        periodo:â€œFolk/Popâ€,   tonality:â€œRe minoreâ€,    difficulty:â€œPrincipianteâ€,  tipo:â€œcollettivoâ€,
note:â€œArrangiamento corale. Ottimo per i principianti.â€,
allievi:[â€œChiara Espositoâ€,â€œDavide Russoâ€], insegnante:â€œProf. Verdeâ€,
lezioni:3, dataPrima:â€œ2025-03-01â€, dataUltima:â€œ2025-04-10â€},

{id:â€œb10â€, title:â€œPreludio in Do maggiore BWV 846â€,       composer:â€œJohann S. Bachâ€,     periodo:â€œBaroccoâ€,   tonality:â€œDo maggioreâ€,  difficulty:â€œElementareâ€,    tipo:â€œindividualeâ€,
note:â€œDal Clavicembalo Ben Temperato. Ottimo esercizio per la fluiditÃ .â€,
allievi:[â€œAlessandro Galloâ€,â€œDavide Russoâ€], insegnante:â€œProf. Rossiâ€,
lezioni:4, dataPrima:â€œ2026-02-10â€, dataUltima:â€œ2025-05-01â€},
];

// â”€â”€â”€ FORM BRANO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BranoForm = ({initial,onSave,onClose})=>{
const empty={title:â€â€,composer:â€â€,periodo:â€â€,tonality:â€â€,difficulty:â€œIntermedioâ€,
tipo:â€œindividualeâ€,note:â€â€,allievi:[],insegnante:â€â€};
const [f,setF]=useState(initial||empty);
const [err,setErr]=useState({});
const set=(k,v)=>setF(p=>({â€¦p,[k]:v}));

const toggleAllievo=(a)=>{
const arr=f.allievi||[];
set(â€œallieviâ€,arr.includes(a)?arr.filter(x=>x!==a):[â€¦arr,a]);
};

const validate=()=>{
const e={};
if(!f.title.trim())    e.title=â€œTitolo obbligatorioâ€;
if(!f.composer.trim()) e.composer=â€œCompositore obbligatorioâ€;
return e;
};
const handleSave=()=>{
const e=validate(); if(Object.keys(e).length){setErr(e);return;}
onSave(f);
};

return(
<>
<div style={{padding:â€œ20px 22pxâ€,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:14,overflow:â€œautoâ€}}>
<div style={{display:â€œgridâ€,gridTemplateColumns:â€œrepeat(auto-fit,minmax(140px,1fr))â€,gap:12}} className=â€œform-2colâ€>
<div style={{gridColumn:â€œ1/-1â€}}>
<Field label=â€œTitolo *â€ value={f.title} onChange={e=>set(â€œtitleâ€,e.target.value)} error={err.title} placeholder=â€œEs. Notturno Op.9 n.2â€/>
</div>
<Field label=â€œCompositore *â€ value={f.composer} onChange={e=>set(â€œcomposerâ€,e.target.value)} error={err.composer} placeholder=â€œEs. Chopinâ€/>
<Sel label=â€œPeriodoâ€ value={f.periodo} onChange={e=>set(â€œperiodoâ€,e.target.value)}
options={PERIODI.map(p=>({value:p.id,label:p.id}))}/>
<Sel label=â€œTonalitÃ  / Scalaâ€ value={f.tonality} onChange={e=>set(â€œtonalityâ€,e.target.value)} options={TONALITY_OPTS}/>
<Sel label=â€œDifficoltÃ â€ value={f.difficulty} onChange={e=>set(â€œdifficultyâ€,e.target.value)}
options={DIFFICULTY.map(d=>({value:d.id,label:d.id}))}/>
</div>

```
    {/* Tipo */}
    <div>
      <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",marginBottom:9}}>Tipo brano</div>
      <div style={{display:"flex",gap:10}}>
        {[["individuale","solo","Studio personale"],[" collettivo","group","Ensemble / orchestra"]].map(([val,ic,desc])=>{
          const v=val.trim();
          const isCol=v==="collettivo";
          const hex=isCol?C.purple:C.gold;
          const bg=isCol?C.purpleBg:C.goldBg;
          const bd=isCol?C.purpleBorder:C.goldDim;
          const sel=f.tipo===v;
          return(
            <button key={v} onClick={()=>set("tipo",v)} style={{flex:1,padding:"10px 14px",borderRadius:10,
              border:`2px solid ${sel?hex:C.border}`,background:sel?bg:C.bg,
              cursor:"pointer",display:"flex",alignItems:"center",gap:10,transition:"all .15s"}}>
              <Ic n={ic} size={16} stroke={sel?hex:C.textMuted}/>
              <div style={{textAlign:"left"}}>
                <div style={{fontSize:13,fontWeight:500,color:sel?hex:C.text,textTransform:"capitalize"}}>{v}</div>
                <div style={{fontSize:10,color:C.textDim,marginTop:1}}>{desc}</div>
              </div>
            </button>
          );
        })}
      </div>
    </div>

    {/* Insegnante */}
    <Sel label="Insegnante responsabile" value={f.insegnante} onChange={e=>set("insegnante",e.target.value)} options={INSEGNANTI}/>

    {/* Allievi */}
    <div>
      <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",marginBottom:9}}>
        Allievi assegnati ({(f.allievi||[]).length})
      </div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}} className="form-2col">
        {ALLIEVI.map(a=>{
          const sel=(f.allievi||[]).includes(a);
          return(
            <button key={a} onClick={()=>toggleAllievo(a)}
              style={{display:"flex",alignItems:"center",gap:8,padding:"7px 10px",
                borderRadius:8,border:`1.5px solid ${sel?C.gold:C.border}`,
                background:sel?C.goldBg:C.bg,cursor:"pointer",transition:"all .12s"}}>
              <div style={{width:14,height:14,borderRadius:3,border:`2px solid ${sel?C.gold:C.border}`,
                background:sel?C.gold:"transparent",flexShrink:0,display:"flex",
                alignItems:"center",justifyContent:"center"}}>
                {sel&&<Ic n="check" size={9} stroke={C.bg}/>}
              </div>
              <span style={{fontSize:12,color:sel?C.gold:C.textMuted}}>{a}</span>
            </button>
          );
        })}
      </div>
    </div>

    {/* Note */}
    <div style={{display:"flex",flexDirection:"column",gap:5}}>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase"}}>Note tecniche / annotazioni</label>
      <textarea value={f.note} onChange={e=>set("note",e.target.value)} rows={3}
        placeholder="Indicazioni tecniche, riferimenti, obiettivi didattici..."
        style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:8,
          color:C.text,fontSize:13,padding:"9px 13px",width:"100%",
          fontFamily:"'DM Sans',sans-serif",resize:"vertical"}}/>
    </div>
  </div>

  <div style={{padding:"13px 22px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"flex-end",gap:8}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={handleSave}><Ic n="check" size={13} stroke={C.bg}/>{initial?.id?"Salva modifiche":"Aggiungi brano"}</Btn>
  </div>
</>
```

);
};

// â”€â”€â”€ DRAWER DETTAGLIO BRANO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BranoDrawer = ({brano,onClose,onEdit,onDelete})=>{
const d=diffById(brano.difficulty);
const p=periodoById(brano.periodo);
const isCol=brano.tipo===â€œcollettivoâ€;
const typeHex=isCol?C.purple:C.gold;
const typeBg=isCol?C.purpleBg:C.goldBg;
const typeBd=isCol?C.purpleBorder:C.goldDim;

return(
<>
<div onClick={onClose} style={{position:â€œfixedâ€,inset:0,zIndex:300,
background:â€œrgba(0,0,0,.7)â€,backdropFilter:â€œblur(3px)â€,animation:â€œfadeIn .2s easeâ€}}/>
<div style={{position:â€œfixedâ€,top:0,right:0,bottom:0,zIndex:301,width:480,
background:C.surface,borderLeft:`1px solid ${C.border}`,
display:â€œflexâ€,flexDirection:â€œcolumnâ€,animation:â€œslideDrawer .26s cubic-bezier(.4,0,.2,1)â€}}>

```
    {/* Header */}
    <div style={{padding:"18px 22px",borderBottom:`1px solid ${C.border}`,flexShrink:0}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:12}}>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:21,fontWeight:600,lineHeight:1.25,marginBottom:5}}>
            {brano.title}
          </div>
          <div style={{fontSize:13,color:C.textMuted}}>{brano.composer}</div>
        </div>
        <button onClick={onClose} style={{background:"none",border:"none",cursor:"pointer",
          color:C.textMuted,display:"flex",padding:4,flexShrink:0}}>
          <Ic n="x" size={17} stroke={C.textMuted}/>
        </button>
      </div>
      <div style={{display:"flex",gap:6,marginTop:12,flexWrap:"wrap"}}>
        <DiffBadge diff={brano.difficulty}/>
        <TipoBadge tipo={brano.tipo}/>
        {brano.periodo&&(
          <span style={{background:p.hex+"18",color:p.hex,border:`1px solid ${p.hex}40`,
            borderRadius:4,padding:"2px 7px",fontSize:10,fontWeight:600,letterSpacing:"0.05em"}}>{brano.periodo}</span>
        )}
        {brano.tonality&&(
          <span style={{background:C.bg,color:C.textMuted,border:`1px solid ${C.border}`,
            borderRadius:4,padding:"2px 7px",fontSize:10}}>{brano.tonality}</span>
        )}
      </div>
    </div>

    {/* Body */}
    <div style={{flex:1,overflow:"auto",padding:"18px 22px",display:"flex",flexDirection:"column",gap:16}}>

      {/* Statistiche */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))",gap:10}}>
        {[
          {label:"Lezioni totali",   val:brano.lezioni||0, hex:C.gold},
          {label:"Allievi assegnati",val:(brano.allievi||[]).length, hex:typeHex},
          {label:"Settimane attivo", val:brano.dataPrima?Math.round((new Date()-new Date(brano.dataPrima))/(7*86400000)):0, hex:C.blue},
        ].map(s=>(
          <div key={s.label} style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:10,padding:"12px 14px",textAlign:"center"}}>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600,color:s.hex}}>{s.val}</div>
            <div style={{fontSize:10,color:C.textDim,marginTop:3,lineHeight:1.3}}>{s.label}</div>
          </div>
        ))}
      </div>

      {/* Timeline */}
      {(brano.dataPrima||brano.dataUltima)&&(
        <div style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:10,padding:"12px 16px"}}>
          <div style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:10}}>Timeline studio</div>
          <div style={{display:"flex",flexDirection:"column",gap:6}}>
            {brano.dataPrima&&(
              <div style={{display:"flex",justifyContent:"space-between"}}>
                <span style={{fontSize:12,color:C.textDim}}>Prima lezione</span>
                <span style={{fontSize:12,color:C.text}}>{new Date(brano.dataPrima+"T00:00:00").toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"})}</span>
              </div>
            )}
            {brano.dataUltima&&(
              <div style={{display:"flex",justifyContent:"space-between"}}>
                <span style={{fontSize:12,color:C.textDim}}>Ultima lezione</span>
                <span style={{fontSize:12,color:C.text}}>{new Date(brano.dataUltima+"T00:00:00").toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"})}</span>
              </div>
            )}
            {brano.insegnante&&(
              <div style={{display:"flex",justifyContent:"space-between"}}>
                <span style={{fontSize:12,color:C.textDim}}>Insegnante</span>
                <span style={{fontSize:12,color:C.text}}>{brano.insegnante}</span>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Allievi */}
      {(brano.allievi||[]).length>0&&(
        <div>
          <div style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:10}}>
            Allievi {brano.tipo==="collettivo"?"nell'ensemble":"che studiano questo brano"} ({brano.allievi.length})
          </div>
          <div style={{display:"flex",flexDirection:"column",gap:6}}>
            {brano.allievi.map(a=>(
              <div key={a} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 12px",
                background:C.bg,border:`1px solid ${C.border}`,borderRadius:8}}>
                <div style={{width:30,height:30,borderRadius:"50%",background:`${typeHex}18`,
                  border:`1.5px solid ${typeHex}40`,display:"flex",alignItems:"center",
                  justifyContent:"center",flexShrink:0,
                  fontFamily:"'Cormorant Garamond',serif",fontSize:13,fontWeight:600,color:typeHex}}>
                  {a.split(" ").map(p=>p[0]).join("").slice(0,2)}
                </div>
                <span style={{fontSize:13}}>{a}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Note */}
      {brano.note&&(
        <div style={{background:C.goldBg,border:`1px solid ${C.goldDim}`,borderRadius:10,padding:"14px 16px"}}>
          <div style={{fontSize:10,color:C.gold,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:7}}>Note tecniche</div>
          <div style={{fontSize:13,color:C.text,lineHeight:1.65}}>{brano.note}</div>
        </div>
      )}
    </div>

    {/* Footer */}
    <div style={{padding:"14px 22px",borderTop:`1px solid ${C.border}`,
      display:"flex",justifyContent:"space-between",flexShrink:0}}>
      <Btn danger onClick={()=>onDelete(brano)}>
        <Ic n="trash" size={13} stroke={C.red}/>Elimina
      </Btn>
      <Btn variant="secondary" onClick={()=>onEdit(brano)}>
        <Ic n="edit" size={13} stroke={C.textMuted}/>Modifica
      </Btn>
    </div>
  </div>
</>
```

);
};

// â”€â”€â”€ VISTA ALLIEVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AllievoBraniView = ({allievo,brani,onBack})=>{
const isMobile = useIsMobile();
const suoiBrani=brani.filter(b=>(b.allievi||[]).includes(allievo));
const individuali=suoiBrani.filter(b=>b.tipo===â€œindividualeâ€);
const collettivi=suoiBrani.filter(b=>b.tipo===â€œcollettivoâ€);

return(
<div style={{flex:1,padding:isMobile?â€œ12pxâ€:â€œ20px 24pxâ€,overflow:â€œautoâ€}}>
<button onClick={onBack} style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:6,background:â€œnoneâ€,
border:â€œnoneâ€,cursor:â€œpointerâ€,color:C.textMuted,fontSize:13,fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,
marginBottom:20,padding:â€œ4px 0â€}}>
<svg width={16} height={16} viewBox="0 0 24 24" fill="none" stroke={C.textMuted} strokeWidth="1.8" strokeLinecap="round"><path d="m15 18-6-6 6-6"/></svg>
Tutti gli allievi
</button>

```
  <div style={{display:"flex",alignItems:"flex-start",gap:16,marginBottom:22}}>
    <div style={{width:56,height:56,borderRadius:"50%",background:`${C.gold}18`,
      border:`2px solid ${C.goldDim}`,display:"flex",alignItems:"center",justifyContent:"center",
      fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:C.gold}}>
      {allievo.split(" ").map(p=>p[0]).join("").slice(0,2)}
    </div>
    <div>
      <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600}}>{allievo}</h2>
      <div style={{fontSize:13,color:C.textMuted,marginTop:3}}>
        {suoiBrani.length} brani Â· {individuali.length} individuali Â· {collettivi.length} collettivi
      </div>
    </div>
  </div>

  {suoiBrani.length===0&&(
    <div style={{textAlign:"center",padding:"48px 0",color:C.textDim}}>
      <Ic n="music" size={32} stroke={C.textDim}/>
      <p style={{marginTop:12,fontSize:14}}>Nessun brano assegnato a questo allievo</p>
    </div>
  )}

  {individuali.length>0&&(
    <div style={{marginBottom:22}}>
      <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:10,display:"flex",alignItems:"center",gap:6}}>
        <Ic n="solo" size={13} stroke={C.gold}/> Studio personale ({individuali.length})
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:8}}>
        {individuali.map(b=>{
          const d=diffById(b.difficulty);
          const p=periodoById(b.periodo);
          return(
            <div key={b.id} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,
              padding:"14px 18px",display:"flex",gap:14,alignItems:"center"}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:14,fontWeight:600,marginBottom:3}}>{b.title}</div>
                <div style={{fontSize:12,color:C.textMuted}}>{b.composer}{b.tonality?` Â· ${b.tonality}`:""}</div>
              </div>
              <div style={{display:"flex",gap:6,flexWrap:"wrap",justifyContent:"flex-end",flexShrink:0}}>
                <DiffBadge diff={b.difficulty}/>
                {b.periodo&&<span style={{background:p.hex+"18",color:p.hex,border:`1px solid ${p.hex}30`,borderRadius:4,padding:"2px 6px",fontSize:10,fontWeight:600}}>{b.periodo}</span>}
                <span style={{fontSize:11,color:C.textDim}}>{b.lezioni} lez.</span>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  )}

  {collettivi.length>0&&(
    <div>
      <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:10,display:"flex",alignItems:"center",gap:6}}>
        <Ic n="group" size={13} stroke={C.purple}/> Ensemble / orchestra ({collettivi.length})
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:8}}>
        {collettivi.map(b=>{
          const d=diffById(b.difficulty);
          return(
            <div key={b.id} style={{background:C.surface,border:`1px solid ${C.purpleBorder}30`,borderRadius:10,
              padding:"14px 18px",display:"flex",gap:14,alignItems:"center"}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:14,fontWeight:600,marginBottom:3}}>{b.title}</div>
                <div style={{fontSize:12,color:C.textMuted}}>{b.composer}</div>
                {(b.allievi||[]).length>1&&(
                  <div style={{fontSize:11,color:C.textDim,marginTop:4}}>
                    Con: {b.allievi.filter(a=>a!==allievo).slice(0,3).join(", ")}{b.allievi.length>4?` +${b.allievi.length-4} altri`:""}
                  </div>
                )}
              </div>
              <DiffBadge diff={b.difficulty}/>
            </div>
          );
        })}
      </div>
    </div>
  )}
</div>
```

);
};

// â”€â”€â”€ CONFIRM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const RepertorioView = () => {
const isMobile = useIsMobile();
const [brani,     setBrani]    = useState(INIT_BRANI);
const [tab,       setTab]      = useState(â€œcatalogoâ€); // catalogo | allievi
const [layout,    setLayout]   = useState(â€œgridâ€);     // grid | list
const [search,    setSearch]   = useState(â€â€);
const [fDiff,     setFDiff]    = useState(â€â€);
const [fTipo,     setFTipo]    = useState(â€â€);
const [fPeriodo,  setFPeriodo] = useState(â€â€);
const [drawer,    setDrawer]   = useState(null);
const [modal,     setModal]    = useState(null); // â€œaddâ€|â€œeditâ€|â€œconfirm_deleteâ€
const [selBrano,  setSelBrano] = useState(null);
const [allievoPOV,setAllievoPOV]=useState(null);
const [toast,     setToast]    = useState(null);

```
const showToast=(msg,hex=C.green)=>{setToast({msg,hex});setTimeout(()=>setToast(null),3000);};
const closeModal=()=>{setModal(null);setSelBrano(null);};

// â”€â”€ CRUD â”€â”€
const aggiungiBrano=(f)=>{setBrani(p=>[...p,{...f,id:uid(),lezioni:0}]);closeModal();showToast("Brano aggiunto");};
const modificaBrano=(f)=>{setBrani(p=>p.map(b=>b.id===selBrano.id?{...b,...f}:b));closeModal();setDrawer(null);showToast("Brano aggiornato");};
const eliminaBrano=()=>{
  setBrani(p=>p.filter(b=>b.id!==selBrano.id));
  setDrawer(null); closeModal();
  showToast("Brano eliminato",C.red);
};

// â”€â”€ FILTRI â”€â”€
const filtrati = useMemo(()=>brani.filter(b=>{
  const q=search.toLowerCase();
  return(!q||b.title.toLowerCase().includes(q)||b.composer.toLowerCase().includes(q)||b.tonality?.toLowerCase().includes(q))
    &&(!fDiff||b.difficulty===fDiff)
    &&(!fTipo||b.tipo===fTipo)
    &&(!fPeriodo||b.periodo===fPeriodo);
}),[brani,search,fDiff,fTipo,fPeriodo]);

const individuali=filtrati.filter(b=>b.tipo==="individuale");
const collettivi= filtrati.filter(b=>b.tipo==="collettivo");

// â”€â”€ STATS â”€â”€
const totLezioni=brani.reduce((s,b)=>s+(b.lezioni||0),0);
const braniAvanzati=brani.filter(b=>b.difficulty==="Avanzato"||b.difficulty==="Professionale").length;

return(
  <>
    <style>{G}</style>
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column"}}>

      {/* â”€â”€ NAVBAR â”€â”€ */}
      <header style={{background:C.surface,borderBottom:`1px solid ${C.border}`,
        padding:"0 20px",display:"flex",alignItems:"center",height:56,flexShrink:0}}>
        <div style={{display:"flex",alignItems:"center",gap:10,paddingRight:22,marginRight:22,
          borderRight:`1px solid ${C.border}`,height:"100%"}}>
          <div style={{width:28,height:28,borderRadius:7,background:C.gold,
            display:"flex",alignItems:"center",justifyContent:"center"}}>
            <Ic n="music" size={14} stroke={C.bg}/>
          </div>
          <div>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,lineHeight:1}}>Accademia Musicale</div>
            <div style={{fontSize:9,color:C.textDim,letterSpacing:"0.12em",textTransform:"uppercase"}}>Sistema gestionale</div>
          </div>
        </div>
        {[["grid2","Dashboard"],["users","Allievi"],["calendar","Calendario"],
          ["shield","ContabilitÃ "],["book","Repertorio"],["users","Utenti"]].map(([ic,lb],i)=>(
          <button key={lb} style={{height:"100%",padding:"0 13px",display:"flex",alignItems:"center",gap:7,
            background:i===4?C.goldBg:"none",border:"none",cursor:"pointer",fontSize:13,
            color:i===4?C.gold:C.textMuted,fontFamily:"'DM Sans',sans-serif",
            borderBottom:i===4?`2px solid ${C.gold}`:"2px solid transparent"}}>
            <Ic n={ic} size={14} stroke={i===4?C.gold:C.textMuted}/>{lb}
          </button>
        ))}
        <div style={{marginLeft:"auto"}}>
          <Btn onClick={()=>setModal("add")}>
            <Ic n="plus" size={14} stroke={C.bg}/>Nuovo brano
          </Btn>
        </div>
      </header>

      {/* â”€â”€ Se allievoPOV attivo, mostra vista allievo â”€â”€ */}
      {allievoPOV ? (
        <AllievoBraniView
          allievo={allievoPOV}
          brani={brani}
          onBack={()=>setAllievoPOV(null)}
        />
      ) : (
        <>
          {/* â”€â”€ PAGE HEADER â”€â”€ */}
          <div style={{background:`linear-gradient(135deg,${C.surface} 0%,${C.bg} 100%)`,
            borderBottom:`1px solid ${C.border}`,padding:"16px 20px",flexShrink:0}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
              <div style={{animation:"fadeUp .4s ease both"}}>
                <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:300,letterSpacing:"0.02em"}}>
                  <span style={{fontWeight:600,color:C.gold}}>Repertorio</span> musicale
                </h1>
                <p style={{fontSize:13,color:C.textMuted,marginTop:5}}>
                  Catalogo brani, assegnazioni allievi e storico lezioni
                </p>
              </div>
              <div style={{display:"flex",gap:12,animation:"fadeUp .4s ease .1s both"}}>
                {[
                  {label:"Brani totali",  val:brani.length,                                    hex:C.gold},
                  {label:"Individuali",   val:brani.filter(b=>b.tipo==="individuale").length,   hex:C.gold},
                  {label:"Collettivi",    val:brani.filter(b=>b.tipo==="collettivo").length,    hex:C.purple},
                  {label:"Lezioni totali",val:totLezioni,                                       hex:C.blue},
                ].map(k=>(
                  <div key={k.label} style={{padding:"10px 16px",background:C.surface,
                    border:`1px solid ${C.border}`,borderRadius:10,textAlign:"center",minWidth:80}}>
                    <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:600,color:k.hex}}>{k.val}</div>
                    <div style={{fontSize:10,color:C.textDim,letterSpacing:"0.07em",textTransform:"uppercase",marginTop:2}}>{k.label}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* â”€â”€ BODY â”€â”€ */}
          <div style={{flex:1,padding:isMobile?"12px":"20px 24px",overflow:"auto",display:"flex",flexDirection:"column",gap:16}}>

            {/* Tabs + layout */}
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{display:"flex",gap:2}}>
                {[["catalogo","book","Catalogo brani"],["allievi","users","Per allievo"]].map(([v,ic,lb])=>(
                  <button key={v} onClick={()=>setTab(v)}
                    style={{display:"flex",alignItems:"center",gap:7,padding:"8px 16px",borderRadius:8,
                      background:tab===v?C.goldBg:"none",border:`1px solid ${tab===v?C.goldDim:C.border}`,
                      cursor:"pointer",fontSize:13,color:tab===v?C.gold:C.textMuted,
                      fontFamily:"'DM Sans',sans-serif",transition:"all .15s"}}>
                    <Ic n={ic} size={14} stroke={tab===v?C.gold:C.textMuted}/>{lb}
                  </button>
                ))}
              </div>
              {tab==="catalogo"&&(
                <div style={{display:"flex",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,overflow:"hidden"}}>
                  {[["grid","grid2"],["list","list"]].map(([v,ic])=>(
                    <button key={v} onClick={()=>setLayout(v)}
                      style={{padding:"7px 12px",display:"flex",alignItems:"center",gap:5,
                        background:layout===v?C.goldBg:"transparent",border:"none",cursor:"pointer",
                        color:layout===v?C.gold:C.textMuted,borderRight:`1px solid ${C.border}`,transition:"all .15s"}}>
                      <Ic n={ic} size={14} stroke={layout===v?C.gold:C.textMuted}/>
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* â”€â”€ TAB CATALOGO â”€â”€ */}
            {tab==="catalogo"&&(
              <>
                {/* Filtri */}
                <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
                  <div style={{position:"relative",flex:"1 1 220px"}}>
                    <span style={{position:"absolute",left:11,top:"50%",transform:"translateY(-50%)"}}>
                      <Ic n="search" size={14} stroke={C.textDim}/>
                    </span>
                    <input value={search} onChange={e=>setSearch(e.target.value)}
                      placeholder="Cerca titolo, compositore, tonalitÃ ..."
                      style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
                        color:C.text,fontSize:13,padding:"9px 12px 9px 34px",fontFamily:"'DM Sans',sans-serif"}}/>
                  </div>
                  {[
                    {val:fTipo,set:setFTipo,opts:["individuale","collettivo"],ph:"Tipo"},
                    {val:fDiff,set:setFDiff,opts:DIFFICULTY.map(d=>d.id),ph:"DifficoltÃ "},
                    {val:fPeriodo,set:setFPeriodo,opts:PERIODI.map(p=>p.id),ph:"Periodo"},
                  ].map((f,i)=>(
                    <select key={i} value={f.val} onChange={e=>f.set(e.target.value)}
                      style={{background:C.surface,border:`1px solid ${f.val?C.goldDim:C.border}`,
                        borderRadius:8,color:f.val?C.gold:C.textMuted,fontSize:13,
                        padding:"9px 12px",fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
                      <option value="">{f.ph}</option>
                      {f.opts.map(o=><option key={o} value={o}>{o}</option>)}
                    </select>
                  ))}
                  {(search||fDiff||fTipo||fPeriodo)&&(
                    <Btn small variant="ghost" onClick={()=>{setSearch("");setFDiff("");setFTipo("");setFPeriodo("");}}>
                      <Ic n="x" size={12} stroke={C.textMuted}/>Azzera
                    </Btn>
                  )}
                  <span style={{fontSize:12,color:C.textDim,marginLeft:"auto"}}>{filtrati.length} brani</span>
                </div>

                {/* â”€â”€ GRID â”€â”€ */}
                {layout==="grid"&&(
                  <div style={{display:"flex",flexDirection:"column",gap:24}}>
                    {/* Sezione individuale */}
                    {individuali.length>0&&(
                      <div>
                        <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",
                          marginBottom:12,display:"flex",alignItems:"center",gap:7}}>
                          <Ic n="solo" size={13} stroke={C.gold}/>
                          Brani individuali <span style={{color:C.textDim}}>({individuali.length})</span>
                        </div>
                        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(300px,1fr))",gap:10}}>
                          {individuali.map((b,i)=>{
                            const d=diffById(b.difficulty);
                            const p=periodoById(b.periodo);
                            return(
                              <div key={b.id} className="card-anim" onClick={()=>setDrawer(b)}
                                style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,
                                  padding:"15px 17px",cursor:"pointer",transition:"all .15s"}}
                                onMouseEnter={e=>{e.currentTarget.style.borderColor=C.gold+"50";e.currentTarget.style.background=C.surfaceHover;}}
                                onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.background=C.surface;}}>
                                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:8,marginBottom:8}}>
                                  <div style={{flex:1,minWidth:0}}>
                                    <div style={{fontSize:14,fontWeight:600,lineHeight:1.3,marginBottom:3,
                                      overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.title}</div>
                                    <div style={{fontSize:12,color:C.textMuted}}>{b.composer}</div>
                                  </div>
                                  <Ic n="right" size={14} stroke={C.textDim}/>
                                </div>
                                <div style={{display:"flex",gap:5,flexWrap:"wrap",alignItems:"center",marginBottom:8}}>
                                  {b.tonality&&<span style={{fontSize:10,padding:"2px 6px",borderRadius:4,border:`1px solid ${C.border}`,color:C.textMuted}}>{b.tonality}</span>}
                                  {b.periodo&&<span style={{fontSize:10,padding:"2px 6px",borderRadius:4,background:p.hex+"18",color:p.hex,border:`1px solid ${p.hex}30`}}>{b.periodo}</span>}
                                  <DiffBadge diff={b.difficulty}/>
                                </div>
                                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
                                  paddingTop:8,borderTop:`1px solid ${C.border}20`}}>
                                  <div style={{display:"flex",alignItems:"center",gap:5}}>
                                    <Ic n="users" size={12} stroke={C.textDim}/>
                                    <span style={{fontSize:11,color:C.textDim}}>{(b.allievi||[]).length} alliev{(b.allievi||[]).length===1?"o":"i"}</span>
                                  </div>
                                  <div style={{display:"flex",alignItems:"center",gap:5}}>
                                    <Ic n="calendar" size={12} stroke={C.textDim}/>
                                    <span style={{fontSize:11,color:C.textDim}}>{b.lezioni||0} lezioni</span>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}

                    {/* Sezione collettivi */}
                    {collettivi.length>0&&(
                      <div>
                        <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",
                          marginBottom:12,display:"flex",alignItems:"center",gap:7}}>
                          <Ic n="group" size={13} stroke={C.purple}/>
                          Brani collettivi <span style={{color:C.textDim}}>({collettivi.length})</span>
                        </div>
                        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(300px,1fr))",gap:10}}>
                          {collettivi.map((b,i)=>{
                            const d=diffById(b.difficulty);
                            const p=periodoById(b.periodo);
                            return(
                              <div key={b.id} className="card-anim" onClick={()=>setDrawer(b)}
                                style={{background:C.surface,border:`1px solid ${C.purpleBorder}30`,borderRadius:12,
                                  padding:"15px 17px",cursor:"pointer",transition:"all .15s"}}
                                onMouseEnter={e=>{e.currentTarget.style.borderColor=C.purple+"50";e.currentTarget.style.background=C.surfaceHover;}}
                                onMouseLeave={e=>{e.currentTarget.style.borderColor=C.purpleBorder+"30";e.currentTarget.style.background=C.surface;}}>
                                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:8,marginBottom:8}}>
                                  <div style={{flex:1,minWidth:0}}>
                                    <div style={{fontSize:14,fontWeight:600,lineHeight:1.3,marginBottom:3}}>{b.title}</div>
                                    <div style={{fontSize:12,color:C.textMuted}}>{b.composer}</div>
                                  </div>
                                  <Ic n="right" size={14} stroke={C.textDim}/>
                                </div>
                                <div style={{display:"flex",gap:5,flexWrap:"wrap",marginBottom:8}}>
                                  {b.periodo&&<span style={{fontSize:10,padding:"2px 6px",borderRadius:4,background:p.hex+"18",color:p.hex,border:`1px solid ${p.hex}30`}}>{b.periodo}</span>}
                                  <DiffBadge diff={b.difficulty}/>
                                  <TipoBadge tipo={b.tipo}/>
                                </div>
                                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
                                  paddingTop:8,borderTop:`1px solid ${C.border}20`}}>
                                  <div style={{display:"flex",alignItems:"center",gap:5}}>
                                    <Ic n="users" size={12} stroke={C.textDim}/>
                                    <span style={{fontSize:11,color:C.textDim}}>{(b.allievi||[]).length} partecipanti</span>
                                  </div>
                                  <div style={{display:"flex",alignItems:"center",gap:5}}>
                                    <Ic n="calendar" size={12} stroke={C.textDim}/>
                                    <span style={{fontSize:11,color:C.textDim}}>{b.lezioni||0} lezioni</span>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}

                    {filtrati.length===0&&(
                      <div style={{textAlign:"center",padding:"48px 0",color:C.textDim}}>
                        <Ic n="music" size={32} stroke={C.textDim}/>
                        <p style={{marginTop:12,fontSize:14}}>Nessun brano trovato</p>
                      </div>
                    )}
                  </div>
                )}

                {/* â”€â”€ LIST â”€â”€ */}
                {layout==="list"&&(
                  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
                    <div style={{display:"grid",gridTemplateColumns:"2.5fr 1.2fr 1.2fr 1fr 0.8fr 0.8fr auto",minWidth:560,
                      padding:"8px 20px",borderBottom:`1px solid ${C.border}`,background:C.bg}}>
                      {["Brano","Tipo","DifficoltÃ ","Periodo","Allievi","Lezioni",""].map(h=>(
                        <div key={h} style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>{h}</div>
                      ))}
                    </div>
                    {filtrati.map((b,i)=>{
                      const p=periodoById(b.periodo);
                      return(
                        <div key={b.id} onClick={()=>setDrawer(b)}
                          style={{display:"grid",gridTemplateColumns:"2.5fr 1.2fr 1.2fr 1fr 0.8fr 0.8fr auto",minWidth:560,
                            padding:"12px 20px",borderBottom:i<filtrati.length-1?`1px solid ${C.border}20`:"none",
                            alignItems:"center",cursor:"pointer",transition:"background .1s"}}
                          onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
                          onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                          <div>
                            <div style={{fontSize:13,fontWeight:500}}>{b.title}</div>
                            <div style={{fontSize:11,color:C.textMuted,marginTop:1}}>{b.composer}</div>
                          </div>
                          <TipoBadge tipo={b.tipo}/>
                          <DiffBadge diff={b.difficulty}/>
                          <div>
                            {b.periodo&&<span style={{fontSize:11,color:p.hex}}>{b.periodo}</span>}
                          </div>
                          <span style={{fontSize:12,color:C.textMuted}}>{(b.allievi||[]).length}</span>
                          <span style={{fontSize:12,color:C.textMuted}}>{b.lezioni||0}</span>
                          <Ic n="right" size={14} stroke={C.textDim}/>
                        </div>
                      );
                    })}
                  </div>
                )}
              </>
            )}

            {/* â”€â”€ TAB ALLIEVI â”€â”€ */}
            {tab==="allievi"&&(
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(220px,1fr))",gap:12}}>
                {ALLIEVI.map((a,i)=>{
                  const suoiBrani=brani.filter(b=>(b.allievi||[]).includes(a));
                  const totLez=suoiBrani.reduce((s,b)=>s+(b.lezioni||0),0);
                  const ind=suoiBrani.filter(b=>b.tipo==="individuale").length;
                  const col=suoiBrani.filter(b=>b.tipo==="collettivo").length;
                  return(
                    <div key={a} className="card-anim" onClick={()=>setAllievoPOV(a)}
                      style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,
                        padding:"18px 18px",cursor:"pointer",transition:"all .15s"}}
                      onMouseEnter={e=>{e.currentTarget.style.borderColor=C.gold+"50";e.currentTarget.style.background=C.surfaceHover;}}
                      onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.background=C.surface;}}>
                      <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:14}}>
                        <div style={{width:44,height:44,borderRadius:"50%",background:`${C.gold}18`,
                          border:`2px solid ${C.goldDim}`,display:"flex",alignItems:"center",justifyContent:"center",
                          fontFamily:"'Cormorant Garamond',serif",fontSize:17,fontWeight:600,color:C.gold}}>
                          {a.split(" ").map(p=>p[0]).join("").slice(0,2)}
                        </div>
                        <div>
                          <div style={{fontSize:13,fontWeight:600}}>{a}</div>
                          <div style={{fontSize:11,color:C.textMuted,marginTop:1}}>{suoiBrani.length} brani</div>
                        </div>
                      </div>
                      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,
                        borderTop:`1px solid ${C.border}`,paddingTop:12}}>
                        {[{val:ind,label:"Ind.",hex:C.gold},{val:col,label:"Col.",hex:C.purple},{val:totLez,label:"Lez.",hex:C.blue}].map(s=>(
                          <div key={s.label} style={{textAlign:"center"}}>
                            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:s.hex}}>{s.val}</div>
                            <div style={{fontSize:9,color:C.textDim,letterSpacing:"0.07em",textTransform:"uppercase"}}>{s.label}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </>
      )}
    </div>

    {/* â”€â”€ DRAWER â”€â”€ */}
    {drawer&&(
      <BranoDrawer
        brano={drawer}
        onClose={()=>setDrawer(null)}
        onEdit={(b)=>{setSelBrano(b);setDrawer(null);setModal("edit");}}
        onDelete={(b)=>{setSelBrano(b);setModal("confirm_delete");}}
      />
    )}

    {/* â”€â”€ MODALI â”€â”€ */}
    {modal==="add"&&(
      <Modal title="Nuovo brano" onClose={closeModal} wide>
        <BranoForm onSave={aggiungiBrano} onClose={closeModal}/>
      </Modal>
    )}
    {modal==="edit"&&selBrano&&(
      <Modal title="Modifica brano" onClose={closeModal} wide>
        <BranoForm initial={selBrano} onSave={modificaBrano} onClose={closeModal}/>
      </Modal>
    )}
    {modal==="confirm_delete"&&selBrano&&(
      <ConfirmDel
        title="Elimina brano"
        testo={`Eliminare "${selBrano.title}" dal catalogo? L'operazione Ã¨ irreversibile.`}
        onConfirm={eliminaBrano}
        onClose={closeModal}
      />
    )}

    {/* â”€â”€ TOAST â”€â”€ */}
    {toast&&(
      <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",zIndex:400,
        background:C.surface,border:`1px solid ${toast.hex}40`,borderLeft:`3px solid ${toast.hex}`,
        borderRadius:10,padding:"11px 18px",display:"flex",alignItems:"center",gap:10,
        animation:"fadeUp .25s ease",boxShadow:"0 8px 32px rgba(0,0,0,.5)",
        fontFamily:"'DM Sans',sans-serif",fontSize:13}}>
        <Ic n="check" size={14} stroke={toast.hex}/>
        <span style={{color:C.text}}>{toast.msg}</span>
      </div>
    )}
  </>
);
```

};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONCERTI & EVENTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TIPI_EVENTO = [
{ id:â€œsaggioâ€,      label:â€œSaggioâ€,         icon:â€œstar2â€,   hex:C.gold,
desc:â€œEsibizione degli allievi con brani del repertorio studiato. Partecipazione obbligatoria.â€ },
{ id:â€œconcertoâ€,    label:â€œConcertoâ€,        icon:â€œmicâ€,     hex:C.purple,
desc:â€œConcerto pubblico con allievi avanzati e docenti. Biglietteria opzionale.â€ },
{ id:â€œworkshopâ€,    label:â€œWorkshopâ€,        icon:â€œgroupâ€,   hex:C.teal,
desc:â€œWorkshop intensivo. Partecipazione facoltativa per gli allievi della scuola.â€ },
{ id:â€œmasterclassâ€, label:â€œMasterclassâ€,     icon:â€œuserâ€,    hex:C.blue,
desc:â€œCon artista ospite. Aperta anche a studenti esterni. Biglietteria opzionale.â€ },
{ id:â€œpubblicoâ€,    label:â€œEvento pubblicoâ€, icon:â€œbellâ€,    hex:C.green,
desc:â€œRassegna, festival o evento aperto. Partecipazione facoltativa.â€ },
];

const STATI_EVENTO = [â€œprogrammatoâ€,â€œin corsoâ€,â€œcompletatoâ€,â€œannullatoâ€];

const statoEvColor = st => ({
programmato:{ fg:C.blue,   bg:C.blueBg,   bd:C.blueBorder  },
completato: { fg:C.green,  bg:C.greenBg,  bd:C.greenBorder },
annullato:  { fg:C.red,    bg:C.redBg,    bd:C.redBorder   },
â€œin corsoâ€: { fg:C.gold,   bg:C.goldBg,   bd:C.goldDim     },
}[st] || { fg:C.textMuted, bg:C.surface, bd:C.border });

const tipoEv = id => TIPI_EVENTO.find(t=>t.id===id)||TIPI_EVENTO[0];

const INIT_CONCERTI = [
{
id:â€œev1â€, tipo:â€œsaggioâ€, titolo:â€œSaggio di Fine Anno 2025/2026â€,
data:â€œ2026-06-15â€, ora:â€œ17:00â€, luogo:â€œAula Magnaâ€, capienza:150,
biglietto:true, prezzoBiglietto:10, stato:â€œprogrammatoâ€,
descrizione:â€œEsibizione annuale di tutti gli allievi con i brani studiati durante lâ€™anno.â€,
note:â€œRinfresco post-saggio nel cortile.â€,
partecipanti:[
{studentId:1, studentName:â€œSofia Marchettiâ€, brani:[â€œNotturno Op.9 n.2 â€“ Chopinâ€,â€œInvenzione n.1 â€“ Bachâ€]},
{studentId:2, studentName:â€œLuca Ferraraâ€,    brani:[â€œRomanza senza parole â€“ Mendelssohnâ€]},
{studentId:3, studentName:â€œEmma Contiâ€,      brani:[â€œGavotte â€“ Gossecâ€,â€œMinuetto â€“ Boccheriniâ€]},
{studentId:4, studentName:â€œMarco Ricciâ€,     brani:[â€œSolo batteria â€“ Red Hot Chili Peppersâ€]},
{studentId:5, studentName:â€œGiulia Romanoâ€,   brani:[â€œSyrinx â€“ Debussyâ€]},
],
prenotazioni:[
{id:â€œpr1â€,nome:â€œAnna Bianchiâ€,  email:â€œanna.b@email.itâ€, telefono:â€œ333 1111111â€,posti:2,stato:â€œconfermataâ€,dataPren:â€œ2026-05-10â€,pagato:true},
{id:â€œpr2â€,nome:â€œCarlo Verdiâ€,   email:â€œcarlo.v@email.itâ€,telefono:â€œ333 2222222â€,posti:3,stato:â€œconfermataâ€,dataPren:â€œ2026-05-12â€,pagato:true},
{id:â€œpr3â€,nome:â€œMaria Russoâ€,   email:â€œmaria.r@email.itâ€,telefono:â€œ333 3333333â€,posti:2,stato:â€œconfermataâ€,dataPren:â€œ2026-05-15â€,pagato:false},
{id:â€œpr4â€,nome:â€œGiuseppe Contiâ€,email:â€œg.conti@email.itâ€,telefono:â€œ333 4444444â€,posti:4,stato:â€œconfermataâ€,dataPren:â€œ2026-05-20â€,pagato:true},
{id:â€œpr5â€,nome:â€œLaura Espositoâ€,email:â€œl.esp@email.itâ€,  telefono:â€œ333 5555555â€,posti:1,stato:â€œannullataâ€, dataPren:â€œ2026-05-21â€,pagato:false},
],
},
{
id:â€œev2â€, tipo:â€œmasterclassâ€, titolo:â€œMasterclass Pianoforte â€“ Marco Bargagnaâ€,
data:â€œ2026-04-12â€, ora:â€œ10:00â€, luogo:â€œSala Bâ€, capienza:30,
biglietto:true, prezzoBiglietto:25, stato:â€œcompletatoâ€,
descrizione:â€œMasterclass aperta anche a studenti esterni.â€,
note:â€œPresenti 18 partecipanti. Grande successo.â€,
partecipanti:[{studentId:1,studentName:â€œSofia Marchettiâ€,brani:[â€œNotturno Op.9 n.2 â€“ Chopinâ€]}],
prenotazioni:[
{id:â€œpr6â€,nome:â€œElena Ferrettiâ€,email:â€œe.ferretti@email.itâ€,telefono:â€œ333 6666666â€,posti:1,stato:â€œconfermataâ€,dataPren:â€œ2026-03-20â€,pagato:true},
{id:â€œpr7â€,nome:â€œPaolo Martiniâ€, email:â€œp.martini@email.itâ€, telefono:â€œ333 7777777â€,posti:1,stato:â€œconfermataâ€,dataPren:â€œ2026-03-22â€,pagato:true},
{id:â€œpr8â€,nome:â€œSara Colomboâ€,  email:â€œs.colombo@email.itâ€, telefono:â€œ333 8888888â€,posti:1,stato:â€œconfermataâ€,dataPren:â€œ2026-03-25â€,pagato:true},
],
},
{
id:â€œev3â€, tipo:â€œworkshopâ€, titolo:â€œWorkshop: Improvvisazione Jazzâ€,
data:â€œ2026-05-08â€, ora:â€œ14:30â€, luogo:â€œSala Proveâ€, capienza:20,
biglietto:false, prezzoBiglietto:0, stato:â€œprogrammatoâ€,
descrizione:â€œWorkshop gratuito di introduzione allâ€™improvvisazione jazz.â€,
note:â€â€, partecipanti:[
{studentId:2,studentName:â€œLuca Ferraraâ€,brani:[]},
{studentId:4,studentName:â€œMarco Ricciâ€,  brani:[]},
], prenotazioni:[],
},
{
id:â€œev4â€, tipo:â€œconcertoâ€, titolo:â€œConcerto di Natale 2025â€,
data:â€œ2025-12-21â€, ora:â€œ18:00â€, luogo:â€œPiazza del Comuneâ€, capienza:500,
biglietto:false, prezzoBiglietto:0, stato:â€œcompletatoâ€,
descrizione:â€œConcerto natalizio allâ€™aperto con docenti e allievi avanzati.â€,
note:â€œStima pubblico: ~200 persone.â€,
partecipanti:[
{studentId:1,studentName:â€œSofia Marchettiâ€,brani:[â€œWhite Christmasâ€,â€œO Holy Nightâ€]},
{studentId:3,studentName:â€œEmma Contiâ€,      brani:[â€œNoelâ€]},
{studentId:5,studentName:â€œGiulia Romanoâ€,   brani:[â€œAdeste Fidelesâ€]},
],
prenotazioni:[],
},
];

// â”€â”€â”€ TOGGLE COMPONENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€ FORM PRENOTAZIONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PrenotazioneForm = ({ evento, initial, onSave, onClose }) => {
const def = initial || {id:â€â€,nome:â€â€,email:â€â€,telefono:â€â€,posti:1,stato:â€œconfermataâ€,dataPren:new Date().toISOString().split(â€œTâ€)[0],pagato:false};
const [f,setF] = useState(def);
const set = (k,v) => setF(p=>({â€¦p,[k]:v}));
const postiGia = evento.prenotazioni
.filter(p=>p.stato===â€œconfermataâ€&&p.id!==(initial?.id||â€â€))
.reduce((t,p)=>t+p.posti,0);
const postiLib = Math.max(0, evento.capienza - postiGia);
const importo  = f.posti*(evento.prezzoBiglietto||0);
return (
<>
<div style={{padding:â€œ20px 24pxâ€,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:14,overflow:â€œautoâ€}}>
<div style={{display:â€œgridâ€,gridTemplateColumns:â€œrepeat(auto-fit,minmax(190px,1fr))â€,gap:12}}>
<Input label=â€œNome *â€ value={f.nome} onChange={e=>set(â€œnomeâ€,e.target.value)} placeholder=â€œNome e cognomeâ€/>
<Input label=â€œEmailâ€ type=â€œemailâ€ value={f.email} onChange={e=>set(â€œemailâ€,e.target.value)} placeholder=â€œemail@esempio.itâ€/>
<Input label=â€œTelefonoâ€ value={f.telefono} onChange={e=>set(â€œtelefonoâ€,e.target.value)} placeholder=â€œ333 0000000â€/>
<Input label={`Posti (max ${postiLib})`} type=â€œnumberâ€ value={f.posti}
onChange={e=>set(â€œpostiâ€,Math.min(postiLib,Math.max(1,+e.target.value)))}/>
<Sel label=â€œStatoâ€ value={f.stato} onChange={e=>set(â€œstatoâ€,e.target.value)} options={[â€œconfermataâ€,â€œin attesaâ€,â€œannullataâ€]}/>
<Sel label=â€œPagamentoâ€ value={f.pagato?â€œpagatoâ€:â€œda pagareâ€} onChange={e=>set(â€œpagatoâ€,e.target.value===â€œpagatoâ€)} options={[â€œpagatoâ€,â€œda pagareâ€]}/>
</div>
{evento.biglietto && (
<div style={{background:C.goldBg,border:`1px solid ${C.goldDim}`,borderRadius:8,padding:â€œ12px 16pxâ€,display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,alignItems:â€œcenterâ€}}>
<span style={{fontSize:12,color:C.textMuted}}>Importo da riscuotere</span>
<span style={{fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€,fontSize:22,fontWeight:600,color:C.gold}}>â‚¬ {importo.toFixed(2)}</span>
</div>
)}
</div>
<div style={{padding:â€œ14px 24pxâ€,borderTop:`1px solid ${C.border}`,display:â€œflexâ€,justifyContent:â€œflex-endâ€,gap:10}}>
<Btn variant="secondary" onClick={onClose}>Annulla</Btn>
<Btn onClick={()=>{if(!f.nome.trim())return alert(â€œNome obbligatorioâ€);onSave({â€¦f,id:f.id||uid()});}}>
<Ic n="check" size={14} stroke={C.bg}/>{initial?.id?â€œSalvaâ€:â€œAggiungiâ€}
</Btn>
</div>
</>
);
};

// â”€â”€â”€ FORM EVENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EventoForm = ({ initial, students, onSave, onClose }) => {
const def = initial || {id:â€â€,tipo:â€œsaggioâ€,titolo:â€â€,data:â€â€,ora:â€â€,luogo:â€â€,capienza:100,
biglietto:false,prezzoBiglietto:0,stato:â€œprogrammatoâ€,descrizione:â€â€,note:â€â€,partecipanti:[],prenotazioni:[]};
const [f,setF]       = useState(def);
const [branoInp, setBranoInp] = useState({});
const [repOpen, setRepOpen]   = useState({});
const set = (k,v) => setF(p=>({â€¦p,[k]:v}));
const tp  = tipoEv(f.tipo);
const isMandatory = f.tipo === â€œsaggioâ€;
const hasBrani = f.tipo === â€œsaggioâ€ || f.tipo === â€œconcertoâ€;

const addPart = sid => {
if(f.partecipanti.find(p=>p.studentId===sid)) return;
const st = students.find(s=>s.id===sid);
if(!st) return;
set(â€œpartecipantiâ€,[â€¦f.partecipanti,{studentId:sid,studentName:st.name,brani:[]}]);
};
const remPart  = sid => set(â€œpartecipantiâ€,f.partecipanti.filter(p=>p.studentId!==sid));
const addBrano = (sid,b) => { if(!b.trim())return; set(â€œpartecipantiâ€,f.partecipanti.map(p=>p.studentId===sid?{â€¦p,brani:[â€¦p.brani,b.trim()]}:p)); };
const remBrano = (sid,i) => set(â€œpartecipantiâ€,f.partecipanti.map(p=>p.studentId===sid?{â€¦p,brani:p.brani.filter((_,j)=>j!==i)}:p));
const toggleRepBrano = (sid, titolo) => {
set(â€œpartecipantiâ€, f.partecipanti.map(p => {
if(p.studentId !== sid) return p;
const has = p.brani.includes(titolo);
return {â€¦p, brani: has ? p.brani.filter(b=>b!==titolo) : [â€¦p.brani, titolo]};
}));
};
const addTutti = () => {
const nuovi = students.filter(s=>!f.partecipanti.find(p=>p.studentId===s.id));
set(â€œpartecipantiâ€,[â€¦f.partecipanti,â€¦nuovi.map(s=>({studentId:s.id,studentName:s.name,brani:[]}))]);
};

return (
<>
<div style={{flex:1,overflow:â€œautoâ€,padding:â€œ20px 24pxâ€,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:18}}>

```
    {/* Tipo */}
    <div>
      <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",display:"block",marginBottom:8}}>Tipo evento</label>
      <div style={{display:"flex",flexWrap:"wrap",gap:8}}>
        {TIPI_EVENTO.map(t=>(
          <button key={t.id} onClick={()=>set("tipo",t.id)}
            style={{padding:"7px 14px",borderRadius:20,border:"2px solid "+(f.tipo===t.id?t.hex:C.border),
              background:f.tipo===t.id?(t.hex+"15"):"transparent",color:f.tipo===t.id?t.hex:C.textMuted,
              cursor:"pointer",fontSize:12,fontFamily:"'DM Sans',sans-serif",
              display:"flex",alignItems:"center",gap:6,transition:"all 0.15s"}}>
            <Ic n={t.icon} size={12} stroke={f.tipo===t.id?t.hex:C.textMuted}/>{t.label}
          </button>
        ))}
      </div>
      <p style={{fontSize:11,color:C.textDim,marginTop:6}}>{tp.desc}</p>
    </div>

    {/* Campi base */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(210px,1fr))",gap:12}}>
      <Input label="Titolo *" value={f.titolo} onChange={e=>set("titolo",e.target.value)} placeholder="Es. Saggio di Fine Anno"/>
      <Sel label="Stato" value={f.stato} onChange={e=>set("stato",e.target.value)} options={STATI_EVENTO}/>
      <Input label="Data *" type="date" value={f.data} onChange={e=>set("data",e.target.value)}/>
      <Input label="Ora" type="time" value={f.ora} onChange={e=>set("ora",e.target.value)}/>
      <Input label="Luogo" value={f.luogo} onChange={e=>set("luogo",e.target.value)} placeholder="Es. Aula Magna"/>
      <Input label="Capienza max" type="number" value={f.capienza} onChange={e=>set("capienza",+e.target.value)}/>
    </div>
    <Textarea label="Descrizione" value={f.descrizione} onChange={e=>set("descrizione",e.target.value)} placeholder="Descrizione pubblica dell'evento..."/>

    {/* Biglietto */}
    <div style={{background:C.surface,border:"1px solid "+C.border,borderRadius:10,padding:16}}>
      <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:f.biglietto?12:0}}>
        <Toggle checked={f.biglietto} onChange={v=>set("biglietto",v)}/>
        <div>
          <div style={{fontSize:13,fontWeight:500}}>Evento a biglietto</div>
          <div style={{fontSize:11,color:C.textDim}}>Abilita la gestione prenotazioni e biglietteria</div>
        </div>
      </div>
      {f.biglietto && (
        <div style={{paddingLeft:50}}>
          <Input label="Prezzo biglietto (euro)" type="number" value={f.prezzoBiglietto} onChange={e=>set("prezzoBiglietto",+e.target.value)}/>
        </div>
      )}
    </div>

    {/* Partecipanti */}
    <div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
        <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>
          {isMandatory ? "Partecipanti â€” obbligatori" : f.tipo==="concerto" ? "Partecipanti allievi" : "Partecipanti (facoltativi)"}
        </label>
        <div style={{display:"flex",gap:6,alignItems:"center"}}>
          {isMandatory && f.partecipanti.length < students.length && (
            <button onClick={addTutti}
              style={{padding:"4px 10px",borderRadius:10,border:"1px solid "+C.gold,background:C.goldBg,
                color:C.gold,cursor:"pointer",fontSize:10,fontFamily:"'DM Sans',sans-serif",
                display:"flex",alignItems:"center",gap:4}}>
              <Ic n="plus" size={9} stroke={C.gold}/> Aggiungi tutti
            </button>
          )}
          <span style={{fontSize:11,color:C.textDim}}>{f.partecipanti.length}/{students.length}</span>
        </div>
      </div>

      {students.filter(s=>!f.partecipanti.find(p=>p.studentId===s.id)).length > 0 && (
        <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:10,
          padding:"10px 12px",background:C.bg,borderRadius:8,border:"1px dashed "+C.border}}>
          <span style={{fontSize:10,color:C.textDim,width:"100%",marginBottom:2}}>
            {isMandatory ? "Aggiungi un allievo:" : "Aggiungi partecipanti (facoltativi):"}
          </span>
          {students.filter(s=>!f.partecipanti.find(p=>p.studentId===s.id)).map(s=>(
            <button key={s.id} onClick={()=>addPart(s.id)}
              style={{padding:"4px 10px",borderRadius:14,border:"1px solid "+C.border,
                background:"transparent",color:C.textMuted,cursor:"pointer",fontSize:11,
                fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:5,transition:"all 0.15s"}}
              onMouseEnter={e=>{e.currentTarget.style.borderColor=tp.hex;e.currentTarget.style.color=tp.hex;}}
              onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;}}>
              <Ic n="plus" size={10} stroke="currentColor"/>{s.name}
            </button>
          ))}
        </div>
      )}

      {f.partecipanti.map(p=>{
        const st = students.find(s=>s.id===p.studentId);
        const rep = (st ? (st.repertorio||[]) : []);
        const repComp   = rep.filter(r=>r.stato==="completato");
        const repStudio = rep.filter(r=>r.stato==="in studio");
        const showRep   = repOpen[p.studentId];
        return (
          <div key={p.studentId} style={{background:C.bg,border:"1px solid "+C.border,borderRadius:8,padding:"12px 14px",marginBottom:8}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:hasBrani?8:0}}>
              <div style={{display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:"50%",background:tp.hex+"20",
                  display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:tp.hex}}>
                  {initials(p.studentName)}
                </div>
                <div>
                  <span style={{fontSize:13,fontWeight:500}}>{p.studentName}</span>
                  {st && <span style={{fontSize:10,color:C.textDim,marginLeft:6}}>{st.instrument}</span>}
                </div>
              </div>
              <div style={{display:"flex",gap:6,alignItems:"center"}}>
                {hasBrani && rep.length > 0 && (
                  <button onClick={()=>setRepOpen(r=>({...r,[p.studentId]:!r[p.studentId]}))}
                    style={{padding:"3px 8px",borderRadius:8,border:"1px solid "+C.border,background:"transparent",
                      color:C.textMuted,cursor:"pointer",fontSize:10,fontFamily:"'DM Sans',sans-serif",
                      display:"flex",alignItems:"center",gap:4}}>
                    <Ic n="music" size={9} stroke={C.textMuted}/>{showRep?"Chiudi":"Scegli dal repertorio"}
                  </button>
                )}
                <button onClick={()=>remPart(p.studentId)} style={{background:"none",border:"none",cursor:"pointer",
                  display:"flex",padding:4,color:C.textDim}}
                  onMouseEnter={e=>e.currentTarget.style.color=C.red} onMouseLeave={e=>e.currentTarget.style.color=C.textDim}>
                  <Ic n="x" size={12} stroke="currentColor"/>
                </button>
              </div>
            </div>

            {hasBrani && (
              <div style={{paddingLeft:36}}>
                {showRep && rep.length > 0 && (
                  <div style={{background:C.surface,border:"1px solid "+C.border,borderRadius:8,padding:"10px 12px",marginBottom:8}}>
                    <div style={{fontSize:10,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em",marginBottom:8}}>
                      Repertorio â€” {p.studentName}
                    </div>
                    {repComp.length > 0 && (
                      <div style={{marginBottom:8}}>
                        <div style={{fontSize:9,color:C.green,fontWeight:600,letterSpacing:"0.06em",marginBottom:4,textTransform:"uppercase"}}>
                          Completati
                        </div>
                        {repComp.map(r=>{
                          const sel = p.brani.includes(r.titolo);
                          return (
                            <label key={r.id} style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",
                              padding:"5px 6px",borderRadius:6,marginBottom:2,
                              background:sel?(C.green+"15"):"transparent",transition:"background 0.1s"}}>
                              <input type="checkbox" checked={sel}
                                onChange={()=>toggleRepBrano(p.studentId,r.titolo)}
                                style={{accentColor:C.green,width:14,height:14,flexShrink:0}}/>
                              <span style={{flex:1}}>
                                <span style={{fontSize:12,fontWeight:sel?600:400}}>{r.titolo}</span>
                                <span style={{fontSize:10,color:C.textDim,marginLeft:6}}>{r.compositore}</span>
                              </span>
                            </label>
                          );
                        })}
                      </div>
                    )}
                    {repStudio.length > 0 && (
                      <div>
                        <div style={{fontSize:9,color:C.gold,fontWeight:600,letterSpacing:"0.06em",marginBottom:4,textTransform:"uppercase"}}>
                          In studio
                        </div>
                        {repStudio.map(r=>{
                          const sel = p.brani.includes(r.titolo);
                          return (
                            <label key={r.id} style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",
                              padding:"5px 6px",borderRadius:6,marginBottom:2,
                              background:sel?(C.gold+"15"):"transparent",transition:"background 0.1s"}}>
                              <input type="checkbox" checked={sel}
                                onChange={()=>toggleRepBrano(p.studentId,r.titolo)}
                                style={{accentColor:C.gold,width:14,height:14,flexShrink:0}}/>
                              <span style={{flex:1}}>
                                <span style={{fontSize:12,fontWeight:sel?600:400}}>{r.titolo}</span>
                                <span style={{fontSize:10,color:C.textDim,marginLeft:6}}>{r.compositore}</span>
                              </span>
                            </label>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}
                {p.brani.map((b,i)=>(
                  <div key={i} style={{display:"flex",alignItems:"center",gap:6,marginBottom:3}}>
                    <Ic n="music" size={10} stroke={tp.hex}/>
                    <span style={{fontSize:11,flex:1,color:C.text}}>{b}</span>
                    <button onClick={()=>remBrano(p.studentId,i)} style={{background:"none",border:"none",cursor:"pointer",
                      display:"flex",padding:2,color:C.textDim}}
                      onMouseEnter={e=>e.currentTarget.style.color=C.red} onMouseLeave={e=>e.currentTarget.style.color=C.textDim}>
                      <Ic n="x" size={9} stroke="currentColor"/>
                    </button>
                  </div>
                ))}
                <div style={{display:"flex",gap:6,marginTop:p.brani.length?6:0}}>
                  <input value={branoInp[p.studentId]||""}
                    onChange={e=>setBranoInp(prev=>({...prev,[p.studentId]:e.target.value}))}
                    onKeyDown={e=>{if(e.key==="Enter"&&branoInp[p.studentId] && branoInp[p.studentId].trim()){addBrano(p.studentId,branoInp[p.studentId]);setBranoInp(prev=>({...prev,[p.studentId]:""}));}}}
                    placeholder="Aggiungi brano manuale + Invio..."
                    style={{flex:1,background:C.surface,border:"1px solid "+C.border,borderRadius:6,
                      padding:"5px 10px",color:C.text,fontSize:11,fontFamily:"'DM Sans',sans-serif"}}/>
                  <button onClick={()=>{if(branoInp[p.studentId] && branoInp[p.studentId].trim()){addBrano(p.studentId,branoInp[p.studentId]);setBranoInp(prev=>({...prev,[p.studentId]:""}));}}}
                    style={{background:C.goldBg,border:"1px solid "+C.goldDim,borderRadius:6,padding:"5px 8px",cursor:"pointer",display:"flex"}}>
                    <Ic n="plus" size={11} stroke={C.gold}/>
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      })}

      {f.partecipanti.length === 0 && (
        <div style={{textAlign:"center",padding:"20px 0",color:C.textDim,fontSize:12,
          border:"1px dashed "+C.border,borderRadius:8}}>
          {isMandatory ? "Aggiungi gli allievi con il pulsante sopra" : "Nessun partecipante â€” facoltativo per questo tipo di evento"}
        </div>
      )}
    </div>

    <Textarea label="Note interne" value={f.note} onChange={e=>set("note",e.target.value)} placeholder="Note riservate alla segreteria..."/>
  </div>

  <div style={{padding:"14px 24px",borderTop:"1px solid "+C.border,display:"flex",justifyContent:"flex-end",gap:10}}>
    <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
    <Btn onClick={()=>{if(!f.titolo.trim()||!f.data)return alert("Titolo e data obbligatori");onSave({...f,id:f.id||("ev"+Date.now())});}}>
      <Ic n="check" size={14} stroke={C.bg}/>{initial && initial.id?"Salva modifiche":"Crea evento"}
    </Btn>
  </div>
</>
```

);
};

// â”€â”€â”€ DETTAGLIO EVENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EventoDetail = ({ evento, students, onEdit, onDelete, onBack, onUpdate }) => {
const [tab,    setTab]    = useState(â€œinfoâ€);
const [modalP, setModalP] = useState(null); // null | â€œaddâ€ | prenotazione-obj

const tp  = tipoEv(evento.tipo);
const sc  = statoEvColor(evento.stato);
const prenConf     = evento.prenotazioni.filter(p=>p.stato===â€œconfermataâ€);
const postiOcc     = prenConf.reduce((t,p)=>t+p.posti,0);
const incassoRisc  = prenConf.filter(p=>p.pagato).reduce((t,p)=>t+p.posti*(evento.prezzoBiglietto||0),0);
const incassoAtteso= prenConf.reduce((t,p)=>t+p.posti*(evento.prezzoBiglietto||0),0);

const savePren = pren => {
const newP = evento.prenotazioni.find(p=>p.id===pren.id)
? evento.prenotazioni.map(p=>p.id===pren.id?pren:p)
: [â€¦evento.prenotazioni,pren];
onUpdate({â€¦evento,prenotazioni:newP});
setModalP(null);
};
const delPren = id => onUpdate({â€¦evento,prenotazioni:evento.prenotazioni.filter(p=>p.id!==id)});

const TABS = [
{id:â€œinfoâ€,    label:â€œInformazioniâ€, icon:â€œflagâ€},
{id:â€œpartecâ€,  label:â€œPartecipantiâ€, icon:â€œusersâ€},
â€¦(evento.biglietto?[{id:â€œbigliettiâ€,label:â€œBiglietteriaâ€,icon:â€œreceiptâ€}]:[]),
{id:â€œreportâ€,  label:â€œReportâ€,       icon:â€œchartâ€},
];

const formatData = d => d ? new Date(d+â€œT00:00:00â€).toLocaleDateString(â€œit-ITâ€,{weekday:â€œlongâ€,day:â€œnumericâ€,month:â€œlongâ€,year:â€œnumericâ€}) : â€œâ€”â€;
const formatDataS = d => d ? new Date(d+â€œT00:00:00â€).toLocaleDateString(â€œit-ITâ€) : â€œâ€”â€;

return (
<div style={{display:â€œflexâ€,flexDirection:â€œcolumnâ€,height:â€œ100%â€,overflow:â€œhiddenâ€}}>

```
  {/* â”€â”€ HEADER â”€â”€ */}
  <div style={{background:C.surface,borderBottom:`1px solid ${C.border}`,padding:"16px 24px 0",flexShrink:0}}>
    <div style={{display:"flex",alignItems:"flex-start",gap:12,marginBottom:12,flexWrap:"wrap"}}>
      <button onClick={onBack} style={{background:"none",border:`1px solid ${C.border}`,borderRadius:8,
        padding:"6px 10px",cursor:"pointer",display:"flex",color:C.textMuted,flexShrink:0}}>
        <Ic n="left" size={14} stroke={C.textMuted}/>
      </button>
      <div style={{flex:1,minWidth:0}}>
        <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:4}}>
          <span style={{padding:"3px 10px",borderRadius:12,background:`${tp.hex}15`,color:tp.hex,
            fontSize:10,fontWeight:700,border:`1px solid ${tp.hex}30`,display:"flex",alignItems:"center",gap:4}}>
            <Ic n={tp.icon} size={9} stroke={tp.hex}/>{tp.label}
          </span>
          <span style={{padding:"3px 10px",borderRadius:12,background:sc.bg,color:sc.fg,
            fontSize:10,fontWeight:700,border:`1px solid ${sc.bd}`}}>{evento.stato}</span>
          {evento.biglietto && (
            <span style={{padding:"3px 10px",borderRadius:12,background:C.goldBg,color:C.gold,
              fontSize:10,fontWeight:700,border:`1px solid ${C.goldDim}`}}>â‚¬ {evento.prezzoBiglietto} / biglietto</span>
          )}
        </div>
        <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:"clamp(18px,3vw,26px)",fontWeight:600,lineHeight:1.2}}>
          {evento.titolo}
        </h2>
        <div style={{fontSize:12,color:C.textMuted,marginTop:4,display:"flex",gap:12,flexWrap:"wrap"}}>
          {evento.data  && <span style={{display:"flex",alignItems:"center",gap:4}}><Ic n="calendar" size={11} stroke={C.textDim}/>{formatData(evento.data)}{evento.ora&&` Â· ${evento.ora}`}</span>}
          {evento.luogo && <span style={{display:"flex",alignItems:"center",gap:4}}><Ic n="map" size={11} stroke={C.textDim}/>{evento.luogo}</span>}
        </div>
      </div>
      <div style={{display:"flex",gap:8,flexShrink:0}}>
        <Btn variant="secondary" onClick={onEdit}><Ic n="edit" size={13} stroke={C.textMuted}/>Modifica</Btn>
        <button onClick={onDelete} style={{background:C.redBg,border:`1px solid ${C.redBorder}`,borderRadius:8,
          padding:"7px 10px",cursor:"pointer",display:"flex",alignItems:"center"}}>
          <Ic n="trash" size={13} stroke={C.red}/>
        </button>
      </div>
    </div>
    {/* Tab bar */}
    <div style={{display:"flex",gap:0,overflowX:"auto"}}>
      {TABS.map(t=>(
        <button key={t.id} onClick={()=>setTab(t.id)}
          style={{padding:"10px 16px",border:"none",background:"none",whiteSpace:"nowrap",
            borderBottom:`2px solid ${tab===t.id?C.gold:"transparent"}`,
            color:tab===t.id?C.gold:C.textMuted,cursor:"pointer",
            fontSize:13,fontFamily:"'DM Sans',sans-serif",
            display:"flex",alignItems:"center",gap:6,transition:"all 0.15s"}}>
          <Ic n={t.icon} size={12} stroke={tab===t.id?C.gold:C.textMuted}/>{t.label}
        </button>
      ))}
    </div>
  </div>

  {/* â”€â”€ CONTENT â”€â”€ */}
  <div style={{flex:1,overflow:"auto",padding:"24px"}}>

    {/* INFO */}
    {tab==="info" && (
      <div style={{maxWidth:760,display:"flex",flexDirection:"column",gap:18}}>
        {/* KPI row */}
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:12}}>
          {[
            {l:"Partecipanti",val:evento.partecipanti.length, hex:C.gold},
            {l:"Capienza",    val:evento.capienza,            hex:C.blue},
            {l:"Prenotazioni",val:prenConf.length,            hex:C.teal},
            {l:"Posti liberi",val:Math.max(0,evento.capienza-postiOcc),hex:postiOcc>=evento.capienza?C.red:C.green},
          ].map(k=>(
            <div key={k.l} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"12px 14px"}}>
              <div style={{fontSize:10,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em"}}>{k.l}</div>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600,color:k.hex,marginTop:2}}>{k.val}</div>
            </div>
          ))}
        </div>

        {/* Biglietteria summary */}
        {evento.biglietto && (
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:12}}>
            {[
              {l:"Prezzo",           val:`â‚¬ ${evento.prezzoBiglietto}`,  hex:C.gold},
              {l:"Incasso previsto", val:fmt(incassoAtteso),             hex:C.blue},
              {l:"Riscosso",         val:fmt(incassoRisc),               hex:C.green},
              {l:"Da riscuotere",    val:fmt(incassoAtteso-incassoRisc), hex:C.red},
            ].map(k=>(
              <div key={k.l} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"12px 14px"}}>
                <div style={{fontSize:10,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em"}}>{k.l}</div>
                <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:k.hex,marginTop:2}}>{k.val}</div>
              </div>
            ))}
          </div>
        )}

        {/* Occupazione */}
        <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"16px 18px"}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:10}}>
            <span style={{fontSize:12,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em"}}>Occupazione posti</span>
            <span style={{fontSize:13,fontWeight:600,color:postiOcc>=evento.capienza?C.red:C.green}}>
              {postiOcc} / {evento.capienza} ({Math.round(postiOcc/evento.capienza*100)||0}%)
            </span>
          </div>
          <div style={{height:8,background:C.border,borderRadius:4,overflow:"hidden"}}>
            <div style={{height:"100%",borderRadius:4,transition:"width 0.5s",
              background:postiOcc>=evento.capienza?C.red:postiOcc/evento.capienza>0.8?C.gold:C.green,
              width:`${Math.min(100,(postiOcc/Math.max(1,evento.capienza)*100))}%`}}/>
          </div>
          <div style={{fontSize:11,color:C.textDim,marginTop:6}}>
            {Math.max(0,evento.capienza-postiOcc)} posti ancora disponibili
          </div>
        </div>

        {evento.descrizione && (
          <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"16px 18px"}}>
            <div style={{fontSize:10,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:8}}>Descrizione</div>
            <p style={{fontSize:13,color:C.text,lineHeight:1.65}}>{evento.descrizione}</p>
          </div>
        )}
        {evento.note && (
          <div style={{background:`${C.gold}08`,border:`1px solid ${C.goldDim}`,borderRadius:10,padding:"14px 16px"}}>
            <div style={{fontSize:10,color:C.gold,textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:6}}>Note</div>
            <p style={{fontSize:13,color:C.text}}>{evento.note}</p>
          </div>
        )}
      </div>
    )}

    {/* PARTECIPANTI */}
    {tab==="partec" && (
      <div style={{maxWidth:680}}>
        {evento.partecipanti.length===0 ? (
          <div style={{textAlign:"center",padding:"56px 0",color:C.textDim}}>
            <Ic n="users" size={36} stroke={C.textDim}/>
            <p style={{marginTop:12,fontSize:13}}>Nessun partecipante</p>
            <p style={{fontSize:11,marginTop:4}}>Modifica l'evento per aggiungere allievi</p>
          </div>
        ) : (
          <div style={{display:"flex",flexDirection:"column",gap:10}}>
            {evento.partecipanti.map((p,i)=>(
              <div key={p.studentId} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
                <div style={{padding:"12px 16px",display:"flex",alignItems:"center",gap:12}}>
                  <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600,
                    color:C.textDim,width:28,textAlign:"right",flexShrink:0}}>{i+1}</span>
                  <div style={{width:36,height:36,borderRadius:"50%",background:`${C.gold}20`,
                    border:`1px solid ${C.goldDim}`,display:"flex",alignItems:"center",
                    justifyContent:"center",fontSize:12,fontWeight:600,color:C.gold,flexShrink:0}}>
                    {initials(p.studentName)}
                  </div>
                  <div style={{flex:1}}>
                    <div style={{fontSize:14,fontWeight:500}}>{p.studentName}</div>
                    <div style={{fontSize:11,color:C.textDim,marginTop:1}}>
                      {p.brani.length} bran{p.brani.length!==1?"i":"o"} in programma
                    </div>
                  </div>
                </div>
                {p.brani.length>0 && (
                  <div style={{padding:"8px 16px 12px 76px",borderTop:`1px solid ${C.border}20`}}>
                    {p.brani.map((b,j)=>(
                      <div key={j} style={{display:"flex",alignItems:"center",gap:8,marginBottom:4}}>
                        <Ic n="music" size={11} stroke={C.gold}/>
                        <span style={{fontSize:12}}>{b}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    )}

    {/* BIGLIETTERIA */}
    {tab==="biglietti" && (
      <div style={{display:"flex",flexDirection:"column",gap:16}}>
        {/* Stats */}
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:12}}>
          {[
            {l:"Prenotazioni", val:prenConf.length,                    hex:C.blue},
            {l:"Posti venduti",val:postiOcc,                           hex:C.teal},
            {l:"Riscosso",     val:fmt(incassoRisc),                   hex:C.green},
            {l:"Da riscuotere",val:fmt(incassoAtteso-incassoRisc),    hex:incassoAtteso-incassoRisc>0?C.red:C.textDim},
          ].map(k=>(
            <div key={k.l} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"12px 14px"}}>
              <div style={{fontSize:10,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em"}}>{k.l}</div>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:k.hex,marginTop:2}}>{k.val}</div>
            </div>
          ))}
        </div>

        {/* Tabella prenotazioni */}
        <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
          <div style={{padding:"13px 18px",borderBottom:`1px solid ${C.border}`,
            display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div style={{display:"flex",alignItems:"center",gap:8}}>
              <Ic n="receipt" size={13} stroke={C.gold}/>
              <span style={{fontSize:12,fontWeight:500,textTransform:"uppercase",letterSpacing:"0.06em",color:C.textMuted}}>
                Prenotazioni ({evento.prenotazioni.length})
              </span>
            </div>
            <Btn small onClick={()=>setModalP("add")}><Ic n="plus" size={12} stroke={C.bg}/>Nuova</Btn>
          </div>
          {evento.prenotazioni.length===0 ? (
            <div style={{padding:"40px 0",textAlign:"center",color:C.textDim,fontSize:13}}>
              Nessuna prenotazione ancora
            </div>
          ) : (
            <div style={{overflowX:"auto",WebkitOverflowScrolling:"touch"}}>
              {/* Header */}
              <div style={{display:"grid",gridTemplateColumns:"1.6fr 1fr 55px 90px 85px 70px",minWidth:520,
                padding:"8px 16px",borderBottom:`1px solid ${C.border}`,background:C.bg}}>
                {["Nome","Contatto","Posti","Importo","Stato",""].map(h=>(
                  <div key={h} style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>{h}</div>
                ))}
              </div>
              {evento.prenotazioni.map((pren,i)=>{
                const imp = pren.posti*(evento.prezzoBiglietto||0);
                const pc  = {confermata:{fg:C.green,bg:C.greenBg},annullata:{fg:C.red,bg:C.redBg},"in attesa":{fg:C.gold,bg:C.goldBg}}[pren.stato]||{fg:C.textMuted,bg:C.surface};
                return (
                  <div key={pren.id} style={{display:"grid",gridTemplateColumns:"1.6fr 1fr 55px 90px 85px 70px",minWidth:520,
                    padding:"11px 16px",borderBottom:i<evento.prenotazioni.length-1?`1px solid ${C.border}20`:"none",alignItems:"center"}}
                    onMouseEnter={e=>e.currentTarget.style.background=C.surfaceHover}
                    onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                    <div>
                      <div style={{fontSize:13,fontWeight:500}}>{pren.nome}</div>
                      <div style={{fontSize:10,color:C.textDim,marginTop:1}}>{formatDataS(pren.dataPren)}</div>
                    </div>
                    <div style={{fontSize:11,color:C.textMuted}}>
                      <div style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{pren.email}</div>
                      <div>{pren.telefono}</div>
                    </div>
                    <div style={{fontSize:13,fontWeight:600}}>{pren.posti}</div>
                    <div>
                      <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,
                        color:pren.pagato?C.green:C.red}}>{fmt(imp)}</div>
                      <div style={{fontSize:10,color:pren.pagato?C.green:C.red}}>
                        {pren.pagato?"âœ“ pagato":"da pagare"}
                      </div>
                    </div>
                    <div>
                      <span style={{padding:"3px 8px",borderRadius:8,fontSize:10,fontWeight:600,
                        background:pc.bg,color:pc.fg}}>{pren.stato}</span>
                    </div>
                    <div style={{display:"flex",gap:4,justifyContent:"flex-end"}}>
                      <button onClick={()=>setModalP(pren)} style={{background:"none",border:"none",cursor:"pointer",display:"flex",padding:4,color:C.textDim,borderRadius:5}}
                        onMouseEnter={e=>e.currentTarget.style.color=C.gold} onMouseLeave={e=>e.currentTarget.style.color=C.textDim}>
                        <Ic n="edit" size={13} stroke="currentColor"/>
                      </button>
                      <button onClick={()=>{if(window.confirm(`Eliminare la prenotazione di ${pren.nome}?`))delPren(pren.id);}}
                        style={{background:"none",border:"none",cursor:"pointer",display:"flex",padding:4,color:C.textDim,borderRadius:5}}
                        onMouseEnter={e=>e.currentTarget.style.color=C.red} onMouseLeave={e=>e.currentTarget.style.color=C.textDim}>
                        <Ic n="trash" size={13} stroke="currentColor"/>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    )}

    {/* REPORT */}
    {tab==="report" && (
      <div style={{maxWidth:700}}>
        <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
          {/* Report header con colore tipo */}
          <div style={{background:`linear-gradient(135deg,${tp.hex}18,${tp.hex}05)`,
            borderBottom:`1px solid ${tp.hex}30`,padding:"20px 24px",
            display:"flex",alignItems:"center",gap:14}}>
            <div style={{width:48,height:48,borderRadius:12,background:`${tp.hex}20`,border:`1px solid ${tp.hex}40`,
              display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
              <Ic n={tp.icon} size={22} stroke={tp.hex}/>
            </div>
            <div>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600}}>{evento.titolo}</div>
              <div style={{fontSize:12,color:C.textMuted,marginTop:2}}>
                {tp.label} Â· {formatData(evento.data)}{evento.ora&&` Â· ${evento.ora}`}
              </div>
            </div>
          </div>

          <div style={{padding:"20px 24px",display:"flex",flexDirection:"column",gap:20}}>
            {/* Dettagli */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
              {[
                {l:"Luogo",  v:evento.luogo||"â€”"},
                {l:"Stato",  v:evento.stato},
                {l:"Tipo",   v:tp.label},
                {l:"Capienza",v:`${evento.capienza} posti`},
              ].map(x=>(
                <div key={x.l} style={{padding:"10px 0",borderBottom:`1px solid ${C.border}20`}}>
                  <div style={{fontSize:10,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em",marginBottom:2}}>{x.l}</div>
                  <div style={{fontSize:13,fontWeight:500}}>{x.v}</div>
                </div>
              ))}
            </div>

            {/* Programma */}
            {evento.partecipanti.length>0 && (
              <div>
                <div style={{fontSize:11,fontWeight:600,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em",marginBottom:12}}>
                  Programma partecipanti
                </div>
                {evento.partecipanti.map((p,i)=>(
                  <div key={p.studentId} style={{display:"flex",gap:10,marginBottom:10,paddingBottom:10,
                    borderBottom:i<evento.partecipanti.length-1?`1px solid ${C.border}20`:"none"}}>
                    <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:16,color:C.textDim,
                      width:24,flexShrink:0,textAlign:"right"}}>{i+1}.</span>
                    <div>
                      <div style={{fontSize:13,fontWeight:500,marginBottom:3}}>{p.studentName}</div>
                      {p.brani.length>0 && p.brani.map((b,j)=>(
                        <div key={j} style={{display:"flex",alignItems:"center",gap:5,marginBottom:2}}>
                          <Ic n="music" size={10} stroke={C.gold}/>
                          <span style={{fontSize:12,color:C.textMuted,fontStyle:"italic"}}>{b}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Riepilogo biglietteria */}
            {evento.biglietto && (
              <div style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:10,padding:"16px 18px"}}>
                <div style={{fontSize:11,fontWeight:600,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em",marginBottom:12}}>
                  Riepilogo biglietteria
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                  {[
                    {l:"Prezzo biglietto",  v:`â‚¬ ${evento.prezzoBiglietto}`},
                    {l:"Posti occupati",    v:`${postiOcc} / ${evento.capienza}`},
                    {l:"Prenotazioni conf.",v:prenConf.length},
                    {l:"Annullate",         v:evento.prenotazioni.filter(p=>p.stato==="annullata").length},
                    {l:"Incasso previsto",  v:fmt(incassoAtteso)},
                    {l:"Incasso riscosso",  v:fmt(incassoRisc)},
                    {l:"Da riscuotere",     v:fmt(incassoAtteso-incassoRisc)},
                  ].map(x=>(
                    <div key={x.l} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",
                      borderBottom:`1px solid ${C.border}20`}}>
                      <span style={{fontSize:12,color:C.textDim}}>{x.l}</span>
                      <span style={{fontSize:12,fontWeight:600}}>{x.v}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Note */}
            {evento.note && (
              <div style={{background:`${C.gold}08`,border:`1px solid ${C.goldDim}`,borderRadius:10,padding:"14px 16px"}}>
                <div style={{fontSize:10,color:C.gold,textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:6}}>Note post-evento</div>
                <p style={{fontSize:13,color:C.text,lineHeight:1.65}}>{evento.note}</p>
              </div>
            )}
          </div>
        </div>
      </div>
    )}
  </div>

  {/* Modal prenotazione */}
  {modalP && (
    <Modal title={modalP==="add"?"Nuova prenotazione":"Modifica prenotazione"} onClose={()=>setModalP(null)} wide>
      <PrenotazioneForm evento={evento} initial={modalP!=="add"?modalP:null} onSave={savePren} onClose={()=>setModalP(null)}/>
    </Modal>
  )}
</div>
```

);
};

// â”€â”€â”€ CONCERTI VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ConcertiView = ({ students:propStudents }) => {
const isMobile = useIsMobile();
const students  = propStudents || INIT_STUDENTS;
const [concerti, setConcerti] = useState(INIT_CONCERTI);
const [selected, setSelected] = useState(null);
const [modal,    setModal]    = useState(null);
const [fTipo,    setFTipo]    = useState(â€â€);
const [fStato,   setFStato]   = useState(â€â€);
const [search,   setSearch]   = useState(â€â€);

const filtered = concerti.filter(e=>{
const q = search.toLowerCase();
return (!q || e.titolo.toLowerCase().includes(q)||e.luogo.toLowerCase().includes(q))
&& (!fTipo  || e.tipo===fTipo)
&& (!fStato || e.stato===fStato);
}).sort((a,b)=>b.data.localeCompare(a.data));

const handleSave   = ev => { setConcerti(p=>[â€¦p.filter(x=>x.id!==ev.id),ev]); setModal(null); if(selected?.id===ev.id) setSelected(ev); };
const handleDelete = () => { setConcerti(p=>p.filter(x=>x.id!==selected?.id)); setSelected(null); setModal(null); };
const handleUpdate = ev => { setConcerti(p=>p.map(x=>x.id===ev.id?ev:x)); setSelected(ev); };

if(selected) return (
<>
<EventoDetail evento={selected} students={students}
onEdit={()=>setModal(â€œeditâ€)}
onDelete={()=>setModal(â€œdelâ€)}
onBack={()=>setSelected(null)}
onUpdate={handleUpdate}/>
{modal===â€œeditâ€ && (
<Modal title=â€œModifica eventoâ€ onClose={()=>setModal(null)} wide>
<EventoForm initial={selected} students={students} onSave={handleSave} onClose={()=>setModal(null)}/>
</Modal>
)}
{modal===â€œdelâ€ && selected && (
<ConfirmDelete label={selected.titolo} description=â€œTutte le prenotazioni associate verranno eliminate.â€
onConfirm={handleDelete} onClose={()=>setModal(null)}/>
)}
</>
);

const prossimi   = concerti.filter(e=>e.stato===â€œprogrammatoâ€).length;
const completati = concerti.filter(e=>e.stato===â€œcompletatoâ€).length;

return (
<div style={{padding:isMobile?â€œ12pxâ€:â€œclamp(16px,3vw,28px)â€,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:20}}>

```
  {/* Header */}
  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:12}}>
    <div>
      <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:"clamp(22px,4vw,32px)",fontWeight:600}}>Concerti & Eventi</h1>
      <p style={{color:C.textMuted,fontSize:14,marginTop:4}}>
        {prossimi} programmati Â· {completati} completati Â· {concerti.length} totali
      </p>
    </div>
    <Btn onClick={()=>setModal("new")}><Ic n="plus" size={14} stroke={C.bg}/>Nuovo evento</Btn>
  </div>

  {/* KPI strip */}
  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:12}}>
    {[
      {l:"Prossimi",    v:prossimi,    hex:C.blue,   icon:"calendar"},
      {l:"Completati",  v:completati,  hex:C.green,  icon:"check"},
      {l:"Con biglietto",v:concerti.filter(e=>e.biglietto).length, hex:C.gold, icon:"ticket"},
      {l:"Gratuiti",    v:concerti.filter(e=>!e.biglietto).length, hex:C.teal, icon:"users"},
      {l:"Annullati",   v:concerti.filter(e=>e.stato==="annullato").length, hex:C.red, icon:"x"},
    ].map(k=>(
      <div key={k.l} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"13px 16px",
        display:"flex",alignItems:"center",gap:12}}>
        <div style={{width:36,height:36,borderRadius:9,background:`${k.hex}15`,
          display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
          <Ic n={k.icon} size={16} stroke={k.hex}/>
        </div>
        <div>
          <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:600,color:k.hex,lineHeight:1}}>{k.v}</div>
          <div style={{fontSize:10,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.06em",marginTop:1}}>{k.l}</div>
        </div>
      </div>
    ))}
  </div>

  {/* Filtri */}
  <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
    <div style={{position:"relative",flex:"1 1 180px"}}>
      <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)"}}><Ic n="search" size={13} stroke={C.textDim}/></span>
      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cerca eventiâ€¦"
        style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
          color:C.text,fontSize:13,padding:"8px 12px 8px 32px",fontFamily:"'DM Sans',sans-serif",boxSizing:"border-box"}}/>
    </div>
    <select value={fTipo} onChange={e=>setFTipo(e.target.value)}
      style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,color:C.text,
        fontSize:12,padding:"8px 12px",fontFamily:"'DM Sans',sans-serif",cursor:"pointer"}}>
      <option value="">Tutti i tipi</option>
      {TIPI_EVENTO.map(t=><option key={t.id} value={t.id}>{t.label}</option>)}
    </select>
    <select value={fStato} onChange={e=>setFStato(e.target.value)}
      style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,color:C.text,
        fontSize:12,padding:"8px 12px",fontFamily:"'DM Sans',sans-serif",cursor:"pointer"}}>
      <option value="">Tutti gli stati</option>
      {STATI_EVENTO.map(s=><option key={s} value={s}>{s}</option>)}
    </select>
    {(fTipo||fStato||search) && (
      <button onClick={()=>{setFTipo("");setFStato("");setSearch("");}}
        style={{background:"none",border:"none",cursor:"pointer",color:C.textDim,fontSize:12,fontFamily:"'DM Sans',sans-serif"}}>
        Reset
      </button>
    )}
  </div>

  {/* Card grid */}
  {filtered.length===0 ? (
    <div style={{textAlign:"center",padding:"64px 0",color:C.textDim}}>
      <Ic n="flag" size={40} stroke={C.textDim}/>
      <p style={{marginTop:14,fontSize:14}}>Nessun evento trovato</p>
      <p style={{fontSize:12,marginTop:4}}>Crea il primo con il pulsante in alto</p>
    </div>
  ) : (
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(300px,1fr))",gap:16}}>
      {filtered.map(ev=>{
        const tp  = tipoEv(ev.tipo);
        const sc  = statoEvColor(ev.stato);
        const pConf = ev.prenotazioni.filter(p=>p.stato==="confermata");
        const pOcc  = pConf.reduce((t,p)=>t+p.posti,0);
        const pct   = ev.capienza>0?Math.min(100,pOcc/ev.capienza*100):0;
        return (
          <div key={ev.id} onClick={()=>setSelected(ev)}
            style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden",
              cursor:"pointer",transition:"all 0.18s",display:"flex",flexDirection:"column"}}
            onMouseEnter={e=>{e.currentTarget.style.transform="translateY(-2px)";e.currentTarget.style.boxShadow="0 8px 28px rgba(0,0,0,0.28)";}}
            onMouseLeave={e=>{e.currentTarget.style.transform="";e.currentTarget.style.boxShadow="";}}>
            {/* Accent bar */}
            <div style={{height:4,background:`linear-gradient(90deg,${tp.hex},${tp.hex}50)`,flexShrink:0}}/>
            <div style={{padding:"15px 18px",flex:1}}>
              <div style={{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap"}}>
                <span style={{padding:"3px 10px",borderRadius:10,background:`${tp.hex}15`,color:tp.hex,
                  fontSize:10,fontWeight:700,display:"flex",alignItems:"center",gap:4}}>
                  <Ic n={tp.icon} size={9} stroke={tp.hex}/>{tp.label}
                </span>
                <span style={{padding:"3px 10px",borderRadius:10,background:sc.bg,color:sc.fg,fontSize:10,fontWeight:700}}>
                  {ev.stato}
                </span>
                {ev.biglietto && (
                  <span style={{padding:"3px 10px",borderRadius:10,background:C.goldBg,color:C.gold,fontSize:10,fontWeight:700}}>
                    â‚¬ {ev.prezzoBiglietto}
                  </span>
                )}
              </div>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:600,lineHeight:1.3,marginBottom:8}}>
                {ev.titolo}
              </div>
              <div style={{display:"flex",flexDirection:"column",gap:3,fontSize:12,color:C.textMuted}}>
                {ev.data && (
                  <span style={{display:"flex",alignItems:"center",gap:5}}>
                    <Ic n="calendar" size={11} stroke={C.textDim}/>
                    {new Date(ev.data+"T00:00:00").toLocaleDateString("it-IT",{day:"numeric",month:"long",year:"numeric"})}
                    {ev.ora&&` Â· ${ev.ora}`}
                  </span>
                )}
                {ev.luogo && (
                  <span style={{display:"flex",alignItems:"center",gap:5}}>
                    <Ic n="map" size={11} stroke={C.textDim}/>{ev.luogo}
                  </span>
                )}
              </div>
            </div>
            {/* Card footer */}
            <div style={{padding:"10px 18px",borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
              <div style={{display:"flex",gap:10,fontSize:11,color:C.textDim}}>
                <span style={{display:"flex",alignItems:"center",gap:4}}>
                  <Ic n="users" size={10} stroke={C.textDim}/>{ev.partecipanti.length} allievi
                </span>
                {ev.biglietto && (
                  <span style={{display:"flex",alignItems:"center",gap:4}}>
                    <Ic n="receipt" size={10} stroke={C.textDim}/>{pConf.length} prenotazioni
                  </span>
                )}
              </div>
              {ev.biglietto && ev.capienza>0 && (
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <div style={{width:56,height:4,background:C.border,borderRadius:2,overflow:"hidden"}}>
                    <div style={{height:"100%",borderRadius:2,
                      background:pct>=90?C.red:pct>=70?C.gold:C.green,
                      width:`${pct}%`,transition:"width 0.4s"}}/>
                  </div>
                  <span style={{fontSize:10,color:C.textDim}}>{pOcc}/{ev.capienza}</span>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  )}

  {/* Modal nuovo evento */}
  {modal==="new" && (
    <Modal title="Nuovo evento" onClose={()=>setModal(null)} wide>
      <EventoForm students={students} onSave={handleSave} onClose={()=>setModal(null)}/>
    </Modal>
  )}
</div>
```

);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// GESTIONE UTENTI

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ COSTANTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OGGI = new Date();
const fmt_data = d => new Date(d+â€œT00:00:00â€).toLocaleDateString(â€œit-ITâ€,{day:â€œ2-digitâ€,month:â€œshortâ€,year:â€œnumericâ€});
const fmt_ts   = d => new Date(d).toLocaleDateString(â€œit-ITâ€,{day:â€œ2-digitâ€,month:â€œshortâ€,hour:â€œ2-digitâ€,minute:â€œ2-digitâ€});

const RUOLI = [
{id:â€œadminâ€,      label:â€œAmministratoreâ€, hex:C.gold,   bg:C.goldBg,    bd:C.goldDim,      desc:â€œAccesso completo al sistema e alle impostazioniâ€},
{id:â€œdirettoreâ€,  label:â€œDirettoreâ€,      hex:C.purple, bg:C.purpleBg,  bd:C.purpleBorder, desc:â€œDashboard completa, report, nessuna impostazione adminâ€},
{id:â€œsegreteriaâ€, label:â€œSegreteriaâ€,     hex:C.blue,   bg:C.blueBg,    bd:C.blueBorder,   desc:â€œAllievi, pagamenti, calendarioâ€},
{id:â€œdocenteâ€,    label:â€œDocenteâ€,        hex:C.teal,   bg:C.tealBg,    bd:C.tealBorder,   desc:â€œSolo le proprie lezioni e il repertorioâ€},
];
const ruoloById = id => RUOLI.find(r=>r.id===id)||RUOLI[3];

const MODULI = [
{id:â€œdashboardâ€,   label:â€œDashboardâ€,      icon:â€œgridâ€},
{id:â€œallieviâ€,     label:â€œAllieviâ€,         icon:â€œusersâ€},
{id:â€œcalendarioâ€,  label:â€œCalendarioâ€,      icon:â€œcalendarâ€},
{id:â€œcontabilitaâ€, label:â€œContabilitÃ â€,     icon:â€œeuroâ€},
{id:â€œrepertorioâ€,  label:â€œRepertorioâ€,      icon:â€œmusicâ€},
{id:â€œreportâ€,      label:â€œReportâ€,          icon:â€œchartâ€},
{id:â€œimpostazioniâ€,label:â€œImpostazioniâ€,    icon:â€œsettingsâ€},
{id:â€œutentiâ€,      label:â€œGestione utentiâ€, icon:â€œshieldâ€},
];

// Permessi default per ruolo
const PERM_DEFAULT = {
admin:      {dashboard:true, allievi:true, calendario:true, contabilita:true, repertorio:true, report:true, impostazioni:true, utenti:true},
direttore:  {dashboard:true, allievi:true, calendario:true, contabilita:true, repertorio:true, report:true, impostazioni:false, utenti:false},
segreteria: {dashboard:true, allievi:true, calendario:true, contabilita:true, repertorio:false,report:false,impostazioni:false, utenti:false},
docente:    {dashboard:true, allievi:false,calendario:true, contabilita:false,repertorio:true, report:false,impostazioni:false, utenti:false},
};

const STATI = [
{id:â€œattivoâ€,   label:â€œAttivoâ€,           hex:C.green,  bg:C.greenBg,  bd:C.greenBorder},
{id:â€œattesaâ€,   label:â€œIn attesaâ€,         hex:C.orange, bg:C.orangeBg, bd:C.orangeBorder},
{id:â€œsospesoâ€,  label:â€œSospesoâ€,           hex:C.red,    bg:C.redBg,    bd:C.redBorder},
{id:â€œinvitatoâ€, label:â€œInvito inviatoâ€,    hex:C.blue,   bg:C.blueBg,   bd:C.blueBorder},
];
const statoById = id => STATI.find(s=>s.id===id)||STATI[0];

// â”€â”€â”€ DATI DEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INIT_UTENTI = [
{id:â€œu1â€, nome:â€œMarco Bianchiâ€,    email:â€œm.bianchi@accademia.itâ€,  ruolo:â€œadminâ€,      stato:â€œattivoâ€,   avatar:â€œMBâ€, iscritto:â€œ2023-09-01â€, ultimoAccesso:â€œ2025-05-23T09:14:00â€, permessi:{â€¦PERM_DEFAULT.admin},     note:â€œFondatore e direttore artisticoâ€},
{id:â€œu2â€, nome:â€œLaura Espositoâ€,   email:â€œl.esposito@accademia.itâ€, ruolo:â€œsegreteriaâ€, stato:â€œattivoâ€,   avatar:â€œLEâ€, iscritto:â€œ2023-09-15â€, ultimoAccesso:â€œ2025-05-23T08:40:00â€, permessi:{â€¦PERM_DEFAULT.segreteria},note:â€â€},
{id:â€œu3â€, nome:â€œProf. Rossiâ€,      email:â€œrossi@accademia.itâ€,      ruolo:â€œdocenteâ€,    stato:â€œattivoâ€,   avatar:â€œPRâ€, iscritto:â€œ2023-10-01â€, ultimoAccesso:â€œ2025-05-22T18:05:00â€, permessi:{â€¦PERM_DEFAULT.docente,allievi:true},note:â€œAccesso allievi esteso per coordinamentoâ€},
{id:â€œu4â€, nome:â€œProf. Bianchiâ€,    email:â€œfbianchi@accademia.itâ€,   ruolo:â€œdocenteâ€,    stato:â€œattivoâ€,   avatar:â€œPBâ€, iscritto:â€œ2023-10-01â€, ultimoAccesso:â€œ2025-05-20T16:30:00â€, permessi:{â€¦PERM_DEFAULT.docente},   note:â€â€},
{id:â€œu5â€, nome:â€œProf. Verdeâ€,      email:â€œverde@accademia.itâ€,      ruolo:â€œdocenteâ€,    stato:â€œattivoâ€,   avatar:â€œPVâ€, iscritto:â€œ2024-01-10â€, ultimoAccesso:â€œ2025-05-21T14:00:00â€, permessi:{â€¦PERM_DEFAULT.docente},   note:â€â€},
{id:â€œu6â€, nome:â€œGiulia Morettiâ€,   email:â€œg.moretti@gmail.comâ€,     ruolo:â€œdirettoreâ€,  stato:â€œattivoâ€,   avatar:â€œGMâ€, iscritto:â€œ2024-03-01â€, ultimoAccesso:â€œ2025-05-19T10:22:00â€, permessi:{â€¦PERM_DEFAULT.direttore}, note:â€œDirettore amministrativoâ€},
{id:â€œu7â€, nome:â€œAntonio Ferraraâ€,  email:â€œa.ferrara@gmail.comâ€,     ruolo:â€œdocenteâ€,    stato:â€œsospesoâ€,  avatar:â€œAFâ€, iscritto:â€œ2024-06-01â€, ultimoAccesso:â€œ2025-03-10T09:00:00â€, permessi:{â€¦PERM_DEFAULT.docente},   note:â€œSospeso â€” contratto scadutoâ€},
];

const INIT_RICHIESTE = [
{id:â€œr1â€, nome:â€œChiara Lombardiâ€,  email:â€œc.lombardi@gmail.comâ€,    ruolo:â€œdocenteâ€,    data:â€œ2025-05-22â€, messaggio:â€œDocente di violoncello, vorrei accedere al calendario e al repertorio.â€},
{id:â€œr2â€, nome:â€œRoberto Neriâ€,     email:â€œr.neri@outlook.comâ€,      ruolo:â€œsegreteriaâ€, data:â€œ2025-05-20â€, messaggio:â€œCollaboro in segreteria, ho bisogno di accedere alla gestione allievi e pagamenti.â€},
{id:â€œr3â€, nome:â€œSofia Belliâ€,      email:â€œs.belli@accademia.itâ€,    ruolo:â€œdocenteâ€,    data:â€œ2025-05-18â€, messaggio:â€œNuova insegnante di canto assunta dal 1Â° giugno.â€},
];

// â”€â”€â”€ DRAWER DETTAGLIO UTENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UtenteDrawer = ({utente,onClose,onSave,onSospendi,onElimina,isCurrentAdmin})=>{
const [draft,setDraft]=useState({â€¦utente});
const [tab,setTab]=useState(â€œprofiloâ€);
const r=ruoloById(draft.ruolo);
const isSelf=isCurrentAdmin&&utente.id===â€œu1â€;// non puÃ² modificare se stesso

const setD=(k,v)=>setDraft(p=>({â€¦p,[k]:v}));
const setPerm=(k,v)=>setDraft(p=>({â€¦p,permessi:{â€¦p.permessi,[k]:v}}));

const handleRuolo=(rid)=>{
setDraft(p=>({â€¦p,ruolo:rid,permessi:{â€¦PERM_DEFAULT[rid]}}));
};

return(
<>
<div onClick={onClose} style={{position:â€œfixedâ€,inset:0,zIndex:300,
background:â€œrgba(0,0,0,.7)â€,backdropFilter:â€œblur(3px)â€,animation:â€œfadeIn .2s easeâ€}}/>
<div style={{position:â€œfixedâ€,top:0,right:0,bottom:0,zIndex:301,width:500,
background:C.surface,borderLeft:`1px solid ${C.border}`,
display:â€œflexâ€,flexDirection:â€œcolumnâ€,animation:â€œslideDrawer .26s cubic-bezier(.4,0,.2,1)â€}}>

```
    {/* Header */}
    <div style={{padding:"18px 22px",borderBottom:`1px solid ${C.border}`,
      display:"flex",alignItems:"center",gap:14,flexShrink:0}}>
      <Avatar initials={utente.avatar} hex={r.hex} size={46}/>
      <div style={{flex:1,minWidth:0}}>
        <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,
          overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{utente.nome}</div>
        <div style={{fontSize:12,color:C.textMuted,marginTop:2}}>{utente.email}</div>
      </div>
      <div style={{display:"flex",gap:8,alignItems:"center"}}>
        <Badge stato={utente.stato}/>
        <button onClick={onClose} style={{background:"none",border:"none",cursor:"pointer",
          color:C.textMuted,display:"flex",padding:4}}>
          <Ic n="x" size={17} stroke={C.textMuted}/>
        </button>
      </div>
    </div>

    {/* Tabs */}
    <div style={{display:"flex",borderBottom:`1px solid ${C.border}`,flexShrink:0}}>
      {[["profilo","user","Profilo"],["permessi","shield","Permessi"],["attivita","clock","AttivitÃ "]].map(([v,ic,lb])=>(
        <button key={v} onClick={()=>setTab(v)}
          style={{flex:1,padding:"11px 0",display:"flex",alignItems:"center",justifyContent:"center",
            gap:6,background:"none",border:"none",cursor:"pointer",fontSize:12,
            color:tab===v?C.gold:C.textMuted,fontFamily:"'DM Sans',sans-serif",
            borderBottom:`2px solid ${tab===v?C.gold:"transparent"}`,transition:"all .15s"}}>
          <Ic n={ic} size={13} stroke={tab===v?C.gold:C.textMuted}/>{lb}
        </button>
      ))}
    </div>

    {/* Body */}
    <div style={{flex:1,overflow:"auto",padding:"18px 22px",display:"flex",flexDirection:"column",gap:18}}>

      {/* â”€â”€ PROFILO â”€â”€ */}
      {tab==="profilo"&&(
        <>
          <div style={{display:"flex",flexDirection:"column",gap:12}}>
            <Field label="Nome completo *" value={draft.nome} onChange={e=>setD("nome",e.target.value)}/>
            <Field label="Email *" type="email" value={draft.email} onChange={e=>setD("email",e.target.value)}/>
          </div>

          {/* Ruolo */}
          <div>
            <div style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase",marginBottom:10}}>Ruolo</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}} className="form-2col">
              {RUOLI.map(r=>(
                <button key={r.id} onClick={()=>!isSelf&&handleRuolo(r.id)}
                  style={{padding:"10px 13px",borderRadius:10,textAlign:"left",cursor:isSelf?"default":"pointer",
                    fontFamily:"'DM Sans',sans-serif",transition:"all .15s",
                    background:draft.ruolo===r.id?r.bg:C.bg,
                    border:`1.5px solid ${draft.ruolo===r.id?r.hex:C.border}`,
                    opacity:isSelf&&draft.ruolo!==r.id?.4:1}}>
                  <div style={{fontSize:12,fontWeight:500,color:draft.ruolo===r.id?r.hex:C.text}}>{r.label}</div>
                  <div style={{fontSize:10,color:C.textDim,marginTop:3,lineHeight:1.4}}>{r.desc}</div>
                </button>
              ))}
            </div>
            {isSelf&&<div style={{fontSize:11,color:C.textDim,marginTop:8}}>Non puoi modificare il tuo ruolo.</div>}
          </div>

          {/* Note */}
          <div style={{display:"flex",flexDirection:"column",gap:5}}>
            <label style={{fontSize:11,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase"}}>Note interne</label>
            <textarea value={draft.note} onChange={e=>setD("note",e.target.value)} rows={2}
              placeholder="Note visibili solo agli amministratori..."
              style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:8,
                color:C.text,fontSize:13,padding:"9px 13px",width:"100%",
                fontFamily:"'DM Sans',sans-serif",resize:"vertical"}}/>
          </div>

          {/* Info di sistema */}
          <div style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:10,padding:"12px 16px"}}>
            <div style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:10}}>Informazioni account</div>
            <div style={{display:"flex",flexDirection:"column",gap:7}}>
              {[
                {label:"Iscritto il",    val:fmt_data(utente.iscritto)},
                {label:"Ultimo accesso", val:utente.ultimoAccesso?fmt_ts(utente.ultimoAccesso):"Mai"},
                {label:"Stato account",  val:<Badge stato={utente.stato}/>},
              ].map(row=>(
                <div key={row.label} style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <span style={{fontSize:12,color:C.textDim}}>{row.label}</span>
                  <span style={{fontSize:12,color:C.text}}>{row.val}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Azioni pericolose */}
          {!isSelf&&(
            <div style={{background:C.redBg,border:`1px solid ${C.redBorder}`,borderRadius:10,padding:"14px 16px"}}>
              <div style={{fontSize:11,color:C.red,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:12}}>Zona pericolosa</div>
              <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                <Btn small danger onClick={()=>onSospendi(utente)}>
                  <Ic n={utente.stato==="sospeso"?"unlock":"ban"} size={13} stroke={C.red}/>
                  {utente.stato==="sospeso"?"Riattiva account":"Sospendi account"}
                </Btn>
                <Btn small danger onClick={()=>onElimina(utente)}>
                  <Ic n="trash" size={13} stroke={C.red}/>Elimina utente
                </Btn>
              </div>
            </div>
          )}
        </>
      )}

      {/* â”€â”€ PERMESSI â”€â”€ */}
      {tab==="permessi"&&(
        <>
          <div>
            <div style={{fontSize:13,fontWeight:500,marginBottom:4}}>Permessi moduli</div>
            <div style={{fontSize:12,color:C.textDim,marginBottom:14}}>
              Personalizza l'accesso ai moduli rispetto al ruolo base.
              Il ruolo <span style={{color:r.hex}}>{r.label}</span> ha permessi predefiniti.
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              {MODULI.map(m=>{
                const def=PERM_DEFAULT[draft.ruolo]?.[m.id]||false;
                const val=draft.permessi?.[m.id]??def;
                const personalizzato=val!==def;
                return(
                  <div key={m.id} style={{display:"flex",alignItems:"center",gap:12,padding:"11px 14px",
                    borderRadius:10,border:`1px solid ${val?C.border+"80":C.border+"30"}`,
                    background:val?C.bg:C.surface2,transition:"all .15s"}}>
                    <div style={{width:30,height:30,borderRadius:8,flexShrink:0,
                      background:val?`${r.hex}18`:C.surface,
                      display:"flex",alignItems:"center",justifyContent:"center"}}>
                      <Ic n={m.icon} size={14} stroke={val?r.hex:C.textDim}/>
                    </div>
                    <div style={{flex:1}}>
                      <div style={{fontSize:13,fontWeight:500,color:val?C.text:C.textMuted}}>{m.label}</div>
                      {personalizzato&&(
                        <div style={{fontSize:10,color:val?C.green:C.orange,marginTop:1}}>
                          {val?"Aggiunto rispetto al ruolo base":"Rimosso rispetto al ruolo base"}
                        </div>
                      )}
                    </div>
                    <Toggle value={val} onChange={v=>setPerm(m.id,v)} disabled={isSelf&&m.id==="utenti"}/>
                  </div>
                );
              })}
            </div>
          </div>
          <button onClick={()=>setDraft(p=>({...p,permessi:{...PERM_DEFAULT[p.ruolo]}}))}
            style={{background:"none",border:`1px solid ${C.border}`,borderRadius:8,color:C.textMuted,
              fontSize:12,padding:"8px 14px",cursor:"pointer",fontFamily:"'DM Sans',sans-serif",
              display:"flex",alignItems:"center",gap:6,alignSelf:"flex-start"}}>
            <Ic n="check" size={13} stroke={C.textMuted}/>Ripristina default ruolo
          </button>
        </>
      )}

      {/* â”€â”€ ATTIVITÃ€ â”€â”€ */}
      {tab==="attivita"&&(
        <div style={{display:"flex",flexDirection:"column",gap:10}}>
          <div style={{fontSize:13,fontWeight:500,marginBottom:2}}>Storico accessi</div>
          {[
            {data:"23/05/2025 09:14",evento:"Accesso effettuato",ip:"192.168.1.10",dispositivo:"Chrome / macOS"},
            {data:"22/05/2025 18:05",evento:"Accesso effettuato",ip:"192.168.1.10",dispositivo:"Chrome / macOS"},
            {data:"22/05/2025 14:30",evento:"Modifica permessi utente",ip:"192.168.1.10",dispositivo:"Chrome / macOS"},
            {data:"20/05/2025 09:00",evento:"Accesso effettuato",ip:"10.0.0.5",dispositivo:"Safari / iPhone"},
            {data:"18/05/2025 16:45",evento:"Password modificata",ip:"192.168.1.10",dispositivo:"Chrome / macOS"},
            {data:"15/05/2025 11:22",evento:"Accesso effettuato",ip:"192.168.1.10",dispositivo:"Firefox / Windows"},
          ].map((a,i)=>(
            <div key={i} style={{padding:"11px 14px",background:C.bg,border:`1px solid ${C.border}`,
              borderRadius:9,display:"flex",gap:12,alignItems:"flex-start"}}>
              <div style={{width:7,height:7,borderRadius:"50%",background:C.goldDim,marginTop:5,flexShrink:0}}/>
              <div style={{flex:1}}>
                <div style={{fontSize:12,fontWeight:500}}>{a.evento}</div>
                <div style={{fontSize:11,color:C.textDim,marginTop:2,display:"flex",gap:10,flexWrap:"wrap"}}>
                  <span>{a.data}</span>
                  <span>Â·</span><span>{a.dispositivo}</span>
                  <span>Â·</span><span style={{fontFamily:"monospace",fontSize:10}}>{a.ip}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>

    {/* Footer */}
    <div style={{padding:"14px 22px",borderTop:`1px solid ${C.border}`,
      display:"flex",justifyContent:"flex-end",gap:8,flexShrink:0}}>
      <Btn variant="secondary" onClick={onClose}>Annulla</Btn>
      <Btn onClick={()=>onSave(draft)}>
        <Ic n="check" size={13} stroke={C.bg}/>Salva modifiche
      </Btn>
    </div>
  </div>
</>
```

);
};

// â”€â”€â”€ MODAL INVITA UTENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const InvitaModal=({onInvita,onClose})=>{
const [f,setF]=useState({nome:â€â€,email:â€â€,ruolo:â€œdocenteâ€,messaggio:â€â€});
const [err,setErr]=useState({});
const set=(k,v)=>setF(p=>({â€¦p,[k]:v}));

const validate=()=>{
const e={};
if(!f.nome.trim()) e.nome=â€œNome obbligatorioâ€;
if(!f.email.trim()||!/\S+@\S+.\S+/.test(f.email)) e.email=â€œEmail non validaâ€;
return e;
};
const handleSend=()=>{
const e=validate(); if(Object.keys(e).length){setErr(e);return;}
onInvita(f);
};

return(
<Modal title="Invita nuovo utente" onClose={onClose} wide>
<div style={{padding:â€œ20px 22pxâ€,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:14}}>
<div style={{display:â€œgridâ€,gridTemplateColumns:â€œrepeat(auto-fit,minmax(140px,1fr))â€,gap:12}} className=â€œform-2colâ€>
<Field label=â€œNome completo *â€ value={f.nome} onChange={e=>set(â€œnomeâ€,e.target.value)} error={err.nome} placeholder=â€œEs. Mario Rossiâ€/>
<Field label=â€œEmail *â€ type=â€œemailâ€ value={f.email} onChange={e=>set(â€œemailâ€,e.target.value)} error={err.email} placeholder=â€œmario@esempio.itâ€/>
</div>
{/* Selezione ruolo */}
<div>
<div style={{fontSize:11,color:C.textMuted,letterSpacing:â€œ0.07emâ€,textTransform:â€œuppercaseâ€,marginBottom:9}}>Ruolo assegnato</div>
<div style={{display:â€œgridâ€,gridTemplateColumns:â€œ1fr 1frâ€,gap:7}} className=â€œform-2colâ€>
{RUOLI.map(r=>(
<button key={r.id} onClick={()=>set(â€œruoloâ€,r.id)}
style={{padding:â€œ10px 12pxâ€,borderRadius:9,textAlign:â€œleftâ€,cursor:â€œpointerâ€,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,transition:â€œall .15sâ€,
background:f.ruolo===r.id?r.bg:C.bg,
border:`1.5px solid ${f.ruolo===r.id?r.hex:C.border}`}}>
<div style={{fontSize:12,fontWeight:500,color:f.ruolo===r.id?r.hex:C.text}}>{r.label}</div>
<div style={{fontSize:10,color:C.textDim,marginTop:3,lineHeight:1.35}}>{r.desc}</div>
</button>
))}
</div>
</div>
{/* Link invito simulato */}
<div style={{background:C.blueBg,border:`1px solid ${C.blueBorder}`,borderRadius:9,padding:â€œ11px 14pxâ€}}>
<div style={{fontSize:11,color:C.blue,marginBottom:5,fontWeight:500}}>Link di invito (verrÃ  inviato via email)</div>
<div style={{fontSize:11,color:C.textDim,fontFamily:â€œmonospaceâ€,
background:C.bg,padding:â€œ6px 10pxâ€,borderRadius:6,wordBreak:â€œbreak-allâ€}}>
https://accademia.it/accesso?token=inv_{Math.random().toString(36).slice(2,10)}
</div>
</div>
<div style={{display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:5}}>
<label style={{fontSize:11,color:C.textMuted,letterSpacing:â€œ0.07emâ€,textTransform:â€œuppercaseâ€}}>Messaggio personalizzato (opzionale)</label>
<textarea value={f.messaggio} onChange={e=>set(â€œmessaggioâ€,e.target.value)} rows={2}
placeholder=â€œEs. Benvenuto! Clicca il link per completare la registrazione.â€
style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:8,
color:C.text,fontSize:13,padding:â€œ9px 13pxâ€,width:â€œ100%â€,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,resize:â€œverticalâ€}}/>
</div>
</div>
<div style={{padding:â€œ13px 22pxâ€,borderTop:`1px solid ${C.border}`,display:â€œflexâ€,justifyContent:â€œflex-endâ€,gap:8}}>
<Btn variant="secondary" onClick={onClose}>Annulla</Btn>
<Btn onClick={handleSend}><Ic n="mail" size={13} stroke={C.bg}/>Invia invito</Btn>
</div>
</Modal>
);
};

// â”€â”€â”€ MODAL RICHIESTA DETTAGLIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RichiestaModal=({richiesta,onApprova,onRifiuta,onClose})=>{
const [ruolo,setRuolo]=useState(richiesta.ruolo);
const r=ruoloById(ruolo);
return(
<Modal title="Richiesta di accesso" onClose={onClose} wide>
<div style={{padding:â€œ20px 22pxâ€,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:16}}>
<div style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:13}}>
<Avatar initials={richiesta.nome.split(â€ â€œ).map(p=>p[0]).join(â€â€).slice(0,2)} hex={r.hex} size={48}/>
<div>
<div style={{fontSize:16,fontWeight:500}}>{richiesta.nome}</div>
<div style={{fontSize:12,color:C.textMuted,marginTop:2}}>{richiesta.email}</div>
<div style={{fontSize:11,color:C.textDim,marginTop:1}}>Richiesta del {fmt_data(richiesta.data)}</div>
</div>
</div>
<div style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:9,padding:â€œ12px 14pxâ€}}>
<div style={{fontSize:11,color:C.textMuted,marginBottom:6,letterSpacing:â€œ0.07emâ€,textTransform:â€œuppercaseâ€}}>Messaggio</div>
<div style={{fontSize:13,color:C.text,lineHeight:1.55}}>{richiesta.messaggio}</div>
</div>
<div>
<div style={{fontSize:11,color:C.textMuted,letterSpacing:â€œ0.07emâ€,textTransform:â€œuppercaseâ€,marginBottom:9}}>Assegna ruolo</div>
<div style={{display:â€œgridâ€,gridTemplateColumns:â€œ1fr 1frâ€,gap:7}} className=â€œform-2colâ€>
{RUOLI.map(r=>(
<button key={r.id} onClick={()=>setRuolo(r.id)}
style={{padding:â€œ9px 12pxâ€,borderRadius:9,textAlign:â€œleftâ€,cursor:â€œpointerâ€,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,transition:â€œall .15sâ€,
background:ruolo===r.id?r.bg:C.bg,
border:`1.5px solid ${ruolo===r.id?r.hex:C.border}`}}>
<div style={{fontSize:12,fontWeight:500,color:ruolo===r.id?r.hex:C.text}}>{r.label}</div>
</button>
))}
</div>
</div>
</div>
<div style={{padding:â€œ13px 22pxâ€,borderTop:`1px solid ${C.border}`,display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,gap:8}}>
<Btn danger onClick={()=>onRifiuta(richiesta)}>
<Ic n="x" size={13} stroke={C.red}/>Rifiuta
</Btn>
<div style={{display:â€œflexâ€,gap:8}}>
<Btn variant="secondary" onClick={onClose}>Annulla</Btn>
<Btn onClick={()=>onApprova(richiesta,ruolo)}>
<Ic n="check" size={13} stroke={C.bg}/>Approva e attiva
</Btn>
</div>
</div>
</Modal>
);
};

// â”€â”€â”€ CONFIRM DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ConfirmModal=({titolo,testo,onConfirm,onClose,danger=true})=>(
<Modal title={titolo} onClose={onClose}>
<div style={{padding:â€œ22px 22px 14pxâ€,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:14,alignItems:â€œcenterâ€,textAlign:â€œcenterâ€}}>
<div style={{width:50,height:50,borderRadius:â€œ50%â€,background:danger?C.redBg:C.orangeBg,
border:`1px solid ${danger?C.redBorder:C.orangeBorder}`,
display:â€œflexâ€,alignItems:â€œcenterâ€,justifyContent:â€œcenterâ€}}>
<Ic n="warn" size={22} stroke={danger?C.red:C.orange}/>
</div>
<p style={{fontSize:14,color:C.textMuted,lineHeight:1.6}}>{testo}</p>
</div>
<div style={{padding:â€œ14px 22pxâ€,borderTop:`1px solid ${C.border}`,display:â€œflexâ€,justifyContent:â€œcenterâ€,gap:10}}>
<Btn variant="secondary" onClick={onClose}>Annulla</Btn>
<Btn danger onClick={onConfirm}>Conferma</Btn>
</div>
</Modal>
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const RuoloBadge = ({ ruolo }) => {
const r = ruoloById(ruolo);
return (
<span style={{display:â€œinline-flexâ€,alignItems:â€œcenterâ€,gap:5,padding:â€œ3px 10pxâ€,
borderRadius:20,background:r.bg,border:`1px solid ${r.bd}`,
fontSize:11,fontWeight:500,color:r.hex,fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,
letterSpacing:â€œ0.04emâ€,whiteSpace:â€œnowrapâ€}}>
{r.label}
</span>
);
};

const UtentiView = () => {
const isMobile = useIsMobile();
const [utenti,    setUtenti]    = useState(INIT_UTENTI);
const [richieste, setRichieste] = useState(INIT_RICHIESTE);
const [tab,       setTab]       = useState(â€œutentiâ€);
const [search,    setSearch]    = useState(â€â€);
const [filterRuolo,setFR]       = useState(â€â€);
const [filterStato,setFS]       = useState(â€â€);
const [drawerUtente, setDrawer] = useState(null);
const [modal,     setModal]     = useState(null);  // â€œinvitaâ€ | â€œrichiestaâ€ | â€œconfirm_sospendiâ€ | â€œconfirm_eliminaâ€
const [selReq,    setSelReq]    = useState(null);
const [selUtente, setSelUtente] = useState(null);
const [toast,     setToast]     = useState(null);

```
const closeModal=()=>{setModal(null);setSelReq(null);setSelUtente(null);};

const showToast=(msg,hex=C.green)=>{
  setToast({msg,hex});
  setTimeout(()=>setToast(null),3000);
};

// â”€â”€ Metriche â”€â”€
const totAttivi   = utenti.filter(u=>u.stato==="attivo").length;
const totSospesi  = utenti.filter(u=>u.stato==="sospeso").length;
const totInvitati = utenti.filter(u=>u.stato==="invitato").length;
const totAttesa   = richieste.length;

// â”€â”€ Filtri â”€â”€
const filtrati = useMemo(()=>utenti.filter(u=>{
  const q=search.toLowerCase();
  return (!q||u.nome.toLowerCase().includes(q)||u.email.toLowerCase().includes(q))
    &&(!filterRuolo||u.ruolo===filterRuolo)
    &&(!filterStato||u.stato===filterStato);
}),[utenti,search,filterRuolo,filterStato]);

// â”€â”€ CRUD â”€â”€
const salvaUtente=(draft)=>{
  setUtenti(p=>p.map(u=>u.id===draft.id?{...draft}:u));
  setDrawer(null);
  showToast(`${draft.nome} aggiornato`);
};
const sospendiUtente=(u)=>{
  const nuovo=u.stato==="sospeso"?"attivo":"sospeso";
  setUtenti(p=>p.map(x=>x.id===u.id?{...x,stato:nuovo}:x));
  setDrawer(null); closeModal();
  showToast(`${u.nome} ${nuovo==="sospeso"?"sospeso":"riattivato"}`,nuovo==="sospeso"?C.orange:C.green);
};
const eliminaUtente=(u)=>{
  setUtenti(p=>p.filter(x=>x.id!==u.id));
  setDrawer(null); closeModal();
  showToast(`${u.nome} eliminato`,C.red);
};
const approvaRichiesta=(req,ruolo)=>{
  const nuovo={id:uid(),nome:req.nome,email:req.email,ruolo,stato:"attivo",
    avatar:req.nome.split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase(),
    iscritto:new Date().toISOString().split("T")[0],
    ultimoAccesso:null,permessi:{...PERM_DEFAULT[ruolo]},note:""};
  setUtenti(p=>[...p,nuovo]);
  setRichieste(p=>p.filter(r=>r.id!==req.id));
  closeModal();
  showToast(`${req.nome} approvato come ${ruoloById(ruolo).label}`);
};
const rifiutaRichiesta=(req)=>{
  setRichieste(p=>p.filter(r=>r.id!==req.id));
  closeModal();
  showToast(`Richiesta di ${req.nome} rifiutata`,C.orange);
};
const invitaUtente=(f)=>{
  const nuovo={id:uid(),nome:f.nome,email:f.email,ruolo:f.ruolo,stato:"invitato",
    avatar:f.nome.split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase(),
    iscritto:new Date().toISOString().split("T")[0],ultimoAccesso:null,
    permessi:{...PERM_DEFAULT[f.ruolo]},note:""};
  setUtenti(p=>[...p,nuovo]);
  closeModal();
  showToast(`Invito inviato a ${f.email}`,C.blue);
};

return(
  <>
    <style>{G}</style>
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column"}}>

      {/* â”€â”€ NAVBAR â”€â”€ */}
      <header style={{background:C.surface,borderBottom:`1px solid ${C.border}`,
        padding:"0 20px",display:"flex",alignItems:"center",height:56,flexShrink:0}}>
        <div style={{display:"flex",alignItems:"center",gap:10,paddingRight:22,marginRight:22,
          borderRight:`1px solid ${C.border}`,height:"100%"}}>
          <div style={{width:28,height:28,borderRadius:7,background:C.gold,
            display:"flex",alignItems:"center",justifyContent:"center"}}>
            <Ic n="music" size={14} stroke={C.bg}/>
          </div>
          <div>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:15,fontWeight:600,lineHeight:1}}>Accademia Musicale</div>
            <div style={{fontSize:9,color:C.textDim,letterSpacing:"0.12em",textTransform:"uppercase"}}>Sistema gestionale</div>
          </div>
        </div>
        {[["grid","Dashboard"],["users","Allievi"],["calendar","Calendario"],
          ["euro","ContabilitÃ "],["music","Repertorio"],["shield","Utenti"]].map(([ic,lb],i)=>(
          <button key={lb} className="nav-btn"
            style={{height:"100%",padding:"0 13px",display:"flex",alignItems:"center",gap:7,
              background:i===5?C.goldBg:"none",border:"none",cursor:"pointer",fontSize:13,
              color:i===5?C.gold:C.textMuted,fontFamily:"'DM Sans',sans-serif",
              borderBottom:i===5?`2px solid ${C.gold}`:"2px solid transparent"}}>
            <Ic n={ic} size={14} stroke={i===5?C.gold:C.textMuted}/>{lb}
          </button>
        ))}
        <div style={{marginLeft:"auto"}}>
          <Btn onClick={()=>setModal("invita")}>
            <Ic n="plus" size={14} stroke={C.bg}/>Invita utente
          </Btn>
        </div>
      </header>

      {/* â”€â”€ PAGE HEADER â”€â”€ */}
      <div style={{background:`linear-gradient(135deg,${C.surface} 0%,${C.bg} 100%)`,
        borderBottom:`1px solid ${C.border}`,padding:"16px 20px",flexShrink:0}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <div style={{animation:"fadeUp .4s ease both"}}>
            <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:300,letterSpacing:"0.02em"}}>
              Gestione <span style={{fontWeight:600,color:C.gold}}>Utenti</span>
            </h1>
            <p style={{fontSize:13,color:C.textMuted,marginTop:5}}>
              Accessi, ruoli e permessi per l'area riservata
            </p>
          </div>
          {/* KPI rapide */}
          <div style={{display:"flex",gap:12,animation:"fadeUp .4s ease .1s both"}}>
            {[
              {label:"Attivi",    val:totAttivi,   hex:C.green},
              {label:"In attesa", val:totAttesa,   hex:C.orange},
              {label:"Invitati",  val:totInvitati, hex:C.blue},
              {label:"Sospesi",   val:totSospesi,  hex:C.red},
            ].map(k=>(
              <div key={k.label} style={{padding:"10px 16px",background:C.surface,
                border:`1px solid ${C.border}`,borderRadius:10,textAlign:"center",minWidth:72}}>
                <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:600,color:k.hex}}>{k.val}</div>
                <div style={{fontSize:10,color:C.textDim,letterSpacing:"0.07em",textTransform:"uppercase",marginTop:2}}>{k.label}</div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* â”€â”€ BODY â”€â”€ */}
      <div style={{flex:1,padding:isMobile?"12px":"20px 24px",overflow:"auto",display:"flex",flexDirection:"column",gap:16}}>

        {/* Sub-tabs */}
        <div style={{display:"flex",gap:2}}>
          {[["utenti","users","Utenti",""],
            ["richieste","mail","Richieste",richieste.length>0?richieste.length:null]
          ].map(([v,ic,lb,badge])=>(
            <button key={v} onClick={()=>setTab(v)}
              style={{display:"flex",alignItems:"center",gap:7,padding:"8px 16px",borderRadius:8,
                background:tab===v?C.goldBg:"none",border:`1px solid ${tab===v?C.goldDim:C.border}`,
                cursor:"pointer",fontSize:13,color:tab===v?C.gold:C.textMuted,
                fontFamily:"'DM Sans',sans-serif",transition:"all .15s"}}>
              <Ic n={ic} size={14} stroke={tab===v?C.gold:C.textMuted}/>{lb}
              {badge!=null&&(
                <span style={{background:C.orange,color:C.bg,borderRadius:"10px",
                  padding:"1px 7px",fontSize:10,fontWeight:700,marginLeft:2}}>{badge}</span>
              )}
            </button>
          ))}
        </div>

        {/* â”€â”€ TAB UTENTI â”€â”€ */}
        {tab==="utenti"&&(
          <>
            {/* Filtri */}
            <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
              <div style={{position:"relative",flex:"1 1 220px"}}>
                <span style={{position:"absolute",left:11,top:"50%",transform:"translateY(-50%)"}}>
                  <Ic n="search" size={14} stroke={C.textDim}/>
                </span>
                <input value={search} onChange={e=>setSearch(e.target.value)}
                  placeholder="Cerca per nome o email..."
                  style={{width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,
                    color:C.text,fontSize:13,padding:"9px 12px 9px 34px",fontFamily:"'DM Sans',sans-serif"}}/>
              </div>
              <select value={filterRuolo} onChange={e=>setFR(e.target.value)}
                style={{background:C.surface,border:`1px solid ${filterRuolo?C.goldDim:C.border}`,
                  borderRadius:8,color:filterRuolo?C.gold:C.textMuted,fontSize:13,
                  padding:"9px 12px",fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
                <option value="">Tutti i ruoli</option>
                {RUOLI.map(r=><option key={r.id} value={r.id}>{r.label}</option>)}
              </select>
              <select value={filterStato} onChange={e=>setFS(e.target.value)}
                style={{background:C.surface,border:`1px solid ${filterStato?C.goldDim:C.border}`,
                  borderRadius:8,color:filterStato?C.gold:C.textMuted,fontSize:13,
                  padding:"9px 12px",fontFamily:"'DM Sans',sans-serif",appearance:"none",cursor:"pointer"}}>
                <option value="">Tutti gli stati</option>
                {STATI.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}
              </select>
              {(search||filterRuolo||filterStato)&&(
                <button onClick={()=>{setSearch("");setFR("");setFS("");}}
                  style={{background:"none",border:`1px solid ${C.border}`,borderRadius:8,
                    color:C.textMuted,fontSize:12,padding:"9px 12px",cursor:"pointer",
                    fontFamily:"'DM Sans',sans-serif",display:"flex",alignItems:"center",gap:5,
                    transition:"all .12s"}}
                  onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;}}
                  onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;}}>
                  <Ic n="x" size={12} stroke="currentColor"/>Azzera
                </button>
              )}
              <span style={{fontSize:12,color:C.textDim,marginLeft:"auto"}}>{filtrati.length} utenti</span>
            </div>

            {/* Tabella */}
            <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"2.5fr 1.6fr 1.2fr 1.2fr 1.6fr auto",minWidth:520,
                padding:"9px 20px",borderBottom:`1px solid ${C.border}`,background:C.bg}}>
                {["Utente","Email","Ruolo","Stato","Ultimo accesso",""].map(h=>(
                  <div key={h} style={{fontSize:10,color:C.textMuted,letterSpacing:"0.08em",textTransform:"uppercase"}}>{h}</div>
                ))}
              </div>
              {filtrati.length===0&&(
                <div style={{padding:"40px 0",textAlign:"center",color:C.textDim,fontSize:13}}>
                  Nessun utente trovato
                </div>
              )}
              {filtrati.map((u,i)=>{
                const r=ruoloById(u.ruolo);
                const oraFa=(d)=>{
                  if(!d) return "Mai";
                  const diff=Math.floor((new Date()-new Date(d))/60000);
                  if(diff<60) return `${diff}min fa`;
                  if(diff<1440) return `${Math.floor(diff/60)}h fa`;
                  return fmt_ts(d);
                };
                return(
                  <div key={u.id} className="row-anim hover-row"
                    onClick={()=>setDrawer(u)}
                    style={{display:"grid",gridTemplateColumns:"2.5fr 1.6fr 1.2fr 1.2fr 1.6fr auto",minWidth:520,
                      padding:"13px 20px",borderBottom:i<filtrati.length-1?`1px solid ${C.border}20`:"none",
                      alignItems:"center"}}>
                    <div style={{display:"flex",alignItems:"center",gap:11}}>
                      <Avatar initials={u.avatar} hex={r.hex} size={34}/>
                      <div>
                        <div style={{fontSize:13,fontWeight:500}}>{u.nome}</div>
                        {u.note&&<div style={{fontSize:11,color:C.textDim,marginTop:1,
                          overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:160}}>{u.note}</div>}
                      </div>
                    </div>
                    <div style={{fontSize:12,color:C.textMuted,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",
                      paddingRight:8}}>{u.email}</div>
                    <div><RuoloBadge ruolo={u.ruolo}/></div>
                    <div><Badge stato={u.stato}/></div>
                    <div style={{display:"flex",alignItems:"center",gap:5}}>
                      {u.stato==="attivo"&&(
                        <span style={{width:6,height:6,borderRadius:"50%",background:C.green,
                          animation:u.ultimoAccesso&&new Date()-new Date(u.ultimoAccesso)<3600000?"pulse 2s infinite":undefined,
                          display:"inline-block",flexShrink:0}}/>
                      )}
                      <span style={{fontSize:12,color:C.textDim}}>{oraFa(u.ultimoAccesso)}</span>
                    </div>
                    <Ic n="right" size={15} stroke={C.textDim}/>
                  </div>
                );
              })}
            </div>
          </>
        )}

        {/* â”€â”€ TAB RICHIESTE â”€â”€ */}
        {tab==="richieste"&&(
          <div style={{display:"flex",flexDirection:"column",gap:10}}>
            {richieste.length===0&&(
              <div style={{background:C.greenBg,border:`1px solid ${C.greenBorder}`,borderRadius:10,
                padding:"16px 20px",display:"flex",alignItems:"center",gap:10}}>
                <Ic n="check" size={16} stroke={C.green}/>
                <span style={{fontSize:13,color:C.green,fontWeight:500}}>Nessuna richiesta in sospeso</span>
              </div>
            )}
            {richieste.map((req,i)=>{
              const r=ruoloById(req.ruolo);
              return(
                <div key={req.id} className="row-anim"
                  style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,
                    overflow:"hidden",animationDelay:`${i*0.07}s`}}>
                  <div style={{padding:"16px 20px",display:"flex",gap:14,alignItems:"flex-start"}}>
                    <Avatar initials={req.nome.split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase()} hex={r.hex} size={44}/>
                    <div style={{flex:1,minWidth:0}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10}}>
                        <div>
                          <div style={{fontSize:15,fontWeight:500}}>{req.nome}</div>
                          <div style={{fontSize:12,color:C.textMuted,marginTop:2}}>{req.email}</div>
                        </div>
                        <div style={{display:"flex",alignItems:"center",gap:10,flexShrink:0}}>
                          <span style={{fontSize:11,color:C.textDim}}>{fmt_data(req.data)}</span>
                          <RuoloBadge ruolo={req.ruolo}/>
                        </div>
                      </div>
                      <div style={{marginTop:10,padding:"10px 14px",background:C.bg,
                        borderRadius:8,border:`1px solid ${C.border}30`}}>
                        <div style={{fontSize:12,color:C.textMuted,lineHeight:1.55}}>{req.messaggio}</div>
                      </div>
                    </div>
                  </div>
                  <div style={{padding:"12px 20px",borderTop:`1px solid ${C.border}20`,
                    display:"flex",justifyContent:"flex-end",gap:8,background:C.bg}}>
                    <Btn small danger onClick={()=>{setSelReq(req);setModal("confirm_rifiuta");}}>
                      <Ic n="x" size={12} stroke={C.red}/>Rifiuta
                    </Btn>
                    <Btn small variant="secondary" onClick={()=>{setSelReq(req);setModal("richiesta");}}>
                      <Ic n="user" size={12} stroke={C.textMuted}/>Esamina
                    </Btn>
                    <Btn small onClick={()=>approvaRichiesta(req,req.ruolo)}>
                      <Ic n="check" size={12} stroke={C.bg}/>Approva come {ruoloById(req.ruolo).label}
                    </Btn>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>

    {/* â”€â”€ DRAWER UTENTE â”€â”€ */}
    {drawerUtente&&(
      <UtenteDrawer
        utente={drawerUtente}
        onClose={()=>setDrawer(null)}
        onSave={salvaUtente}
        isCurrentAdmin={true}
        onSospendi={u=>{setSelUtente(u);setModal("confirm_sospendi");}}
        onElimina={u=>{setSelUtente(u);setModal("confirm_elimina");}}
      />
    )}

    {/* â”€â”€ MODALI â”€â”€ */}
    {modal==="invita"&&<InvitaModal onInvita={invitaUtente} onClose={closeModal}/>}
    {modal==="richiesta"&&selReq&&(
      <RichiestaModal richiesta={selReq} onApprova={approvaRichiesta} onRifiuta={r=>{rifiutaRichiesta(r);closeModal();}} onClose={closeModal}/>
    )}
    {modal==="confirm_sospendi"&&selUtente&&(
      <ConfirmDel
        title={selUtente.stato==="sospeso"?"Riattiva account":"Sospendi account"}
        testo={selUtente.stato==="sospeso"
          ?`Riattivare l'account di ${selUtente.nome}? PotrÃ  accedere di nuovo all'area riservata.`
          :`Sospendere l'account di ${selUtente.nome}? Non potrÃ  piÃ¹ accedere finchÃ© non viene riattivato.`}
        onConfirm={()=>sospendiUtente(selUtente)}
        onClose={closeModal}
        danger={selUtente.stato!=="sospeso"}
      />
    )}
    {modal==="confirm_elimina"&&selUtente&&(
      <ConfirmDel
        title="Elimina utente"
        testo={`Eliminare definitivamente l'account di ${selUtente.nome}? L'operazione Ã¨ irreversibile.`}
        onConfirm={()=>eliminaUtente(selUtente)}
        onClose={closeModal}
      />
    )}
    {modal==="confirm_rifiuta"&&selReq&&(
      <ConfirmDel
        title="Rifiuta richiesta"
        testo={`Rifiutare la richiesta di accesso di ${selReq.nome}?`}
        onConfirm={()=>{rifiutaRichiesta(selReq);closeModal();}}
        onClose={closeModal}
      />
    )}

    {/* â”€â”€ TOAST â”€â”€ */}
    {toast&&(
      <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",zIndex:400,
        background:C.surface,border:`1px solid ${toast.hex}40`,borderLeft:`3px solid ${toast.hex}`,
        borderRadius:10,padding:"11px 18px",display:"flex",alignItems:"center",gap:10,
        animation:"fadeUp .25s ease",boxShadow:"0 8px 32px rgba(0,0,0,.5)",
        fontFamily:"'DM Sans',sans-serif",fontSize:13}}>
        <Ic n="check" size={14} stroke={toast.hex}/>
        <span style={{color:C.text}}>{toast.msg}</span>
      </div>
    )}
  </>
);
```

};

// â”€â”€â”€ DATI DOCENTI ESTESI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INIT_DOCENTI_EXT = [
{ id:â€œd1â€, nome:â€œProf. Marco Rossiâ€,   teacherKey:â€œProf. Rossiâ€,   email:â€œm.rossi@accademia.itâ€,    phone:â€œ338 1122334â€, strumenti:â€œPianoforte Â· Violinoâ€,   bio:â€œDiplomato al Conservatorio di Milano. 15 anni di esperienza.â€, tariffaOra:35, contratto:â€œTempo indeterminatoâ€, dataInizio:â€œ2015-09-01â€, colore:C.gold    },
{ id:â€œd2â€, nome:â€œProf. Luca Bianchiâ€,  teacherKey:â€œProf. Bianchiâ€, email:â€œl.bianchi@accademia.itâ€,  phone:â€œ347 5566778â€, strumenti:â€œChitarra Â· Flautoâ€,      bio:â€œSpecializzato in musica moderna e jazz. Masterclass annuali.â€, tariffaOra:35, contratto:â€œTempo determinatoâ€,    dataInizio:â€œ2018-01-15â€, colore:C.teal    },
{ id:â€œd3â€, nome:â€œProf. Mario Verdeâ€,   teacherKey:â€œProf. Verdeâ€,   email:â€œm.verde@accademia.itâ€,    phone:â€œ333 9988776â€, strumenti:â€œBatteria Â· Percussioniâ€, bio:â€œBatterista professionista, collabora con diverse orchestre.â€,   tariffaOra:35, contratto:â€œCollaborazioneâ€,        dataInizio:â€œ2020-03-01â€, colore:C.blue    },
{ id:â€œd4â€, nome:â€œProf.ssa Lia Marinoâ€, teacherKey:â€œProf. Marinoâ€,  email:â€œl.marino@accademia.itâ€,   phone:â€œ366 3344556â€, strumenti:â€œCanto Â· Solfeggioâ€,      bio:â€œSoprano lirico, docente di tecnica vocale e teoria musicale.â€,  tariffaOra:35, contratto:â€œTempo indeterminatoâ€, dataInizio:â€œ2017-09-01â€, colore:C.purple  },
];

const DocentiView = ({ students:_studentsRaw, lessons:_lessonsRaw, docenti, setDocenti, annoInizioAttivo }) => {
const isMobile = useIsMobile();
const students = _studentsRaw || [];
const lessons = _lessonsRaw || [];
const [selected,  setSelected]  = useState(null);
const [tab,       setTab]       = useState(â€œprofiloâ€);
const [modal,     setModal]     = useState(null); // null | â€œnewâ€ | â€œeditâ€ | â€œdelâ€
const [draft,     setDraft]     = useState({});

const initDoc = { nome:â€â€, email:â€â€, phone:â€â€, strumenti:â€â€, bio:â€â€, tariffaOra:35, contratto:â€œCollaborazioneâ€, dataInizio:â€â€, colore:C.gold };

const openNew  = () => { setDraft({â€¦initDoc}); setModal(â€œnewâ€); };
const openEdit = (d) => { setDraft({â€¦d}); setModal(â€œeditâ€); };
const saveDoc  = () => {
if(modal===â€œnewâ€)  setDocenti(p=>[â€¦p,{â€¦draft,id:uid(),colore:draft.colore||C.gold,teacherKey:draft.teacherKey||draft.nome}]);
if(modal===â€œeditâ€) { setDocenti(p=>p.map(d=>d.id===draft.id?{â€¦draft}:d)); if(selected?.id===draft.id) setSelected({â€¦draft}); }
setModal(null);
};
const delDoc = (id) => { setDocenti(p=>p.filter(d=>d.id!==id)); if(selected?.id===id) setSelected(null); setModal(null); };

// Helpers â€” match tramite teacherKey (campo dedicato per corrispondenza esatta)
const matchTeacher = (d, teacherField) => {
if(!teacherField) return false;
const key = d.teacherKey || d.nome;
return teacherField === key || teacherField === d.nome;
};
const allievi  = (d) => students.filter(s => matchTeacher(d, s.teacher));
const lezioniD = (d) => lessons.filter(l  => matchTeacher(d, l.teacher));

// Calcoli mensili basati su lezioni effettive
const nowDate   = new Date(today);
const curYear   = nowDate.getFullYear();
const curMonth  = nowDate.getMonth()+1;
const prevMonth = curMonth===1 ? 12 : curMonth-1;
const prevYear  = curMonth===1 ? curYear-1 : curYear;

const lezioniMese = (d, m, y) => lessons.filter(l => {
if(!matchTeacher(d, l.teacher)) return false;
const [ly,lm] = l.date.split(â€-â€).map(Number);
return ly===y && lm===m;
});
// Nota: lezioniMese giÃ  funziona per collettive perchÃ© l.teacher Ã¨ sempre valorizzato
const stipendioMese = (d, m=curMonth, y=curYear) => lezioniMese(d,m,y).length * d.tariffaOra;

// Anno scolastico â€” usa il prop dallâ€™admin (fallback: auto da data corrente)
const annoInizio = annoInizioAttivo ?? (curMonth >= 9 ? curYear : curYear-1);
const MESI_AS = [
{m:9, y:annoInizio},{m:10,y:annoInizio},{m:11,y:annoInizio},{m:12,y:annoInizio},
{m:1, y:annoInizio+1},{m:2,y:annoInizio+1},{m:3,y:annoInizio+1},
{m:4, y:annoInizio+1},{m:5,y:annoInizio+1},{m:6,y:annoInizio+1},
];
const isFuture = (x) => new Date(x.y, x.m-1, 1) > new Date(curYear, curMonth-1, 1);
const defaultSelMese = MESI_AS.find(x=>x.m===curMonth && x.y===curYear) || MESI_AS[MESI_AS.length-1];
// â† useState QUI, prima di qualsiasi return condizionale
const [selMese, setSelMese] = useState(defaultSelMese);

// FormModal inline JSX (evita re-mount su ogni keystroke)
const formModalJSX = (modal && modal !== â€œdelâ€) ? (
<Modal title={modal===â€œnewâ€?â€œNuovo docenteâ€:â€œModifica docenteâ€} onClose={()=>setModal(null)} wide>
<div style={{padding:24,display:â€œflexâ€,flexDirection:â€œcolumnâ€,gap:16}}>
<div className="form-2col">
<Input label=â€œNome completo *â€ value={draft.nome||â€â€} onChange={e=>setDraft(p=>({â€¦p,nome:e.target.value}))} placeholder=â€œProf. Nome Cognomeâ€/>
<Input label=â€œEmailâ€ type=â€œemailâ€ value={draft.email||â€â€} onChange={e=>setDraft(p=>({â€¦p,email:e.target.value}))} placeholder=â€œnome@accademia.itâ€/>
<Input label=â€œTelefonoâ€ value={draft.phone||â€â€} onChange={e=>setDraft(p=>({â€¦p,phone:e.target.value}))} placeholder=â€œ333 0000000â€/>
<Input label=â€œStrumentiâ€ value={draft.strumenti||â€â€} onChange={e=>setDraft(p=>({â€¦p,strumenti:e.target.value}))} placeholder=â€œPianoforte Â· Chitarraâ€/>
<Input label=â€œTariffa oraria (â‚¬)â€ type=â€œnumberâ€ value={draft.tariffaOra||35} onChange={e=>setDraft(p=>({â€¦p,tariffaOra:+e.target.value}))}/>
<Sel label=â€œTipo contrattoâ€ value={draft.contratto||â€â€} onChange={e=>setDraft(p=>({â€¦p,contratto:e.target.value}))}
options={[â€œTempo indeterminatoâ€,â€œTempo determinatoâ€,â€œCollaborazioneâ€,â€œPartita IVAâ€]}/>
<Input label=â€œData inizioâ€ type=â€œdateâ€ value={draft.dataInizio||â€â€} onChange={e=>setDraft(p=>({â€¦p,dataInizio:e.target.value}))}/>
</div>
<Textarea label=â€œBiografiaâ€ value={draft.bio||â€â€} onChange={e=>setDraft(p=>({â€¦p,bio:e.target.value}))} placeholder=â€œFormazione, esperienzaâ€¦â€/>
</div>
<div style={{padding:â€œ14px 24pxâ€,borderTop:`1px solid ${C.border}`,display:â€œflexâ€,justifyContent:â€œflex-endâ€,gap:10}}>
<Btn variant=â€œsecondaryâ€ onClick={()=>setModal(null)}>Annulla</Btn>
<Btn onClick={saveDoc} disabled={!draft.nome?.trim()}><Ic n="check" size={14} stroke={C.bg}/>Salva</Btn>
</div>
</Modal>
) : null;

// â”€â”€ VISTA LISTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (!selected) return (
<div style={{maxWidth:1100,margin:â€œ0 autoâ€,padding:â€œclamp(12px, 3vw, 32px)â€}}>
<div style={{display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,alignItems:â€œcenterâ€,marginBottom:28}}>
<div>
<h1 style={{fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€,fontSize:32,fontWeight:600,lineHeight:1}}>Docenti</h1>
<p style={{fontSize:13,color:C.textMuted,marginTop:4}}>
{docenti.length} docenti
</p>
</div>
<Btn onClick={openNew}><Ic n="plus" size={15} stroke={C.bg}/>Nuovo docente</Btn>
</div>

```
  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(310px,1fr))",gap:16}}>
    {docenti.map(d=>{
      const all = allievi(d);
      return (
        <div key={d.id} onClick={()=>{setSelected(d);setTab("profilo");}}
          style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,
            padding:22,cursor:"pointer",transition:"all 0.18s",borderTop:`3px solid ${d.colore}30`}}
          onMouseEnter={e=>{e.currentTarget.style.borderColor=d.colore;e.currentTarget.style.borderTopColor=d.colore;}}
          onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.borderTopColor=d.colore+"30";}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:14}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <Avatar initials={d.nome.replace("Prof.ssa ","").replace("Prof. ","").split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase()} hex={d.colore} size={44}/>
              <div>
                <div style={{fontSize:15,fontWeight:600,marginBottom:2}}>{d.nome}</div>
                <div style={{fontSize:12,color:C.textMuted}}>{d.strumenti}</div>
              </div>
            </div>
            <button onClick={e=>{e.stopPropagation();openEdit(d);}}
              style={{background:"none",border:"none",cursor:"pointer",padding:6,borderRadius:6,color:C.textMuted}}
              onMouseEnter={ev=>ev.currentTarget.style.background=C.bg}
              onMouseLeave={ev=>ev.currentTarget.style.background="none"}>
              <Ic n="edit" size={15} stroke={C.textMuted}/>
            </button>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))",gap:10,marginTop:14,paddingTop:14,borderTop:`1px solid ${C.border}`}}>
            {[
              {label:"Allievi",  value:all.length,                                      hex:d.colore},
              {label:"Lez/mese", value:lezioniMese(d,curMonth,curYear).length,            hex:selected?.id===d.id?d.colore:C.textMuted},
              {label:"Compenso",  value:`â‚¬${stipendioMese(d).toLocaleString("it-IT")}`,    hex:C.green},
            ].map(s=>(
              <div key={s.label} style={{textAlign:"center"}}>
                <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:s.hex,lineHeight:1}}>{s.value}</div>
                <div style={{fontSize:10,color:C.textDim,textTransform:"uppercase",letterSpacing:"0.08em",marginTop:3}}>{s.label}</div>
              </div>
            ))}
          </div>
          <div style={{marginTop:12}}>
            <span style={{fontSize:11,color:C.textDim,background:C.bg,borderRadius:4,padding:"3px 8px",border:`1px solid ${C.border}`}}>
              {d.contratto}
            </span>
          </div>
        </div>
      );
    })}
  </div>
  {formModalJSX}
</div>
```

);

// â”€â”€ VISTA DETTAGLIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MESI_LABEL_L = [â€œGennaioâ€,â€œFebbraioâ€,â€œMarzoâ€,â€œAprileâ€,â€œMaggioâ€,â€œGiugnoâ€,â€œLuglioâ€,â€œAgostoâ€,â€œSettembreâ€,â€œOttobreâ€,â€œNovembreâ€,â€œDicembreâ€];
const MESI_LABEL_S = [â€œGenâ€,â€œFebâ€,â€œMarâ€,â€œAprâ€,â€œMagâ€,â€œGiuâ€,â€œLugâ€,â€œAgoâ€,â€œSetâ€,â€œOttâ€,â€œNovâ€,â€œDicâ€];

const all   = allievi(selected);
const lez   = lezioniD(selected);
const TABS  = [
{id:â€œprofiloâ€,  label:â€œProfiloâ€,  icon:â€œuserâ€},
{id:â€œallieviâ€,  label:â€œAllieviâ€,  icon:â€œusersâ€},
{id:â€œlezioniâ€,  label:â€œLezioniâ€,  icon:â€œcalendarâ€},
{id:â€œcompensoâ€, label:â€œCompensoâ€, icon:â€œeuroâ€},
];
const stip = stipendioMese(selected);

// Dati del mese selezionato
const lezSel   = lezioniMese(selected, selMese.m, selMese.y);
const lezPrevM = selMese.m===1 ? 12 : selMese.m-1;
const lezPrevY = selMese.m===1 ? selMese.y-1 : selMese.y;
const lezPrev  = lezioniMese(selected, lezPrevM, lezPrevY);
const stipSel  = lezSel.length * selected.tariffaOra;
const stipPrev = lezPrev.length * selected.tariffaOra;

// andamento anno scolastico (tutte le lezioni per il grafico)
const andamento = MESI_AS.map(x => {
const n = lezioniMese(selected, x.m, x.y).length;
return { label:MESI_LABEL_S[x.m-1], n, comp:n*selected.tariffaOra, m:x.m, y:x.y,
isSel: x.m===selMese.m && x.y===selMese.y, isFut: isFuture(x) };
});
const maxN = Math.max(â€¦andamento.map(x=>x.n), 1);

// Selettore mese UI
const MeseSelector = () => (
<div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:â€œ12px 16pxâ€,marginBottom:20}}>
<div style={{fontSize:10,color:C.textDim,letterSpacing:â€œ0.1emâ€,textTransform:â€œuppercaseâ€,marginBottom:10}}>
Anno scolastico {annoInizio}/{String(annoInizio+1).slice(-2)}
</div>
<div style={{display:â€œflexâ€,gap:6,flexWrap:â€œwrapâ€}}>
{MESI_AS.map(x=>{
const isS  = x.m===selMese.m && x.y===selMese.y;
const isF  = isFuture(x);
const hasD = lezioniMese(selected,x.m,x.y).length > 0;
return (
<button key={`${x.y}-${x.m}`} onClick={()=>!isF&&setSelMese(x)}
disabled={isF}
style={{padding:â€œ5px 12pxâ€,borderRadius:20,fontSize:12,fontWeight:isS?600:400,
border:`1px solid ${isS?selected.colore:hasD?selected.colore+"50":C.border}`,
background: isS ? selected.colore : hasD ? selected.colore+â€œ15â€ : C.bg,
color: isS ? C.bg : isF ? C.textDim : hasD ? selected.colore : C.textMuted,
cursor: isF ? â€œnot-allowedâ€ : â€œpointerâ€, opacity: isF ? 0.4 : 1,
transition:â€œall 0.15sâ€}}>
{MESI_LABEL_S[x.m-1]}
{hasD && !isF && <span style={{display:â€œinline-blockâ€,width:4,height:4,borderRadius:â€œ50%â€,
background:isS?C.bg:selected.colore,marginLeft:5,verticalAlign:â€œmiddleâ€}}/>}
</button>
);
})}
</div>
</div>
);

// Grafico andamento anno scolastico (barre cliccabili)
const GraficoAS = ({tipo=â€œlezioniâ€}) => (
<div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:â€œ16px 20pxâ€,marginBottom:16}}>
<div style={{display:â€œflexâ€,justifyContent:â€œspace-betweenâ€,alignItems:â€œcenterâ€,marginBottom:14}}>
<div style={{fontSize:11,color:C.textMuted,letterSpacing:â€œ0.07emâ€,textTransform:â€œuppercaseâ€}}>
Andamento anno scolastico
</div>
<div style={{fontSize:11,color:C.textDim}}>
{tipo===â€œlezioniâ€
? `Totale: ${andamento.reduce((t,x)=>t+x.n,0)} lezioni`
: `Totale: â‚¬${andamento.reduce((t,x)=>t+x.comp,0).toLocaleString("it-IT")}`}
</div>
</div>
<div style={{display:â€œflexâ€,alignItems:â€œflex-endâ€,gap:4,height:80}}>
{andamento.map(x=>(
<div key={`${x.y}-${x.m}`} onClick={()=>!x.isFut&&setSelMese({m:x.m,y:x.y})}
style={{flex:1,display:â€œflexâ€,flexDirection:â€œcolumnâ€,alignItems:â€œcenterâ€,gap:4,
cursor:x.isFut?â€œdefaultâ€:â€œpointerâ€}}>
<div style={{fontSize:9,color:x.isSel?selected.colore:C.textDim,fontWeight:x.isSel?700:400,lineHeight:1}}>
{tipo===â€œlezioniâ€?(x.isFut?â€â€:x.n):(x.isFut?â€â€:x.n>0?`${(x.comp/1000).toFixed(1)}k`:â€â€)}
</div>
<div style={{width:â€œ100%â€,borderRadius:â€œ3px 3px 0 0â€,
background: x.isFut ? C.border : x.isSel ? selected.colore : `${selected.colore}45`,
height:`${x.isFut ? 4 : Math.round((x.n/maxN)*60)+4}px`,
minHeight:4,transition:â€œall 0.2sâ€,
outline: x.isSel ? `2px solid ${selected.colore}` : â€œnoneâ€, outlineOffset:1}}/>
<div style={{fontSize:9,color:x.isSel?selected.colore:C.textDim,textTransform:â€œuppercaseâ€,
fontWeight:x.isSel?700:400}}>{x.label}</div>
</div>
))}
</div>
</div>
);

return (
<div style={{maxWidth:1100,margin:â€œ0 autoâ€,padding:â€œclamp(12px, 3vw, 32px)â€}}>
<button onClick={()=>setSelected(null)}
style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:6,background:â€œnoneâ€,border:â€œnoneâ€,
cursor:â€œpointerâ€,color:C.textMuted,fontSize:13,fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,marginBottom:20,padding:0}}>
<Ic n="left" size={14} stroke={C.textMuted}/>Tutti i docenti
</button>

```
  {/* Header card */}
  <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,marginBottom:24,
    padding:"16px 20px",borderTop:`3px solid ${selected.colore}`}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
      <div style={{display:"flex",alignItems:"center",gap:16}}>
        <Avatar initials={selected.nome.replace("Prof.ssa ","").replace("Prof. ","").split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase()} hex={selected.colore} size={56}/>
        <div>
          <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600,marginBottom:4}}>{selected.nome}</h1>
          <div style={{fontSize:13,color:C.textMuted,marginBottom:6}}>{selected.strumenti}</div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
            <span style={{fontSize:11,background:C.goldBg,color:C.gold,border:`1px solid ${C.goldDim}`,borderRadius:4,padding:"2px 8px"}}>{selected.contratto}</span>
            {selected.dataInizio && <span style={{fontSize:11,color:C.textDim}}>Dal {new Date(selected.dataInizio+"T00:00:00").toLocaleDateString("it-IT",{month:"long",year:"numeric"})}</span>}
          </div>
        </div>
      </div>
      <div style={{display:"flex",gap:8}}>
        <Btn small variant="secondary" onClick={()=>openEdit(selected)}><Ic n="edit" size={13} stroke={C.textMuted}/>Modifica</Btn>
        <Btn small danger onClick={()=>setModal("del")}><Ic n="trash" size={13} stroke={C.red}/></Btn>
      </div>
    </div>
    {/* KPI strip â€” dati mese selezionato */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:14,marginTop:20,paddingTop:20,borderTop:`1px solid ${C.border}`}} className="stat-strip">
      {[
        {label:"Allievi totali",  value:all.length,                          hex:selected.colore},
        {label:`Lez. ${MESI_LABEL_S[selMese.m-1]}`, value:lezSel.length,    hex:C.textMuted},
        {label:"Tariffa/ora",     value:`â‚¬${selected.tariffaOra}`,           hex:C.gold},
        {label:`Compenso ${MESI_LABEL_S[selMese.m-1]}`, value:`â‚¬${stipSel.toLocaleString("it-IT")}`, hex:C.green},
      ].map(k=>(
        <div key={k.label} style={{background:C.bg,borderRadius:10,padding:"12px 16px",border:`1px solid ${C.border}`}}>
          <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:600,color:k.hex,lineHeight:1}}>{k.value}</div>
          <div style={{fontSize:10,color:C.textDim,textTransform:"uppercase",letterSpacing:"0.08em",marginTop:4}}>{k.label}</div>
        </div>
      ))}
    </div>
  </div>

  {/* Tabs */}
  <div style={{display:"flex",borderBottom:`1px solid ${C.border}`,marginBottom:22}}>
    {TABS.map(t=>(
      <button key={t.id} onClick={()=>setTab(t.id)}
        style={{display:"flex",alignItems:"center",gap:6,padding:"10px 18px",background:"none",
          border:"none",borderBottom:`2px solid ${tab===t.id?selected.colore:"transparent"}`,
          color:tab===t.id?selected.colore:C.textMuted,cursor:"pointer",
          fontFamily:"'DM Sans',sans-serif",fontSize:13,transition:"all 0.15s",marginBottom:-1}}>
        <Ic n={t.icon} size={13} stroke={tab===t.id?selected.colore:C.textMuted}/>{t.label}
      </button>
    ))}
  </div>

  {/* â”€â”€ PROFILO â”€â”€ */}
  {tab==="profilo" && (
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}} className="form-2col">
      {[
        {label:"Email",    value:selected.email||"â€”", icon:"mail"},
        {label:"Telefono", value:selected.phone||"â€”", icon:"phone"},
        {label:"Strumenti insegnati", value:selected.strumenti||"â€”", icon:"music"},
        {label:"Tipo contratto",      value:selected.contratto||"â€”", icon:"tag"},
        {label:"Tariffa oraria",      value:`â‚¬${selected.tariffaOra}/h`, icon:"euro"},
        {label:"Data inizio",         value:selected.dataInizio||"â€”", icon:"calendar"},
      ].map(f=>(
        <div key={f.label} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"14px 18px",display:"flex",alignItems:"center",gap:12}}>
          <div style={{width:34,height:34,borderRadius:8,background:C.goldBg,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
            <Ic n={f.icon} size={15} stroke={C.gold}/>
          </div>
          <div>
            <div style={{fontSize:10,color:C.textDim,textTransform:"uppercase",letterSpacing:"0.08em"}}>{f.label}</div>
            <div style={{fontSize:14,fontWeight:500,marginTop:2}}>{f.value}</div>
          </div>
        </div>
      ))}
      {selected.bio && (
        <div style={{gridColumn:"1/-1",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"16px 18px"}}>
          <div style={{fontSize:10,color:C.textDim,textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:8}}>Biografia</div>
          <p style={{fontSize:13,color:C.textMuted,lineHeight:1.7}}>{selected.bio}</p>
        </div>
      )}
    </div>
  )}

  {/* â”€â”€ ALLIEVI â”€â”€ */}
  {tab==="allievi" && (
    <div>
      <MeseSelector/>
      <GraficoAS tipo="lezioni"/>
      {/* Allievi con lezioni nel mese selezionato */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <Ic n="users" size={14} stroke={C.textMuted}/>
            <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>
              Allievi â€” {MESI_LABEL_L[selMese.m-1]} {selMese.y}
            </span>
          </div>
          <span style={{fontSize:12,color:C.textDim}}>
            {[...new Set(lezSel.flatMap(l=>isColl(l)?(l.students||[]).map(s=>s.name):[l.student]))].length} su {all.length} totali
          </span>
        </div>
        {all.length===0 ? (
          <div style={{textAlign:"center",padding:"48px 0",color:C.textMuted,fontSize:14}}>Nessun allievo assegnato</div>
        ) : (
          all.map((s,i)=>{
            const lezS = lezSel.filter(l=>studentInLesson(l,s.name));
            const attPres = lezS.filter(l=>l.attendance==="presente").length;
            const attAss  = lezS.filter(l=>l.attendance==="assente").length;
            const hasMese = lezS.length > 0;
            return (
              <div key={s.id} style={{display:"flex",alignItems:"center",gap:14,
                padding:"14px 18px",borderBottom:i<all.length-1?`1px solid ${C.border}`:"none",
                opacity: hasMese ? 1 : 0.45}}>
                <Avatar initials={s.name.split(" ").map(p=>p[0]).join("").slice(0,2)} hex={selected.colore} size={36}/>
                <div style={{flex:1}}>
                  <div style={{fontSize:14,fontWeight:500}}>{s.name}</div>
                  <div style={{fontSize:12,color:C.textMuted,marginTop:2}}>{s.instrument} Â· {s.level}</div>
                </div>
                <div style={{textAlign:"center",minWidth:60}}>
                  <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:hasMese?selected.colore:C.textDim}}>{lezS.length}</div>
                  <div style={{fontSize:10,color:C.textDim,textTransform:"uppercase"}}>lezioni</div>
                </div>
                {hasMese && (
                  <div style={{display:"flex",gap:6}}>
                    {attPres>0 && <span style={{fontSize:11,background:C.greenBg,color:C.green,border:`1px solid ${C.greenBorder}`,borderRadius:4,padding:"2px 7px"}}>{attPres}P</span>}
                    {attAss>0  && <span style={{fontSize:11,background:C.redBg,color:C.red,border:`1px solid ${C.redBorder}`,borderRadius:4,padding:"2px 7px"}}>{attAss}A</span>}
                  </div>
                )}
                <Badge stato={s.status}/>
                <div style={{textAlign:"right",flexShrink:0}}>
                  <div style={{fontSize:13,fontWeight:600,color:C.gold}}>â‚¬{s.monthlyFee}/mese</div>
                </div>
              </div>
            );
          })
        )}
      </div>
      {/* Riepilogo tutti i mesi */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,marginTop:16,overflow:"hidden"}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`}}>
          <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Riepilogo anno scolastico</span>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)"}}>
          {MESI_AS.map((x,i)=>{
            const n = lezioniMese(selected,x.m,x.y).length;
            const isS = x.m===selMese.m&&x.y===selMese.y;
            const isF = isFuture(x);
            return (
              <div key={i} onClick={()=>!isF&&setSelMese(x)}
                style={{padding:"14px 16px",borderRight:i%5!==4?`1px solid ${C.border}`:"none",
                  borderBottom:i<5?`1px solid ${C.border}`:"none",
                  background:isS?`${selected.colore}15`:"transparent",
                  cursor:isF?"default":"pointer",opacity:isF?0.4:1,
                  transition:"background 0.15s"}}>
                <div style={{fontSize:10,color:isS?selected.colore:C.textDim,textTransform:"uppercase",marginBottom:4}}>{MESI_LABEL_S[x.m-1]}</div>
                <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:600,color:isF?C.textDim:n>0?selected.colore:C.textDim}}>{isF?"â€”":n}</div>
                <div style={{fontSize:10,color:C.textDim}}>{isF?"":n===1?"lezione":"lezioni"}</div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  )}

  {/* â”€â”€ LEZIONI â”€â”€ */}
  {tab==="lezioni" && (
    <div>
      <MeseSelector/>
      <GraficoAS tipo="lezioni"/>
      {/* Lista lezioni mese selezionato */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <Ic n="calendar" size={14} stroke={C.textMuted}/>
            <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>
              {MESI_LABEL_L[selMese.m-1]} {selMese.y}
            </span>
          </div>
          <div style={{display:"flex",gap:12,alignItems:"center"}}>
            <span style={{fontSize:12,color:C.textDim}}>{lezSel.length} lezioni</span>
            {lezSel.filter(l=>l.attendance==="presente").length>0 && (
              <span style={{fontSize:11,background:C.greenBg,color:C.green,border:`1px solid ${C.greenBorder}`,borderRadius:4,padding:"2px 8px"}}>
                {lezSel.filter(l=>l.attendance==="presente").length} pres.
              </span>
            )}
            {lezSel.filter(l=>l.attendance==="assente").length>0 && (
              <span style={{fontSize:11,background:C.redBg,color:C.red,border:`1px solid ${C.redBorder}`,borderRadius:4,padding:"2px 8px"}}>
                {lezSel.filter(l=>l.attendance==="assente").length} ass.
              </span>
            )}
          </div>
        </div>
        {lezSel.length===0 ? (
          <div style={{textAlign:"center",padding:"48px 0",color:C.textMuted,fontSize:14}}>
            {isFuture(selMese) ? "Mese non ancora iniziato" : "Nessuna lezione registrata"}
          </div>
        ) : (
          lezSel.slice().sort((a,b)=>a.date.localeCompare(b.date)||a.hour.localeCompare(b.hour)).map((l,i)=>{
            const insHex2 = (typeof INS_HEX !== "undefined" && INS_HEX[l.instrument]) || C.gold;
            return (
              <div key={l.id} style={{display:"grid",gridTemplateColumns:"90px 1fr 1fr auto",gap:12,alignItems:"center",
                padding:"12px 20px",borderBottom:i<lezSel.length-1?`1px solid ${C.border}`:"none",
                borderLeft:`3px solid ${isColl(l)?C.purple:"transparent"}`,
                background:isColl(l)?`${C.purple}06`:"transparent"}}>
                <div>
                  <div style={{fontSize:11,color:C.textDim}}>{new Date(l.date+"T00:00:00").toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})}</div>
                  <div style={{fontSize:13,fontWeight:600,color:isColl(l)?C.purple:selected.colore}}>{l.hour}</div>
                </div>
                <div>
                  <div style={{display:"flex",alignItems:"center",gap:6}}>
                    <span style={{fontSize:13,fontWeight:500}}>
                      {isColl(l)?l.courseName:l.student}
                    </span>
                    {isColl(l) && <span style={{fontSize:10,background:C.purpleBg,color:C.purple,
                      border:`1px solid ${C.purpleBorder}`,borderRadius:4,padding:"1px 6px",letterSpacing:"0.05em"}}>collettiva</span>}
                  </div>
                  <div style={{fontSize:11,color:C.textMuted}}>
                    {isColl(l)
                      ? `${(l.students||[]).length} allievi`
                      : l.topic||"â€”"}
                  </div>
                </div>
                <div style={{fontSize:12,color:isColl(l)?C.purple:insHex2}}>
                  {isColl(l)?`${l.room||"â€”"}`:`${l.instrument} Â· ${l.room||"â€”"}`}
                </div>
                {l.attendance
                  ? <Badge label={l.attendance} color={l.attendance==="presente"?"green":l.attendance==="assente"?"red":"gold"}/>
                  : <span style={{fontSize:11,color:C.textDim}}>â€”</span>
                }
              </div>
            );
          })
        )}
      </div>
      {/* Tabella riepilogo anno */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,marginTop:16,overflow:"hidden"}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`}}>
          <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Riepilogo anno scolastico</span>
        </div>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:`1px solid ${C.border}`,background:C.bg}}>
              {["Mese","Lezioni","Presenti","Assenti","Tasso pres."].map(h=>(
                <th key={h} style={{padding:"10px 18px",textAlign:"left",fontSize:10,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {MESI_AS.map((x,i)=>{
              const lm = lezioniMese(selected,x.m,x.y);
              const pres = lm.filter(l=>l.attendance==="presente").length;
              const ass  = lm.filter(l=>l.attendance==="assente").length;
              const tasso = lm.length>0 ? Math.round((pres/lm.filter(l=>l.attendance).length||0)*100) : null;
              const isS  = x.m===selMese.m&&x.y===selMese.y;
              const isF  = isFuture(x);
              return (
                <tr key={i} onClick={()=>!isF&&setSelMese(x)}
                  style={{borderBottom:i<MESI_AS.length-1?`1px solid ${C.border}`:"none",
                    background:isS?`${selected.colore}12`:"transparent",
                    cursor:isF?"default":"pointer",opacity:isF?0.45:1,transition:"background 0.12s"}}
                  onMouseEnter={e=>{if(!isF&&!isS)e.currentTarget.style.background=C.surfaceHover;}}
                  onMouseLeave={e=>{e.currentTarget.style.background=isS?`${selected.colore}12`:"transparent";}}>
                  <td style={{padding:"11px 18px",fontSize:13,fontWeight:isS?600:400,color:isS?selected.colore:C.text}}>
                    {MESI_LABEL_L[x.m-1]} {x.y}
                  </td>
                  <td style={{padding:"11px 18px"}}>
                    <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:isF?C.textDim:lm.length>0?selected.colore:C.textDim}}>
                      {isF?"â€”":lm.length}
                    </span>
                  </td>
                  <td style={{padding:"11px 18px",fontSize:13,color:C.green}}>{isF?"â€”":pres||"â€”"}</td>
                  <td style={{padding:"11px 18px",fontSize:13,color:ass>0?C.red:C.textDim}}>{isF?"â€”":ass||"â€”"}</td>
                  <td style={{padding:"11px 18px"}}>
                    {!isF && tasso!==null && !isNaN(tasso) ? (
                      <div style={{display:"flex",alignItems:"center",gap:8}}>
                        <div style={{flex:1,height:4,background:C.border,borderRadius:2,maxWidth:60}}>
                          <div style={{height:"100%",borderRadius:2,background:tasso>=80?C.green:tasso>=60?C.gold:C.red,width:`${tasso}%`}}/>
                        </div>
                        <span style={{fontSize:12,color:tasso>=80?C.green:tasso>=60?C.gold:C.red}}>{tasso}%</span>
                      </div>
                    ) : <span style={{color:C.textDim}}>â€”</span>}
                  </td>
                </tr>
              );
            })}
          </tbody>
          <tfoot>
            <tr style={{borderTop:`2px solid ${C.border}`,background:C.bg}}>
              <td style={{padding:"11px 18px",fontSize:12,color:C.textMuted,fontWeight:600}}>TOTALE ANNO</td>
              <td style={{padding:"11px 18px"}}>
                <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:selected.colore}}>
                  {andamento.reduce((t,x)=>t+x.n,0)}
                </span>
              </td>
              <td style={{padding:"11px 18px",fontSize:13,color:C.green}}>{andamento.reduce((t,x)=>t+lezioniMese(selected,x.m,x.y).filter(l=>l.attendance==="presente").length,0)}</td>
              <td style={{padding:"11px 18px",fontSize:13,color:C.red}}>{andamento.reduce((t,x)=>t+lezioniMese(selected,x.m,x.y).filter(l=>l.attendance==="assente").length,0)}</td>
              <td style={{padding:"11px 18px",fontSize:12,color:C.textDim}}>â€”</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  )}

  {/* â”€â”€ COMPENSO â”€â”€ */}
  {tab==="compenso" && (
    <div>
      <MeseSelector/>
      <GraficoAS tipo="compenso"/>
      {/* KPI mese selezionato */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:12,marginBottom:16}}>
        {[
          {label:"Tariffa oraria",    value:`â‚¬${selected.tariffaOra}`,             desc:"Base contrattuale",      hex:C.gold},
          {label:`Lezioni ${MESI_LABEL_S[selMese.m-1]} ${selMese.y}`, value:lezSel.length,
           desc: lezSel.length>lezPrev.length?`+${lezSel.length-lezPrev.length} vs mese prec.`:
                 lezSel.length<lezPrev.length?`${lezSel.length-lezPrev.length} vs mese prec.`:"= mese prec.",
           hex:selected.colore},
          {label:`Compenso ${MESI_LABEL_S[selMese.m-1]}`,
           value:`â‚¬${stipSel.toLocaleString("it-IT")}`,
           desc:`mese prec.: â‚¬${stipPrev.toLocaleString("it-IT")}`,
           hex:C.green},
        ].map(k=>(
          <div key={k.label} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"18px 20px",borderTop:`3px solid ${k.hex}30`}}>
            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:600,color:k.hex,lineHeight:1,marginBottom:6}}>{k.value}</div>
            <div style={{fontSize:11,color:C.textMuted,textTransform:"uppercase",letterSpacing:"0.07em"}}>{k.label}</div>
            <div style={{fontSize:11,color:C.textDim,marginTop:4}}>{k.desc}</div>
          </div>
        ))}
      </div>
      {/* Dettaglio lezioni mese selezionato */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden",marginBottom:16}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <span style={{fontSize:12,color:C.textMuted,letterSpacing:"0.07em",textTransform:"uppercase"}}>
            Dettaglio {MESI_LABEL_L[selMese.m-1]} {selMese.y}
          </span>
          <span style={{fontSize:13,color:C.green,fontWeight:600}}>â‚¬{stipSel.toLocaleString("it-IT")}</span>
        </div>
        {lezSel.length===0 ? (
          <div style={{textAlign:"center",padding:"32px 0",color:C.textDim,fontSize:13}}>
            {isFuture(selMese)?"Mese non ancora iniziato":"Nessuna lezione registrata questo mese"}
          </div>
        ) : (
          lezSel.slice().sort((a,b)=>a.date.localeCompare(b.date)).map((l,i)=>(
            <div key={l.id} style={{display:"grid",gridTemplateColumns:"90px 1fr auto",gap:12,alignItems:"center",
              padding:"11px 20px",borderBottom:i<lezSel.length-1?`1px solid ${C.border}`:"none"}}>
              <div style={{fontSize:12,color:C.textMuted}}>
                {new Date(l.date+"T00:00:00").toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})} {l.hour}
              </div>
              <div>
                <div style={{fontSize:13,fontWeight:500}}>{l.student}</div>
                <div style={{fontSize:11,color:C.textMuted}}>{l.topic||"â€”"}</div>
              </div>
              <div style={{textAlign:"right",display:"flex",alignItems:"center",gap:8}}>
                <div style={{fontSize:13,fontWeight:600,color:C.green}}>â‚¬{selected.tariffaOra}</div>
                {l.attendance && <Badge label={l.attendance} color={l.attendance==="presente"?"green":l.attendance==="assente"?"red":"gold"}/>}
              </div>
            </div>
          ))
        )}
      </div>
      {/* Tabella compensi anno scolastico */}
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,overflow:"hidden"}}>
        <div style={{padding:"14px 20px",borderBottom:`1px solid ${C.border}`}}>
          <span style={{fontSize:12,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted}}>Compensi anno scolastico</span>
        </div>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:`1px solid ${C.border}`,background:C.bg}}>
              {["Mese","Lezioni","Compenso","vs mese prec."].map(h=>(
                <th key={h} style={{padding:"10px 18px",textAlign:"left",fontSize:10,letterSpacing:"0.08em",textTransform:"uppercase",color:C.textMuted,fontWeight:500}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {MESI_AS.map((x,i)=>{
              const pm = x.m===1?12:x.m-1, py = x.m===1?x.y-1:x.y;
              const n  = lezioniMese(selected,x.m,x.y).length;
              const np = lezioniMese(selected,pm,py).length;
              const c  = n * selected.tariffaOra;
              const delta = n - np;
              const isS  = x.m===selMese.m&&x.y===selMese.y;
              const isF  = isFuture(x);
              return (
                <tr key={i} onClick={()=>!isF&&setSelMese(x)}
                  style={{borderBottom:i<MESI_AS.length-1?`1px solid ${C.border}`:"none",
                    background:isS?`${selected.colore}12`:"transparent",
                    cursor:isF?"default":"pointer",opacity:isF?0.45:1,transition:"background 0.12s"}}
                  onMouseEnter={e=>{if(!isF&&!isS)e.currentTarget.style.background=C.surfaceHover;}}
                  onMouseLeave={e=>{e.currentTarget.style.background=isS?`${selected.colore}12`:"transparent";}}>
                  <td style={{padding:"11px 18px",fontSize:13,fontWeight:isS?600:400,color:isS?selected.colore:C.text}}>
                    {MESI_LABEL_L[x.m-1]} {x.y}
                  </td>
                  <td style={{padding:"11px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:isF?C.textDim:n>0?selected.colore:C.textDim}}>
                    {isF?"â€”":n}
                  </td>
                  <td style={{padding:"11px 18px",fontSize:14,fontWeight:600,color:isF?C.textDim:n>0?C.green:C.textDim}}>
                    {isF?"â€”":n>0?`â‚¬${c.toLocaleString("it-IT")}`:"â€”"}
                  </td>
                  <td style={{padding:"11px 18px"}}>
                    {!isF && np>0 && (
                      <span style={{fontSize:12,color:delta>0?C.green:delta<0?C.red:C.textDim,fontWeight:500}}>
                        {delta>0?`+${delta}`:delta<0?delta:"="}
                      </span>
                    )}
                    {!isF && np===0 && n>0 && <span style={{fontSize:11,color:C.textDim}}>primo mese</span>}
                    {isF && <span style={{color:C.textDim}}>â€”</span>}
                  </td>
                </tr>
              );
            })}
          </tbody>
          <tfoot>
            <tr style={{borderTop:`2px solid ${C.border}`,background:C.bg}}>
              <td style={{padding:"11px 18px",fontSize:12,color:C.textMuted,fontWeight:600}}>TOTALE ANNO</td>
              <td style={{padding:"11px 18px",fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:600,color:selected.colore}}>
                {andamento.reduce((t,x)=>t+x.n,0)}
              </td>
              <td style={{padding:"11px 18px",fontSize:14,fontWeight:600,color:C.green}}>
                â‚¬{andamento.reduce((t,x)=>t+x.comp,0).toLocaleString("it-IT")}
              </td>
              <td style={{padding:"11px 18px"}}/>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  )}

  {/* Modali â€” sempre renderizzati indipendentemente dal tab */}
  {formModalJSX}
  {modal==="del" && (
    <ConfirmDel
      title="Rimuovi docente"
      testo={`Rimuovere ${selected.nome} dall\'organico? Questa azione Ã¨ irreversibile.`}
      onConfirm={()=>delDoc(selected.id)}
      onClose={()=>setModal(null)}
    />
  )}
</div>
```

);
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NAV_ITEMS = [
{ id:â€œdashboardâ€,   label:â€œDashboardâ€,    icon:â€œgridâ€     },
{ id:â€œallieviâ€,     label:â€œAllieviâ€,      icon:â€œusersâ€    },
{ id:â€œdocentiâ€,     label:â€œDocentiâ€,      icon:â€œuserâ€     },
{ id:â€œcorsiâ€,       label:â€œCorsiâ€,        icon:â€œcoursesâ€  },
{ id:â€œcalendarioâ€,  label:â€œCalendarioâ€,   icon:â€œcalendarâ€ },
{ id:â€œconcertiâ€,    label:â€œConcertiâ€,     icon:â€œmicâ€      },
{ id:â€œcontabilitaâ€, label:â€œContabilitÃ â€,  icon:â€œeuroâ€     },
{ id:â€œrepertorioâ€,  label:â€œRepertorioâ€,   icon:â€œmusicâ€    },
{ id:â€œutentiâ€,      label:â€œUtentiâ€,       icon:â€œshieldâ€   },
];

const Sidebar = ({ current, setView, user, onLogout }) => {
const ruoloHex = {admin:C.gold, direttore:C.purple, segreteria:C.blue, docente:C.teal}[user?.ruolo] || C.gold;
const ini = user?.nome ? user.nome.split(â€ â€œ).map(p=>p[0]).join(â€â€).slice(0,2).toUpperCase() : â€œ??â€;
// Primary nav items shown in bottom bar (most used)
const BOTTOM_ITEMS = NAV_ITEMS.slice(0, 5);
return (
<>
{/* â”€â”€ Desktop sidebar â”€â”€ */}
<div className=â€œsidebar-desktopâ€ style={{width:220,background:C.surface,borderRight:`1px solid ${C.border}`,
display:â€œflexâ€,flexDirection:â€œcolumnâ€,height:â€œ100vhâ€,flexShrink:0,overflowY:â€œautoâ€}}>
{/* Logo */}
<div style={{padding:â€œ18px 16pxâ€,borderBottom:`1px solid ${C.border}`,flexShrink:0}}>
<div style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:10}}>
<div style={{width:32,height:32,borderRadius:8,background:C.gold,
display:â€œflexâ€,alignItems:â€œcenterâ€,justifyContent:â€œcenterâ€,flexShrink:0}}>
<Ic n="music" size={15} stroke={C.bg}/>
</div>
<div>
<div style={{fontFamily:â€â€˜Cormorant Garamondâ€™,serifâ€,fontSize:14,fontWeight:600,lineHeight:1.2}}>
Accademia Musicale
</div>
<div style={{fontSize:9,color:C.textDim,letterSpacing:â€œ0.1emâ€,textTransform:â€œuppercaseâ€,marginTop:1}}>
gestionale
</div>
</div>
</div>
</div>
{/* Navigation */}
<nav style={{flex:1,padding:â€œ10px 8pxâ€,overflowY:â€œautoâ€}}>
{NAV_ITEMS.map(item => {
const active = current === item.id;
return (
<button key={item.id} onClick={()=>setView(item.id)}
style={{width:â€œ100%â€,display:â€œflexâ€,alignItems:â€œcenterâ€,gap:10,
padding:â€œ9px 12pxâ€,borderRadius:9,border:â€œnoneâ€,cursor:â€œpointerâ€,
background:active?C.goldBg:â€œtransparentâ€,
color:active?C.gold:C.textMuted,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,fontSize:13,fontWeight:active?500:400,
textAlign:â€œleftâ€,transition:â€œall 0.15sâ€,marginBottom:1,
borderLeft:active?`2px solid ${C.gold}`:â€œ2px solid transparentâ€}}>
<Ic n={item.icon} size={15} stroke={active?C.gold:C.textMuted}/>
{item.label}
</button>
);
})}
</nav>
{/* User profile */}
<div style={{padding:â€œ12px 14pxâ€,borderTop:`1px solid ${C.border}`,flexShrink:0}}>
<div style={{display:â€œflexâ€,alignItems:â€œcenterâ€,gap:10,marginBottom:10}}>
<Avatar initials={ini} hex={ruoloHex} size={32}/>
<div style={{flex:1,minWidth:0}}>
<div style={{fontSize:12,fontWeight:500,overflow:â€œhiddenâ€,textOverflow:â€œellipsisâ€,whiteSpace:â€œnowrapâ€}}>
{user?.nome || â€œUtenteâ€}
</div>
<div style={{fontSize:10,color:ruoloHex,textTransform:â€œcapitalizeâ€,marginTop:1}}>
{user?.ruolo || â€œâ€”â€}
</div>
</div>
</div>
<button onClick={onLogout}
style={{width:â€œ100%â€,padding:â€œ7px 0â€,borderRadius:7,border:`1px solid ${C.border}`,
background:â€œtransparentâ€,color:C.textMuted,fontSize:12,cursor:â€œpointerâ€,
display:â€œflexâ€,alignItems:â€œcenterâ€,justifyContent:â€œcenterâ€,gap:6,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,transition:â€œall 0.15sâ€}}
onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;}}
onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;}}>
Esci
</button>
</div>
</div>

```
  {/* â”€â”€ Mobile bottom navigation bar â”€â”€ */}
  <div className="bottom-nav" style={{
    position:"fixed",bottom:0,left:0,right:0,zIndex:300,
    background:C.surface,borderTop:`1px solid ${C.border}`,
    display:"none", // hidden by default, shown by CSS on mobile
    justifyContent:"space-around",alignItems:"center",
    height:60,padding:"0 4px",gap:0}}>
    {BOTTOM_ITEMS.map(item => {
      const active = current === item.id;
      return (
        <button key={item.id} onClick={()=>setView(item.id)}
          style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",
            justifyContent:"center",gap:3,border:"none",background:"transparent",
            cursor:"pointer",padding:"6px 2px",
            color:active?C.gold:C.textMuted,transition:"all 0.15s"}}>
          <Ic n={item.icon} size={20} stroke={active?C.gold:C.textMuted}/>
          <span style={{fontSize:9,letterSpacing:"0.04em",fontFamily:"'DM Sans',sans-serif",
            fontWeight:active?600:400,textTransform:"uppercase"}}>
            {item.label.slice(0,6)}
          </span>
        </button>
      );
    })}
    {/* "Altro" button for remaining items */}
    <MobileMoreMenu current={current} setView={setView} extraItems={NAV_ITEMS.slice(5)} onLogout={onLogout}/>
  </div>
</>
```

);
};

const MobileMoreMenu = ({ current, setView, extraItems, onLogout }) => {
const [open, setOpen] = useState(false);
const activeExtra = extraItems.some(i => i.id === current);
return (
<>
<button onClick={()=>setOpen(v=>!v)}
style={{flex:1,display:â€œflexâ€,flexDirection:â€œcolumnâ€,alignItems:â€œcenterâ€,
justifyContent:â€œcenterâ€,gap:3,border:â€œnoneâ€,background:â€œtransparentâ€,
cursor:â€œpointerâ€,padding:â€œ6px 2pxâ€,
color:activeExtra?C.gold:C.textMuted}}>
<Ic n="grid" size={20} stroke={activeExtra?C.gold:C.textMuted}/>
<span style={{fontSize:9,letterSpacing:â€œ0.04emâ€,fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,
fontWeight:activeExtra?600:400,textTransform:â€œuppercaseâ€}}>Altro</span>
</button>
{open && (
<div style={{position:â€œfixedâ€,bottom:60,left:0,right:0,zIndex:400,
background:C.surface,borderTop:`1px solid ${C.border}`,
padding:â€œ8px 0â€,boxShadow:â€œ0 -4px 20px rgba(0,0,0,0.5)â€}}>
{extraItems.map(item => {
const active = current === item.id;
return (
<button key={item.id} onClick={()=>{setView(item.id);setOpen(false);}}
style={{width:â€œ100%â€,display:â€œflexâ€,alignItems:â€œcenterâ€,gap:14,
padding:â€œ14px 20pxâ€,border:â€œnoneâ€,background:active?C.goldBg:â€œtransparentâ€,
cursor:â€œpointerâ€,color:active?C.gold:C.text,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,fontSize:14,textAlign:â€œleftâ€}}>
<Ic n={item.icon} size={18} stroke={active?C.gold:C.textMuted}/>
{item.label}
</button>
);
})}
<div style={{height:1,background:C.border,margin:â€œ8px 0â€}}/>
<button onClick={onLogout}
style={{width:â€œ100%â€,display:â€œflexâ€,alignItems:â€œcenterâ€,gap:14,
padding:â€œ14px 20pxâ€,border:â€œnoneâ€,background:â€œtransparentâ€,
cursor:â€œpointerâ€,color:C.red,
fontFamily:â€â€˜DM Sansâ€™,sans-serifâ€,fontSize:14,textAlign:â€œleftâ€}}>
<Ic n="x" size={18} stroke={C.red}/>Esci
</button>
</div>
)}
</>
);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP ROOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
// â”€â”€ TUTTI GLI HOOK IN CIMA â€” mai dopo un return condizionale â”€â”€
const [user,           setUser]           = useState(null);
const [view,           setView]           = useState(â€œdashboardâ€);
const [panKey,         setPanKey]         = useState(0);
const [schermata,      setSchermata]      = useState(â€œloginâ€);
const [sharedStudents,       setSharedStudents]       = useState(INIT_STUDENTS);
const [sharedCourses,        setSharedCourses]        = useState(INIT_COURSES);
const [sharedDocenti,        setSharedDocenti]        = useState(INIT_DOCENTI_EXT);
const [sharedLessons,        setSharedLessons]        = useState(INIT_LESSONS);
const [sharedConfig,         setSharedConfig]         = useState(CONFIG_DEFAULT);
const [sharedAnniScolastici, setSharedAnniScolastici] = useState(INIT_ANNI_SCOLASTICI);
const [sharedEntrate,         setSharedEntrate]         = useState(INIT_ENTRATE_QUOTE);

const cambiaSchermata = (s) => { setSchermata(s); setPanKey(p=>p+1); };

// â”€â”€ SCHERMATA AUTH â”€â”€
if (!user) {
return (
<>
<style>{G}</style>
<div style={{minHeight:â€œ100vhâ€,display:â€œflexâ€,background:C.bg,overflow:â€œhiddenâ€}}>
<div className="login-left-panel"><PanelloSinistra/></div>
<div style={{flex:1,display:â€œflexâ€,alignItems:â€œcenterâ€,justifyContent:â€œcenterâ€,
padding:â€œ40px 24pxâ€,overflowY:â€œautoâ€}}>
<div key={panKey} style={{width:â€œ100%â€,maxWidth:400,padding:â€œ0 4pxâ€}}>
{schermata===â€œloginâ€ && (
<FormLogin
onSuccess={u=>{setUser(u);setView(â€œdashboardâ€);}}
onRegistrazione={()=>cambiaSchermata(â€œregisterâ€)}
onRecupero={()=>cambiaSchermata(â€œrecoverâ€)}
/>
)}
{schermata===â€œregisterâ€ && <FormRegistrazione onBack={()=>cambiaSchermata(â€œloginâ€)}/>}
{schermata===â€œrecoverâ€   && <FormRecupero onBack={()=>cambiaSchermata(â€œloginâ€)}/>}
</div>
</div>
</div>
</>
);
}

// â”€â”€ WEBAPP PRINCIPALE â”€â”€
const views = {
dashboard:   <DashboardView appUser={user} onNavigate={setView}
config={sharedConfig} setConfig={setSharedConfig}
anniScolastici={sharedAnniScolastici} setAnniScolastici={setSharedAnniScolastici}/>,
allievi:     <AllieviView    students={sharedStudents} setStudents={setSharedStudents} courses={sharedCourses} setCourses={setSharedCourses} lessons={sharedLessons} entrate={sharedEntrate} setEntrate={setSharedEntrate} annoInizioAttivo={sharedConfig.annoInizioAttivo} config={sharedConfig}/>,
docenti:     <DocentiView   students={sharedStudents} lessons={sharedLessons} docenti={sharedDocenti} setDocenti={setSharedDocenti}
annoInizioAttivo={sharedConfig.annoInizioAttivo}/>,
corsi:       <CorsiView     courses={sharedCourses}   setCourses={setSharedCourses} students={sharedStudents} setStudents={setSharedStudents} docenti={sharedDocenti}/>,
calendario:  <CalendarioView lessons={sharedLessons} setLessons={setSharedLessons} courses={sharedCourses} students={sharedStudents} docenti={sharedDocenti}/>,
contabilita: <ContabilitaView students={sharedStudents} entrate={sharedEntrate} setEntrate={setSharedEntrate} config={sharedConfig} setConfig={setSharedConfig}/>,
repertorio:  <RepertorioView/>,
concerti:    <ConcertiView students={sharedStudents}/>,
utenti:      <UtentiView/>,
};

return (
<>
<style>{G}</style>
<div style={{display:â€œflexâ€,height:â€œ100vhâ€,overflow:â€œhiddenâ€}}>
<Sidebar current={view} setView={setView} user={user} onLogout={()=>setUser(null)}/>
<div key={view} className=â€œmain-scrollâ€ style={{flex:1,overflow:â€œautoâ€,background:C.bg,animation:â€œfadeIn 0.25s easeâ€,
paddingBottom:â€œcalc(env(safe-area-inset-bottom, 0px) + 4px)â€,minWidth:0}}>
{views[view]}
</div>
</div>
</>
);
}

// Espone App al bootstrap in index.html
window.__AppComponent = App;

```
// Mount
const rootEl = document.getElementById("root");
const loadingEl = document.getElementById("loading");
const root = ReactDOM.createRoot(rootEl);
root.render(React.createElement(App));
loadingEl.style.opacity = "0";
setTimeout(() => loadingEl.style.display = "none", 400);
```

  </script>
</body>
</html>
